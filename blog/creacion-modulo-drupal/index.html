<!DOCTYPE html>
<html prefix="
og: https://ogp.me/ns#
article: https://ogp.me/ns/article#
" lang="es">
<head>
<meta charset="utf-8">
<meta name="description" content="Primeros pasos en la creación de un módulo Drupal">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="max-age=43200">
<meta http-equiv="ETag" content="b'2864e0750e0914fb7ea57f1000e152d2d49eb37b'">
<title>Creación de un módulo Drupal | MagMax Blog</title>
<link href="/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="/assets/css/code.css" rel="stylesheet" type="text/css">
<link href="/assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="/assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="/assets/css/custom.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/magmax">
<link rel="canonical" href="http://magmax.org/blog/creacion-modulo-drupal/">
<link rel="icon" href="/favicon_330.png" sizes="330x330">
<link rel="icon" href="/favicon.png" sizes="128x128">
<link rel="icon" href="/favicon.ico" sizes="16x16">
<meta name="description" itemprop="description" content="Primeros pasos en la creación de un módulo Drupal">
<meta name="author" content="Miguel Ángel García">
<link rel="prev" href="/blog/creacion-modulo-drupal-4/" title="Creación de un módulo Drupal IV" type="text/html">
<link rel="next" href="/blog/recuperar-grub/" title="Recuperar Grub" type="text/html">
<meta property="og:site_name" content="MagMax Blog">
<meta property="og:title" content="Creación de un módulo Drupal">
<meta property="og:url" content="http://magmax.org/blog/creacion-modulo-drupal/">
<meta property="og:description" content="Primeros pasos en la creación de un módulo Drupal">
<meta property="og:type" content="article">
<meta property="article:author" content="Miguel Ángel García">
<meta property="article:published_time" content="2010-05-11T00:00:00+00:00">
<meta property="article:updated" content="2010-05-11T00:00:00">
<meta property="article:tag" content="drupal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@magmax_en">
<meta name="twitter:creator" content="@magmax">
<meta name="twitter:title" content="MagMax Blog">
<meta name="twitter:description" content="Primeros pasos en la creación de un módulo Drupal">
<meta name="twitter:url" content="http://magmax.org//blog/creacion-modulo-drupal/">
<meta name="twitter:image" content="http://magmax.org/favicon.png">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Ir al contenido principal</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container">
<!-- This keeps the margins nice -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://magmax.org/">

        <span id="blog-title">MagMax Blog</span>
      </a>
    </div>
<!-- /.navbar-header -->
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav">
<li>
<a href="/">Inicio</a>
                </li>
<li>
<a href="/archive.html">Archivo</a>
                </li>
<li>
<a href="/categories">Categorías</a>
                </li>
<li>
<a href="/projects">Proyectos</a>
                </li>
<li>
<a href="/news">Posts Externos</a>

        
      </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
<form class="navbar-form navbar-left" role="search" action="http://google.com/search" method="get">
<div class="form-group">
<input type="hidden" name="sitesearch" value="magmax.org"><input type="text" name="q" class="form-control" placeholder="Search / Buscar">
</div>
</form>
</li>

        <li style="margin-left:0">
          <a href="http://feeds.feedburner.com/magmax">
            <img src="/assets/images/rss.png" style="width:22px;height:22px"></a>
        </li>

        
      </ul>
</div>
<!-- /.navbar-collapse -->
  </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
  <div class="body-content">
    <div class="row">
      <div class="page-content col-md-9">
        
        <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="https://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="/blog/creacion-modulo-drupal/" class="u-url">Creación de un módulo Drupal</a></h1>
            <div class="metadata text-muted">
              <i class="glyphicon glyphicon-calendar"></i>
              <p class="dateline">
                <time class="published dt-published" datetime="2010-05-11T00:00:00+00:00" title="2010-05-11">2010-05-11</time>
                // <time class="updated dt-updated" datetime="2010-05-11T00:00:00" title="2010-05-11">2010-05-11</time></p>
              <p class="commentline">            <a href="/blog/creacion-modulo-drupal/#disqus_thread" data-disqus-identifier="cache/posts/creacion-modulo-drupal.html">Comments</a>

</p>
              <address class="vcard author"><a class="url fn" href="https://magmax.org">Miguel Ángel García</a></address>
            </div>
            <br></header><div class="e-content entry-content" itemprop="articleBody text">
            <div>
<p>Hoy vamos a ver cómo crear un módulo drupal sencillito. Como ejemplo vamos a escribir nuestro propio módulo, algo que sea útil: un <strong>"feedback"</strong>.</p>
<p>En este tutorial nos vamos a centrar en drupal 6. Para usar otro drupal, basta mirarse la API de cada función.</p>
<p>Tras probar varios, para la edición recomiendo kate.</p>
<!-- TEASER_END -->
<div class="section" id="directorios-y-ficheros">
<h2>Directorios y ficheros</h2>
<p>Los módulos deben colgar a partir de la ruta <tt class="docutils literal">/etc/drupal/6/sites/default/modules</tt>. Allí crearemos un directorio con el nombre de nuestro módulo. En este caso, <code>feedback</code>: <tt class="docutils literal">/etc/drupal/6/sites/default/modules/feedback</tt>.</p>
<p>Será en este directorio donde vayan nuestros ficheros. Para el ejemplo, tan sólo vamos a crear 3 ficheros: <tt class="docutils literal">feedback.info</tt>, <tt class="docutils literal">feedback.module</tt> y <tt class="docutils literal">feedback.install</tt>. El primero de los ficheros sirve para decirle a drupal de qué va nuestro módulo; el segundo contendrá toda la lógica; y el tercero servirá para crear la base de datos.</p>
</div>
<div class="section" id="diciendole-a-drupal-que-estamos-aqui">
<h2>Diciéndole a Drupal que estamos aquí</h2>
<p>Crearemos el archivo <tt class="docutils literal">feedback.info</tt>. Su contenido es el siguiente:</p>
<pre class="code php"><a name="rest_code_89c6322585a348d8b8125483e6008402-1"></a><span class="x">; $Id$</span>
<a name="rest_code_89c6322585a348d8b8125483e6008402-2"></a><span class="x">name = "Feedback"</span>
<a name="rest_code_89c6322585a348d8b8125483e6008402-3"></a><span class="x">description = "Proporciona un formulario para solicitar mejoras."</span>
<a name="rest_code_89c6322585a348d8b8125483e6008402-4"></a><span class="x">core = 6.x</span>
</pre>
<p>Habitualmente, la gente de Drupal suele comenzar por un comentario con el ID del repositorio. De esta manera, es fácil identificar la versión del módulo.</p>
<p>A continuación viene el nombre, tal cual se mostrará en la ventanade administracción. Conviene usar algo corto.</p>
<p>La descripción puede ser algo más larga. Aparecerá también en la ventana de administracción, y nos dará una idea sobre para qué sirve el módulo. Podemos usar hasta varias líneas</p>
<p>El <em>"core"</em> hace referencia a la versión de drupal para la que se construye el módulo. Como vamos a hacer algo para drupal 6, el valorserá "6.x".</p>
<p>A parte de estas 3 <em>keywords</em> que son obligatorias (<code>name</code>, <code>description</code> y <code>core</code>), hay varias opcionales, como <code>package</code>, <cite>dependences</cite>, ... que están más allá del objetivo de este tutorial. Vean la documentación para más información.</p>
<p>Tened cuidado con las tildes y las eñes, ya que pueden causar problemas. Si guardáis en UTF-8, os ahorraréis quebraderos de cabeza. Además, si encerráis las cosas entre comillas dobles (como he hecho), podréis usar varias líneas ;)</p>
</div>
<div class="section" id="creacion-de-la-base-de-datos">
<h2>Creación de la base de datos</h2>
<p>Suele ser buena política comenzar los nombres de las tablas con el nombre del módulo; así nos aseguramos que no se van a chocar con otros módulos. Así, vamos a crear la tabla <code>feedback_messages</code>, paralo que crearemos el fichero <tt class="docutils literal">feedback.install</tt>:</p>
<pre class="code php"><a name="rest_code_9186b00202384b809b3884140781445b-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_9186b00202384b809b3884140781445b-2"></a><span class="k">function</span> <span class="nf">feedback_schema</span> <span class="p">()</span>
<a name="rest_code_9186b00202384b809b3884140781445b-3"></a><span class="p">{</span>
<a name="rest_code_9186b00202384b809b3884140781445b-4"></a>  <span class="nv">$schema</span><span class="p">[</span><span class="s1">'feedback_messages'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_9186b00202384b809b3884140781445b-5"></a>  <span class="p">(</span>
<a name="rest_code_9186b00202384b809b3884140781445b-6"></a>    <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Tabla para mensajes de retroalimentacion'</span><span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-7"></a>    <span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_9186b00202384b809b3884140781445b-8"></a>    <span class="p">(</span>
<a name="rest_code_9186b00202384b809b3884140781445b-9"></a>      <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_9186b00202384b809b3884140781445b-10"></a>      <span class="p">(</span>
<a name="rest_code_9186b00202384b809b3884140781445b-11"></a>        <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Identificador de mensaje'</span><span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-12"></a>        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'serial'</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-13"></a>        <span class="s1">'unsigned'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-14"></a>        <span class="s1">'not null'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-15"></a>      <span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-16"></a>      <span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_9186b00202384b809b3884140781445b-17"></a>      <span class="p">(</span>
<a name="rest_code_9186b00202384b809b3884140781445b-18"></a>        <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Identificador del usuario que realiza el feedback'</span><span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-19"></a>        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'int'</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-20"></a>        <span class="s1">'unsigned'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-21"></a>        <span class="s1">'not null'</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-22"></a>      <span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-23"></a>      <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_9186b00202384b809b3884140781445b-24"></a>      <span class="p">(</span>
<a name="rest_code_9186b00202384b809b3884140781445b-25"></a>        <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Mensaje de feedback'</span><span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-26"></a>        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'text'</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-27"></a>        <span class="s1">'not null'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-28"></a>      <span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-29"></a>      <span class="s1">'indate'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_9186b00202384b809b3884140781445b-30"></a>      <span class="p">(</span>
<a name="rest_code_9186b00202384b809b3884140781445b-31"></a>        <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Fecha en la que se crea el comentario'</span><span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-32"></a>        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'datetime'</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-33"></a>        <span class="s1">'not null'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_9186b00202384b809b3884140781445b-34"></a>      <span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-35"></a>    <span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-36"></a>    <span class="s1">'primary key'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span><span class="p">),</span>
<a name="rest_code_9186b00202384b809b3884140781445b-37"></a>  <span class="p">);</span>
<a name="rest_code_9186b00202384b809b3884140781445b-38"></a>  <span class="k">return</span> <span class="nv">$schema</span><span class="p">;</span>
<a name="rest_code_9186b00202384b809b3884140781445b-39"></a><span class="p">}</span>
<a name="rest_code_9186b00202384b809b3884140781445b-40"></a>
<a name="rest_code_9186b00202384b809b3884140781445b-41"></a>
<a name="rest_code_9186b00202384b809b3884140781445b-42"></a><span class="k">function</span> <span class="nf">feedback_install</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_9186b00202384b809b3884140781445b-43"></a>  <span class="c1">// Create my tables.</span>
<a name="rest_code_9186b00202384b809b3884140781445b-44"></a>  <span class="nx">drupal_install_schema</span><span class="p">(</span><span class="s1">'feedback'</span><span class="p">);</span>
<a name="rest_code_9186b00202384b809b3884140781445b-45"></a><span class="p">}</span>
<a name="rest_code_9186b00202384b809b3884140781445b-46"></a>
<a name="rest_code_9186b00202384b809b3884140781445b-47"></a><span class="k">function</span> <span class="nf">feedback_uninstall</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_9186b00202384b809b3884140781445b-48"></a>  <span class="c1">// Drop my tables.</span>
<a name="rest_code_9186b00202384b809b3884140781445b-49"></a>  <span class="nx">drupal_uninstall_schema</span><span class="p">(</span><span class="s1">'feedback'</span><span class="p">);</span>
<a name="rest_code_9186b00202384b809b3884140781445b-50"></a><span class="p">}</span>
<a name="rest_code_9186b00202384b809b3884140781445b-51"></a><span class="cp">?&gt;</span><span class="x"></span>
</pre>
<p><strong>Nota importante:</strong> Fijaos que no cierro el tag de PHP. En nuestros módulos es muy importante que los dejemos abiertos. Es decir: usaremos <code>&lt;?php</code>, pero no <code>?&gt;</code>.</p>
<p>Aquí hemos creado una cosa que se llama <strong>hook</strong> y que veremos más adelante. En concreto, hemos usado el <code>hook_schema</code>, <code>hook_install</code> y <code>hook_uninstall</code>.</p>
<p>Existen algunas limitaciones. Para comenzar, Drupal utiliza un tipo de tabla de MySQL que no soporta Foreign Keys, por lo que no tenemos que preocuparnos por eso: nada más que las tablas y los campos.</p>
<p>Quizá os llame la atención la función "<em>t</em>". Sirve para indicarle a Drupal que es un texto traducible y, si encuentra la traducción, lo mostrará traducido. Conviene poner las claves en inglés, que es el idioma por defecto para Drupal, pero esa norma me la he saltado a la torera.</p>
<p>Por lo demás, no creo necesario comentar el archivo: como cada apartado tiene su comentario, creo que se explica sólo.</p>
</div>
<div class="section" id="creacion-de-la-logica">
<h2>Creación de la lógica</h2>
<p>Ahora vamos con lo más difícil: La lógica del módulo.</p>
<p>Una norma básica: Todas las funciones de nuestro módulo deben comenzar por el nombre de nuestro módulo. Si queremos crear una función estática (invisible desde fuera), antecederemos una barra baja (<code>_</code>).</p>
<p>En la documentación veremos muchas referencias a <code>hook</code>. No es el Capitán Garfio... Son funciones que Drupal espera encontrar ennuestro código (aunque no todas son obligatorias), es decir: puntos de entrada a nuestro módulo.</p>
<p>Veamos un ejemplo de hook: <code>hook_help</code>. Así, de paso, proporcionamos un poco de ayuda a nuestro módulo.</p>
<pre class="code php"><a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-2"></a><span class="sd">/**</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-3"></a><span class="sd">* Implements hook_help().</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-4"></a><span class="sd">*/</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-5"></a><span class="k">function</span> <span class="nf">feedback_help</span> <span class="p">(</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$arg</span> <span class="p">)</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-6"></a><span class="p">{</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-7"></a>  <span class="nv">$output</span><span class="o">=</span><span class="s1">''</span><span class="p">;</span> <span class="c1">// para construir la salida</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-8"></a>  <span class="k">switch</span> <span class="p">(</span> <span class="nx">path</span> <span class="p">)</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-9"></a>  <span class="p">{</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-10"></a>    <span class="k">case</span> <span class="s1">'admin/help#feedback'</span><span class="o">:</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-11"></a>      <span class="nv">$output</span> <span class="o">.=</span> <span class="s1">'&lt;p&gt;'</span> <span class="o">.</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Módulo que permite la inserción de mensajes de feedback.'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/p&gt;'</span><span class="p">;</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-12"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-13"></a>  <span class="p">}</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-14"></a>  <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<a name="rest_code_6582e7a0bfa7496d8639b232021eebb0-15"></a><span class="p">}</span>
</pre>
<p><strong>Nota:</strong> Vuelvo a recordar que los ficheros del módulo contendrán el <code>&lt;?php</code>, pero no el <code>?&gt;</code>.</p>
<p>Con esa función en nuestro <code>feedback.module</code> tenemos asegurado que cuando alguien acceda a <tt class="docutils literal">admin/help#feedback</tt> podrá ver la ayuda.</p>
<p>Para más información, la página de <a class="reference external" href="http://api.drupal.org/api/function/hook_help">hook_help</a>.</p>
<div class="section" id="permisos">
<h3>Permisos</h3>
<p>Veamos ahora quién puede usar nuestro módulo.</p>
<p>Por un lado, queremos que cualquier usuario pueda rellenar un formulario, que será lo que después veremos desde un usuario administrador. Así que tenemos dos tipos de permiso: <em>"send message"</em> y <em>"view message"</em>. El primero será útil por si sólo queremos el feedback de usuarios autenticados. Pensad que luego tendremos que asignar estos permisos a algunos roles. El nombre de los permisos puede coincidir con otros, pero no creo que pase nada, porque van identificados contra nuestro módulo (es posible que exista alguno especial para ver si se tienen privilegios de administrador, etc.).</p>
<p>Para crear los permisos, tenemos otro hook, el <code>hook_perm</code>:</p>
<pre class="code php"><a name="rest_code_0301b4a3bfae4b0cb822498d54f0f15b-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_0301b4a3bfae4b0cb822498d54f0f15b-2"></a><span class="sd">/**</span>
<a name="rest_code_0301b4a3bfae4b0cb822498d54f0f15b-3"></a><span class="sd">* Implements hook_perm().</span>
<a name="rest_code_0301b4a3bfae4b0cb822498d54f0f15b-4"></a><span class="sd">*/</span>
<a name="rest_code_0301b4a3bfae4b0cb822498d54f0f15b-5"></a><span class="k">function</span> <span class="nf">feedback_perm</span> <span class="p">()</span>
<a name="rest_code_0301b4a3bfae4b0cb822498d54f0f15b-6"></a><span class="p">{</span>
<a name="rest_code_0301b4a3bfae4b0cb822498d54f0f15b-7"></a>  <span class="k">return</span> <span class="k">array</span> <span class="p">(</span><span class="s1">'send message'</span><span class="p">,</span> <span class="s1">'view messages'</span><span class="p">);</span>
<a name="rest_code_0301b4a3bfae4b0cb822498d54f0f15b-8"></a><span class="p">}</span>
</pre>
<p><strong>Nota:</strong> En algún sitio leí que los comentarios para los hooks se recomienda que sean como éstos que estoy poniendo.</p>
<p>Como véis, no tiene mayor complicación. Copiar y pegar en nuestro <code>feedback.module</code></p>
<p>Más información en <a class="reference external" href="http://api.drupal.org/api/function/hook_perm">hook_perm</a>  y también <a class="reference external" href="http://drupal.org/getting-started/6/admin/user/permissions">en la propia web de drupal</a>.</p>
</div>
</div>
<div class="section" id="bloques">
<h2>Bloques</h2>
<p>Nuestro módulo aún no hace nada. Ahora vamos a declarar dosbloques: Uno para que el Administrador del sitio pueda colocar donde quiera un enlace al formulario (que luego crearemos) y otro para que el Administrador pueda decidir quién y dónde pude verse si hay algún mensaje o no.</p>
<p>La función <code>hook_block</code> (seguro que ya os lo esperábais) tiene tres parámetros:</p>
<ul class="simple">
<li>
<code>$op</code>, que puede valer <code>list</code>, <code>view</code>, <code>save</code> o <code>configure</code>,  dependiendo de la operación solicitada. En nuestro caso, como vamos  a lo fácil, sólo contemplaremos <code>list</code> y <code>view</code>.</li>
<li>
<code>$delta</code>, que sirve para identificar el identificador de  bloque.</li>
<li>
<code>$edit</code>, usado para la operación "save", por lo que nos  olvidamos de él.</li>
</ul>
<pre class="code php"><a name="rest_code_ab02d8084313446b81ec503d53d2a149-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-2"></a><span class="sd">/**</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-3"></a><span class="sd">* Implementation of hook_block().</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-4"></a><span class="sd">*/</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-5"></a><span class="k">function</span> <span class="nf">feedback_block</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">=</span> <span class="s1">'list'</span><span class="p">,</span> <span class="nv">$delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$edit</span> <span class="o">=</span> <span class="k">array</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-6"></a><span class="p">{</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-7"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">"list"</span><span class="p">)</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-8"></a>  <span class="p">{</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-9"></a>      <span class="nv">$blocks</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-10"></a>      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"info"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-11"></a>      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"info"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'New Feedbacks'</span><span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-12"></a>      <span class="k">return</span> <span class="nv">$blocks</span><span class="p">;</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-13"></a>  <span class="p">}</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-14"></a>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">"view"</span> <span class="p">)</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-15"></a>  <span class="p">{</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-16"></a>      <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-17"></a>      <span class="nv">$block</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-18"></a>      <span class="k">switch</span> <span class="p">(</span> <span class="nv">$delta</span> <span class="p">)</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-19"></a>      <span class="p">{</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-20"></a>        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-21"></a>          <span class="nv">$block</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-22"></a>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-23"></a>          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"attributes"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"Sends a feedback message"</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-24"></a>          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"New Feedback"</span><span class="p">),</span> <span class="s2">"feedback/message"</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-25"></a>          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">'&lt;div class="link"&gt;'</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-26"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-27"></a>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-28"></a>          <span class="nv">$block</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback Messages'</span><span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-29"></a>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-30"></a>          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"attributes"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"Shows feedback messages"</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-31"></a>          <span class="nv">$title</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"There are @total new feeds"</span><span class="p">,</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'@total'</span> <span class="o">=&gt;</span> <span class="nx">_feedback_count</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-32"></a>          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nv">$title</span> <span class="p">,</span> <span class="s2">"feedback/adminmessages"</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-33"></a>          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">'&lt;div class="link"&gt;'</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-34"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-35"></a>      <span class="p">}</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-36"></a>      <span class="nv">$block</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-37"></a>      <span class="k">return</span> <span class="nv">$block</span><span class="p">;</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-38"></a>  <span class="p">}</span>
<a name="rest_code_ab02d8084313446b81ec503d53d2a149-39"></a><span class="p">}</span>
</pre>
<p>Vamos a ver esto, que tiene mucha tela.</p>
<p>La parte de <code>list</code> no tiene mucha complicación: es un array que devuelve en la posición 0 el bloque para usuarios y en la posición 1, el de administradores. Se le pasan los títulos y en paz.</p>
<p>La parte de <code>view</code> depende de si estamos en el bloque 0 (usuarios) o en el bloque 1 (administradores). Ambos van a crear un enlace (<code>$link</code>) a unas páginas que trataremos más adelante. Además, le añaden un título molón mediante $options. Para que queden chulos se utiliza la clase <code>link</code>. Y... Bueno, en el caso de los administradores nos interesa saber cuántos feedbacks nuevos hay, por lo que llamamos a la función <code>_feedback_count()</code>, que debe darnos el número de <em>feeds</em> nuevos.</p>
<p>Como es facilita, vamos con la función <code>_feedback_count()</code>:</p>
<pre class="code php"><a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-2"></a><span class="sd">/** Devuelve el número de feeds creados en la última semana</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-3"></a><span class="sd">*/</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-4"></a><span class="k">function</span> <span class="nf">_feedback_count</span> <span class="p">()</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-5"></a><span class="p">{</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-6"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT count(id) as total from {feedback_messages} where datediff( now(), indate ) &lt; 7"</span><span class="p">;</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-7"></a>  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-8"></a>  <span class="nv">$result</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">;</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-9"></a>  <span class="k">return</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">total</span><span class="p">;</span>
<a name="rest_code_735283f6dc6145b0958bae2a1cf5f172-10"></a><span class="p">}</span>
</pre>
<p>Bueno, ya tenemos un ejemplo (pequeñito) de consulta SQL :D</p>
<p>Aquí nos dejamos pendiente el manejar las direcciones de los enlaces. Esto se verá en los siguientes apartados.</p>
<p>Pero... Antes que nada, ¡vamos a probar lo poco que tenemos!</p>
<div class="section" id="probando-que-no-os-engano">
<h3>Probando que no os engaño</h3>
<p>Si todo está en su sitio, deberíamos poder ver los módulos. Vamos a Drupal, <strong>Administer-&gt;Site Building-&gt;Modules</strong>, buscamos nuestro modulito, que estará en la sección <em>"others"</em> (sección por defecto, ya que no hemos establecido un <em>"package"</em> en el <tt class="docutils literal">.info</tt>) y lo activamos.</p>
<p>Guardamos la configuración.</p>
<p>¡¡ Y ya está funcionando !!</p>
<p>...</p>
<p>¿Que no veis nada? ¡Pues claro que no! Vamos con los bloques: <strong>Administer-&gt;Site Building-&gt;Blocks</strong>, buscamos <strong>New Feedbacks</strong> y <strong>Feedback</strong> y los colocamos en algún sitio, por ejemplo en la <strong>Right sidebar</strong>, y guardamos.</p>
<p>Tachaaaaaaan!!!</p>
<p>Si no hemos hecho algo mal (vosotros o yo), deberíais ver vuestros dos fabulosos bloques.</p>
</div>
<div class="section" id="manejando-direcciones">
<h3>Manejando direcciones</h3>
<p>En el apartado anterior nos dejamos pendiente el manejo de direcciones. Para esto hay otro hook, el hook_menu:</p>
<pre class="code php"><a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-2"></a><span class="sd">/**</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-3"></a><span class="sd">* Implementation of hook_menu().</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-4"></a><span class="sd">*/</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-5"></a><span class="k">function</span> <span class="nf">feedback_menu</span> <span class="p">(</span> <span class="p">)</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-6"></a><span class="p">{</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-7"></a>  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-8"></a>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-9"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/message'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-10"></a>  <span class="p">(</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-11"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">),</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-12"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_message'</span><span class="p">,</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-13"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'send message'</span><span class="p">),</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-14"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-15"></a>  <span class="p">);</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-16"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/adminmessages'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-17"></a>  <span class="p">(</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-18"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback Admin'</span><span class="p">),</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-19"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_admin'</span><span class="p">,</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-20"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'view messages'</span><span class="p">),</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-21"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-22"></a>  <span class="p">);</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-23"></a>  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<a name="rest_code_57b2dfe81f90455b972d6df20de78a9d-24"></a><span class="p">}</span>
</pre>
<p>Con esto le estamos contando a Drupal qué función es la que nos va a generar la página a mostrar en ese link.</p>
<p>Así que volvemos a dejar cosas en el tintero: ahora tenemos que crear las funciones <code>feedback_message</code> y <code>feedback_admin</code>.</p>
<p>Si os dais cuenta, hemos rellenado "access arguments". Estos son los permisos necesarios para poder acceder a ese link. Si el usuario que trata de acceder no tiene esos permisos, se le mostrará la página de que no tiene acceso (ojo, que el administrador tiene todos los permisos).</p>
</div>
<div class="section" id="creacion-de-un-formulario">
<h3>Creación de un formulario</h3>
<p>Vamos con el formulario de inserción de un feed. Comenzamos por la función que nos dejamos pendiente:</p>
<pre class="code php"><a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-2"></a><span class="k">function</span> <span class="nf">feedback_message</span> <span class="p">()</span>
<a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-3"></a><span class="p">{</span>
<a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-4"></a>  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-5"></a>
<a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-6"></a>  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">'feedback_message_form'</span> <span class="p">);</span>
<a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-7"></a>
<a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-8"></a>  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_320c8de56f324e5cab0b04f102cb9dec-9"></a><span class="p">}</span>
</pre>
<p>Y con eso, delegamos en la función feedback_message, que es un formulario. Al ser un formulario, tiene "cosas especiales". Por ejemplo, tiene hooks. Así podemos tener el hook_validate y el hook_submit, que se ejecutarán para validar y enviar el formulario, respectivamente. Venga, no hay dolor; vamos con las 3 a la vez:</p>
<pre class="code php"><a name="rest_code_7def40fcf2074cba9990e54c325d235f-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-2"></a><span class="k">function</span> <span class="nf">feedback_message_form</span> <span class="p">()</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-3"></a><span class="p">{</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-4"></a>  <span class="nv">$form</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-5"></a>  <span class="p">(</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-6"></a>    <span class="s1">'feedback'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-7"></a>    <span class="p">(</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-8"></a>      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-9"></a>      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span> <span class="s1">'Feedback'</span> <span class="p">),</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-10"></a>      <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textarea'</span><span class="p">,</span> <span class="s2">"#description"</span><span class="o">=&gt;</span><span class="s2">"Write here your message"</span> <span class="p">),</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-11"></a>      <span class="s1">'submit'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>  <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Submit'</span><span class="p">),</span>  <span class="p">),</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-12"></a>    <span class="p">),</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-13"></a>  <span class="p">);</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-14"></a>  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-15"></a><span class="p">}</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-16"></a>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-17"></a><span class="k">function</span> <span class="nf">feedback_message_form_validate</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-18"></a><span class="p">{</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-19"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">'values'</span><span class="p">][</span><span class="s1">'message'</span><span class="p">];</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-20"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">==</span> <span class="s1">''</span> <span class="p">)</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-21"></a>    <span class="nx">form_set_error</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Message cannot be empty.'</span><span class="p">));</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-22"></a>  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-23"></a><span class="p">}</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-24"></a>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-25"></a><span class="k">function</span> <span class="nf">feedback_message_form_submit</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-26"></a><span class="p">{</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-27"></a>  <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-28"></a>  <span class="nv">$userid</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-29"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$user</span> <span class="p">)</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-30"></a>    <span class="nv">$userid</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-31"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">'values'</span><span class="p">][</span><span class="s1">'message'</span><span class="p">];</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-32"></a>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-33"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"INSERT into {feedback_messages} ( uid, message, indate ) values ( %d, '%s', now() ) "</span><span class="p">;</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-34"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$userid</span><span class="p">,</span> <span class="nv">$message</span> <span class="p">);</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-35"></a>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-36"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-37"></a>    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span> <span class="p">(</span> <span class="s2">"Thank you for your feedback."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-38"></a>  <span class="k">else</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-39"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">"An error has happened. Your feedback has not been sent."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_7def40fcf2074cba9990e54c325d235f-40"></a><span class="p">}</span>
</pre>
<p>No hay mucho que comentar aquí... Que la función del formulario devuelve un array, que _hook_submit_ y _hook_validate_ se tienen que llamar igual que la función del formulario pero con las coletillas <code>_submit</code> y <code>_validate</code>, que si "validate" lanza el <code>form_set_error</code> entonces no se lanza el submit y... poco más.</p>
<p>Como el submit no ha redireccionado a otra página, aparecerá de nuevo la antigua.</p>
</div>
<div class="section" id="tablas">
<h3>Tablas</h3>
<p>Vamos a hacer algo muy cutre: una tabla enorme con todos losfeeds. Por no ser tan sumamente cutres, haremos que sea ordenable si pinchamos en las cabeceras :D</p>
<pre class="code php"><a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-1"></a><span class="x">function feedback_admin ()</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-2"></a><span class="x">{</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-3"></a><span class="x">  $content = '';</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-4"></a>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-5"></a><span class="x">  $header = array</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-6"></a><span class="x">  (</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-7"></a><span class="x">    array('data' =&gt; t('Date'), 'field' =&gt; 'indate', 'sort' =&gt; 'desc'),</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-8"></a><span class="x">    array('data' =&gt; t('User'), 'field' =&gt; 'name'),</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-9"></a><span class="x">    array('data' =&gt; t('Message'), 'field' =&gt; 'message'),</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-10"></a><span class="x">  );</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-11"></a>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-12"></a><span class="x">  $query = "SELECT u.name, fm.indate, fm.message FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid";</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-13"></a><span class="x">  $queryResult =  db_query ( $query );</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-14"></a>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-15"></a><span class="x">  $rows = array ();</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-16"></a><span class="x">  while ( $message = db_fetch_object ( $queryResult ) )</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-17"></a><span class="x">  {</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-18"></a><span class="x">    $row = array ();</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-19"></a><span class="x">    $row['name'] = $message-&gt;name;</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-20"></a><span class="x">    $row['indate'] = $message-&gt;indate;</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-21"></a><span class="x">    $row['message'] = $message-&gt;message;</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-22"></a><span class="x">    $rows[] = $row;</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-23"></a><span class="x">  }</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-24"></a>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-25"></a><span class="x">  $content .= theme_table($header, $rows);</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-26"></a><span class="x">  return $content;</span>
<a name="rest_code_a0bf042b816944f2a129258f05a0fbfd-27"></a><span class="x">}</span>
</pre>
<p><code>$header</code> tiene las cabeceras y son el nexo con los campos. El <code>while</code> transforma los resultados en un vector de arrays y, al llamar a <code>theme_table</code>, Drupal sabe cómo tiene que renderizar eso, así que nos lo pinta todo mono.</p>
</div>
</div>
<div class="section" id="este-tutorial-no-acaba-aqui">
<h2>Este tutorial no acaba aquí</h2>
<ul class="simple">
<li><a class="reference external" href="/blog/creacion-modulo-drupal-2">Creación de un módulo drupal II</a></li>
<li><a class="reference external" href="/blog/creacion-modulo-drupal-3">Creación de un módulo drupal III</a></li>
<li><a class="reference external" href="/blog/creacion-modulo-drupal-4">Creación de un módulo drupal IV</a></li>
<li><a class="reference external" href="/blog/drupal-expansors">Drupal: Creando contenido con 'expansors'</a></li>
<li><a class="reference external" href="/blog/critica-drupal">Crítica a Drupal</a></li>
<li><a class="reference external" href="/blog/drupal-tabla-perfecta">Tablas en Drupal: Haciendo la tabla perfecta</a></li>
</ul>
</div>
<div class="section" id="enlaces">
<h2>Enlaces</h2>
<ul class="simple">
<li><a class="reference external" href="http://drupal.org/node/206753">Creación de módulos para drupal"</a></li>
<li><a class="reference external" href="http://drupal.org/node/231036">Escribir ficheros .info"</a></li>
<li><a class="reference external" href="http://drupal.org/node/159605">Tipos de datos para el .install"</a></li>
</ul>
</div>
<div class="section" id="licencia">
<h2>Licencia</h2>
<p>Este documento se puede distribuir bajo licencia <a class="reference external" href="http://www.gnu.org/copyleft/fdl.html">FDL</a> y el código bajo licencia <a class="reference external" href="http://www.gnu.org/licenses/gpl.html">GPL v3 o posterior, a su elección.</a></p>
</div>
<div class="section" id="codigo">
<h2>Código</h2>
<p>Aquí está todo el código:</p>
<div class="section" id="feedback-info">
<h3>feedback.info</h3>
<pre class="code php"><a name="rest_code_28fb549bdacd47e1b2b1915557d40f87-1"></a><span class="x">; $Id$</span>
<a name="rest_code_28fb549bdacd47e1b2b1915557d40f87-2"></a><span class="x">name = "MagMax Feedback"</span>
<a name="rest_code_28fb549bdacd47e1b2b1915557d40f87-3"></a><span class="x">description = "Proporciona un sistema de feedbacks fácil para drupal"</span>
<a name="rest_code_28fb549bdacd47e1b2b1915557d40f87-4"></a><span class="x">core = 6.x</span>
</pre>
</div>
<div class="section" id="feedback-install">
<h3>feedback.install</h3>
<pre class="code php"><a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-2"></a><span class="cm">/*</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-3"></a><span class="cm">Copyright 2009 Miguel Ángel García Martínez &lt;miguelangel.garcia@gmail.com&gt;</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-4"></a>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-5"></a><span class="cm">  'Feedback' is free software; you can redistribute it and/or modify</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-6"></a><span class="cm">it under the terms of the GNU General Public License as published by</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-7"></a><span class="cm">the Free Software Foundation; either version 3 of the License, or</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-8"></a><span class="cm">(at your option) any later version.</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-9"></a>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-10"></a><span class="cm">  'Feedback' is distributed in the hope that it will be useful,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-11"></a><span class="cm">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-12"></a><span class="cm">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-13"></a><span class="cm">GNU General Public License for more details.</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-14"></a>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-15"></a><span class="cm">  You should have received a copy of the GNU General Public License</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-16"></a><span class="cm">along with 'Feedback' (maybe in file "COPYING"); if not, write to the Free Software</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-17"></a><span class="cm">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-18"></a><span class="cm">*/</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-19"></a>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-20"></a>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-21"></a><span class="k">function</span> <span class="nf">feedback_schema</span> <span class="p">()</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-22"></a><span class="p">{</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-23"></a>  <span class="nv">$schema</span><span class="p">[</span><span class="s1">'feedback_messages'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-24"></a>  <span class="p">(</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-25"></a>    <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Tabla para mensajes de retroalimentacion'</span><span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-26"></a>    <span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-27"></a>    <span class="p">(</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-28"></a>      <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-29"></a>      <span class="p">(</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-30"></a>        <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Identificador de mensaje'</span><span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-31"></a>        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'serial'</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-32"></a>        <span class="s1">'unsigned'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-33"></a>        <span class="s1">'not null'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-34"></a>      <span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-35"></a>      <span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-36"></a>      <span class="p">(</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-37"></a>        <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Identificador del usuario que realiza el feedback'</span><span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-38"></a>        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'int'</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-39"></a>        <span class="s1">'unsigned'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-40"></a>        <span class="s1">'not null'</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-41"></a>      <span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-42"></a>      <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-43"></a>      <span class="p">(</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-44"></a>        <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Mensaje de feedback'</span><span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-45"></a>        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'text'</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-46"></a>        <span class="s1">'not null'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-47"></a>      <span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-48"></a>      <span class="s1">'indate'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-49"></a>      <span class="p">(</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-50"></a>        <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Fecha en la que se crea el comentario'</span><span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-51"></a>        <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'datetime'</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-52"></a>        <span class="s1">'not null'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-53"></a>      <span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-54"></a>    <span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-55"></a>    <span class="s1">'primary key'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'id'</span><span class="p">),</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-56"></a>  <span class="p">);</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-57"></a>  <span class="k">return</span> <span class="nv">$schema</span><span class="p">;</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-58"></a><span class="p">}</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-59"></a>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-60"></a>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-61"></a><span class="k">function</span> <span class="nf">feedback_install</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-62"></a>  <span class="c1">// Create my tables.</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-63"></a>  <span class="nx">drupal_install_schema</span><span class="p">(</span><span class="s1">'feedback'</span><span class="p">);</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-64"></a><span class="p">}</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-65"></a>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-66"></a><span class="k">function</span> <span class="nf">feedback_uninstall</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-67"></a>  <span class="c1">// Drop my tables.</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-68"></a>  <span class="nx">drupal_uninstall_schema</span><span class="p">(</span><span class="s1">'feedback'</span><span class="p">);</span>
<a name="rest_code_0c4a93f2d2a540598b2f433028e59f4a-69"></a><span class="p">}</span>
</pre>
</div>
<div class="section" id="feedback-module">
<h3>feedback.module</h3>
<pre class="code php"><a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-2"></a><span class="cm">/*</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-3"></a><span class="cm">Copyright 2009 Miguel Ángel García Martínez &lt;miguelangel.garcia@gmail.com&gt;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-4"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-5"></a><span class="cm">  'Feedback' is free software; you can redistribute it and/or modify</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-6"></a><span class="cm">it under the terms of the GNU General Public License as published by</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-7"></a><span class="cm">the Free Software Foundation; either version 3 of the License, or</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-8"></a><span class="cm">(at your option) any later version.</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-9"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-10"></a><span class="cm">  'Feedback' is distributed in the hope that it will be useful,</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-11"></a><span class="cm">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-12"></a><span class="cm">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-13"></a><span class="cm">GNU General Public License for more details.</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-14"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-15"></a><span class="cm">  You should have received a copy of the GNU General Public License</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-16"></a><span class="cm">along with 'Feedback' (maybe in file "COPYING"); if not, write to the Free Software</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-17"></a><span class="cm">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-18"></a><span class="cm">*/</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-19"></a><span class="sd">/**</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-20"></a><span class="sd">* Implements hook_help().</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-21"></a><span class="sd">*/</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-22"></a><span class="k">function</span> <span class="nf">feedback_help</span> <span class="p">(</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$arg</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-23"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-24"></a>  <span class="nv">$output</span><span class="o">=</span><span class="s1">''</span><span class="p">;</span> <span class="c1">// para construir la salida</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-25"></a>  <span class="k">switch</span> <span class="p">(</span> <span class="nx">path</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-26"></a>  <span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-27"></a>    <span class="k">case</span> <span class="s1">'admin/help#feedback'</span><span class="o">:</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-28"></a>      <span class="nv">$output</span> <span class="o">.=</span> <span class="s1">'&lt;p&gt;'</span> <span class="o">.</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Módulo que permite la inserción de mensajes de feedback.'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/p&gt;'</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-29"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-30"></a>  <span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-31"></a>  <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-32"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-33"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-34"></a><span class="sd">/**</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-35"></a><span class="sd">* Implements hook_perm().</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-36"></a><span class="sd">*/</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-37"></a><span class="k">function</span> <span class="nf">feedback_perm</span> <span class="p">()</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-38"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-39"></a>  <span class="k">return</span> <span class="k">array</span> <span class="p">(</span><span class="s1">'send message'</span><span class="p">,</span> <span class="s1">'view messages'</span><span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-40"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-41"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-42"></a><span class="sd">/**</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-43"></a><span class="sd">* Implementation of hook_block().</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-44"></a><span class="sd">*/</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-45"></a><span class="k">function</span> <span class="nf">feedback_block</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">=</span> <span class="s1">'list'</span><span class="p">,</span> <span class="nv">$delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$edit</span> <span class="o">=</span> <span class="k">array</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-46"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-47"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">"list"</span><span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-48"></a>  <span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-49"></a>      <span class="nv">$blocks</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-50"></a>      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"info"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-51"></a>      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"info"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'New Feedbacks'</span><span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-52"></a>      <span class="k">return</span> <span class="nv">$blocks</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-53"></a>  <span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-54"></a>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">"view"</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-55"></a>  <span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-56"></a>      <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-57"></a>      <span class="nv">$block</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-58"></a>      <span class="k">switch</span> <span class="p">(</span> <span class="nv">$delta</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-59"></a>      <span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-60"></a>        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-61"></a>          <span class="nv">$block</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-62"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-63"></a>          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"attributes"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"Sends a feedback message"</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-64"></a>          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"New Feedback"</span><span class="p">),</span> <span class="s2">"feedback/message"</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-65"></a>          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">'&lt;div class="link"&gt;'</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-66"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-67"></a>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-68"></a>          <span class="nv">$block</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback Messages'</span><span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-69"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-70"></a>          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"attributes"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"Shows feedback messages"</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-71"></a>          <span class="nv">$title</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"There are @total new feeds"</span><span class="p">,</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'@total'</span> <span class="o">=&gt;</span> <span class="nx">_feedback_count</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-72"></a>          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nv">$title</span> <span class="p">,</span> <span class="s2">"feedback/adminmessages"</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-73"></a>          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">'&lt;div class="link"&gt;'</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-74"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-75"></a>      <span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-76"></a>      <span class="nv">$block</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-77"></a>      <span class="k">return</span> <span class="nv">$block</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-78"></a>  <span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-79"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-80"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-81"></a><span class="sd">/**</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-82"></a><span class="sd">* Implementation of hook_menu().</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-83"></a><span class="sd">*/</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-84"></a><span class="k">function</span> <span class="nf">feedback_menu</span> <span class="p">(</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-85"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-86"></a>  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-87"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-88"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/message'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-89"></a>  <span class="p">(</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-90"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Feedback'</span><span class="p">,</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-91"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_message'</span><span class="p">,</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-92"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'send message'</span><span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-93"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-94"></a>  <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-95"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/adminmessages'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-96"></a>  <span class="p">(</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-97"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Feedback admin'</span><span class="p">,</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-98"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_admin'</span><span class="p">,</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-99"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'view messages'</span><span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-100"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-101"></a>  <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-102"></a>  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-103"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-104"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-105"></a><span class="k">function</span> <span class="nf">feedback_message</span> <span class="p">()</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-106"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-107"></a>  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-108"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-109"></a>  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">'feedback_message_form'</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-110"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-111"></a>  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-112"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-113"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-114"></a><span class="k">function</span> <span class="nf">feedback_message_form</span> <span class="p">()</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-115"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-116"></a>  <span class="nv">$form</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-117"></a>  <span class="p">(</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-118"></a>    <span class="s1">'feedback'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-119"></a>    <span class="p">(</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-120"></a>      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-121"></a>      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span> <span class="s1">'Feedback'</span> <span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-122"></a>      <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textarea'</span><span class="p">,</span> <span class="s2">"#description"</span><span class="o">=&gt;</span><span class="s2">"Write here your message"</span> <span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-123"></a>      <span class="s1">'submit'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>  <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Submit'</span><span class="p">),</span>  <span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-124"></a>    <span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-125"></a>  <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-126"></a>  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-127"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-128"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-129"></a><span class="k">function</span> <span class="nf">feedback_message_form_validate</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-130"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-131"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">'values'</span><span class="p">][</span><span class="s1">'message'</span><span class="p">];</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-132"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">==</span> <span class="s1">''</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-133"></a>    <span class="nx">form_set_error</span><span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Message cannot be empty.'</span><span class="p">));</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-134"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-135"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-136"></a><span class="k">function</span> <span class="nf">feedback_message_form_submit</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-137"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-138"></a>  <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-139"></a>  <span class="nv">$userid</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-140"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$user</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-141"></a>    <span class="nv">$userid</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-142"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">'values'</span><span class="p">][</span><span class="s1">'message'</span><span class="p">];</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-143"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-144"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"INSERT into {feedback_messages} ( uid, message, indate ) values ( %d, '%s', now() ) "</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-145"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$userid</span><span class="p">,</span> <span class="nv">$message</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-146"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-147"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-148"></a>    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span> <span class="p">(</span> <span class="s2">"Thank you for your feedback."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-149"></a>  <span class="k">else</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-150"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">"An error has happened. Your feedback has not been sent."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-151"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-152"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-153"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-154"></a><span class="k">function</span> <span class="nf">feedback_admin</span> <span class="p">()</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-155"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-156"></a>  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-157"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-158"></a>  <span class="nv">$header</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-159"></a>  <span class="p">(</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-160"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Date'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'indate'</span><span class="p">,</span> <span class="s1">'sort'</span> <span class="o">=&gt;</span> <span class="s1">'desc'</span><span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-161"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'User'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'name'</span><span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-162"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Message'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'message'</span><span class="p">),</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-163"></a>  <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-164"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-165"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT u.name, fm.indate, fm.message FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid"</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-166"></a>  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-167"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-168"></a>  <span class="nv">$rows</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-169"></a>  <span class="k">while</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">)</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-170"></a>  <span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-171"></a>    <span class="nv">$row</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-172"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-173"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'indate'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-174"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-175"></a>    <span class="nv">$rows</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-176"></a>  <span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-177"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-178"></a>  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">theme_table</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$rows</span><span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-179"></a>  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-180"></a><span class="p">}</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-181"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-182"></a><span class="sd">/** Devuelve el número de feeds creados en la última semana</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-183"></a><span class="sd">*/</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-184"></a><span class="k">function</span> <span class="nf">_feedback_count</span> <span class="p">()</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-185"></a><span class="p">{</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-186"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT count(id) as total from {feedback_messages} where datediff( now(), indate ) &lt; 7"</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-187"></a>  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-188"></a>  <span class="nv">$result</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-189"></a>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-190"></a>  <span class="k">return</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">total</span><span class="p">;</span>
<a name="rest_code_d6b577bf7c16485cbb35fc24cc7cf69e-191"></a><span class="p">}</span>
</pre>
</div>
</div>
</div>
          </div>
          <br><div>
            <nav><span class="author">
                <span class="glyphicon glyphicon-user"></span> 
                <span>Publicado:Miguel Ángel García</span>
              </span>
               

              
              <span class="dateline">
                <span class="glyphicon glyphicon-calendar"></span> 
                <time class="published dt-published" datetime="2010-05-11T00:00:00+00:00" title="2010-05-11">2010-05-11</time></span>
               
              <span class="tags">
                <span class="glyphicon glyphicon-tags"></span> 
                <a class="label label-primary p-category" href="/categories/drupal/" rel="tag">drupal</a>
              </span>
                      <ul class="pager">
<li class="previous">
              <a href="/blog/creacion-modulo-drupal-4/" rel="prev" title="Creación de un módulo Drupal IV">
                <span class="glyphicon glyphicon-arrow-left"></span>
                Publicación anterior
              </a>
            </li>
            <li class="next">
              <a href="/blog/recuperar-grub/" rel="next" title="Recuperar Grub">
                Siguiente publicación
                <span class="glyphicon glyphicon-arrow-right"></span>
              </a>
            </li>
        </ul></nav>
</div>
          <section class="comments"><h2>Comentarios</h2>
                            <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="magmax",
            disqus_url="http://magmax.org/blog/creacion-modulo-drupal/",
        disqus_title="Creaci\u00f3n de un m\u00f3dulo Drupal",
        disqus_identifier="cache/posts/creacion-modulo-drupal.html",
        disqus_config = function () {
            this.language = "es_ES";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


          </section></article><script>var disqus_shortname="magmax";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
      <aside class="sidebar col-md-3"><div>
<section class="panel panel-default"><div class="panel-heading">
    <h3 class="panel-title">Last comments</h3>
  </div>
  <div class="panel-body">
    <div id="disqus_last_comments" class="dsq-widget">
      <script type="text/javascript" src="https://magmax.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=32&amp;excerpt_length=150">
      </script>
</div>
  </div>
</section>
</div>
          <div>
<section class="panel panel-default"><div class="panel-heading">
    <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="panel-body">
    <ul id="gh_repos" class="list-unstyled">
<li class="loading">Status updating…</li>
    </ul>
</div>
  <div class="panel-footer">
    <a href="https://github.com/magmax">@magmax</a> on GitHub
  </div>
</section>
</div>
      </aside>
</div>

    <footer>
      Contents © 2009-2020 <a href="mailto:">Miguel Ángel García</a> 
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.5/es/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;width:80px;height:15px;vertical-align:middle" src="https://i.creativecommons.org/l/by-nc-sa/2.5/es/80x15.png"></a>; Using <a href="/stories/credits/">a lot of free software</a>
      
    </footer>
</div>
</div>




<script data-main="/assets/js/main" src="/assets/js/libs/require/require.min.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-9308241-3', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
