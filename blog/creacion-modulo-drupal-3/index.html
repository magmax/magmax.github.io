<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Creación de un módulo Drupal III | El blog de MagMax</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Qué vamos a hacer En esta ocasión me voy a dedicar a arreglar los estropicios que hice anteriomente :D
Además, voy a añadir enlaces para eliminar los feeds (como me han solicitado) y también vamos a redirigir al usuario a la página principal después de añadir un feed (como también me han solicitado).
También añadiremos un mail al usuario que inserta el mensaje, por si no está registrado. En caso de que esté registrado, guardaremos una referencia al mismo.">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="Creación de un módulo Drupal III" />
<meta property="og:description" content="Qué vamos a hacer En esta ocasión me voy a dedicar a arreglar los estropicios que hice anteriomente :D
Además, voy a añadir enlaces para eliminar los feeds (como me han solicitado) y también vamos a redirigir al usuario a la página principal después de añadir un feed (como también me han solicitado).
También añadiremos un mail al usuario que inserta el mensaje, por si no está registrado. En caso de que esté registrado, guardaremos una referencia al mismo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/creacion-modulo-drupal-3/" />
<meta property="article:published_time" content="2010-05-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2010-05-11T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta itemprop="name" content="Creación de un módulo Drupal III">
<meta itemprop="description" content="Qué vamos a hacer En esta ocasión me voy a dedicar a arreglar los estropicios que hice anteriomente :D
Además, voy a añadir enlaces para eliminar los feeds (como me han solicitado) y también vamos a redirigir al usuario a la página principal después de añadir un feed (como también me han solicitado).
También añadiremos un mail al usuario que inserta el mensaje, por si no está registrado. En caso de que esté registrado, guardaremos una referencia al mismo.">
<meta itemprop="datePublished" content="2010-05-11T00:00:00+00:00" />
<meta itemprop="dateModified" content="2010-05-11T00:00:00+00:00" />
<meta itemprop="wordCount" content="3925">



<meta itemprop="keywords" content="drupal," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Creación de un módulo Drupal III"/>
<meta name="twitter:description" content="Qué vamos a hacer En esta ocasión me voy a dedicar a arreglar los estropicios que hice anteriomente :D
Además, voy a añadir enlaces para eliminar los feeds (como me han solicitado) y también vamos a redirigir al usuario a la página principal después de añadir un feed (como también me han solicitado).
También añadiremos un mail al usuario que inserta el mensaje, por si no está registrado. En caso de que esté registrado, guardaremos una referencia al mismo."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        El blog de MagMax
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Inicio page">
              Inicio
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="../en" title="English page">
              English
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://magmax.org/blog/creacion-modulo-drupal-3/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://magmax.org/blog/creacion-modulo-drupal-3/&amp;text=Creaci%c3%b3n%20de%20un%20m%c3%b3dulo%20Drupal%20III" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://magmax.org/blog/creacion-modulo-drupal-3/&amp;title=Creaci%c3%b3n%20de%20un%20m%c3%b3dulo%20Drupal%20III" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Creación de un módulo Drupal III</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2010-05-11T00:00:00Z">May 11, 2010</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h2 id="qué-vamos-a-hacer">Qué vamos a hacer</h2>
<p>En esta ocasión me voy a dedicar a arreglar los estropicios que hice anteriomente :D</p>
<p>Además, voy a añadir enlaces para eliminar los feeds (como me han solicitado) y también vamos a redirigir al usuario a la página principal después de añadir un feed (como también me han solicitado).</p>
<p>También añadiremos un mail al usuario que inserta el mensaje, por si no está registrado. En caso de que esté registrado, guardaremos una referencia al mismo.</p>
<!-- raw HTML omitted -->
<figure>
    <img src="/images/drupal.png"
         alt="Drupal"/> 
</figure>

<h2 id="qué-se-explica-aquí">Qué se explica aquí</h2>
<p>En esta ocasión veremos cómo:</p>
<ul>
<li>Redirigir al usuario a la página que deseemos.</li>
<li>Ordenación de tablas.</li>
<li>Expresiones regulares.</li>
</ul>
<h2 id="notas-previas">Notas previas</h2>
<p>En la <a href="https://magmax.org/blog/creacion-modulo-drupal/">primera parte del tutorial drupal</a> ya insistí en que sólo se debe abrir el tag de <code>&lt;?php</code>, y no se debe cerrar con <code>?&gt;</code>. Dicho esto, continuamos.</p>
<h2 id="modificando-la-bbdd">Modificando la BBDD</h2>
<p>Añadimos el campo usermail. Además, modificamos el campo &ldquo;uid&rdquo; para que referencie al usuario si éste hizo login.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_update_6102</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  $ret <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  <span style="color:#a6e22e">db_add_field</span> ( $ret, <span style="color:#e6db74">&#39;feedback_messages&#39;</span>, <span style="color:#e6db74">&#39;usermail&#39;</span>, <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;text&#39;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  <span style="color:#a6e22e">db_change_field</span> ( $ret, <span style="color:#e6db74">&#39;feedback_messages&#39;</span>, <span style="color:#e6db74">&#39;uid&#39;</span>, <span style="color:#e6db74">&#39;uid&#39;</span>, <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;type&#39;</span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;int&#39;</span>, <span style="color:#e6db74">&#39;unsigned&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#66d9ef">TRUE</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  <span style="color:#66d9ef">return</span> $ret;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>}
</code></pre></div><h2 id="fe-de-erratas">Fe de erratas</h2>
<p>El primer error fue la contabilización de feeds. Si miráis el tutorial <code>Creación de un módulo Drupal (II)</code>_, veréis la siguiente línea (función <code>_feedback_count</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT count(id) as total from {feedback_messages} fm where fm.read != 1&#34;</span>;
</code></pre></div><p>Bueno, pues está <em>mal</em>. Lo correcto es lo siguiente:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;select count(*) from drupal6.feedback_messages fm where isnull (fm.read) or fm.read != 1&#34;</span>;
</code></pre></div><p>Como véis, comprobamos que no sea nulo, ya que en ese caso no estaba
contabilizando correctamente.</p>
<p>El segundo error cometido es que los <code>set_error</code> deben realizarse sobre un
campo. Así, en el primer tutorial, donde aparecen los <code>set_error</code>, están mal.
Realmente no veremos la diferencia si no la conocemos: Si lo hacemos bien, los
campos indicados se marcarán en rojo (depende del tema) indicando que el
problema se encuentra en ése campo. De esta manera, quedarían así (función
<code>feedback_message_form_submit</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;feedback&#39;</span>, <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#34;An error has happened. Your feedback has not been sent.&#34;</span> ) );
</code></pre></div><p>Veremos la función completa cuando añadamos más cosas.</p>
<p>Y ya, como error menor, deciros que las etiquetas &lsquo;Date&rsquo; y &lsquo;User&rsquo; estaban cambiadas en la función <code>feedback_admin</code>.</p>
<p>Al final de este tutorial, pondré todo seguido para que podáis aclararos.</p>
<h2 id="modificando-funciones">Modificando funciones</h2>
<p>Primero vamos con lo más sencillo de todo: Queremos que cuando alguien meta un feed, que vuelva a la pantalla de inicio. Asumiré que la página de inicio es <code>?q=node</code>, por lo que basta con indicarle:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#a6e22e">drupal_goto</span> ( <span style="color:#e6db74">&#39;node&#39;</span> );
</code></pre></div><p>A continuación, no sé si notásteis que la tabla con todos los mensajes no se ordena al pulsar las columnas. Esto nos puede venir bien para poder agrupar los mensajes no leídos, para ordenar por fecha, para agrupar los mensajes sin contenido, etc. ¡¡ Y es tan sencillo !! Basta con realizar un cambio durante la consulta, así que en <code>feedback_admin</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.id, u.name, fm.indate, fm.message FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>$query <span style="color:#f92672">.=</span> <span style="color:#a6e22e">tablesort_sql</span> ( $header );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>$queryResult <span style="color:#f92672">=</span>  <span style="color:#a6e22e">db_query</span> ( $query );
</code></pre></div><p>Con eso le decimos a drupal que nos ordene la tabla. Ésa es una de las gracias de usar los headers en una tabla a parte, y por eso los definimos antes de realizar la consulta.</p>
<h2 id="añadiendo-un-mail">Añadiendo un mail</h2>
<p>En las modificaciones de la base de datos, añadimos el campo <code>usermail</code>. Ahora vamos a usarlo. Necesitaremos que el usuario lo inserte, así que tenemos que modificar <code>feedback_message_form</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message_form</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  <span style="color:#66d9ef">global</span> $user;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $mail <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#66d9ef">if</span> ( $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    $mail <span style="color:#f92672">=</span> $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  $form <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#e6db74">&#39;feedback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>      <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;fieldset&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>      <span style="color:#e6db74">&#39;#title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#39;Feedback&#39;</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>      <span style="color:#e6db74">&#39;mail&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> (<span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textfield&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;E-Mail&#34;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $mail,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>                <span style="color:#e6db74">&#34;#description&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;If you want any answer, please, tell me your mail. It would not be shown anywhere.&#34;</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>      <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textarea&#39;</span>, <span style="color:#e6db74">&#34;#description&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;Write here your message&#34;</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>      <span style="color:#e6db74">&#39;submit&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;submit&#39;</span>,  <span style="color:#e6db74">&#39;#value&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Submit&#39;</span>),  ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>}
</code></pre></div><p>Como veréis, esta función tiene un añadido: si el usuario ha hecho <em>login</em>, rellenamos el campo con el mail que puso para su usuario. Así le ahorramos trabajo. El UID del usuario no es necesario que lo metamos en el formulario, ya que podemos recuperarlo directamente de la variable global.</p>
<p>Las validaciones también cambian, ya que no sólo vamos a comprobar que el mensaje no esté vacío, sino que queremos hacer más cosas. Queremos que, si el usuario hizo <em>login</em>, entonces el campo de e-mail no es obligatorio. Si no lo hizo, entonces sí que lo es. Y el e-mail tiene que parecer un e-mail, es decir, tener su arroba y demás:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message_form_validate</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  <span style="color:#66d9ef">global</span> $user;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  $message <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;message&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  $mail    <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;mail&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  $validmail <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_match</span> (<span style="color:#e6db74">&#34;/^[^0-9][A-z0-9_]+([.][A-z0-9_]+)*[@][A-z0-9_]+([.][A-z0-9_]+)*[.][A-z]{2,4}$/&#34;</span> , $mail );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#66d9ef">if</span> ( $mail <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;mail&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;You are not a registered user. Please, insert your e-mail.&#39;</span>) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  <span style="color:#66d9ef">if</span> ( $mail <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> $validmail )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;mail&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;The mail does not like an e-mail address.&#39;</span>) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  <span style="color:#66d9ef">if</span> ( $message <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message cannot be empty.&#39;</span>));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>}
</code></pre></div><p>Aquí hemos introducido la creación de una expresión regular. Explicada brevemente, estamos comprobando si encaja el mail con un patrón dado. La expresión regular es bastante compleja, así que sólo comentaré lo más básico de todo:</p>
<ul>
<li>Lo que va entre corchetes, significa &ldquo;uno de estos&rdquo;. Ej: *[A-z0-9_]* significa que queremos una letra mayúscula o minúscula, un número o un guión bajo.</li>
<li>Lo que va entre corchetes pero comienza por &ldquo;^&rdquo;, significa &ldquo;ninguno de estos&rdquo;. Ej. <em>[^0-9]</em> significa &ldquo;algo que no sea un número&rdquo;.</li>
<li>El asterisco significa &ldquo;lo anterior se puede repetir 0 o más veces&rdquo;. Ej: <em>[0-9]*</em> significa que puede no haber nada o bien un número indeterminado de números.</li>
<li>El símbolo de suma significa &ldquo;lo anterior se puede repetir 1 o más veces&rdquo;. Ej: <em>[0-9]+</em> significa que puede haber un número indeterminado de números, pero debe aparecer al menos uno.</li>
<li>Los paréntesis permiten agrupar cosas para aplicarle otros símbolos.</li>
<li>Las llaves implican la multiplicidad exacta. Ej: <em>[A-z]{2}</em> significa &ldquo;dos letras&rdquo;. <em>[A-z]{2,4}</em> significa &ldquo;entre 2 y 4 letras&rdquo;.</li>
</ul>
<p>Habitualmente, crear una expresión regular es mucho más sencillo de lo que parece, pero modificar una que ya existe suele ser bastante complicadete :-D</p>
<p>Bueno, y nos queda la inserción:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message_form_submit</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  <span style="color:#66d9ef">global</span> $user;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $userid <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#66d9ef">if</span> ( $user )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    $userid <span style="color:#f92672">=</span> $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  $message <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;message&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  $mail <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;mail&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;INSERT into {feedback_messages} ( uid, message, indate, usermail ) values ( %d, &#39;%s&#39;, now(), &#39;%s&#39; ) &#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $userid, $message, $mail );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">db_affected_rows</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#a6e22e">drupal_set_message</span> ( <span style="color:#a6e22e">t</span> ( <span style="color:#e6db74">&#34;Thank you for your feedback.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#a6e22e">drupal_goto</span> ( <span style="color:#e6db74">&#39;node&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>  <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;feedback&#39;</span>, <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#34;An error has happened. Your feedback has not been sent.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>}
</code></pre></div><p>Como ya sabemos redirigir, si todo va bien, nos iremos a la página principal :-D</p>
<p>Ya que tenemos el mail, lo suyo es que lo veamos desde la tabla principal de feeds:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_admin</span> ( $messageid<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#66d9ef">if</span> ( $messageid <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_messageadmin_form&#39;</span>, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  $header <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Date&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;indate&#39;</span>, <span style="color:#e6db74">&#39;sort&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;desc&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;User&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;name&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;email&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;mail&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;message&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Read&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;fm.read&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.id, u.uid as uid, u.name, fm.usermail, fm.indate, fm.message, fm.read FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>  $query <span style="color:#f92672">.=</span> <span style="color:#a6e22e">tablesort_sql</span> ( $header );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  $queryResult <span style="color:#f92672">=</span>  <span style="color:#a6e22e">db_query</span> ( $query );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  $rows <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  <span style="color:#66d9ef">while</span> ( $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult ) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    $row <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    $row[<span style="color:#e6db74">&#39;indate&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    $row[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">:</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    $row[<span style="color:#e6db74">&#39;mail&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">usermail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    $row[<span style="color:#e6db74">&#39;message&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    $row[<span style="color:#e6db74">&#39;read&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    $row[<span style="color:#e6db74">&#39;edit&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;edit&#39;</span>), <span style="color:#e6db74">&#34;feedback/adminmessages/&#34;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">id</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>    $rows[] <span style="color:#f92672">=</span> $row;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">theme_table</span>($header, $rows);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>}
</code></pre></div><p>¡¡¡ Mucho ojo, porque a esta función aún tenemos que añadirle una línea para el borrado !!!</p>
<p>Además he añadido una cosa nueva. Si pulsáis sobre el nombre de uno de los usuarios, os redirigirá a la página personal del mismo.</p>
<h3 id="borrando">Borrando</h3>
<p>Ahora vamos a añadir una nueva operación: el borrado.</p>
<p>La forma de realizarlo va a ser similar a como está hecha la edición, con la diferencia de que vamos a cambiar el botón por uno de &ldquo;eliminar&rdquo;. Así que resulta fácil realizar este paso, aunque tendrá sus inconvenientes :-D</p>
<p>Comenzamos como siempre: permisos, menú, función principal y formularios.</p>
<p>No necesitamos más permisos de los que ya tenemos, así que en la función de menú (<code>feedback_menu</code>), añadimos lo siguiente:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$items[<span style="color:#e6db74">&#39;feedback/delete/%&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Feedback delete&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_delete&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;view messages&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>    <span style="color:#e6db74">&#39;page arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#ae81ff">2</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>  );
</code></pre></div><p>Ahora creamos la función principal:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_delete</span> ( $messageid<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_delete_form&#39;</span>, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>}
</code></pre></div><p>Muy similar a <code>feedback_message</code>. Y también creamos el formulario:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_delete_form</span> ( $form, $messageid )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.message, fm.read, fm.indate, u.name FROM {feedback_messages} fm, {users} u WHERE fm.id=%d and u.uid=fm.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  $form <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>      <span style="color:#e6db74">&#39;feedback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>      (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;fieldset&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#e6db74">&#39;#title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#39;Feedback from &#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">.</span><span style="color:#e6db74">&#39; sended on &#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#e6db74">&#39;messageid&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;hidden&#39;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $messageid ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textarea&#39;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>, <span style="color:#e6db74">&#34;#disabled&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#e6db74">&#39;read&#39;</span>  <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;checkbox&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Read&#34;</span>,<span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>, <span style="color:#e6db74">&#34;#disabled&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        <span style="color:#e6db74">&#39;submit&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;submit&#39;</span>,  <span style="color:#e6db74">&#39;#value&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Delete forever&#39;</span>),  ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>      ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_delete_form_submit</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  $messageid <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;messageid&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DELETE FROM {feedback_messages} where id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">db_affected_rows</span>()){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    <span style="color:#a6e22e">drupal_set_message</span> ( <span style="color:#a6e22e">t</span> ( <span style="color:#e6db74">&#34;Message deleted&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  <span style="color:#a6e22e">drupal_goto</span> (<span style="color:#e6db74">&#39;/feedback/adminmessages&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>}
</code></pre></div><p>Como véis, me he saltado la validación, ya que no hay nada que validar. El formulario es muy parecido al de <code>feedback_messageadmin_form</code>, pero con la diferencia de que el campo &ldquo;read&rdquo; también es de sólo lectura.</p>
<p>Lo que nos queda es poder llegar a este formulario. Para llegar, dijimos que usaríamos un sistema similar al del botón &ldquo;edit&rdquo;, así que eso mismo vamos a hacer: En la función <code>feedback_admin</code>, el final quedará así:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_admin</span>( $messageid<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span> ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    [<span style="color:#f92672">...</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    $row[<span style="color:#e6db74">&#39;edit&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;edit&#39;</span>), <span style="color:#e6db74">&#34;feedback/adminmessages/&#34;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">id</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    $row[<span style="color:#e6db74">&#39;delete&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;delete&#39;</span>), <span style="color:#e6db74">&#34;feedback/delete/&#34;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">id</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    $rows[] <span style="color:#f92672">=</span> $row;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">theme_table</span>($header, $rows);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>}
</code></pre></div><h2 id="dos-palabras">Dos palabras</h2>
<p>Últimamente estoy recibiendo muchas consultas sobre cómo hacer tal o cual cosa en drupal. La verdad es que no esperaba tener &ldquo;tanto&rdquo; éxito con los tutoriales&hellip; casi ni explico nada, sólo he desglosado un ejercicio en partes tan pequeñas que no dé miedo atacarlas.</p>
<p>Así que tan sólo puedo deciros una cosa: ¡¡ Muchas gracias !! ;)</p>
<h2 id="más-tutoriales">Más tutoriales</h2>
<p>Este tutorial es la continuación de una serie de tutoriales relacionados con Drupal. Podéis consultar cualquiera de ellos:</p>
<ul>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal/">Creación de un módulo drupal (I)</a></li>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-2/">Creación de un módulo drupal (II)</a></li>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-4/">Creación de un módulo drupal (IV)</a></li>
<li><a href="https://magmax.org/blog/drupal-expansors/">Drupal: Creando contenido con &lsquo;expansors&rsquo;</a></li>
<li><a href="https://magmax.org/blog/critica-drupal/">Crítica a Drupal</a></li>
<li><a href="https://magmax.org/blog/drupal-tabla-perfecta/">Tablas en Drupal: Haciendo la tabla perfecta</a></li>
</ul>
<h2 id="código">Código</h2>
<p>Aquí tenéis todo el código necesario:</p>
<h3 id="feedbackinfo">feedback.info</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>; $Id<span style="color:#960050;background-color:#1e0010">$</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;MagMax Feedback&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#a6e22e">description</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Proporciona un sistema de feedbacks fácil para drupal&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#a6e22e">core</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">6.</span><span style="color:#a6e22e">x</span>
</code></pre></div><h3 id="feedbackinstall">feedback.install</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#75715e">Copyright 2009 Miguel Ángel García Martínez
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">  &#39;Feedback&#39; is free software; you can redistribute it and/or modify
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e">it under the terms of the GNU General Public License as published by
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#75715e">the Free Software Foundation; either version 3 of the License, or
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#75715e">(at your option) any later version.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#75715e">  &#39;Feedback&#39; is distributed in the hope that it will be useful,
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#75715e">but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#75715e">GNU General Public License for more details.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#75715e">  You should have received a copy of the GNU General Public License
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#75715e">along with &#39;Feedback&#39; (maybe in file &#34;COPYING&#34;); if not, write to the Free Software
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#75715e">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#75715e">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_schema</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  $schema[<span style="color:#e6db74">&#39;feedback_messages&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#e6db74">&#39;description&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Tabla para mensajes de retroalimentacion&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    <span style="color:#e6db74">&#39;fields&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>      <span style="color:#e6db74">&#39;id&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>      (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>        <span style="color:#e6db74">&#39;description&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Identificador de mensaje&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>        <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;serial&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        <span style="color:#e6db74">&#39;unsigned&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>        <span style="color:#e6db74">&#39;not null&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>      ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>      <span style="color:#e6db74">&#39;uid&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>      (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>        <span style="color:#e6db74">&#39;description&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Identificador del usuario que realiza el feedback&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>        <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;int&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>        <span style="color:#e6db74">&#39;unsigned&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>        <span style="color:#e6db74">&#39;not null&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">FALSE</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>      ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>      <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>      (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>        <span style="color:#e6db74">&#39;description&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Mensaje de feedback&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>        <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;text&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>        <span style="color:#e6db74">&#39;not null&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>      ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>      <span style="color:#e6db74">&#39;indate&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>      (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>        <span style="color:#e6db74">&#39;description&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Fecha en la que se crea el comentario&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>        <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;datetime&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>        <span style="color:#e6db74">&#39;not null&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>      ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>    ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>    <span style="color:#e6db74">&#39;primary key&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;id&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>  <span style="color:#66d9ef">return</span> $schema;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_update_6100</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>  $ret <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>  <span style="color:#a6e22e">db_add_field</span>($ret, <span style="color:#e6db74">&#39;feedback_messages&#39;</span>, <span style="color:#e6db74">&#39;read&#39;</span>, <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;int&#39;</span>, <span style="color:#e6db74">&#39;size&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;tiny&#39;</span>));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>  <span style="color:#66d9ef">return</span> $ret;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_update_6103</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>  $ret <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>  <span style="color:#a6e22e">db_add_field</span> ( $ret, <span style="color:#e6db74">&#39;feedback_messages&#39;</span>, <span style="color:#e6db74">&#39;usermail&#39;</span>, <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;text&#39;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>  <span style="color:#a6e22e">db_change_field</span> ( $ret, <span style="color:#e6db74">&#39;feedback_messages&#39;</span>, <span style="color:#e6db74">&#39;uid&#39;</span>, <span style="color:#e6db74">&#39;uid&#39;</span>, <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;type&#39;</span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;int&#39;</span>, <span style="color:#e6db74">&#39;unsigned&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#66d9ef">TRUE</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>  <span style="color:#66d9ef">return</span> $ret;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_install</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>  <span style="color:#75715e">// Create my tables.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">drupal_install_schema</span>(<span style="color:#e6db74">&#39;feedback&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_uninstall</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span>  <span style="color:#75715e">// Drop my tables.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">drupal_uninstall_schema</span>(<span style="color:#e6db74">&#39;feedback&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81</span>}
</code></pre></div><h3 id="feedbackmodule">feedback.module</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span><span style="color:#75715e">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span><span style="color:#75715e">Copyright 2009 Miguel Ángel García Martínez
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span><span style="color:#75715e">  &#39;Feedback&#39; is free software; you can redistribute it and/or modify
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span><span style="color:#75715e">it under the terms of the GNU General Public License as published by
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span><span style="color:#75715e">the Free Software Foundation; either version 3 of the License, or
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span><span style="color:#75715e">(at your option) any later version.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span><span style="color:#75715e">  &#39;Feedback&#39; is distributed in the hope that it will be useful,
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span><span style="color:#75715e">but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span><span style="color:#75715e">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span><span style="color:#75715e">GNU General Public License for more details.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span><span style="color:#75715e">  You should have received a copy of the GNU General Public License
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span><span style="color:#75715e">along with &#39;Feedback&#39; (maybe in file &#34;COPYING&#34;); if not, write to the Free Software
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span><span style="color:#75715e">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span><span style="color:#75715e">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span><span style="color:#e6db74">* Implements hook_help().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_help</span> ( $path, $arg )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>  $output<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>; <span style="color:#75715e">// para construir la salida
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">switch</span> ( <span style="color:#a6e22e">path</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;admin/help#feedback&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>      $output <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Módulo que permite la inserción de mensajes de feedback.&#39;</span>) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span>      <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span>  <span style="color:#66d9ef">return</span> $output;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span><span style="color:#e6db74">* Implements hook_perm().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_perm</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">array</span> (<span style="color:#e6db74">&#39;send message&#39;</span>, <span style="color:#e6db74">&#39;view messages&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span><span style="color:#e6db74">* Implementation of hook_block().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_block</span> ( $op <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;list&#39;</span>, $delta <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, $edit <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span>  <span style="color:#66d9ef">if</span> ( $op <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;list&#34;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span>      $blocks <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span>      $blocks[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;info&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>      $blocks[<span style="color:#ae81ff">1</span>][<span style="color:#e6db74">&#34;info&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;New Feedbacks&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span>      <span style="color:#66d9ef">return</span> $blocks;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( $op <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;view&#34;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>      $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>      $block <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>      <span style="color:#66d9ef">switch</span> ( $delta )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>      {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span>          $block[<span style="color:#e6db74">&#39;subject&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>          $options <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>( <span style="color:#e6db74">&#34;attributes&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;Sends a feedback message&#34;</span>) ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span>          $link <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span>( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;New Feedback&#34;</span>), <span style="color:#e6db74">&#34;feedback/message&#34;</span>, $options );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>          $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">.</span> $link <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span>          <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span>          $block[<span style="color:#e6db74">&#39;subject&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback Messages&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span>          $options <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>( <span style="color:#e6db74">&#34;attributes&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;Shows feedback messages&#34;</span>) ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span>          $title <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;There are @total new feeds&#34;</span>, <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;@total&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">_feedback_count</span>() ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span>          $link <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span>( $title , <span style="color:#e6db74">&#34;feedback/adminmessages&#34;</span>, $options );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span>          $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">.</span> $link <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>          <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>      $block[<span style="color:#e6db74">&#39;content&#39;</span>] <span style="color:#f92672">=</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>      <span style="color:#66d9ef">return</span> $block;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span><span style="color:#e6db74">* Implementation of hook_menu().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_menu</span> ( )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span>  $items <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span>  $items[<span style="color:#e6db74">&#39;feedback/message&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Feedback&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_message&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;send message&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span>  $items[<span style="color:#e6db74">&#39;feedback/adminmessages/%&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Feedback admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>    <span style="color:#e6db74">&#39;page arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#ae81ff">2</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;view messages&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>  $items[<span style="color:#e6db74">&#39;feedback/adminmessages&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Feedback admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;view messages&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span>  $items[<span style="color:#e6db74">&#39;feedback/delete/%&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Feedback delete&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_delete&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span>    <span style="color:#e6db74">&#39;page arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#ae81ff">2</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;view messages&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121</span>  <span style="color:#66d9ef">return</span> $items;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_message_form&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message_form</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135</span>  <span style="color:#66d9ef">global</span> $user;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136</span>  $mail <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138</span>  <span style="color:#66d9ef">if</span> ( $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139</span>    $mail <span style="color:#f92672">=</span> $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141</span>  $form <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143</span>    <span style="color:#e6db74">&#39;feedback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145</span>      <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;fieldset&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146</span>      <span style="color:#e6db74">&#39;#title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#39;Feedback&#39;</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147</span>      <span style="color:#e6db74">&#39;mail&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> (<span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textfield&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;E-Mail&#34;</span>, <span style="color:#e6db74">&#34;#description&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;If you want any answer, please, tell me your mail. It would not be shown anywhere.&#34;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $mail ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148</span>      <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textarea&#39;</span>, <span style="color:#e6db74">&#34;#description&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;Write here your message&#34;</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149</span>      <span style="color:#e6db74">&#39;submit&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;submit&#39;</span>,  <span style="color:#e6db74">&#39;#value&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Submit&#39;</span>),  ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150</span>    ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153</span>  <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message_form_validate</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158</span>  <span style="color:#66d9ef">global</span> $user;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160</span>  $message <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;message&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161</span>  $mail    <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;mail&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162</span>  $validmail <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_match</span> (<span style="color:#e6db74">&#34;/^[^0-9][A-z0-9_]+([.][A-z0-9_]+)*[@][A-z0-9_]+([.][A-z0-9_]+)*[.][A-z]{2,4}$/&#34;</span> , $mail );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164</span>  <span style="color:#66d9ef">if</span> ( $mail <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;mail&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;You are not a registered user. Please, insert your e-mail.&#39;</span>) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166</span>  <span style="color:#66d9ef">if</span> ( $mail <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> $validmail )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;mail&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;The mail does not like an e-mail address.&#39;</span>) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168</span>  <span style="color:#66d9ef">if</span> ( $message <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message cannot be empty.&#39;</span>));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171</span>  <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message_form_submit</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176</span>  <span style="color:#66d9ef">global</span> $user;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177</span>  $userid <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178</span>  <span style="color:#66d9ef">if</span> ( $user )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179</span>    $userid <span style="color:#f92672">=</span> $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180</span>  $message <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;message&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181</span>  $mail <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;mail&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;INSERT into {feedback_messages} ( uid, message, indate, usermail ) values ( %d, &#39;%s&#39;, now(), &#39;%s&#39; ) &#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $userid, $message, $mail );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186</span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">db_affected_rows</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188</span>    <span style="color:#a6e22e">drupal_set_message</span> ( <span style="color:#a6e22e">t</span> ( <span style="color:#e6db74">&#34;Thank you for your feedback.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189</span>    <span style="color:#a6e22e">drupal_goto</span> ( <span style="color:#e6db74">&#39;node&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191</span>  <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;feedback&#39;</span>, <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#34;An error has happened. Your feedback has not been sent.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_admin</span> ( $messageid<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200</span>  <span style="color:#66d9ef">if</span> ( $messageid <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202</span>    $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_messageadmin_form&#39;</span>, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203</span>    $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206</span>  $header <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Date&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;indate&#39;</span>, <span style="color:#e6db74">&#39;sort&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;desc&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;User&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;name&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;email&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;mail&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;message&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Read&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;fm.read&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.id, u.uid as uid, u.name, fm.usermail, fm.indate, fm.message, fm.read FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216</span>  $query <span style="color:#f92672">.=</span> <span style="color:#a6e22e">tablesort_sql</span> ( $header );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217</span>  $queryResult <span style="color:#f92672">=</span>  <span style="color:#a6e22e">db_query</span> ( $query );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219</span>  $rows <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220</span>  <span style="color:#66d9ef">while</span> ( $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult ) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222</span>    $row <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223</span>    $row[<span style="color:#e6db74">&#39;indate&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224</span>    $row[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">:</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225</span>    $row[<span style="color:#e6db74">&#39;mail&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">usermail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226</span>    $row[<span style="color:#e6db74">&#39;message&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227</span>    $row[<span style="color:#e6db74">&#39;read&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228</span>    $row[<span style="color:#e6db74">&#39;edit&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;edit&#39;</span>), <span style="color:#e6db74">&#34;feedback/adminmessages/&#34;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">id</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229</span>    $row[<span style="color:#e6db74">&#39;delete&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;delete&#39;</span>), <span style="color:#e6db74">&#34;feedback/delete/&#34;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">id</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230</span>    $rows[] <span style="color:#f92672">=</span> $row;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">theme_table</span>($header, $rows);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237</span><span style="color:#e6db74">/** Devuelve el número de feeds creados en la última semana
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">238</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">239</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_feedback_count</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">240</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">241</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT count(id) as total from {feedback_messages} fm where fm.read != 1 or isnull(fm.read)&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">242</span>  $queryResult <span style="color:#f92672">=</span>  <span style="color:#a6e22e">db_query</span> ( $query );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">243</span>  $result <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult ) ;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">244</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">245</span>  <span style="color:#66d9ef">return</span> $result<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">total</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">246</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">247</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">248</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_messageadmin_form</span> ( $form, $messageid )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">249</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">250</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.message, fm.read, fm.indate, u.name FROM {feedback_messages} fm, {users} u WHERE fm.id=%d and u.uid=fm.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">251</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">252</span>  $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">253</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">254</span>  $form <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">255</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">256</span>      <span style="color:#e6db74">&#39;feedback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">257</span>      (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">258</span>        <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;fieldset&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">259</span>        <span style="color:#e6db74">&#39;#title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#39;Feedback from &#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">.</span><span style="color:#e6db74">&#39; sended on &#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">260</span>        <span style="color:#e6db74">&#39;messageid&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;hidden&#39;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $messageid ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">261</span>        <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textarea&#39;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>, <span style="color:#e6db74">&#34;#disabled&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">262</span>        <span style="color:#e6db74">&#39;read&#39;</span>  <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;checkbox&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Read&#34;</span>,<span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">263</span>        <span style="color:#e6db74">&#39;submit&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;submit&#39;</span>,  <span style="color:#e6db74">&#39;#value&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Submit&#39;</span>),  ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">264</span>      ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">265</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">266</span>    <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">267</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">268</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">269</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_messageadmin_form_submit</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">270</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">271</span>  $messageid <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;messageid&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">272</span>  $read      <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;read&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">273</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">274</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UPDATE {feedback_messages} fm set fm.read=%d where fm.id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">275</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $read, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">276</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">277</span>  <span style="color:#a6e22e">drupal_goto</span> (<span style="color:#e6db74">&#39;/feedback/adminmessages&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">278</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">279</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">280</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">281</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_delete</span> ( $messageid<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">282</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">283</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">284</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_delete_form&#39;</span>, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">285</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">286</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">287</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">288</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">289</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_delete_form</span> ( $form, $messageid )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">290</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">291</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.message, fm.read, fm.indate, u.name FROM {feedback_messages} fm, {users} u WHERE fm.id=%d and u.uid=fm.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">292</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">293</span>  $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">294</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">295</span>  $form <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">296</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">297</span>      <span style="color:#e6db74">&#39;feedback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">298</span>      (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">299</span>        <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;fieldset&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">300</span>        <span style="color:#e6db74">&#39;#title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#39;Feedback from &#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">.</span><span style="color:#e6db74">&#39; sended on &#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">301</span>        <span style="color:#e6db74">&#39;messageid&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;hidden&#39;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $messageid ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">302</span>        <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textarea&#39;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>, <span style="color:#e6db74">&#34;#disabled&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">303</span>        <span style="color:#e6db74">&#39;read&#39;</span>  <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;checkbox&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Read&#34;</span>,<span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>, <span style="color:#e6db74">&#34;#disabled&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">304</span>        <span style="color:#e6db74">&#39;submit&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;submit&#39;</span>,  <span style="color:#e6db74">&#39;#value&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Delete forever&#39;</span>),  ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">305</span>      ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">306</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">307</span>    <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">308</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">309</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">310</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_delete_form_submit</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">311</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">312</span>  $messageid <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;messageid&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">313</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">314</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DELETE FROM {feedback_messages} where id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">315</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">316</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">317</span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">db_affected_rows</span>()){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">318</span>    <span style="color:#a6e22e">drupal_set_message</span> ( <span style="color:#a6e22e">t</span> ( <span style="color:#e6db74">&#34;Message deleted&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">319</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">320</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">321</span>  <span style="color:#a6e22e">drupal_goto</span> (<span style="color:#e6db74">&#39;/feedback/adminmessages&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">322</span>}
</code></pre></div><ul class="pa0">
  
   <li class="list">
     <a href="/tags/drupal" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">drupal</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "magmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Relacionado</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal/">Creación de un módulo Drupal</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal-2/">Creación de un módulo Drupal II</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal-4/">Creación de un módulo Drupal IV</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/drupal-no-muestra-comentarios/">Drupal no me muestra los comentarios</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/drupal-tabla-perfecta/">Tablas en Drupal: Haciendo una tabla perfecta</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://magmax.org/" >
    &copy;  El blog de MagMax 2021 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
