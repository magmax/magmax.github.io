<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>MongoDB | El blog de MagMax</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="En este artículo voy a exponer un problema, como de costumbre, y a resolverlo de la manera más rápida posible. Una vez hecho esto, trataré de cambiarlo para que utilice MongoDB para la persistencia. Usaré YAGNI.
No soy un experto en MongoDB, sino que estoy comenzando mis primeros pinitos. Por eso voy a tratar de explicarlo como yo lo veo.
El problema es el siguiente: quiero un programa que me permita gestionar mi biblioteca.">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="MongoDB" />
<meta property="og:description" content="En este artículo voy a exponer un problema, como de costumbre, y a resolverlo de la manera más rápida posible. Una vez hecho esto, trataré de cambiarlo para que utilice MongoDB para la persistencia. Usaré YAGNI.
No soy un experto en MongoDB, sino que estoy comenzando mis primeros pinitos. Por eso voy a tratar de explicarlo como yo lo veo.
El problema es el siguiente: quiero un programa que me permita gestionar mi biblioteca." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/mongodb/" />
<meta property="article:published_time" content="2012-08-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2012-08-30T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta itemprop="name" content="MongoDB">
<meta itemprop="description" content="En este artículo voy a exponer un problema, como de costumbre, y a resolverlo de la manera más rápida posible. Una vez hecho esto, trataré de cambiarlo para que utilice MongoDB para la persistencia. Usaré YAGNI.
No soy un experto en MongoDB, sino que estoy comenzando mis primeros pinitos. Por eso voy a tratar de explicarlo como yo lo veo.
El problema es el siguiente: quiero un programa que me permita gestionar mi biblioteca.">
<meta itemprop="datePublished" content="2012-08-30T00:00:00+00:00" />
<meta itemprop="dateModified" content="2012-08-30T00:00:00+00:00" />
<meta itemprop="wordCount" content="2295">



<meta itemprop="keywords" content="nosql,mongodb," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MongoDB"/>
<meta name="twitter:description" content="En este artículo voy a exponer un problema, como de costumbre, y a resolverlo de la manera más rápida posible. Una vez hecho esto, trataré de cambiarlo para que utilice MongoDB para la persistencia. Usaré YAGNI.
No soy un experto en MongoDB, sino que estoy comenzando mis primeros pinitos. Por eso voy a tratar de explicarlo como yo lo veo.
El problema es el siguiente: quiero un programa que me permita gestionar mi biblioteca."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        El blog de MagMax
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Inicio page">
              Inicio
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="../en" title="English page">
              English
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://magmax.org/blog/mongodb/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://magmax.org/blog/mongodb/&amp;text=MongoDB" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://magmax.org/blog/mongodb/&amp;title=MongoDB" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">MongoDB</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2012-08-30T00:00:00Z">August 30, 2012</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>En este artículo voy a exponer un problema, como de costumbre, y a resolverlo de la manera más rápida posible. Una vez hecho esto, trataré de cambiarlo para que utilice MongoDB para la persistencia. Usaré YAGNI.</p>
<p>No soy un experto en MongoDB, sino que estoy comenzando mis primeros pinitos. Por eso voy a tratar de explicarlo como yo lo veo.</p>
<p>El problema es el siguiente: quiero un programa que me permita gestionar mi biblioteca. Algo sencillo: sólo libro y autor. Y quiero poder buscar un libro por el título.</p>
<p>La idea de este artículo partió del titulado &ldquo;<a href="https://www.carlosble.com/2012/08/diseno-emergente-tambien-para-la-base-de-datos/">Diseño emergente, también para la base de datos</a>&rdquo;, por <a href="https://twitter.com/carlosble">Carlos Blé</a>.</p>
<p>Usaré python y freshen.</p>
<!-- raw HTML omitted -->
<figure>
    <img src="/images/mongo.png"
         alt="Mongo DB"/> 
</figure>

<h2 id="primeros-pasos">Primeros pasos</h2>
<h3 id="comenzando-definir-lo-que-queremos">Comenzando: definir lo que queremos</h3>
<p>El primer paso es decidir qué es lo que quiero. Veamos&hellip; Lo que quiero es buscar un libro por el título. Eso es lo más importante. Pero no puedo buscar nada si no indico el título o el autor. Así que comenzaré por ahí:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gherkin" data-lang="gherkin"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#75715e"># file: ./tests/library.feature</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#a6e22e"></span><span style="color:#66d9ef">Feature:</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#a6e22e">  In order to store my library reference
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#a6e22e">  As a book lover
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#a6e22e">  I want to be sure my library works
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span style="color:#a6e22e">  </span><span style="color:#66d9ef">Scenario:</span><span style="color:#a6e22e"> Author or title is necessary to search a book
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span style="color:#a6e22e"></span><span style="color:#66d9ef">    When </span><span style="color:#a6e22e">I search a book without parameters
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">Then </span><span style="color:#a6e22e">output contains &#34;</span><span style="color:#e6db74">You should ask for a title or an author</span><span style="color:#a6e22e">&#34;
</span></code></pre></div><p>Ahora trato de ejecutarlo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$ nosetests --with-freshen tests/library.feature
</code></pre></div><h3 id="preparando-el-entorno-de-pruebas">Preparando el entorno de pruebas</h3>
<p>Evidentemente tengo un error. <a href="https://github.com/rlisagor/freshen">Freshen</a> me está diciendo que no encuentra la manera de ejecutar los pasos del escenario. Por eso tengo que escribir el archivo <em>steps.py</em>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># file ./tests/steps.py</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">import</span> os
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#f92672">import</span> subprocess
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">from</span> freshen <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#f92672">from</span> freshen.checks <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>DATABASE_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test_db&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">before</span>(sc):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(DATABASE_FILE):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        os<span style="color:#f92672">.</span>remove(DATABASE_FILE)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    scc<span style="color:#f92672">.</span>output <span style="color:#f92672">=</span> None
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    scc<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> None
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(args):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    cmd <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;./library.py&#39;</span>, <span style="color:#e6db74">&#39;-d&#39;</span>, DATABASE_FILE] <span style="color:#f92672">+</span> args
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    process <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>Popen(cmd, stdout<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE, stderr<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>STDOUT)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    output, _ <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>communicate()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    status <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>returncode
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#66d9ef">return</span> (output, status)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(args):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    scc<span style="color:#f92672">.</span>output, scc<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> process <span style="color:#f92672">=</span> run(args)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#a6e22e">@When</span>(<span style="color:#e6db74">&#39;^I search a book without parameters$&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exec_search_without_parameters</span>():
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    execute([<span style="color:#e6db74">&#39;--action=show&#39;</span>])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#a6e22e">@Then</span>(<span style="color:#e6db74">&#39;^output contains &#34;(.*)&#34;$&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_output_contains</span>(expected):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    assert_true(expected <span style="color:#f92672">in</span> scc<span style="color:#f92672">.</span>output, <span style="color:#e6db74">&#39;Text &#34;{}&#34;, was not found in &#34;{}&#34;&#39;</span><span style="color:#f92672">.</span>format(expected, scc<span style="color:#f92672">.</span>output))
</code></pre></div><p>Para leer este archivo es mejor comenzar por las claves básicas: el <em>When</em> y el
<em>Then</em>. Está claro que en el <em>When</em> lo que quiero es ejecutar mi aplicación; por
eso la función comienza por <code>exec_</code>. En el <em>Then</em> realizaré las
comprobaciones pertinentes, por lo que comienza por <code>check_</code>.</p>
<p>Llegados a este punto ya he tomado numerosas decisiones:</p>
<ul>
<li>he decidido que mi biblioteca se ejecuta desde línea de órdenes. Eso es así porque era lo más sencillo de probar.</li>
<li>he decidido que tenga un parámetro <code>action</code> que admita la variable <code>show</code> que mostrará la información del libro.</li>
<li>he decidido el nombre del programa principal, <code>library.py</code></li>
<li>he decidio que, de alguna manera, necesitaré un sitio donde guardar la información; claramente necesitaré limpiar ese sitio entre test y test.</li>
</ul>
<p>Todo esto&hellip; Y aún no he escrito una línea del programa.</p>
<h3 id="pasando-los-tests">Pasando los tests</h3>
<p>Vamos a por él:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e">#File: ./library.py</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">import</span> sys
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#f92672">import</span> argparse
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Library</span>(object):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#66d9ef">def</span> __init__(self, db):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        self<span style="color:#f92672">.</span>_db <span style="color:#f92672">=</span> db
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show</span>(self, title<span style="color:#f92672">=</span>None, author<span style="color:#f92672">=</span>None):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> title <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> author:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;You should ask for a title or an author&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_args</span>():
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;My library!&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--action&#39;</span>, type<span style="color:#f92672">=</span>str, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;action&#39;</span>, choices<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;add&#39;</span>, <span style="color:#e6db74">&#39;remove&#39;</span>, <span style="color:#e6db74">&#39;show&#39;</span>], required<span style="color:#f92672">=</span>True,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;indicates the action to be performed&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-a&#39;</span>, <span style="color:#e6db74">&#39;--author&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;author&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;store&#34;</span>, default<span style="color:#f92672">=</span>None,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;The author of the book&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-t&#39;</span>, <span style="color:#e6db74">&#39;--title&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;title&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;store&#34;</span>, default<span style="color:#f92672">=</span>None,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;The title of the book&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-d&#39;</span>, <span style="color:#e6db74">&#39;--database&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;database&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;store&#34;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;library.db&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Path to the database file&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    <span style="color:#66d9ef">return</span> args
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    args <span style="color:#f92672">=</span> parse_args()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    library <span style="color:#f92672">=</span> Library(args<span style="color:#f92672">.</span>database)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;show&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>        library<span style="color:#f92672">.</span>show(title<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>title, author<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>author)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>    main()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</code></pre></div><p>Como veréis, he hecho un poco de trampa. He decidido especificar la interfaz más probable que voy a necesitar. Así no me voy a tener que preocupar después por pelearme con el párser. Podría cambiar cualquier cosa, ya que no está comprometida mediante un test.</p>
<p>Pruebo a volver a ejecutarlo y ahora&hellip; pasa. Claro. No hay mucho que hacer de momento.</p>
<h2 id="avanzando">Avanzando</h2>
<h3 id="creando-más-tests-de-aceptación">Creando más tests de aceptación</h3>
<p>Con el fin de no alargar mucho el artículo, voy a escribir todo el programa del tirón, aunque en realidad lo he ido escribiendo escenario a escenario.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gherkin" data-lang="gherkin"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># file: ./tests/library.feature</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#a6e22e"></span><span style="color:#66d9ef">Feature:</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#a6e22e">  In order to store my library reference
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#a6e22e">  As a book lover
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#a6e22e">  I want to be sure my library works
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#a6e22e">  </span><span style="color:#66d9ef">Scenario:</span><span style="color:#a6e22e"> Author or title is necessary to search a book
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#a6e22e"></span><span style="color:#66d9ef">    When </span><span style="color:#a6e22e">I search a book without parameters
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">Then </span><span style="color:#a6e22e">output contains &#34;</span><span style="color:#e6db74">You should ask for a title or an author</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#a6e22e">  </span><span style="color:#66d9ef">Scenario:</span><span style="color:#a6e22e"> Searching an inexistent book
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#a6e22e"></span><span style="color:#66d9ef">    When </span><span style="color:#a6e22e">I search the book &#34;</span><span style="color:#e6db74">inexistent</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">Then </span><span style="color:#a6e22e">output contains &#34;</span><span style="color:#e6db74">Book not found</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">And </span><span style="color:#a6e22e">my library do not contains the title &#34;</span><span style="color:#e6db74">inexistent</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#a6e22e">  </span><span style="color:#66d9ef">Scenario:</span><span style="color:#a6e22e"> Adding a title
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#a6e22e"></span><span style="color:#66d9ef">    When </span><span style="color:#a6e22e">I add the book &#34;</span><span style="color:#e6db74">Fundation</span><span style="color:#a6e22e">&#34; written by &#34;</span><span style="color:#e6db74">Assimov, Isaac</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">Then </span><span style="color:#a6e22e">output contains &#34;</span><span style="color:#e6db74">Book added</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">And </span><span style="color:#a6e22e">my library contains the title &#34;</span><span style="color:#e6db74">Fundation</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#a6e22e">  </span><span style="color:#66d9ef">Scenario:</span><span style="color:#a6e22e"> Searching an existent a title
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#a6e22e"></span><span style="color:#66d9ef">    Given </span><span style="color:#a6e22e">the book &#34;</span><span style="color:#e6db74">I, Robot</span><span style="color:#a6e22e">&#34;, written by &#34;</span><span style="color:#e6db74">Assimov, Isaac</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">When </span><span style="color:#a6e22e">I search the book &#34;</span><span style="color:#e6db74">I, Robot</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">Then </span><span style="color:#a6e22e">output contains &#34;</span><span style="color:#e6db74">Assimov, Isaac</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span style="color:#a6e22e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#a6e22e">  </span><span style="color:#66d9ef">Scenario:</span><span style="color:#a6e22e"> Removing a title
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#a6e22e"></span><span style="color:#66d9ef">    Given </span><span style="color:#a6e22e">the book &#34;</span><span style="color:#e6db74">I, Robot</span><span style="color:#a6e22e">&#34;, written by &#34;</span><span style="color:#e6db74">Assimov, Isaac</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">When </span><span style="color:#a6e22e">I remove the book &#34;</span><span style="color:#e6db74">I, Robot</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">Then </span><span style="color:#a6e22e">output contains &#34;</span><span style="color:#e6db74">Book removed</span><span style="color:#a6e22e">&#34;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#a6e22e">    </span><span style="color:#66d9ef">And </span><span style="color:#a6e22e">my library do not contains the title &#34;</span><span style="color:#e6db74">I, Robot</span><span style="color:#a6e22e">&#34;
</span></code></pre></div><p>Lo que fallará estrepitosamente porque <em>freshen</em> no encuentra la mayoría de las frases. Vamos a solucionarlo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">#File: ./tests/steps.py</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">import</span> os
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#f92672">import</span> subprocess
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">from</span> freshen <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#f92672">from</span> freshen.checks <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#f92672">from</span> multiprocessing <span style="color:#f92672">import</span> Pool
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>DATABASE_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test.db&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">before</span>(sc):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(DATABASE_FILE):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        os<span style="color:#f92672">.</span>remove(DATABASE_FILE)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    scc<span style="color:#f92672">.</span>output <span style="color:#f92672">=</span> None
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    scc<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> None
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(args):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    cmd <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;./library.py&#39;</span>, <span style="color:#e6db74">&#39;-d&#39;</span>, DATABASE_FILE] <span style="color:#f92672">+</span> args
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    process <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>Popen(cmd, stdout<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>PIPE, stderr<span style="color:#f92672">=</span>subprocess<span style="color:#f92672">.</span>STDOUT)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    output, _ <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>communicate()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    status <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>returncode
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    <span style="color:#66d9ef">return</span> (output, status)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(args):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    scc<span style="color:#f92672">.</span>output, scc<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> process <span style="color:#f92672">=</span> run(args)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#a6e22e">@Given</span>(<span style="color:#e6db74">&#39;^the book &#34;(.*)&#34;, written by &#34;(.*)&#34;$&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize_library</span>(title, author):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    execute([<span style="color:#e6db74">&#39;--action=add&#39;</span>, <span style="color:#e6db74">&#39;-t&#39;</span>, title, <span style="color:#e6db74">&#39;-a&#39;</span>, author])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#a6e22e">@When</span>(<span style="color:#e6db74">&#39;^I search the book &#34;(.*)&#34;$&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exec_search_by_title</span>(title):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    execute([<span style="color:#e6db74">&#39;--action=show&#39;</span>, <span style="color:#e6db74">&#39;--title&#39;</span>, title])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span style="color:#a6e22e">@When</span>(<span style="color:#e6db74">&#39;^I search a book without parameters$&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exec_search_without_parameters</span>():
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>    execute([<span style="color:#e6db74">&#39;--action=show&#39;</span>])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#a6e22e">@When</span>(<span style="color:#e6db74">&#39;I add the book &#34;(.*)&#34; written by &#34;(.*)&#34;&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exec_add_book</span>(title, author):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>    execute([<span style="color:#e6db74">&#39;--action=add&#39;</span>, <span style="color:#e6db74">&#39;-t&#39;</span>, title, <span style="color:#e6db74">&#39;-a&#39;</span>, author])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span style="color:#a6e22e">@When</span>(<span style="color:#e6db74">&#39;I remove the book &#34;(.*)&#34;&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exec_remove_book</span>(title):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>    execute([<span style="color:#e6db74">&#39;--action=remove&#39;</span>, <span style="color:#e6db74">&#39;-t&#39;</span>, title])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span style="color:#a6e22e">@Then</span>(<span style="color:#e6db74">&#39;^output contains &#34;(.*)&#34;$&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_output_contains</span>(expected):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>    assert_true(expected <span style="color:#f92672">in</span> scc<span style="color:#f92672">.</span>output, <span style="color:#e6db74">&#39;Text &#34;{}&#34;, was not found in &#34;{}&#34;&#39;</span><span style="color:#f92672">.</span>format(expected, scc<span style="color:#f92672">.</span>output))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span style="color:#a6e22e">@Then</span>(<span style="color:#e6db74">&#39;^my library( do not|) contains the title &#34;(.*)&#34;$&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_contains_title</span>(condition, title):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>    _, rc <span style="color:#f92672">=</span> run([<span style="color:#e6db74">&#39;--action=show&#39;</span>, <span style="color:#e6db74">&#39;-t&#39;</span>, title])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> condition:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>        assert_equals(<span style="color:#ae81ff">0</span>, rc, <span style="color:#e6db74">&#39;The book &#34;{}&#34; is not in the collection&#39;</span><span style="color:#f92672">.</span>format(title))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>    <span style="color:#66d9ef">else</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>        assert_equals(<span style="color:#ae81ff">1</span>, rc, <span style="color:#e6db74">&#39;The book &#34;{}&#34; is in the collection but it shouldnot&#39;</span><span style="color:#f92672">.</span>format(title))
</code></pre></div><p>Lo que provocará que los tests se lancen&hellip; pero fallen.</p>
<h3 id="pasando-los-tests-1">Pasando los tests</h3>
<p>Primero el código y luego lo comento.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e">#File: ./library.py</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">import</span> sys
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#f92672">import</span> argparse
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#f92672">import</span> shelve
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Library</span>(object):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#66d9ef">def</span> __init__(self, db):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        self<span style="color:#f92672">.</span>_db <span style="color:#f92672">=</span> db
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show</span>(self, title<span style="color:#f92672">=</span>None, author<span style="color:#f92672">=</span>None):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> title <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> author:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;You should ask for a title or an author&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_db_file()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> db<span style="color:#f92672">.</span>has_key(title):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Book not found&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            db<span style="color:#f92672">.</span>close()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;{} -&gt; {}&#39;</span><span style="color:#f92672">.</span>format(title, db[title])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        db<span style="color:#f92672">.</span>close()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, title, author):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> title <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> author:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;You should introduce the title and author&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>            <span style="color:#66d9ef">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>        db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_db_file()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        db[title] <span style="color:#f92672">=</span> author
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>        db<span style="color:#f92672">.</span>close()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Book added&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove</span>(self, title):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> title:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;You should introduce the title to remove&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>            <span style="color:#66d9ef">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>        db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_db_file()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>        <span style="color:#66d9ef">if</span> db<span style="color:#f92672">.</span>has_key(title):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>            <span style="color:#66d9ef">del</span> db[title]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>        db<span style="color:#f92672">.</span>close()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Book removed&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_db_file</span>(self):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>        <span style="color:#66d9ef">return</span> shelve<span style="color:#f92672">.</span>open(self<span style="color:#f92672">.</span>_db)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_args</span>():
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;My library!&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--action&#39;</span>, type<span style="color:#f92672">=</span>str, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;action&#39;</span>, choices<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;add&#39;</span>, <span style="color:#e6db74">&#39;remove&#39;</span>, <span style="color:#e6db74">&#39;show&#39;</span>], required<span style="color:#f92672">=</span>True,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;indicates the action to be performed&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-a&#39;</span>, <span style="color:#e6db74">&#39;--author&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;author&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;store&#34;</span>, default<span style="color:#f92672">=</span>None,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;The author of the book&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-t&#39;</span>, <span style="color:#e6db74">&#39;--title&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;title&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;store&#34;</span>, default<span style="color:#f92672">=</span>None,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;The title of the book&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-d&#39;</span>, <span style="color:#e6db74">&#39;--database&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;database&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;store&#34;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;library.db&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Path to the database file&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>    <span style="color:#66d9ef">return</span> args
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>    args <span style="color:#f92672">=</span> parse_args()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>    library <span style="color:#f92672">=</span> Library(args<span style="color:#f92672">.</span>database)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;show&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>        library<span style="color:#f92672">.</span>show(title<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>title, author<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>author)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;add&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>        library<span style="color:#f92672">.</span>add(title<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>title, author<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>author)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remove&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>        library<span style="color:#f92672">.</span>remove(title<span style="color:#f92672">=</span>args<span style="color:#f92672">.</span>title)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>    main()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span>    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</code></pre></div><p>Como puede observarse, al utilizar <a href="https://docs.python.org/library/shelve.html">Shelve</a> estoy creando una tabla <em>Hash</em> que me permite enlazar el título con el autor. Mientras busque por título, todo irá bien&hellip; cuando intente buscar por autor, sufriré una penalización terrible, ya que tendré que recorrer todos los valores :D</p>
<p>Como primera aproximación me basta. Así que puedo decir que está terminado.</p>
<h2 id="conclusiones">Conclusiones</h2>
<p>Puedo asegurar que hasta el escenario &ldquo;<em>Searching an existent a title</em>&rdquo; no decidí qué tipo de persistencia iba a utilizar. Y decidí utilizar <strong>Shelve</strong> porque es muy sencilla y me pareció que se ajustaba a lo que yo necesitaba. Igualmente podría haber utilizado un fichero de texto plano o haber volcado una <em>hash</em> a disco con <em>pickle</em>. No importa. No es nada importante.</p>
<p>Como veis, me he ajustado al enunciado en todo lo que he podido. Por eso tardé en escribirlo media hora, más o menos. Eso era importante, porque quería algo rápido pero usable. Además, me permite añadir más &ldquo;columnas&rdquo;, aunque tendría que portar los datos viejos o tirarlos, directamente.</p>
<h2 id="pasándolo-a-mongodb">Pasándolo a MongoDB</h2>
<p>Vamos ahora a tratar de aprovechar todo lo aprovechable y a utilizar <a href="https://www.mongodb.org/">MongoDB</a> en su lugar. Para ello utilizaremos la librería <a href="https://api.mongodb.org/python/current/">pymongo</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e"># file: ./library.py</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">import</span> sys
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#f92672">import</span> argparse
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#f92672">import</span> pymongo
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Library</span>(object):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#66d9ef">def</span> __init__(self, db):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        self<span style="color:#f92672">.</span>_db <span style="color:#f92672">=</span> db
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        self<span style="color:#f92672">.</span>_conn <span style="color:#f92672">=</span> None
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show</span>(self, title<span style="color:#f92672">=</span>None, author<span style="color:#f92672">=</span>None):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> title <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> author:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;You should ask for a title or an author&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_books_collection()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        result <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>find_one({<span style="color:#e6db74">&#39;_id&#39;</span>: title})
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> result:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Book not found&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>            self<span style="color:#f92672">.</span>_disconnect()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        <span style="color:#66d9ef">print</span> result
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        self<span style="color:#f92672">.</span>_disconnect()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, title, author):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> title <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> author:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;You should introduce the title and author&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>            <span style="color:#66d9ef">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>        db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_books_collection()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>        db<span style="color:#f92672">.</span>save({<span style="color:#e6db74">&#39;_id&#39;</span>:title, <span style="color:#e6db74">&#39;author&#39;</span>:author})
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>        self<span style="color:#f92672">.</span>_disconnect()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Book added&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove</span>(self, title):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> title:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;You should introduce the title to remove&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>            <span style="color:#66d9ef">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>        db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_books_collection()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>        db<span style="color:#f92672">.</span>remove({<span style="color:#e6db74">&#39;_id&#39;</span>: title})
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>        self<span style="color:#f92672">.</span>_disconnect()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#39;Book removed&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_db_file</span>(self):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>        <span style="color:#66d9ef">return</span> shelve<span style="color:#f92672">.</span>open(self<span style="color:#f92672">.</span>_db)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_books_collection</span>(self):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>        self<span style="color:#f92672">.</span>_conn <span style="color:#f92672">=</span> pymongo<span style="color:#f92672">.</span>Connection(<span style="color:#e6db74">&#39;localhost&#39;</span>, <span style="color:#ae81ff">27017</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>        db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_conn[self<span style="color:#f92672">.</span>_db]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>        <span style="color:#66d9ef">return</span> db[<span style="color:#e6db74">&#39;books&#39;</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_disconnect</span>(self):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_conn:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>            self<span style="color:#f92672">.</span>_conn<span style="color:#f92672">.</span>close()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>            self<span style="color:#f92672">.</span>_conn <span style="color:#f92672">=</span> None
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span><span style="color:#75715e"># ...</span>
</code></pre></div><p>El resto de ficheros será igual, de la misma forma que no he necesitado tocar el pársing de los parámetros de entrada. Y los tests pasan.</p>
<h2 id="mongodb">MongoDB</h2>
<p>¿Cómo funciona MongoDB? Pues exactamente igual que la librería <em>Shelve</em>: como una tabla <em>hash</em>.</p>
<p>En este caso he utilizado el título del libro como índice, lo que es poco recomendable. Lo he hecho así para que sea lo más parecida posible a la primera implementación y, así, pueda explicarlo más fácilmente.</p>
<p>Hay algunas diferencias&hellip; Para comenzar, en la versión <em>Shelve</em> no se sabe lo que es el contenido. MongoDB sí sabe que es el autor. Eso nos permitirá poder añadir nuevas características sobre la marcha, sin tener que migrar nada. Añadir nuevas columnas es gratis, ya que funcionan como otra hash. Para que la versión <em>Shelve</em> funcione igual, sólo tenéis que guardar el autor como una hash de la forma &ldquo;<em>{&lsquo;author&rsquo;: author}</em>&rdquo;.</p>
<p>Veamos un poco de la organización interna.</p>
<h3 id="conexiones-bases-de-datos-y-colecciones">Conexiones, bases de datos y colecciones</h3>
<p>Resulta fácil entender MongoDB como una <strong>hash de hashes</strong>:</p>
<ul>
<li>Una <strong>conexión</strong> a MongoDB tiene los nombres de las bases de datos como claves.</li>
<li>La <strong>base de datos</strong>, tiene los nombres de las colecciones como claves.</li>
<li>Una <strong>colección</strong> es el equivalente en una base de datos relacional a una tabla (más o menos). Y tendrá como claves los nombres de las columnas, aunque tiene otra serie de métodos que nos permitirán realizar búsquedas.</li>
</ul>
<h3 id="el-lenguaje-javascript">El lenguaje: JavaScript</h3>
<p>Una vez que hemos obtenido una instancia de la colección que queremos tratar, podemos realizar consultas. El lenguaje interno de mongodb es JavaScript.</p>
<p>A nivel básico no es necesario conocer este lenguaje para realizar consultas, ya que éstas serán solo <em>hashes</em> o listas. Con un par de ejemplos será suficiente. Sin embargo, a nivel avanzado la cosa cambia, ya que entraremos en el maravilloso mundo del <strong>mapreduce</strong> que&hellip; bueno, no termino de entender :D</p>
<p>Por lo poco que lo he tratado, el <em>mapreduce</em> consiste en dos partes:</p>
<ul>
<li>La primera parte, el <strong>map</strong>, consiste en seleccionar, de cada fila, los campos que nos hacen falta.</li>
<li>La segunda parte, el <strong>reduce</strong>, permite agrupar los datos obtenidos en la primera fase.</li>
</ul>
<p>Estas dos etapas se realizan de forma paralela, dando unos rendimientos muy elevados.</p>
<p>El <em>mapreduce</em> suele utilizarse para obtener estadísticas de la base de datos, tales como contar elementos que cumplen ciertos criterios.</p>
<p>Pero insisto en que estoy comenzando y, seguramente, diga alguna burrada XD</p>
<h2 id="conclusión">Conclusión</h2>
<p>Probablemente existan muchos escenarios en los que una base de datos <a href="https://es.wikipedia.org/wiki/NoSQL">No-SQL</a> no sea la solución, pero creo que existen muchos más escenarios donde son la solución, pero los desarrolladores se empeñan en encajarla en una base de datos relacional. A menudo, con resultados desastrosos.</p>
<p>Por extraño que parezca, No-SQL es muy intuitivo. No resulta muy diferente de lo que haríamos sin bases de datos convencionales. Sin embargo, utilizar un motor nos ofrece ciertas ventajas que no debemos despreciar.</p>
<p>Sinceramente, creo que hay todo un mundo a descubrir en este sentido.</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/nosql" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">nosql</a>
   </li>
  
   <li class="list">
     <a href="/tags/mongodb" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">mongodb</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "magmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://magmax.org/" >
    &copy;  El blog de MagMax 2021 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
