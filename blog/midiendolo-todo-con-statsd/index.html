<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Midiéndolo todo con StatsD - El blog de MagMax</title><meta name="Description" content="Introducción al uso de StatsD"><meta property="og:title" content="Midiéndolo todo con StatsD" />
<meta property="og:description" content="Introducción al uso de StatsD" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/midiendolo-todo-con-statsd/" />
<meta property="og:image" content="https://magmax.org/icons/favicon.png"/>
<meta property="article:published_time" content="2015-07-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-28T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://magmax.org/icons/favicon.png"/>

<meta name="twitter:title" content="Midiéndolo todo con StatsD"/>
<meta name="twitter:description" content="Introducción al uso de StatsD"/>
<meta name="application-name" content="El blog de MagMax">
<meta name="apple-mobile-web-app-title" content="El blog de MagMax"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://magmax.org/blog/midiendolo-todo-con-statsd/" /><link rel="prev" href="https://magmax.org/blog/yapsy-un-sistema-de-plugins-pythonico/" /><link rel="next" href="https://magmax.org/blog/puppet-templates-hint-quitando-espacios/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Midiéndolo todo con StatsD",
        "inLanguage": "es",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/magmax.org\/blog\/midiendolo-todo-con-statsd\/"
        },"genre": "posts","keywords": "monitoring","wordcount":  1688 ,
        "url": "https:\/\/magmax.org\/blog\/midiendolo-todo-con-statsd\/","datePublished": "2015-07-12T00:00:00+00:00","dateModified": "2021-01-28T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Miguel Ángel"},"author": {
                "@type": "Person",
                "name": "Miguel Ángel"
            },"description": "Introducción al uso de StatsD"
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="El blog de MagMax"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon.png"
        data-srcset="/icons/favicon.png, /icons/favicon.png 1.5x, /icons/favicon.png 2x"
        data-sizes="auto"
        alt="/icons/favicon.png"
        title="/icons/favicon.png" />MagMax Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> Inicio </a><a class="menu-item" href="/tags"> Tags </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Selecciona el lenguage">Español<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/blog/midiendolo-todo-con-statsd/" selected>Español</option></select>
                    </a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="El blog de MagMax"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon.png"
        data-srcset="/icons/favicon.png, /icons/favicon.png 1.5x, /icons/favicon.png 2x"
        data-sizes="auto"
        alt="/icons/favicon.png"
        title="/icons/favicon.png" />MagMax Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="">Inicio</a><a class="menu-item" href="/tags" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Selecciona el lenguage">Español<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/blog/midiendolo-todo-con-statsd/" selected>Español</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contenido</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Midiéndolo todo con StatsD</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Miguel Ángel</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="12 Jul 2015">12 Jul 2015</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1688 palabras&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;8 minutos&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contenido</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#qué-es-statsd">¿Qué es StatsD?</a></li>
    <li><a href="#instalando-statsd">Instalando StatsD</a></li>
    <li><a href="#ejecutando-statsd">Ejecutando StatsD</a></li>
    <li><a href="#cómo-enviar-métricas-a-statsd">Cómo enviar métricas a StatsD</a></li>
    <li><a href="#para-qué-sive-statsd">¿Para qué sive StatsD?</a>
      <ul>
        <li><a href="#ventajas">Ventajas</a></li>
      </ul>
    </li>
    <li><a href="#clusters-de-statsd">Clusters de StatsD</a></li>
    <li><a href="#conclusión">Conclusión</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Tras el artículo <a href="https://magmax.org/blog/graficas-basadas-en-tiempo-graphite/" rel="">Gráficas basadas en tiempo: Graphite</a> era obligatorio escribir
uno sobre <a href="https://github.com/etsy/statsd" target="_blank" rel="noopener noreffer">StatsD</a>.</p>
<p>En este artículo voy a contar qué es <a href="https://github.com/etsy/statsd" target="_blank" rel="noopener noreffer">StatsD</a> y cómo usarlo para extraer
estadísticas de uso de nuestro código. Aunque al principio pueda parecer un poco
extraño, os aseguro que es realmente interesante, sobre todo cuando se usa junto
con <a href="https://graphite.wikidot.com/" target="_blank" rel="noopener noreffer">Graphite</a>.</p>
<figure>
    <img src="/images/stats.png"
         alt="Diferentes tipos de gráficas"/> 
</figure>

<h2 id="qué-es-statsd">¿Qué es StatsD?</h2>
<p>Según la propia página de StatsD:</p>
<blockquote>
<p>StatsD is a front-end proxy for the Graphite/Carbon metrics server, originally written by Etsy&rsquo;s Erik Kastner. It is based on ideas from Flickr and this post by Cal Henderson: Counting and Timing. The server was written in Node, though there have been implementations in other languages since then.</p>
</blockquote>
<p>Pero debo decir que la definición no me gusta. No, porque <a href="https://graphite.wikidot.com/" target="_blank" rel="noopener noreffer">Graphite</a> es sólo uno de los posibles backends.</p>
<p>En lugar de preguntarnos <em>&quot;¿qué es StatsD?&quot;</em> deberíamos preguntarnos <em>&quot;¿Para qué sirve StatsD?&quot;</em>.</p>
<p>StatsD permite recopilar datos de&hellip; cosas, para su posterior uso. Cosas como número de ejecuciones, veces que se pasa por una función, tiempo que tarda en ejecutarse una acción, etc.</p>
<p>Existen <a href="https://github.com/etsy/statsd/wiki#server-implementations" target="_blank" rel="noopener noreffer">distintas implementaciones del servidor StatsD</a>, aunque la original es
la escrita en <a href="https://nodejs.org/" target="_blank" rel="noopener noreffer">NodeJS</a>, que va a ser la que voy a comentar, ya que es la más completa. Hay clientes para cualquier lenguaje, ya que basta enviar una trama sencilla por UDP. Veremos esto más adelante.</p>
<h2 id="instalando-statsd">Instalando StatsD</h2>
<p>Como ya he dicho, usaremos <a href="https://github.com/etsy/statsd" target="_blank" rel="noopener noreffer">la implementación de Etsy</a>, que es la más famosa, y
que está implementada en <a href="https://nodejs.org/" target="_blank" rel="noopener noreffer">NodeJS</a>, por lo que lo primero será instalar <a href="https://nodejs.org/" target="_blank" rel="noopener noreffer">NodeJS</a> si no lo tenemos ya:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">apt-get install nodejs
</code></pre></td></tr></table>
</div>
</div><p>A continuación, la instalación estándar nos sugiere clonar el repositorio:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/etsy/statsd.git
</code></pre></td></tr></table>
</div>
</div><p>Aunque otro métido alternativo es usar <a href="https://www.npmjs.com/" target="_blank" rel="noopener noreffer">npm</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">npm install statsd
</code></pre></td></tr></table>
</div>
</div><p>El primer metodo nos dejará el código en el directorio <code>statsd</code>, mientras que
el segundo lo hará en <code>node_modules\statsd</code>, pero el resultado será muy
similar. Yo he usado <a href="https://www.npmjs.com/" target="_blank" rel="noopener noreffer">npm</a> para este artículo.</p>
<p>Lo siguiente es configurarlo. Para ello basta copiar el archivo <code>node_modules/statsd/exampleConfig.js</code> al directorio actual y modificarlo. Veréis que el 99% del archivo es ayuda sobre el propio archivo, y que la configuración se reduce a algo como:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="nx">graphitePort</span><span class="o">:</span> <span class="mi">2003</span>
<span class="p">,</span> <span class="nx">graphiteHost</span><span class="o">:</span> <span class="s2">&#34;graphite.example.com&#34;</span>
<span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">8125</span>
<span class="p">,</span> <span class="nx">backends</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&#34;./backends/graphite&#34;</span> <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Podéis cambiar <code>graphiteHost</code> por <code>localhost</code>, y si seguísteis el artículo
<a href="https://magmax.org/blog/graficas-basadas-en-tiempo-graphite/" rel="">Gráficas basadas en tiempo: Graphite</a> ya estaría todo funcionando con
<a href="https://graphite.wikidot.com/" target="_blank" rel="noopener noreffer">Graphite</a>. De todas maneras, para comenzar recomiendo cambiar el <strong>backend</strong>
por <code>console</code>, y así no es necesario tener <a href="https://graphite.wikidot.com/" target="_blank" rel="noopener noreffer">Graphite</a> instalado y podremos ver todos los datos en crudo. Por ello usaremos el archivo de configuración:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="nx">port</span><span class="o">:</span> <span class="mi">8125</span>
<span class="p">,</span> <span class="nx">backends</span><span class="o">:</span> <span class="p">[</span> <span class="s2">&#34;./backends/console&#34;</span> <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ejecutando-statsd">Ejecutando StatsD</h2>
<p>Con esta configuración ya podemos ejecutarlo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">node node_modules/statsd/stats.js config.js
</code></pre></td></tr></table>
</div>
</div><p>Cada 10 segundos aparecerá un mensaje parecido a éste:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span> <span class="nx">counters</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;statsd.bad_lines_seen&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;statsd.packets_received&#39;</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
  <span class="nx">timers</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">gauges</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">timer_data</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">counter_rates</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;statsd.bad_lines_seen&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;statsd.packets_received&#39;</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
  <span class="nx">sets</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">pctThreshold</span><span class="o">:</span> <span class="p">[</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Ahí se indica la información recolectada. Hay algunos puntos curiosos:</p>
<ul>
<li><code>counters</code>: Los contadores recibidos. Por defecto ya tiene 2, relacionados
con el propio <a href="https://github.com/etsy/statsd" target="_blank" rel="noopener noreffer">StatsD</a>.</li>
<li><code>timers</code>: contadores de tipo tiempo recibidos.</li>
<li><code>gauges</code>: Es un tipo de métrica que mantiene el último valor hasta recibir uno nuevo.</li>
<li><code>timer_data</code>: Información ya tratada de los <code>timers</code>.</li>
<li><code>counter_rates</code>: estadísticas de uso de los contadores.</li>
<li><code>sets</code>: grupos de métricas recibidos.</li>
<li><code>pctThreshold</code>: o &ldquo;percentile threshold&rdquo;, que es el percentil calculado para
tiempos. Es decir: si en un intervalo se reciben 100 mediciones de tiempo, se
cogerá el <a href="https://en.wikipedia.org/wiki/Percentile" target="_blank" rel="noopener noreffer">percentil 90</a> de éstas, ya que es estadísticamente más representativo.</li>
</ul>
<p>Se puede configurar el tiempo del intervalo, pero por defecto son 10 segundos, y eso está bien para nuestro ejemplo.</p>
<h2 id="cómo-enviar-métricas-a-statsd">Cómo enviar métricas a StatsD</h2>
<p>Bueno, antes deberíamos saber qué tipos de métricas se pueden enviar, aunque ya están mencionadas en el apartado anterior:</p>
<ul>
<li>Contadores, con formato <code>métrica:N|c</code>, siendo <code>N</code> el valor de la métrica.</li>
<li>Tiempos, con formato <code>métrica:N|ms</code>, siendo <code>N</code> el tiempo a registrar.</li>
<li>Gauges, con formato <code>métrica:N|g</code>, siendo <code>N</code> el valor de la métrica. Son valores que se mantienen hasta que llegue el siguiente.</li>
<li>Sets, con formato <code>métrica:N|s</code>, siendo <code>N</code> un número de ocurrencias a registrar.</li>
</ul>
<p>El formato, además, permite indicar la agrupación añadiendo <code>|@0.1</code>, donde <code>0.1</code> indica que el valor sólo se está enviando 1/10 del tiempo.
También se permite el envío de varias métricas en un sólo mensaje, separándolas por <code>\n</code>.</p>
<p>Como ya se dijo antes, basta con enviar estos datos en una trama UDP. Podemos usar <strong>Bash</strong>, por ejemplo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">   <span class="nb">echo</span> <span class="s2">&#34;this.is.a.counter:1|c&#34;</span> <span class="p">|</span> nc -u -w1 127.0.0.1 <span class="m">8125</span>
</code></pre></td></tr></table>
</div>
</div><p>que provocará un cambio en la salida del servidor, mostrando el mensaje:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">   <span class="p">{</span> <span class="nx">counters</span><span class="o">:</span>
      <span class="p">{</span> <span class="s1">&#39;statsd.bad_lines_seen&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;statsd.packets_received&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;this.is.a.counter&#39;</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span>
     <span class="nx">timers</span><span class="o">:</span> <span class="p">{</span> <span class="nx">glork</span><span class="o">:</span> <span class="p">[]</span> <span class="p">},</span>
     <span class="nx">gauges</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;statsd.timestamp_lag&#39;</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
     <span class="nx">timer_data</span><span class="o">:</span> <span class="p">{},</span>
     <span class="nx">counter_rates</span><span class="o">:</span>
      <span class="p">{</span> <span class="s1">&#39;statsd.bad_lines_seen&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;statsd.packets_received&#39;</span><span class="o">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;this.is.a.counter&#39;</span><span class="o">:</span> <span class="mf">0.1</span> <span class="p">},</span>
     <span class="nx">sets</span><span class="o">:</span> <span class="p">{},</span>
     <span class="nx">pctThreshold</span><span class="o">:</span> <span class="p">[</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Como vemos, hay una ocurrencia del contador. A los 10 segundos se volverá a mostrar un 0, ya que en ese intervalo no ha habido ocurrencias.</p>
<p>Recomendaría jugar aquí con los distintos tipos de métricas, varias métricas en un mensaje, cambiar la agrupación, etc. Incluso intentarlo desde el lenguaje que vayáis a utilizar después.</p>
<h2 id="para-qué-sive-statsd">¿Para qué sive StatsD?</h2>
<p>Pero nada de todo esto explica para qué podemos utilizar StatsD. Vamos a verlo
con ejemplos. Utilizaré Python, junto con el [ejemplo de cliente Python
proporcionado por Ets]y</p>
<p>Tenemos una función muy costosa, que permite multiplicar dos matrices y queremos registrar cuánto tarda en ejecutarse. Aquí está nuestra función original:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">multiply_matrix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">acols</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bcols</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">acols</span> <span class="o">*</span> <span class="n">bcols</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">acols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bcols</span><span class="p">):</span>
            <span class="n">partial</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bcols</span><span class="p">):</span>
                <span class="n">partial</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">acols</span><span class="p">)]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">bcols</span><span class="p">)]</span>
            <span class="n">c</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">acols</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span>
    <span class="k">return</span> <span class="n">c</span>
</code></pre></td></tr></table>
</div>
</div><p>Dado que el cliente de <a href="https://github.com/etsy/statsd" target="_blank" rel="noopener noreffer">StatsD</a> no va a cambiar con el tiempo, podemos considerar que todos sus métodos son estáticos y usar una única instancia, ya configurada con el <em>host</em> y <em>port</em> deseados, y guardarlo todo en una variable global (cosa que no debería ser lo habitual, pero en este caso estaría justificado). He marcado las líneas nuevas:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">time</span>  <span class="c1"># +</span>
<span class="kn">from</span> <span class="nn">python_example</span> <span class="kn">import</span> <span class="n">StatsdClient</span>  <span class="c1"># +</span>

<span class="n">statsd</span> <span class="o">=</span> <span class="n">StatsdClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8125</span><span class="p">)</span>  <span class="c1"># +</span>

<span class="k">def</span> <span class="nf">multiply_matrix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">acols</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bcols</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># +</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">acols</span> <span class="o">*</span> <span class="n">bcols</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">acols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bcols</span><span class="p">):</span>
            <span class="n">partial</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bcols</span><span class="p">):</span>
                <span class="n">partial</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">acols</span><span class="p">)]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">bcols</span><span class="p">)]</span>
            <span class="n">c</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">acols</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>  <span class="c1"># +</span>
    <span class="n">statsd</span><span class="o">.</span><span class="n">timing</span><span class="p">(</span><span class="s1">&#39;matrix.</span><span class="si">%s</span><span class="s1">_colsx</span><span class="si">%s</span><span class="s1">_cols.time&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">acols</span><span class="p">,</span> <span class="n">bcols</span><span class="p">),</span> <span class="n">elapsed</span><span class="p">)</span>  <span class="c1"># +</span>
    <span class="k">return</span> <span class="n">c</span>
</code></pre></td></tr></table>
</div>
</div><p>6 líneas contando <code>include</code> y configuración.</p>
<p>Además, quiero contar cuántas veces se llama a la función por cada tamaño de matrices:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">python_example</span> <span class="kn">import</span> <span class="n">StatsdClient</span>

<span class="n">statsd</span> <span class="o">=</span> <span class="n">StatsdClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8125</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">multiply_matrix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">acols</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bcols</span><span class="p">):</span>
    <span class="n">statsd</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;matrix.</span><span class="si">%s</span><span class="s1">_colsx</span><span class="si">%s</span><span class="s1">_cols.count&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">acols</span><span class="p">,</span> <span class="n">bcols</span><span class="p">),</span> <span class="n">elapsed</span><span class="p">)</span>  <span class="c1"># +</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">acols</span> <span class="o">*</span> <span class="n">bcols</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">acols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bcols</span><span class="p">):</span>
            <span class="n">partial</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bcols</span><span class="p">):</span>
                <span class="n">partial</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">acols</span><span class="p">)]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">bcols</span><span class="p">)]</span>
            <span class="n">c</span><span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">acols</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">statsd</span><span class="o">.</span><span class="n">timing</span><span class="p">(</span><span class="s1">&#39;matrix.</span><span class="si">%s</span><span class="s1">_colsx</span><span class="si">%s</span><span class="s1">_cols.time&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">acols</span><span class="p">,</span> <span class="n">bcols</span><span class="p">),</span> <span class="n">elapsed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>
</code></pre></td></tr></table>
</div>
</div><p>Una línea más.</p>
<h3 id="ventajas">Ventajas</h3>
<p>Pero&hellip; ¿En qué afecta esto al tiempo de ejecución? Bueno, por el principio de Heisenberg, donde el observador siempre altera lo observado, en algo, pero en muy poco, ya que al utilizar el protocolo UDP no hay tiempos de latencia.</p>
<p>UDP tiene un problema: Es posible que la trama se pierda. Así que estas
estadísticas no serán muy exactas, pero pueden darnos una idea muy aproximada de
la evolución del sistema. De todas maneras, si el servidor <a href="https://github.com/etsy/statsd" target="_blank" rel="noopener noreffer">StatsD</a> está en local, es raro que se pierda una trama.</p>
<p>Si se conectara contra <a href="https://graphite.wikidot.com/" target="_blank" rel="noopener noreffer">Graphite</a> directamente por TCP entonces sí que habría retrasos: hay que establecer la conexión, enviar la información, esperar <strong>ACK</strong>, etc.</p>
<p>Otra ventaja es que no puede fallar. Si nuestro servidor TCP está caído, debemos tratar la excepción o el programa fallará. Si usamos UDP, perderemos la métrica, pero seguiremos dando servicio.</p>
<p>¿Dónde es especialmente útil?</p>
<ul>
<li>Para tiempos de ejecución de <strong>queries</strong>. En pruebas de estrés podría mostrar la evolución del tiempo de ejecución en función de los datos ya existentes.</li>
<li>Contabilizar <strong>logins en una web</strong> u otras operaciones, así como <em>logins</em> fallidos, permitiendo detectar ataques por fuerza bruta.</li>
<li>Medir <strong>tiempos de respuesta</strong> en una web.</li>
</ul>
<p>En Tuenti nos hicimos un <em>wrapper</em> sobre mercurial, para detectar la evolución
del tiempo necesario para ejecutar cada subcomando, para medir la evolución de
los más lentos. Gracias a esto, <a href="https://corporate.tuenti.com/es/dev/blog/Mercurial-performance-boost" target="_blank" rel="noopener noreffer">detectamos un problema grave de rendimiento</a> y pudimos medir su evolución.</p>
<h2 id="clusters-de-statsd">Clusters de StatsD</h2>
<p>Todo esto tiene un problema. Si tenemos un balanceador de carga con dos
servidores, cada uno con su servidor StatsD, y queremos medir los tiempos de
request, el último que mande su valor a <a href="https://graphite.wikidot.com/" target="_blank" rel="noopener noreffer">Graphite</a> es el que quedará. Por eso debemos configurar los servidores StatsD como <strong>Proxies</strong>, indicando la ubicación del resto de servidores StatsD.</p>
<h2 id="conclusión">Conclusión</h2>
<p>Todo se puede medir, y es importante medirlo todo. Desgraciadamente, eso requiere muchos recursos. Pero StatsD es una herramienta muy interesante para medir allá donde no se puede con otras herramientas.</p>
<p>Finalmente os dejo con un vídeo de cómo hacer todo lo que he contado aquí:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/J5CeLI2CiPk" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>También os proporciono otro vídeo de cómo instalar <a href="https://graphite.wikidot.com/" target="_blank" rel="noopener noreffer">Graphite</a> y <a href="https://github.com/etsy/statsd" target="_blank" rel="noopener noreffer">Statsd</a> en 3
minutos, mostrando los datos. Es importante tener en cuenta que <a href="https://github.com/etsy/statsd" target="_blank" rel="noopener noreffer">Statsd</a> dejará las métricas en <code>stats/gauges/</code> en lugar de colgar del árbol principal.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/ADMPs4FzLDQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>Quizá os parezca extraño ver cómo se altera la gráfica en parte del vídeo, pero
es algo normal: Al llegar varias métricas durante el mismo cupo de tiempo, el
último predomina. Para cambiar eso habría que modificar la configuración de
Carbon, como se explicó en el artículo <a href="https://magmax.org/blog/graficas-basadas-en-tiempo-graphite/" rel="">Gráficas basadas en tiempo: Graphite</a>.</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Actualizado el 28 Jan 2021</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Compartir en Twitter" data-sharer="twitter" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/" data-title="Midiéndolo todo con StatsD" data-hashtags="monitoring"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Facebook" data-sharer="facebook" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/" data-hashtag="monitoring"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Linkedin" data-sharer="linkedin" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en WhatsApp" data-sharer="whatsapp" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/" data-title="Midiéndolo todo con StatsD" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Tumblr" data-sharer="tumblr" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/" data-title="Midiéndolo todo con StatsD" data-caption="Introducción al uso de StatsD" data-tags="monitoring"><i class="fab fa-tumblr fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Reddit" data-sharer="reddit" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Instapaper" data-sharer="instapaper" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/" data-title="Midiéndolo todo con StatsD" data-description="Introducción al uso de StatsD"><i data-svg-src="/lib/simple-icons/icons/instapaper.min.svg"></i></a><a href="javascript:void(0);" title="Compartir en Digg" data-sharer="digg" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/"><i class="fab fa-digg fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Blogger" data-sharer="blogger" data-url="https://magmax.org/blog/midiendolo-todo-con-statsd/" data-title="Midiéndolo todo con StatsD" data-description="Introducción al uso de StatsD"><i class="fab fa-blogger fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/monitoring/">monitoring</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Regresar</a></span>&nbsp;|&nbsp;<span><a href="/">Inicio</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/blog/yapsy-un-sistema-de-plugins-pythonico/" class="prev" rel="prev" title="Yapsy, un sistema de plugins pythónico"><i class="fas fa-angle-left fa-fw"></i>Yapsy, un sistema de plugins pythónico</a>
            <a href="/blog/puppet-templates-hint-quitando-espacios/" class="next" rel="next" title="Puppet templates hint: quitando espacios">Puppet templates hint: quitando espacios<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Provisto por <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.79.1">Hugo</a> | Tema - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Miguel Ángel</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Volver arriba">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="Ver comentarios">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="https://magmax.disqus.com/embed.js" defer></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copiar al portapapeles","maxShownLines":10},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-9308241-3', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-9308241-3" async></script></body>
</html>
