<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="max-age=43200">
<meta http-equiv="ETag" content="b'9d3a2c636e1f062842af3aff686491e3efba2446'">
<title>Creación de un módulo Drupal IV | MagMax Blog</title>
<link href="/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="/assets/css/code.css" rel="stylesheet" type="text/css">
<link href="/assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="/assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="/assets/css/custom.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/magmax">
<link rel="canonical" href="http://magmax.org/blog/creacion-modulo-drupal-4/">
<link rel="icon" href="/favicon.png" sizes="128x128">
<link rel="icon" href="/favicon.ico" sizes="16x16">
<link rel="icon" href="/favicon_330.png" sizes="330x330">
<meta name="author" content="Miguel Ángel García">
<link rel="prev" href="/blog/creacion-modulo-drupal-3/" title="Creación de un módulo Drupal III" type="text/html">
<link rel="next" href="/blog/creacion-modulo-drupal/" title="Creación de un módulo Drupal" type="text/html">
<meta property="og:site_name" content="MagMax Blog">
<meta property="og:title" content="Creación de un módulo Drupal IV">
<meta property="og:url" content="http://magmax.org/blog/creacion-modulo-drupal-4/">
<meta property="og:description" content="En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura... cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas">
<meta property="og:type" content="article">
<meta property="article:author" content="Miguel Ángel García">
<meta property="article:published_time" content="2010-05-11T00:00:00+00:00">
<meta property="article:updated" content="2010-05-11T00:00:00">
<meta property="article:tag" content="drupal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@magmax">
<meta name="twitter:creator" content="@magmax">
<meta name="twitter:title" content="MagMax Blog">
<meta name="twitter:description" content="El blog de un Ingeniero Informático: tutoriales, manuales, opiniones, comparativas, ...">
<meta name="twitter:url" content="http://magmax.org//blog/creacion-modulo-drupal-4/">
<meta name="twitter:image" content="http://magmax.org/favicon.png">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Ir al contenido principal</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container">
<!-- This keeps the margins nice -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://magmax.org/">

        <span id="blog-title">MagMax Blog</span>
      </a>
    </div>
<!-- /.navbar-header -->
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav">
<li>
<a href="/">Inicio</a>
                </li>
<li>
<a href="/archive.html">Archivo</a>
                </li>
<li>
<a href="/categories">Categorías</a>
                </li>
<li>
<a href="/projects">Proyectos</a>
                </li>
<li>
<a href="/news">Posts Externos</a>

        
      </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
<form class="navbar-form navbar-left" role="search" action="http://google.com/search" method="get">
<div class="form-group">
<input type="hidden" name="sitesearch" value="magmax.org"><input type="text" name="q" class="form-control" placeholder="Search / Buscar">
</div>
</form>
</li>

        <li style="margin-left:0">
          <a href="http://feeds.feedburner.com/magmax">
            <img src="/assets/images/rss.png" style="width:22px;height:22px"></a>
        </li>

        
      </ul>
</div>
<!-- /.navbar-collapse -->
  </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
  <div class="body-content">
    <div class="row">
      <div class="page-content col-md-9">
        
        <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="/blog/creacion-modulo-drupal-4/" class="u-url">Creación de un módulo Drupal IV</a></h1>
            <div class="metadata text-muted">
              <i class="glyphicon glyphicon-calendar"></i>
              <p class="dateline">
                <time class="published dt-published" datetime="2010-05-11T00:00:00+00:00" title="2010-05-11">2010-05-11</time>
                // <time class="updated dt-updated" datetime="2010-05-11T00:00:00" title="2010-05-11">2010-05-11</time></p>
              <p class="commentline">            <a href="/blog/creacion-modulo-drupal-4/#disqus_thread" data-disqus-identifier="cache/posts/creacion-modulo-drupal-4.html">Comments</a>

</p>
              <address class="vcard author"><a class="url fn" href="http://magmax.org">Miguel Ángel García</a></address>
            </div>
            <br></header><div class="e-content entry-content" itemprop="articleBody text">
            <div>
<p>En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura... cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.</p>
<p>Hoy queremos que nuestros "feedbacks" se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc.</p>
<p>Me voy a basar en el <a class="reference external" href="http://drupal.org/node/231019">magnífico tutorial para crear contenido en Drupal</a></p>
<!-- TEASER_END -->
<div class="section" id="versiones">
<h2>Versiones</h2>
<p>Igual que es posible que este documento se copie, también es posible que yo lo modifique. Por eso, la última versión del mismo siempre se encontrará en la "cuarta parte del tutorial de drupal":link://slug/creacion-modulo-drupal-4. Un saludo.</p>
</div>
<div class="section" id="que-se-explica-aqui">
<h2>Qué se explica aquí</h2>
<p>Cómo crear un nodo programáticamente. Una vez hayamos terminado, todo lo que hayamos hecho se podría haber hecho con el módulo CCK, pero de lo que se trata es aprender.</p>
</div>
<div class="section" id="que-es-el-cck">
<h2>Qué es el CCK</h2>
<p>Fácil: es el <em>Content Construction Kit</em> :-D</p>
<p>Consiste en una herramienta muy potente para la creación de formularios mediante el propio Drupal. De esta manera, sólo tenemos que ir añadiendo una lista de elementos, que posteriormente se renderizarán como un formulario. Gran parte de nuestro módulo "feedback" se podría haber hecho directamente sobre el CCK, por no decir todo.</p>
<p>¿Por qué no usar el CCK? En nuestro caso, "porque estamos aprendiendo" es una razón tan válida como cualquier otra. En concreto, para un módulo de las características de "feedback", tal vez haya sido una pérdida de tiempo usar un módulo en lugar de el CCK. Sin embargo, un módulo tiene unas características de replicabilidad que el CCK creo que no tiene.</p>
<p>Además, el CCK nos permite crear formularios simples, pero si lo que queremos es poder manipular los datos, entonces necesitaremos crear nuestro propio módulo.</p>
</div>
<div class="section" id="pasos">
<h2>Pasos</h2>
<p>Vamos a necesitar los siguientes <em>hooks</em>, aunque algunos de ellos ya los hemos implementado:</p>
<ul class="simple">
<li><code>hook_node_info</code></li>
<li><code>hook_perm</code></li>
<li><code>hook_access</code></li>
<li><code>hook_form</code></li>
</ul>
<p>También vamos a necesitar algunos de los siguientes <em>hooks</em> opcionales:</p>
<ul class="simple">
<li><code>hook_insert</code></li>
<li><code>hook_update</code></li>
<li><code>hook_delete</code></li>
<li><code>hook_validate</code></li>
<li><code>hook_nodeapi</code></li>
<li><code>hook_view</code></li>
<li><code>hook_load</code></li>
</ul>
</div>
<div class="section" id="hooks-obligatorios">
<h2>Hooks obligatorios</h2>
<p>Nosotros ya tenemos nuestro <code>hook_node_info</code> y nuestro propio <code>hook_perm</code>, así que saltamos directamente a implementar el <code>hook_access</code>:</p>
<pre class="code php"><a name="rest_code_580230ae02034e99aa486b1f7037f279-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-2"></a><span class="sd">/**</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-3"></a><span class="sd">* Implements hook_access()</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-4"></a><span class="sd">*/</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-5"></a><span class="k">function</span> <span class="nf">feedback_access</span> <span class="p">(</span> <span class="nv">$op</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-6"></a><span class="p">{</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-7"></a>  <span class="nv">$retval</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-8"></a>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-9"></a>  <span class="k">switch</span> <span class="p">(</span> <span class="nv">$op</span> <span class="p">)</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-10"></a>  <span class="p">{</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-11"></a>    <span class="k">case</span> <span class="s1">'view'</span><span class="o">:</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-12"></a>      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">'view messages'</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">);</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-13"></a>    <span class="k">case</span> <span class="s1">'create'</span><span class="o">:</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-14"></a>      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">'send message'</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">);</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-15"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-16"></a>    <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-17"></a>      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">'admin messages'</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="p">);</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-18"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-19"></a>    <span class="k">case</span> <span class="s1">'delete'</span><span class="o">:</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-20"></a>      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">'admin messages'</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="p">);</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-21"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-22"></a>  <span class="p">}</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-23"></a>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-24"></a>  <span class="k">return</span> <span class="nv">$retval</span><span class="p">;</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-25"></a><span class="p">}</span>
<a name="rest_code_580230ae02034e99aa486b1f7037f279-26"></a><span class="cp">?&gt;</span><span class="x"></span>
</pre>
<p>La función va a devolver <em>true</em> si queremos que el usuario tenga acceso. Para ello comprobamos si el usuario tiene los roles necesarios como para realizar ciertas acciones. En el caso de "update" y "delete" comprobamos también que el usuario sea el propietario del nodo.</p>
<p>Siguiendo con la lista, implementaremos el <code>hook_node_info</code>:</p>
<pre class="code php"><a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-2"></a><span class="sd">/**</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-3"></a><span class="sd">* Implements hook_node_info()</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-4"></a><span class="sd">*/</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-5"></a><span class="k">function</span> <span class="nf">feedback_node_info</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-6"></a>  <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-7"></a>    <span class="s1">'feedback'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-8"></a>      <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">),</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-9"></a>      <span class="s1">'module'</span> <span class="o">=&gt;</span> <span class="s1">'feedback'</span><span class="p">,</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-10"></a>      <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s2">"Handle a feedback message"</span><span class="p">,</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-11"></a>    <span class="p">),</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-12"></a>  <span class="p">);</span>
<a name="rest_code_5845b3478bab44d3b3dd452440f1fc82-13"></a><span class="p">}</span>
</pre>
<p>Ahora vamos a renombrar algunas de nuestras funciones... En concreto, <code>feedback_message_form</code>, que pasará a ser <code>feedback_form</code>. Es necesario también renombrar las funciones <code>feedback_message_form_validate</code> y <code>feedback_message_form_submit</code> para que todo siga funcionando como hasta ahora. También tendremos que modificar la llamada a <code>feedback_message_form</code> (ojo, que luego seguiremos transformando estas funciones):</p>
<pre class="code php"><a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-2"></a><span class="k">function</span> <span class="nf">feedback_message</span> <span class="p">()</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-3"></a><span class="p">{</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-4"></a>  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-5"></a>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-6"></a>  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">'feedback_form'</span> <span class="p">);</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-7"></a>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-8"></a>  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-9"></a><span class="p">}</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-10"></a>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-11"></a><span class="k">function</span> <span class="nf">feedback_form</span> <span class="p">()</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-12"></a><span class="p">{</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-13"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-14"></a><span class="p">}</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-15"></a>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-16"></a><span class="k">function</span> <span class="nf">feedback_form_validate</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-17"></a><span class="p">{</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-18"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-19"></a><span class="p">}</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-20"></a>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-21"></a><span class="k">function</span> <span class="nf">feedback_form_submit</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-22"></a><span class="p">{</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-23"></a>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a name="rest_code_afe8de1e58d54c6faf5fd4696313079f-24"></a><span class="p">}</span>
</pre>
<p>Y.... ya está. Ya tenemos nuestro elemento integrado con Drupal. Si recargamos la caché (Administration-&gt;Performance), y nos vamos a "create content", veremos que tenemos un tipo de contenido llamado "feedback".</p>
<p>El caso es que también veremos que no funciona del todo bien :-D</p>
<div class="section" id="hooks-recomendables">
<h3>Hooks recomendables</h3>
<p>Antes de nada, os voy a hablar de <code>hook_nodeapi</code>. Hacéos un favor a vosotros mismos: olvidad que alguna vez existió. Las funciones que tienen parámetros que cambian en función de otros parámetros nunca son una buena idea. Además, en Drupal 7 lo han quitado, por lo que su uso está obsoleto. Toda la funcionalidad que podía ofrecer esta función la cumplen el resto de los hooks de la lista: insert, update, delete, validate, view y load. Existe una remota posibilidad de que necesitéis usar <code>hook_nodeapi</code>; pensáoslo bien antes de usarla.</p>
<p>El resto de <code>hooks</code> se ejecutarán automáticamente cuando alguien realice la operación esperada: <code>hook_insert</code> cuando se cree un nuevo elemento, etc.</p>
<p>Realmente lo que vamos a hacer es realizar una serie de transformaciones. Por ejemplo, nuestro antiguo <code>feedback_form_submit</code> se va a transformar en el nuevo y flamante <code>feedback_insert</code>, nuestro propio <code>hook_insert</code>:</p>
<pre class="code php"><a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-2"></a><span class="k">function</span> <span class="nf">feedback_insert</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-3"></a><span class="p">{</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-4"></a>  <span class="nv">$userid</span>  <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-5"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-6"></a>  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-7"></a>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-8"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"INSERT into {feedback_messages} ( uid, message, indate, usermail ) values ( %d, '%s', now(), '%s' ) "</span><span class="p">;</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-9"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$userid</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$mail</span> <span class="p">);</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-10"></a>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-11"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-12"></a>  <span class="p">{</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-13"></a>    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span> <span class="p">(</span> <span class="s2">"Thank you for your feedback."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-14"></a>    <span class="nx">drupal_goto</span> <span class="p">(</span> <span class="s1">'node'</span> <span class="p">);</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-15"></a>  <span class="p">}</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-16"></a>  <span class="k">else</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-17"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'feedback'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">"An error has happened. Your feedback has not been sent."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_0d72a482fbb64d2b8dbe9a5e9cb017db-18"></a><span class="p">}</span>
</pre>
<p>Vamos a estudiarlo un poquito... Hemos cambiado la cabecera, de manera que ahora el <em>UID</em>, el mensaje y el e-mail lo sacamos del nodo en lugar de usar variables globales y formularios. Nosotros tenemos que decidir cómo almacenar la información que sobrepasa a la información del nodo, por lo que insertamos en nuestra tabla exactamente la misma información que antes. Es decir: a partir de <code>$query</code> no hemos cambiado nada.</p>
<p>No ha sido difícil, ¿verdad? Ahora ya podemos insertar nodos que son feeds. Y podemos probarlo: <cite>Create Content-&gt;feedback</cite>, escribimos y guardamos.</p>
<p>Se nos ha quedado el submit del formulario. Eso queda un poquito feo, ¿no? Ahora que tenemos nuestro botón "preview" y nuestro "save", amén de todas las opciones de publicación, permisos, etc... Así que vamos a quitarlo. Además hay un problema: se va a utilizar el mismo formulario para editar y para crear nuevos elementos. Por esa razón, he decidido sacar una serie de variables que se establecerán cuando se esté editando el nodo. Además, en modo "edición" se mostrará también el check para indicar que ya se ha leído.</p>
<pre class="code php"><a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-2"></a><span class="k">function</span> <span class="nf">feedback_form</span> <span class="p">(</span> <span class="o">&amp;</span><span class="nv">$node</span> <span class="p">)</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-3"></a><span class="p">{</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-4"></a>  <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-5"></a>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-6"></a>  <span class="nv">$title</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="p">(</span> <span class="s1">'Feed from %s'</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">name</span> <span class="p">);</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-7"></a>  <span class="nv">$mail</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-8"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-9"></a>  <span class="nv">$read</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-10"></a>  <span class="nv">$editing</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-11"></a>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-12"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-13"></a>    <span class="nv">$mail</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-14"></a>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-15"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-16"></a>  <span class="p">{</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-17"></a>    <span class="c1">// estamos editando</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-18"></a>    <span class="nv">$editing</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-19"></a>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT uid, message, indate, usermail, fm.read FROM {feedback_messages} fm WHERE id=%d"</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-20"></a>    <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-21"></a>    <span class="nv">$storednode</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-22"></a>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-23"></a>    <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-24"></a>    <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-25"></a>    <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-26"></a>  <span class="p">}</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-27"></a>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-28"></a>  <span class="nv">$form</span> <span class="p">[</span><span class="s1">'feedback'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-29"></a>    <span class="p">(</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-30"></a>      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-31"></a>      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span> <span class="s1">'Feedback'</span> <span class="p">),</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-32"></a>      <span class="s1">'mail'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span> <span class="s2">"#title"</span><span class="o">=&gt;</span><span class="s2">"E-Mail"</span><span class="p">,</span> <span class="s2">"#description"</span><span class="o">=&gt;</span><span class="s2">"If you want any answer, please, tell me your mail. It would not be shown anywhere."</span><span class="p">,</span> <span class="s2">"#default_value"</span> <span class="o">=&gt;</span> <span class="nv">$mail</span> <span class="p">),</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-33"></a>      <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textarea'</span><span class="p">,</span> <span class="s2">"#description"</span><span class="o">=&gt;</span><span class="s2">"Write here your message"</span><span class="p">,</span> <span class="s1">'#default_value'</span><span class="o">=&gt;</span><span class="nv">$message</span> <span class="p">),</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-34"></a>      <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-35"></a>    <span class="p">);</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-36"></a>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-37"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$editing</span> <span class="p">)</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-38"></a>  <span class="p">{</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-39"></a>    <span class="nv">$form</span> <span class="p">[</span><span class="s1">'feedback'</span><span class="p">][</span><span class="s1">'read'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'checkbox'</span><span class="p">,</span> <span class="s2">"#title"</span><span class="o">=&gt;</span><span class="s2">"The message has been read"</span><span class="p">,</span> <span class="s1">'#default_value'</span><span class="o">=&gt;</span><span class="nv">$read</span> <span class="p">)</span> <span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-40"></a>  <span class="p">}</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-41"></a>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-42"></a>  <span class="nv">$form</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-43"></a>    <span class="p">(</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-44"></a>      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'hidden'</span><span class="p">,</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-45"></a>      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-46"></a>    <span class="p">);</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-47"></a>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-48"></a>  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<a name="rest_code_fc3a872dd92a4ff2a95e1aa6153b1d91-49"></a><span class="p">}</span>
</pre>
<p>¡Eh!, ¡Para!, que aquí al final hay algo extraño... Sí, lo que hacemos es preguntarle a Drupal el tipo de nodo que estamos tratando, y comprobar si este tipo necesita un título. Si es así, pues lo pintamos. Se podría hacer lo mismo con el <em>body</em>, pero en esta ocasión no lo queremos. El título es interesante para que después nos aparezca en la lista de contenido y podamos pincharle.</p>
<p>Ahora vamos a realizar las comprobaciones adecuadas, renombrando <code>feedback_form_validate</code> y haciendo los cambios pertinentes:</p>
<pre class="code php"><a name="rest_code_780cb27e572a4134aff528b1bf1fc715-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-2"></a><span class="k">function</span> <span class="nf">feedback_validate</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form</span> <span class="p">)</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-3"></a><span class="p">{</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-4"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'values'</span><span class="p">][</span><span class="s1">'message'</span><span class="p">];</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-5"></a>  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">'values'</span><span class="p">][</span><span class="s1">'mail'</span><span class="p">];</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-6"></a>  <span class="nv">$validmail</span> <span class="o">=</span> <span class="nb">preg_match</span> <span class="p">(</span><span class="s2">"/^[^0-9][A-z0-9_]+([.][A-z0-9_]+)*[@][A-z0-9_]+([.][A-z0-9_]+)*[.][A-z]{2,4}$/"</span> <span class="p">,</span> <span class="nv">$mail</span> <span class="p">);</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-7"></a>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-8"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$mail</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-9"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'mail'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'You are not a registered user. Please, insert your e-mail.'</span><span class="p">)</span> <span class="p">);</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-10"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$mail</span> <span class="o">!=</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$validmail</span> <span class="p">)</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-11"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'mail'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'The mail does not like an e-mail address.'</span><span class="p">)</span> <span class="p">);</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-12"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">==</span> <span class="s1">''</span> <span class="p">)</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-13"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Message cannot be empty.'</span><span class="p">));</span>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-14"></a>
<a name="rest_code_780cb27e572a4134aff528b1bf1fc715-15"></a>  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
</pre>
<p>Es una lástima ver lo fácil que habría resultado realizarlo así desde el principio, ¿verdad? ¡¡Pero había que aprender!! Pasito a pasito...</p>
<p>Ahora vamos a "ver" los feeds. No sé si habréis notado que cuando pulsáis sobre un feed, no se ve nada. Igual que en el <em>preview</em>. Eso es porque tenemos que implementar el <code>hook_view</code>:</p>
<pre class="code php"><a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-2"></a><span class="k">function</span> <span class="nf">feedback_view</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$teaser</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">,</span> <span class="nv">$page</span> <span class="o">=</span> <span class="k">FALSE</span> <span class="p">)</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-3"></a><span class="p">{</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-4"></a>  <span class="nv">$messageread</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-5"></a>  <span class="nv">$messagedata</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-6"></a>  <span class="nv">$messagename</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-7"></a>  <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-8"></a>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-9"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span> <span class="p">)</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-10"></a>  <span class="p">{</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-11"></a>    <span class="c1">// ya tenemos el mensaje. Puede deberse a que estamos editando.</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-12"></a>    <span class="nv">$messageread</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-13"></a>    <span class="nv">$messagedata</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-14"></a>    <span class="nv">$messagename</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-15"></a>    <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-16"></a>  <span class="p">}</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-17"></a>  <span class="k">else</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-18"></a>  <span class="p">{</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-19"></a>    <span class="c1">// tenemos que obtener el mensaje</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-20"></a>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT fm.uid, message, indate, usermail, u.name, fm.read FROM {feedback_messages} fm, {users} u WHERE id=%d and fm.uid=u.uid"</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-21"></a>    <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-22"></a>    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-23"></a>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-24"></a>    <span class="nv">$messageread</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-25"></a>    <span class="nv">$messagedata</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-26"></a>    <span class="nv">$messagename</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-27"></a>    <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-28"></a>  <span class="p">}</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-29"></a>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-30"></a>  <span class="nv">$read</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-31"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageread</span> <span class="p">)</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-32"></a>    <span class="nv">$read</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">" and &lt;b&gt;already read&lt;/b&gt;"</span><span class="p">);</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-33"></a>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-34"></a>  <span class="nv">$content</span>  <span class="o">=</span> <span class="nb">sprintf</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'&lt;blockquote&gt;&lt;i&gt;%s&lt;/i&gt;&lt;/blockquote&gt;&lt;p&gt;Sent by %s&lt;a href="mailto:%s"&gt;&amp;lt;%s&amp;gt;&lt;/a&gt;%s.&lt;/p&gt;'</span><span class="p">),</span> <span class="nv">$messagedata</span><span class="p">,</span> <span class="nv">$messagename</span><span class="p">,</span> <span class="nv">$messageusermail</span><span class="p">,</span> <span class="nv">$messageusermail</span><span class="p">,</span> <span class="nv">$read</span> <span class="p">);</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-35"></a>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-36"></a>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-37"></a>  <span class="nv">$node</span> <span class="o">=</span> <span class="nx">node_prepare</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$teaser</span> <span class="p">);</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-38"></a>  <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-39"></a>    <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-40"></a>    <span class="s1">'#weight'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-41"></a>  <span class="p">);</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-42"></a>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-43"></a>  <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
<a name="rest_code_89f9d03a9d5947f4adaf9fbdaab23d2d-44"></a><span class="p">}</span>
</pre>
<p>Ahora vamos con la edición, para que se hagan efectivos los cambios:</p>
<pre class="code php"><a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-2"></a><span class="k">function</span> <span class="nf">feedback_update</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-3"></a><span class="p">{</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-4"></a>  <span class="nv">$userid</span>  <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-5"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-6"></a>  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-7"></a>  <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-8"></a>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-9"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE {feedback_messages} fm SET message='%s', usermail='%s', fm.read=%d where id=%d"</span><span class="p">;</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-10"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$mail</span><span class="p">,</span> <span class="nv">$read</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-11"></a>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-12"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-13"></a>  <span class="p">{</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-14"></a>    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">"The feedback has been updated."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-15"></a>    <span class="nx">drupal_goto</span> <span class="p">(</span> <span class="s1">'node'</span> <span class="p">);</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-16"></a>  <span class="p">}</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-17"></a>  <span class="k">else</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-18"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'feedback'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">"An error has happened. Your feedback has not been sent."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_8662cb713ae34b2797cb452e6d3dc073-19"></a><span class="p">}</span>
</pre>
<p>Ahora una nota sobre el borrado: Si tratamos de borrar el nodo, veremos que se realiza sin problemas, pero eso no quiere decir que lo estemos haciendo BIEN. Se habrá borrado el nodo, pero no se habrá borrado la información asociada a nuestro feed, dejando basura inaccesible en la base de datos. Por eso implementaremos:</p>
<pre class="code php"><a name="rest_code_31695d9523a241f28110910d7ea39d22-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_31695d9523a241f28110910d7ea39d22-2"></a><span class="sd">/**</span>
<a name="rest_code_31695d9523a241f28110910d7ea39d22-3"></a><span class="sd">* Implementation of hook_delete</span>
<a name="rest_code_31695d9523a241f28110910d7ea39d22-4"></a><span class="sd">*/</span>
<a name="rest_code_31695d9523a241f28110910d7ea39d22-5"></a><span class="k">function</span> <span class="nf">feedback_delete</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<a name="rest_code_31695d9523a241f28110910d7ea39d22-6"></a><span class="p">{</span>
<a name="rest_code_31695d9523a241f28110910d7ea39d22-7"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"DELETE FROM {feedback_messages} where id=%d"</span><span class="p">;</span>
<a name="rest_code_31695d9523a241f28110910d7ea39d22-8"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<a name="rest_code_31695d9523a241f28110910d7ea39d22-9"></a><span class="p">}</span>
</pre>
<p>Con esto, queda obsoleto lo que implementamos en la cuarta entrega del curso para poder eliminar mensajes :-D. Claro, que también hay una serie de enlaces anticuados que nos están permitiendo crear feeds que no son nodos. Por estas razones, vamos a eliminar:</p>
<ul class="simple">
<li><code>feedback_delete_form_submit</code></li>
<li><code>feedback_delete_form</code></li>
<li><code>feedback_messageadmin_form_submit</code></li>
<li><code>feedback_messageadmin_form_submit</code></li>
<li><code>feedback_messageadmin_form</code></li>
</ul>
<p>Y vamos a cambiar los enlaces en <code>feedback_admin</code>:</p>
<pre class="code php"><a name="rest_code_e5e41fce96744cf38e584882c232e38f-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-2"></a><span class="k">function</span> <span class="nf">feedback_admin</span> <span class="p">(</span> <span class="nv">$messageid</span><span class="o">=</span><span class="k">null</span> <span class="p">)</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-3"></a><span class="p">{</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-4"></a>  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-5"></a>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-6"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageid</span> <span class="o">!=</span> <span class="k">null</span> <span class="p">)</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-7"></a>  <span class="p">{</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-8"></a>    <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">'feedback_messageadmin_form'</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-9"></a>    <span class="nv">$content</span> <span class="o">.=</span> <span class="s2">"&lt;hr/&gt;"</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-10"></a>  <span class="p">}</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-11"></a>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-12"></a>  <span class="nv">$header</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-13"></a>  <span class="p">(</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-14"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Date'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'indate'</span><span class="p">,</span> <span class="s1">'sort'</span> <span class="o">=&gt;</span> <span class="s1">'desc'</span><span class="p">),</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-15"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'User'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'name'</span><span class="p">),</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-16"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'email'</span><span class="p">),</span> <span class="s1">'field'</span><span class="o">=&gt;</span><span class="s1">'mail'</span><span class="p">),</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-17"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Message'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'message'</span><span class="p">),</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-18"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Read'</span><span class="p">),</span> <span class="s1">'field'</span><span class="o">=&gt;</span><span class="s1">'fm.read'</span><span class="p">),</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-19"></a>  <span class="p">);</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-20"></a>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-21"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT fm.id, u.uid as uid, u.name, fm.usermail, fm.indate, fm.message, fm.read FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid"</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-22"></a>  <span class="nv">$query</span> <span class="o">.=</span> <span class="nx">tablesort_sql</span> <span class="p">(</span> <span class="nv">$header</span> <span class="p">);</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-23"></a>  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-24"></a>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-25"></a>  <span class="nv">$rows</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-26"></a>  <span class="k">while</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">)</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-27"></a>  <span class="p">{</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-28"></a>    <span class="nv">$row</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-29"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'indate'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-30"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">'&lt;a href="?q=user/'</span><span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">.</span><span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span> <span class="o">:</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-31"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'mail'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-32"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-33"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-34"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'edit'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'edit'</span><span class="p">),</span> <span class="s2">"node/"</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span> <span class="s2">"/edit"</span><span class="p">);</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-35"></a>    <span class="nv">$rows</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-36"></a>  <span class="p">}</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-37"></a>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-38"></a>  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">theme_table</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$rows</span><span class="p">);</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-39"></a>  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_e5e41fce96744cf38e584882c232e38f-40"></a><span class="p">}</span>
</pre>
<p>Y lo más importante: ¡¡Ahora no podemos permitir que se cree un elemento <em>feedback</em> sin que sea un nodo!! Así que se tercian dos cambios: Cambiar el enlace del bloque (acordaos de limpiar la caché en Administration-&gt;performance) y eliminar el acceso del <code>hook_menu</code>:</p>
<pre class="code php"><a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-2"></a><span class="sd">/**</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-3"></a><span class="sd">* Implementation of hook_block().</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-4"></a><span class="sd">*/</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-5"></a><span class="k">function</span> <span class="nf">feedback_block</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">=</span> <span class="s1">'list'</span><span class="p">,</span> <span class="nv">$delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$edit</span> <span class="o">=</span> <span class="k">array</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-6"></a><span class="p">{</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-7"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">"list"</span><span class="p">)</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-8"></a>  <span class="p">{</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-9"></a>      <span class="nv">$blocks</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-10"></a>      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"info"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-11"></a>      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"info"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'New Feedbacks'</span><span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-12"></a>      <span class="k">return</span> <span class="nv">$blocks</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-13"></a>  <span class="p">}</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-14"></a>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">"view"</span> <span class="p">)</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-15"></a>  <span class="p">{</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-16"></a>      <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-17"></a>      <span class="nv">$block</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-18"></a>      <span class="k">switch</span> <span class="p">(</span> <span class="nv">$delta</span> <span class="p">)</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-19"></a>      <span class="p">{</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-20"></a>        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-21"></a>          <span class="nv">$block</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-22"></a>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-23"></a>          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"attributes"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"Sends a feedback message"</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-24"></a>          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"New Feedback"</span><span class="p">),</span> <span class="s2">"node/add/feedback"</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-25"></a>          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">'&lt;div class="link"&gt;'</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-26"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-27"></a>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-28"></a>          <span class="nv">$block</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback Messages'</span><span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-29"></a>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-30"></a>          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"attributes"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"Shows feedback messages"</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-31"></a>          <span class="nv">$title</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"There are @total new feeds"</span><span class="p">,</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'@total'</span> <span class="o">=&gt;</span> <span class="nx">_feedback_count</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-32"></a>          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nv">$title</span> <span class="p">,</span> <span class="s2">"feedback/adminmessages"</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-33"></a>          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">'&lt;div class="link"&gt;'</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-34"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-35"></a>      <span class="p">}</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-36"></a>      <span class="nv">$block</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-37"></a>      <span class="k">return</span> <span class="nv">$block</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-38"></a>  <span class="p">}</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-39"></a><span class="p">}</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-40"></a>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-41"></a><span class="sd">/**</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-42"></a><span class="sd">* Implementation of hook_menu().</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-43"></a><span class="sd">*/</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-44"></a><span class="k">function</span> <span class="nf">feedback_menu</span> <span class="p">(</span> <span class="p">)</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-45"></a><span class="p">{</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-46"></a>  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-47"></a>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-48"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/adminmessages'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-49"></a>  <span class="p">(</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-50"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Feedback admin'</span><span class="p">,</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-51"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_admin'</span><span class="p">,</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-52"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'view messages'</span><span class="p">),</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-53"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-54"></a>  <span class="p">);</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-55"></a>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-56"></a>  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<a name="rest_code_37b81cb79dcf43e3a3857165ca138ddd-57"></a><span class="p">}</span>
</pre>
</div>
</div>
<div class="section" id="drupal-7">
<h2>Drupal 7</h2>
<p>Mucho me temo que todo lo que cuento aquí es válido para Drupal 6, pero no para Drupal 7.</p>
<p>Hay tutoriales de cómo pasar de Drupal 6 a Drupal 7, y seguro que todo lo contado en esta parte del tutorial se verá afectado.</p>
</div>
<div class="section" id="mas-tutoriales">
<h2>Más tutoriales</h2>
<p>Tengo en mente hacer un tutorial más y terminar con toda la tanda. Lo que queda por ver es sencillo: aplicar _themes_ y añadir archivos de traducción. Si se os ocurre algo más, ¡¡decidlo ahora!!</p>
</div>
<div class="section" id="opinion-personal">
<h2>Opinión personal</h2>
<p>En muchos casos puede venir bien crear un módulo para drupal que gestiona nodos. Sin embargo, también es cierto que en este caso a mí, particulamente, me parece un problema. Al ser nodos, se verán afectados por los permisos de nodos, por lo que si en tu site no dejas crear contenido, se acabaron los feeds.</p>
<p>De todas maneras, me parecía interesante contarlo de esta manera, con el fin de que quede como una continuación y se aprenda a crear contenido para Drupal, que no es nada difícil</p>
</div>
<div class="section" id="id1">
<h2>Más tutoriales</h2>
<p>Este tutorial es la continuación de una serie de tutoriales relacionados con Drupal. Podéis consultar cualquiera de ellos:</p>
<ul class="simple">
<li><a class="reference external" href="/blog/creacion-modulo-drupal">Creación de un módulo drupal (I)</a></li>
<li><a class="reference external" href="/blog/creacion-modulo-drupal-2">Creación de un módulo drupal (II)</a></li>
<li><a class="reference external" href="/blog/creacion-modulo-drupal-4">Creación de un módulo drupal (III)</a></li>
<li><a class="reference external" href="/blog/drupal-expansors">Drupal: Creando contenido con 'expansors'</a></li>
<li><a class="reference external" href="/blog/critica-drupal">Crítica a Drupal</a></li>
<li><a class="reference external" href="/blog/drupal-tabla-perfecta">Tablas en Drupal: Haciendo la tabla perfecta</a></li>
</ul>
</div>
<div class="section" id="codigo">
<h2>Código</h2>
<p>Como en este caso no se ha modificado nada del @feedback.install@, pongo sólo el módulo principal:</p>
<div class="section" id="feedback-module">
<h3>feedback.module</h3>
<pre class="code php"><a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-2"></a><span class="cm">/*</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-3"></a><span class="cm">Copyright 2009-2010 Miguel Ángel García Martínez &lt;miguelangel.garcia@gmail.com&gt;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-4"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-5"></a><span class="cm">  'Feedback' is free software; you can redistribute it and/or modify</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-6"></a><span class="cm">it under the terms of the GNU General Public License as published by</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-7"></a><span class="cm">the Free Software Foundation; either version 3 of the License, or</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-8"></a><span class="cm">(at your option) any later version.</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-9"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-10"></a><span class="cm">  'Feedback' is distributed in the hope that it will be useful,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-11"></a><span class="cm">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-12"></a><span class="cm">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-13"></a><span class="cm">GNU General Public License for more details.</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-14"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-15"></a><span class="cm">  You should have received a copy of the GNU General Public License</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-16"></a><span class="cm">along with 'Feedback' (maybe in file "COPYING"); if not, write to the Free Software</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-17"></a><span class="cm">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-18"></a><span class="cm">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-19"></a><span class="sd">/**</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-20"></a><span class="sd">* Implements hook_help().</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-21"></a><span class="sd">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-22"></a><span class="k">function</span> <span class="nf">feedback_help</span> <span class="p">(</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$arg</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-23"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-24"></a>  <span class="nv">$output</span><span class="o">=</span><span class="s1">''</span><span class="p">;</span> <span class="c1">// para construir la salida</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-25"></a>  <span class="k">switch</span> <span class="p">(</span> <span class="nx">path</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-26"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-27"></a>    <span class="k">case</span> <span class="s1">'admin/help#feedback'</span><span class="o">:</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-28"></a>      <span class="nv">$output</span> <span class="o">.=</span> <span class="s1">'&lt;p&gt;'</span> <span class="o">.</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Módulo que permite la inserción de mensajes de feedback.'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;/p&gt;'</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-29"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-30"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-31"></a>  <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-32"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-33"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-34"></a><span class="sd">/**</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-35"></a><span class="sd">* Implements hook_perm().</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-36"></a><span class="sd">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-37"></a><span class="k">function</span> <span class="nf">feedback_perm</span> <span class="p">()</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-38"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-39"></a>  <span class="k">return</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'send message'</span><span class="p">,</span> <span class="s1">'view messages'</span><span class="p">,</span> <span class="s1">'admin messages'</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-40"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-41"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-42"></a><span class="sd">/**</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-43"></a><span class="sd">* Implements hook_access()</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-44"></a><span class="sd">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-45"></a><span class="k">function</span> <span class="nf">feedback_access</span> <span class="p">(</span> <span class="nv">$op</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-46"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-47"></a>  <span class="nv">$retval</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-48"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-49"></a>  <span class="k">switch</span> <span class="p">(</span> <span class="nv">$op</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-50"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-51"></a>    <span class="k">case</span> <span class="s1">'view'</span><span class="o">:</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-52"></a>      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">'view messages'</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-53"></a>    <span class="k">case</span> <span class="s1">'create'</span><span class="o">:</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-54"></a>      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">'send message'</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-55"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-56"></a>    <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-57"></a>      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">'admin messages'</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-58"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-59"></a>    <span class="k">case</span> <span class="s1">'delete'</span><span class="o">:</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-60"></a>      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">'admin messages'</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-61"></a>      <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-62"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-63"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-64"></a>  <span class="k">return</span> <span class="nv">$retval</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-65"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-66"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-67"></a><span class="sd">/**</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-68"></a><span class="sd">* Implements hook_node_info()</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-69"></a><span class="sd">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-70"></a><span class="k">function</span> <span class="nf">feedback_node_info</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-71"></a>  <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-72"></a>    <span class="s1">'feedback'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-73"></a>      <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-74"></a>      <span class="s1">'module'</span> <span class="o">=&gt;</span> <span class="s1">'feedback'</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-75"></a>      <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s2">"Handle a feedback message"</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-76"></a>    <span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-77"></a>  <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-78"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-79"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-80"></a><span class="sd">/**</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-81"></a><span class="sd">* Implementation of hook_block().</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-82"></a><span class="sd">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-83"></a><span class="k">function</span> <span class="nf">feedback_block</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">=</span> <span class="s1">'list'</span><span class="p">,</span> <span class="nv">$delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$edit</span> <span class="o">=</span> <span class="k">array</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-84"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-85"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">"list"</span><span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-86"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-87"></a>      <span class="nv">$blocks</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-88"></a>      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"info"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-89"></a>      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"info"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'New Feedbacks'</span><span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-90"></a>      <span class="k">return</span> <span class="nv">$blocks</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-91"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-92"></a>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">"view"</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-93"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-94"></a>      <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-95"></a>      <span class="nv">$block</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-96"></a>      <span class="k">switch</span> <span class="p">(</span> <span class="nv">$delta</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-97"></a>      <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-98"></a>        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-99"></a>          <span class="nv">$block</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-100"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-101"></a>          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"attributes"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"Sends a feedback message"</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-102"></a>          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"New Feedback"</span><span class="p">),</span> <span class="s2">"node/add/feedback"</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-103"></a>          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">'&lt;div class="link"&gt;'</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-104"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-105"></a>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-106"></a>          <span class="nv">$block</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback Messages'</span><span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-107"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-108"></a>          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">"attributes"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"Shows feedback messages"</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-109"></a>          <span class="nv">$title</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">"There are @total new feeds"</span><span class="p">,</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'@total'</span> <span class="o">=&gt;</span> <span class="nx">_feedback_count</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-110"></a>          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nv">$title</span> <span class="p">,</span> <span class="s2">"feedback/adminmessages"</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-111"></a>          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">'&lt;div class="link"&gt;'</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-112"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-113"></a>      <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-114"></a>      <span class="nv">$block</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-115"></a>      <span class="k">return</span> <span class="nv">$block</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-116"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-117"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-118"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-119"></a><span class="sd">/**</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-120"></a><span class="sd">* Implementation of hook_menu().</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-121"></a><span class="sd">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-122"></a><span class="k">function</span> <span class="nf">feedback_menu</span> <span class="p">(</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-123"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-124"></a>  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-125"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-126"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/adminmessages'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-127"></a>  <span class="p">(</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-128"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'Feedback admin'</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-129"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_admin'</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-130"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'view messages'</span><span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-131"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-132"></a>  <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-133"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-134"></a>  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-135"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-136"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-137"></a><span class="k">function</span> <span class="nf">feedback_message</span> <span class="p">()</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-138"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-139"></a>  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-140"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-141"></a>  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">'feedback_form'</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-142"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-143"></a>  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-144"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-145"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-146"></a><span class="k">function</span> <span class="nf">feedback_form</span> <span class="p">(</span> <span class="o">&amp;</span><span class="nv">$node</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-147"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-148"></a>  <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-149"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-150"></a>  <span class="nv">$title</span> <span class="o">=</span> <span class="nb">sprintf</span> <span class="p">(</span> <span class="s1">'Feed from %s'</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">name</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-151"></a>  <span class="nv">$mail</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-152"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-153"></a>  <span class="nv">$read</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-154"></a>  <span class="nv">$editing</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-155"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-156"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-157"></a>    <span class="nv">$mail</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-158"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-159"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-160"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-161"></a>    <span class="c1">// estamos editando</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-162"></a>    <span class="nv">$editing</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-163"></a>    <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-164"></a>    <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-165"></a>      <span class="c1">// estamos previsualizando datos</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-166"></a>      <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-167"></a>      <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-168"></a>      <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-169"></a>    <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-170"></a>    <span class="k">else</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-171"></a>    <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-172"></a>      <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT uid, message, indate, usermail, fm.read FROM {feedback_messages} fm WHERE id=%d"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-173"></a>      <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-174"></a>      <span class="nv">$storednode</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-175"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-176"></a>      <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-177"></a>      <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-178"></a>      <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-179"></a>    <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-180"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-181"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-182"></a>  <span class="nv">$form</span> <span class="p">[</span><span class="s1">'feedback'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-183"></a>    <span class="p">(</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-184"></a>      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-185"></a>      <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span> <span class="s1">'Feedback'</span> <span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-186"></a>      <span class="s1">'mail'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span><span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textfield'</span><span class="p">,</span> <span class="s2">"#title"</span><span class="o">=&gt;</span><span class="s2">"E-Mail"</span><span class="p">,</span> <span class="s2">"#description"</span><span class="o">=&gt;</span><span class="s2">"If you want any answer, please, tell me your mail. It would not be shown anywhere."</span><span class="p">,</span> <span class="s2">"#default_value"</span> <span class="o">=&gt;</span> <span class="nv">$mail</span> <span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-187"></a>      <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textarea'</span><span class="p">,</span> <span class="s2">"#description"</span><span class="o">=&gt;</span><span class="s2">"Write here your message"</span><span class="p">,</span> <span class="s1">'#default_value'</span><span class="o">=&gt;</span><span class="nv">$message</span> <span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-188"></a>      <span class="s1">'#required'</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-189"></a>    <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-190"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-191"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$editing</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-192"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-193"></a>    <span class="nv">$form</span> <span class="p">[</span><span class="s1">'feedback'</span><span class="p">][</span><span class="s1">'read'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'checkbox'</span><span class="p">,</span> <span class="s2">"#title"</span><span class="o">=&gt;</span><span class="s2">"The message has been read"</span><span class="p">,</span> <span class="s1">'#default_value'</span><span class="o">=&gt;</span><span class="nv">$read</span> <span class="p">)</span> <span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-194"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-195"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-196"></a>  <span class="nv">$form</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-197"></a>    <span class="p">(</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-198"></a>      <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'hidden'</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-199"></a>      <span class="s1">'#default_value'</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-200"></a>    <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-201"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-202"></a>  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-203"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-204"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-205"></a><span class="k">function</span> <span class="nf">feedback_insert</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-206"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-207"></a>  <span class="nv">$userid</span>  <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-208"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-209"></a>  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-210"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-211"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"INSERT into {feedback_messages} ( id, uid, message, indate, usermail ) values ( %d, %d, '%s', now(), '%s' ) "</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-212"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span><span class="p">,</span> <span class="nv">$userid</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$mail</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-213"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-214"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-215"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-216"></a>    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span> <span class="p">(</span> <span class="s2">"Thank you for your feedback."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-217"></a>    <span class="nx">drupal_goto</span> <span class="p">(</span> <span class="s1">'node'</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-218"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-219"></a>  <span class="k">else</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-220"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'feedback'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">"An error has happened. Your feedback has not been sent."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-221"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-222"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-223"></a><span class="k">function</span> <span class="nf">feedback_update</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-224"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-225"></a>  <span class="nv">$userid</span>  <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-226"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-227"></a>  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-228"></a>  <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-229"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-230"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE {feedback_messages} fm SET message='%s', usermail='%s', fm.read=%d where id=%d"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-231"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$mail</span><span class="p">,</span> <span class="nv">$read</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-232"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-233"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-234"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-235"></a>    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span> <span class="p">(</span> <span class="s2">"The feedback has been updated."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-236"></a>    <span class="nx">drupal_goto</span> <span class="p">(</span> <span class="s1">'node'</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-237"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-238"></a>  <span class="k">else</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-239"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'feedback'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">"An error has happened. Your feedback has not been sent."</span> <span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-240"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-241"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-242"></a><span class="sd">/**</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-243"></a><span class="sd">* Implementation of hook_delete</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-244"></a><span class="sd">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-245"></a><span class="k">function</span> <span class="nf">feedback_delete</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-246"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-247"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"DELETE FROM {feedback_messages} where id=%d"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-248"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-249"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-250"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-251"></a><span class="k">function</span> <span class="nf">feedback_validate</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-252"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-253"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-254"></a>  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-255"></a>  <span class="nv">$validmail</span> <span class="o">=</span> <span class="nb">preg_match</span> <span class="p">(</span><span class="s2">"/^[^0-9][A-z0-9_]+([.][A-z0-9_]+)*[@][A-z0-9_]+([.][A-z0-9_]+)*[.][A-z]{2,4}$/"</span> <span class="p">,</span> <span class="nv">$mail</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-256"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-257"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$mail</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-258"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'mail'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'You are not a registered user. Please, insert your e-mail.'</span><span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-259"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$mail</span> <span class="o">!=</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$validmail</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-260"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'mail'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'The mail does not like an e-mail address.'</span><span class="p">)</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-261"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">==</span> <span class="s1">''</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-262"></a>    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Message cannot be empty.'</span><span class="p">));</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-263"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-264"></a>  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-265"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-266"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-267"></a><span class="k">function</span> <span class="nf">feedback_view</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$teaser</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">,</span> <span class="nv">$page</span> <span class="o">=</span> <span class="k">FALSE</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-268"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-269"></a>  <span class="nv">$messageread</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-270"></a>  <span class="nv">$messagedata</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-271"></a>  <span class="nv">$messagename</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-272"></a>  <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-273"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-274"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-275"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-276"></a>    <span class="c1">// ya tenemos el mensaje. Puede deberse a que estamos editando.</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-277"></a>    <span class="nv">$messageread</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-278"></a>    <span class="nv">$messagedata</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-279"></a>    <span class="nv">$messagename</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-280"></a>    <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-281"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-282"></a>  <span class="k">else</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-283"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-284"></a>    <span class="c1">// tenemos que obtener el mensaje</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-285"></a>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT fm.uid, message, indate, usermail, u.name, fm.read FROM {feedback_messages} fm, {users} u WHERE id=%d and fm.uid=u.uid"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-286"></a>    <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-287"></a>    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-288"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-289"></a>    <span class="nv">$messageread</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-290"></a>    <span class="nv">$messagedata</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-291"></a>    <span class="nv">$messagename</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-292"></a>    <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-293"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-294"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-295"></a>  <span class="nv">$read</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-296"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageread</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-297"></a>    <span class="nv">$read</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">" and &lt;b&gt;already read&lt;/b&gt;"</span><span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-298"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-299"></a>  <span class="nv">$content</span>  <span class="o">=</span> <span class="nb">sprintf</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'&lt;blockquote&gt;&lt;i&gt;%s&lt;/i&gt;&lt;/blockquote&gt;&lt;p&gt;Sent by %s&lt;a href="mailto:%s"&gt;&amp;lt;%s&amp;gt;&lt;/a&gt;%s.&lt;/p&gt;'</span><span class="p">),</span> <span class="nv">$messagedata</span><span class="p">,</span> <span class="nv">$messagename</span><span class="p">,</span> <span class="nv">$messageusermail</span><span class="p">,</span> <span class="nv">$messageusermail</span><span class="p">,</span> <span class="nv">$read</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-300"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-301"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-302"></a>  <span class="nv">$node</span> <span class="o">=</span> <span class="nx">node_prepare</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$teaser</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-303"></a>  <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-304"></a>    <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-305"></a>    <span class="s1">'#weight'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-306"></a>  <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-307"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-308"></a>  <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-309"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-310"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-311"></a><span class="k">function</span> <span class="nf">feedback_admin</span> <span class="p">(</span> <span class="nv">$messageid</span><span class="o">=</span><span class="k">null</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-312"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-313"></a>  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-314"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-315"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageid</span> <span class="o">!=</span> <span class="k">null</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-316"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-317"></a>    <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">'feedback_messageadmin_form'</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-318"></a>    <span class="nv">$content</span> <span class="o">.=</span> <span class="s2">"&lt;hr/&gt;"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-319"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-320"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-321"></a>  <span class="nv">$header</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-322"></a>  <span class="p">(</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-323"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Date'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'indate'</span><span class="p">,</span> <span class="s1">'sort'</span> <span class="o">=&gt;</span> <span class="s1">'desc'</span><span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-324"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'User'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'name'</span><span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-325"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'email'</span><span class="p">),</span> <span class="s1">'field'</span><span class="o">=&gt;</span><span class="s1">'mail'</span><span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-326"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Message'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'message'</span><span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-327"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Read'</span><span class="p">),</span> <span class="s1">'field'</span><span class="o">=&gt;</span><span class="s1">'fm.read'</span><span class="p">),</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-328"></a>  <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-329"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-330"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT fm.id, u.uid as uid, u.name, fm.usermail, fm.indate, fm.message, fm.read FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-331"></a>  <span class="nv">$query</span> <span class="o">.=</span> <span class="nx">tablesort_sql</span> <span class="p">(</span> <span class="nv">$header</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-332"></a>  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-333"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-334"></a>  <span class="nv">$rows</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-335"></a>  <span class="k">while</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">)</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-336"></a>  <span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-337"></a>    <span class="nv">$row</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-338"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'indate'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-339"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">'&lt;a href="?q=user/'</span><span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">.</span><span class="s1">'"&gt;'</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">.</span> <span class="s1">'&lt;/a&gt;'</span> <span class="o">:</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-340"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'mail'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-341"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-342"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-343"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'edit'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'edit'</span><span class="p">),</span> <span class="s2">"node/"</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span> <span class="s2">"/edit"</span><span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-344"></a>    <span class="nv">$rows</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-345"></a>  <span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-346"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-347"></a>  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">theme_table</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$rows</span><span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-348"></a>  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-349"></a><span class="p">}</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-350"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-351"></a><span class="sd">/** Devuelve el número de feeds creados en la última semana</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-352"></a><span class="sd">*/</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-353"></a><span class="k">function</span> <span class="nf">_feedback_count</span> <span class="p">()</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-354"></a><span class="p">{</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-355"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT count(id) as total from {feedback_messages} fm where fm.read != 1 or isnull(fm.read)"</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-356"></a>  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-357"></a>  <span class="nv">$result</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-358"></a>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-359"></a>  <span class="k">return</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">total</span><span class="p">;</span>
<a name="rest_code_d57052f506ad4a0f81dce72be40ce1d9-360"></a><span class="p">}</span>
</pre>
</div>
</div>
</div>
          </div>
          <br><div>
            <nav><span class="author">
                <span class="glyphicon glyphicon-user"></span> 
                <span>Publicado:Miguel Ángel García</span>
              </span>
               

              
              <span class="dateline">
                <span class="glyphicon glyphicon-calendar"></span> 
                <time class="published dt-published" datetime="2010-05-11T00:00:00+00:00" title="2010-05-11">2010-05-11</time></span>
               
              <span class="tags">
                <span class="glyphicon glyphicon-tags"></span> 
                <a class="label label-primary p-category" href="/categories/drupal/" rel="tag">drupal</a>
              </span>
                      <ul class="pager">
<li class="previous">
              <a href="/blog/creacion-modulo-drupal-3/" rel="prev" title="Creación de un módulo Drupal III">
                <span class="glyphicon glyphicon-arrow-left"></span>
                Publicación anterior
              </a>
            </li>
            <li class="next">
              <a href="/blog/creacion-modulo-drupal/" rel="next" title="Creación de un módulo Drupal">
                Siguiente publicación
                <span class="glyphicon glyphicon-arrow-right"></span>
              </a>
            </li>
        </ul>
<div style="margin-left: auto; margin-right: auto;">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-1887364423515042" data-ad-slot="4236077264"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>
            </nav>
</div>
          <section class="comments"><h2>Comentarios</h2>
                            <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="magmax",
            disqus_url="http://magmax.org/blog/creacion-modulo-drupal-4/",
        disqus_title="Creaci\u00f3n de un m\u00f3dulo Drupal IV",
        disqus_identifier="cache/posts/creacion-modulo-drupal-4.html",
        disqus_config = function () {
            this.language = "es_ES";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


          </section></article><script>var disqus_shortname="magmax";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
      <aside class="sidebar col-md-3"><div>
<section class="panel panel-default"><div class="panel-body">
    <div id="recentcomments" class="dsq-widget">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:inline-block;width:180px;height:150px" data-ad-client="ca-pub-1887364423515042" data-ad-slot="7479875641"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
</div>
  </div>
</section>
</div>
          <div>
<section class="panel panel-default"><div class="panel-heading">
    <h3 class="panel-title">Last comments</h3>
  </div>
  <div class="panel-body">
    <div id="disqus_last_comments" class="dsq-widget">
      <script type="text/javascript" src="http://magmax.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=32&amp;excerpt_length=150">
      </script>
</div>
  </div>
</section>
</div>
          <div>
<section class="panel panel-default"><div class="panel-heading">
    <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="panel-body">
    <ul id="gh_repos" class="list-unstyled">
<li class="loading">Status updating…</li>
    </ul>
</div>
  <div class="panel-footer">
    <a href="https://github.com/magmax">@magmax</a> on GitHub
  </div>
</section>
</div>
      </aside>
</div>

    <footer>
      Contents © 2009-2016 <a href="mailto:">Miguel Ángel García</a> 
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.5/es/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;width:80px;height:15px;vertical-align:middle" src="https://i.creativecommons.org/l/by-nc-sa/2.5/es/80x15.png"></a>; Using <a href="/stories/credits/">a lot of free software</a>
      
    </footer>
</div>
</div>




<a href="http://www.addthis.com/bookmark.php?v=250" id="addthisbox" class="addthis_button" src="http://s7.addthis.com/static/btn/v2/lg-share-en.gif" width="125" height="16" border="0" alt="Share">
<script data-main="/assets/js/main" src="/assets/js/libs/require/require.min.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-9308241-3', 'auto');
  ga('send', 'pageview');

</script></a>
</body>
</html>
