<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="max-age=43200">
<meta http-equiv="ETag" content="b'e6d9a3a6436868cc37f2adc95962bbff925af33b'">
<title>Creación de un módulo Drupal II | MagMax Blog</title>
<link href="/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="/assets/css/code.css" rel="stylesheet" type="text/css">
<link href="/assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="/assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="/assets/css/custom.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/magmax">
<link rel="canonical" href="http://magmax.org/blog/creacion-modulo-drupal-2/">
<link rel="icon" href="/favicon.ico" sizes="16x16">
<link rel="icon" href="/favicon_330.png" sizes="330x330">
<link rel="icon" href="/favicon.png" sizes="128x128">
<meta name="author" content="Miguel Ángel García">
<link rel="prev" href="/blog/tarta-manzana/" title="Tarta de manzana" type="text/html">
<link rel="next" href="/blog/creacion-modulo-drupal-3/" title="Creación de un módulo Drupal III" type="text/html">
<meta property="og:site_name" content="MagMax Blog">
<meta property="og:title" content="Creación de un módulo Drupal II">
<meta property="og:url" content="http://magmax.org/blog/creacion-modulo-drupal-2/">
<meta property="og:description" content='Tomando como referencia el tutorial Creación de un módulo Drupal, vamos a añadirle la posibilidad de "ver" los comentarios, marcándolos como leídos.


Qué se explica aquí
En esta ocasión veremos cómo:'>
<meta property="og:type" content="article">
<meta property="article:author" content="Miguel Ángel García">
<meta property="article:published_time" content="2010-05-11T00:00:00+00:00">
<meta property="article:updated" content="2010-05-11T00:00:00">
<meta property="article:tag" content="drupal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@magmax_en">
<meta name="twitter:creator" content="@magmax">
<meta name="twitter:title" content="MagMax Blog">
<meta name="twitter:description" content="El blog de un Ingeniero Informático: tutoriales, manuales, opiniones, comparativas, ...">
<meta name="twitter:url" content="http://magmax.org//blog/creacion-modulo-drupal-2/">
<meta name="twitter:image" content="http://magmax.org/favicon.png">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Ir al contenido principal</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container">
<!-- This keeps the margins nice -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://magmax.org/">

        <span id="blog-title">MagMax Blog</span>
      </a>
    </div>
<!-- /.navbar-header -->
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav">
<li>
<a href="/">Inicio</a>
                </li>
<li>
<a href="/archive.html">Archivo</a>
                </li>
<li>
<a href="/categories">Categorías</a>
                </li>
<li>
<a href="/projects">Proyectos</a>
                </li>
<li>
<a href="/news">Posts Externos</a>

        
      </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
<form class="navbar-form navbar-left" role="search" action="http://google.com/search" method="get">
<div class="form-group">
<input type="hidden" name="sitesearch" value="magmax.org"><input type="text" name="q" class="form-control" placeholder="Search / Buscar">
</div>
</form>
</li>

        <li style="margin-left:0">
          <a href="http://feeds.feedburner.com/magmax">
            <img src="/assets/images/rss.png" style="width:22px;height:22px"></a>
        </li>

        
      </ul>
</div>
<!-- /.navbar-collapse -->
  </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
  <div class="body-content">
    <div class="row">
      <div class="page-content col-md-9">
        
        <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="/blog/creacion-modulo-drupal-2/" class="u-url">Creación de un módulo Drupal II</a></h1>
            <div class="metadata text-muted">
              <i class="glyphicon glyphicon-calendar"></i>
              <p class="dateline">
                <time class="published dt-published" datetime="2010-05-11T00:00:00+00:00" title="2010-05-11">2010-05-11</time>
                // <time class="updated dt-updated" datetime="2010-05-11T00:00:00" title="2010-05-11">2010-05-11</time></p>
              <p class="commentline">            <a href="/blog/creacion-modulo-drupal-2/#disqus_thread" data-disqus-identifier="cache/posts/creacion-modulo-drupal-2.html">Comments</a>

</p>
              <address class="vcard author"><a class="url fn" href="http://magmax.org">Miguel Ángel García</a></address>
            </div>
            <br></header><div class="e-content entry-content" itemprop="articleBody text">
            <div>
<p>Tomando como referencia el tutorial <a class="reference external" href="/blog/creacion-modulo-drupal">Creación de un módulo Drupal</a>, vamos a añadirle la posibilidad de "ver" los comentarios, marcándolos como leídos.</p>
<!-- TEASER_END -->
<div class="section" id="que-se-explica-aqui">
<h2>Qué se explica aquí</h2>
<p>En esta ocasión veremos cómo:</p>
<ul class="simple">
<li>Actualizar la base de datos</li>
<li>Crear enlaces desde una tabla</li>
<li>Crear un formulario de edición para una tabla.</li>
<li>Entraremos un poquito más en profundidad en algunos temas.</li>
</ul>
</div>
<div class="section" id="notas-previas">
<h2>Notas previas</h2>
<p>En la primera parte del tutorial ya traté de inculcaros que sólo se debe abrir el tag de <code>&lt;?php</code>, y no se debe cerrar con <code>?&gt;</code>. En esta ocasión no seré tan pesado.</p>
<p>El primer tutorial fue algo rápido, ya que era muy largo. En los próximos tutoriales, iré ampliando conceptos para que podáis desarrollar vuestros propios módulos. Prometo que serán más cortos.</p>
</div>
<div class="section" id="modificando-la-bbdd">
<h2>Modificando la BBDD</h2>
<p>Nuestro primer problema es que la base de datos va a cambiar. Necesitamos una columna nueva para la tabla feedback_messages, llamada "read", (de 'leído'). Va a ser un booleano. Como tenemos nuestro plugin en producción, no nos apetece tener que estar desinstalándolo, instalándolo de nuevo, etc, perdiendo todos los comentarios que nos hayan puesto. Otra opción es modificar la base de datos a mano, pero no deja de ser igual de tedioso, y no podemos pedirles a nuestros usuarios que lo hagan así.</p>
<p>Vamos a hacerlo bien, editando <code>feedback.install</code> y añadiendo lo siguiente:</p>
<pre class="code php"><a name="rest_code_08021d60853740f79fe042e43cc19bae-1"></a><span class="x">function feedback_update_6100() {</span>
<a name="rest_code_08021d60853740f79fe042e43cc19bae-2"></a><span class="x">  $ret = array();</span>
<a name="rest_code_08021d60853740f79fe042e43cc19bae-3"></a><span class="x">  db_add_field($ret, 'feedback_messages', 'read', array('type' =&gt; 'int', 'size' =&gt; 'tiny'));</span>
<a name="rest_code_08021d60853740f79fe042e43cc19bae-4"></a><span class="x">  return $ret;</span>
<a name="rest_code_08021d60853740f79fe042e43cc19bae-5"></a><span class="x">}</span>
</pre>
<p>En la función <code>virtualcoin_schema</code> que creamos en la primera parte, lo que hicimos fue crear un enorme array de arrays. Realmente se le llama <em>"schema"</em>, ya que es el esquema de nuestra base de datos. Podríamos haber usado sentencias SQL, pero el uso de este esquema nos permite ser independientes de la base de datos que use el futuro usuario de nuestro módulo.</p>
<p>En este caso, completamos el schema añadiéndole la columna nueva, que, como veréis, no es booleana como dije. Eso es porque el tipo booleano no existe en Drupal. Podéis consultar la <a class="reference external" href="http://drupal.org/node/159605">lista de tipos drupal</a>.</p>
<p>La función se llama <code>feedback_update_6100</code>, ya que es del módulo "feedback", es un "update", para la versión 6 de drupal y es el que debe ejecutarse en primer lugar, si es que tuviéramos más actualizaciones que aplicar. No me voy a detener a explicar <a class="reference external" href="http://api.drupal.org/api/function/hook_update_N/6">el por qué de los numeritos</a>.</p>
<p>Después es necesario irnos a "update.php" y seguir las instrucciones. Con eso se nos actualizarán los módulos (en este caso, nuestro módulo) y tendremos la tabla actualizada.</p>
</div>
<div class="section" id="modificando-los-menus">
<h2>Modificando los menús</h2>
<p>Vamos a modificar el <code>hook_menu</code>.</p>
<p>Como ODIO que me pongan sólo parte de una función, os pego el código entero:</p>
<pre class="code php"><a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-2"></a><span class="sd">/**</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-3"></a><span class="sd">* Implementation of hook_menu().</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-4"></a><span class="sd">*/</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-5"></a><span class="k">function</span> <span class="nf">feedback_menu</span> <span class="p">(</span> <span class="p">)</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-6"></a><span class="p">{</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-7"></a>  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-8"></a>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-9"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/message'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-10"></a>  <span class="p">(</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-11"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback'</span><span class="p">),</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-12"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_message'</span><span class="p">,</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-13"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'send message'</span><span class="p">),</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-14"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-15"></a>  <span class="p">);</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-16"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/adminmessages/%'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-17"></a>  <span class="p">(</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-18"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback Admin'</span><span class="p">),</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-19"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_admin'</span><span class="p">,</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-20"></a>    <span class="s1">'page arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">),</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-21"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'view messages'</span><span class="p">),</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-22"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-23"></a>  <span class="p">);</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-24"></a>  <span class="nv">$items</span><span class="p">[</span><span class="s1">'feedback/adminmessages'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-25"></a>  <span class="p">(</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-26"></a>    <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Feedback Admin'</span><span class="p">),</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-27"></a>    <span class="s1">'page callback'</span> <span class="o">=&gt;</span> <span class="s1">'feedback_admin'</span><span class="p">,</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-28"></a>    <span class="s1">'access arguments'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'view messages'</span><span class="p">),</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-29"></a>    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-30"></a>  <span class="p">);</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-31"></a>  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<a name="rest_code_38ac2e79af914fbb829b42f11007c6a4-32"></a><span class="p">}</span>
</pre>
<p>Hay dos cambios respecto de la original. ¿Los véis? ¿No?</p>
<p>El primero consiste en el nombre del menú. Antes era <code>feedback/adminmessages</code>, y ahora <code>feedback/adminmessages/%</code>. Drupal irá tratando de encajar la ruta que hayan insertado con alguno de los patrones; el porcentaje (%) es como decir: <em>cualquier cosa</em>. En este caso, encajará con cualquier cosa que tenga: <cite>feedback/adminmessages/</cite> y algo más (ojo, ya que no encaja si no tiene nada más).</p>
<p>El segundo cambio es la opción <code>page arguments</code>. Le asignamos el valor <code>array (2)</code>:. Eso implica tomar la 3ª parte de la ruta y meterla en un vector que se le pasará a nuestra función.</p>
<p>Voy a explicarlo con un ejemplo. El usuario pone la ruta <cite>feedback/adminmessages/25</cite>. Por lo tanto, si ponemos el valor de <code>page arguments</code> a 0, obtendremos <cite>feedback</cite>; a 1, <cite>adminmessages</cite> y a 2, "25", que es justo lo que queremos.</p>
<p>¿Qué ocurre si el usuario pone <cite>feedback/adminmessages/25/añsldfj</cite>? Pues que vuelve a encajar en el patrón dado (a falta de otro mejor), y se trataría exactamente igual que el ejemplo anterior (la parte <em>añsldfj</em> ignorará).</p>
<p>Dejamos también la parte que existía antes, con el fin de poder pintar también algo cuando no se ha seleccionado un mensaje.</p>
</div>
<div class="section" id="modificando-funciones">
<h2>Modificando funciones</h2>
<p>Bueno, pues ya tenemos modificados los menus, así que vamos a modificar también las funciones.</p>
<p>Comenzamos por la función <code>feedback_admin</code>. En esta función vamos a hacer tres cambios:</p>
<pre class="code php"><a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-2"></a><span class="k">function</span> <span class="nf">feedback_admin</span> <span class="p">(</span> <span class="nv">$messageid</span><span class="o">=</span><span class="k">null</span> <span class="p">)</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-3"></a><span class="p">{</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-4"></a>  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-5"></a>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-6"></a>  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageid</span> <span class="o">!=</span> <span class="k">null</span> <span class="p">)</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-7"></a>  <span class="p">{</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-8"></a>    <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">'feedback_messageadmin_form'</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-9"></a>    <span class="nv">$content</span> <span class="o">.=</span> <span class="s2">""</span><span class="p">;</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-10"></a>  <span class="p">}</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-11"></a>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-12"></a>  <span class="nv">$header</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-13"></a>  <span class="p">(</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-14"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Date'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'indate'</span><span class="p">,</span> <span class="s1">'sort'</span> <span class="o">=&gt;</span> <span class="s1">'desc'</span><span class="p">),</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-15"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'User'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'name'</span><span class="p">),</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-16"></a>    <span class="k">array</span><span class="p">(</span><span class="s1">'data'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Message'</span><span class="p">),</span> <span class="s1">'field'</span> <span class="o">=&gt;</span> <span class="s1">'message'</span><span class="p">),</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-17"></a>  <span class="p">);</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-18"></a>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-19"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT fm.id, u.name, fm.indate, fm.message FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid"</span><span class="p">;</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-20"></a>  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-21"></a>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-22"></a>  <span class="nv">$rows</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-23"></a>  <span class="k">while</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">)</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-24"></a>  <span class="p">{</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-25"></a>    <span class="nv">$row</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-26"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-27"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'indate'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span><span class="p">;</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-28"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-29"></a>    <span class="nv">$row</span><span class="p">[</span><span class="s1">'edit'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'edit'</span><span class="p">),</span> <span class="s2">"feedback/adminmessages/"</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">id</span> <span class="p">);</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-30"></a>    <span class="nv">$rows</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-31"></a>  <span class="p">}</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-32"></a>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-33"></a>  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">theme_table</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$rows</span><span class="p">);</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-34"></a>  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<a name="rest_code_7d5da5ca941a475593f676a1b1c43fe5-35"></a><span class="p">}</span>
</pre>
<p>En primer lugar, hemos añadido un parámetro con un valor por defecto.</p>
<p>En segundo lugar, se añade la comprobación para saber si a la función se le llamó con algún parámetro (en caso contario, habría obtenido el valor por defecto, que es <code>NULL</code>). Si es así, pintamos un formulario (más adelante).</p>
<p>Y para finalizar, le hemos añadido una nueva fila a cada elemento de la lista, de manera que se creen enlaces a la dirección <code>feedback/adminmessages/</code> seguida del id del mensaje a mostrar.</p>
<p><strong>NOTA:</strong> ¿Qué ocurre si un usuario malicioso trata de escribir esta dirección sin tener permisos? No tenemos que preocuparnos. Recordad que al definir los menús (apartado anterior) establecimos los permisos.</p>
<p>Claro, la función anterior nos está pidiendo a gritos que implementemos el formulario que nos falta y que, por ser un formulario, requiere también de un submit:</p>
<pre class="code php"><a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-2"></a><span class="k">function</span> <span class="nf">feedback_messageadmin_form</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$messageid</span> <span class="p">)</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-3"></a><span class="p">{</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-4"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT fm.message, fm.read, fm.indate, u.name FROM {feedback_messages} fm, {users} u WHERE fm.id=%d and u.uid=fm.uid"</span><span class="p">;</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-5"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-6"></a>  <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-7"></a>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-8"></a>  <span class="nv">$form</span> <span class="o">=</span> <span class="k">array</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-9"></a>    <span class="p">(</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-10"></a>      <span class="s1">'feedback'</span> <span class="o">=&gt;</span> <span class="k">array</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-11"></a>      <span class="p">(</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-12"></a>        <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'fieldset'</span><span class="p">,</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-13"></a>        <span class="s1">'#title'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span> <span class="s1">'Feedback from '</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">.</span> <span class="s1">' sended on '</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span> <span class="p">),</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-14"></a>        <span class="s1">'messageid'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'hidden'</span><span class="p">,</span> <span class="s2">"#default_value"</span> <span class="o">=&gt;</span> <span class="nv">$messageid</span> <span class="p">),</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-15"></a>        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'textarea'</span><span class="p">,</span> <span class="s2">"#default_value"</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span> <span class="s2">"#disabled"</span> <span class="o">=&gt;</span> <span class="k">TRUE</span> <span class="p">),</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-16"></a>        <span class="s1">'read'</span>  <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span><span class="o">=&gt;</span> <span class="s1">'checkbox'</span><span class="p">,</span> <span class="s2">"#title"</span> <span class="o">=&gt;</span> <span class="s2">"Read"</span><span class="p">,</span><span class="s2">"#default_value"</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span> <span class="p">),</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-17"></a>        <span class="s1">'submit'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'#type'</span> <span class="o">=&gt;</span> <span class="s1">'submit'</span><span class="p">,</span>  <span class="s1">'#value'</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">'Submit'</span><span class="p">),</span>  <span class="p">),</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-18"></a>      <span class="p">),</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-19"></a>    <span class="p">);</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-20"></a>    <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-21"></a><span class="p">}</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-22"></a>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-23"></a><span class="k">function</span> <span class="nf">feedback_messageadmin_form_submit</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-24"></a><span class="p">{</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-25"></a>  <span class="nv">$messageid</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">'values'</span><span class="p">][</span><span class="s1">'messageid'</span><span class="p">];</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-26"></a>  <span class="nv">$read</span>      <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">'values'</span><span class="p">][</span><span class="s1">'read'</span><span class="p">];</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-27"></a>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-28"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE {feedback_messages} fm set fm.read=%d where fm.id=%d"</span><span class="p">;</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-29"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$read</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
<a name="rest_code_439f45bb986d43e887b6617f65e6e3a2-30"></a><span class="p">}</span>
</pre>
<p>Una explicación breve: Hemos creado un formulario con un campo oculto (<code>messageid</code>) para albergar el id del mensaje. Además, añadimos el propio mensaje en un textarea deshabilitado, con el fin de que no se pueda modificar. Por último, añadimos un checkbox para marcar como leído, que es lo que puede hacer el administrador. Bueno, claro: y el botón de submit.</p>
<p>En este caso no hemos implementado un hook_validate debido a lo sencillo que era el formulario (en un formulario con un único checkbox es difícil hacer marranadas), pero sí hemos implementado el <code>hook_submit</code>, que tan sólo actualiza el mensaje en cuestión.</p>
<p>Y, para ya dejarlo todo niquelao, vamos a modificar la función que obtenía el número de mensajes a ver. Antes era tan cutre que mostraba todos los que tuvieran menos de una semana. Ahora podemos hacer que muestre los que no hemos marcado como leídos:</p>
<pre class="code php"><a name="rest_code_1bec4361efde4f8ab909d6e4d5a87895-1"></a><span class="cp">&lt;?php</span>
<a name="rest_code_1bec4361efde4f8ab909d6e4d5a87895-2"></a><span class="k">function</span> <span class="nf">_feedback_count</span> <span class="p">()</span>
<a name="rest_code_1bec4361efde4f8ab909d6e4d5a87895-3"></a><span class="p">{</span>
<a name="rest_code_1bec4361efde4f8ab909d6e4d5a87895-4"></a>  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT count(id) as total from {feedback_messages} fm where fm.read != 1"</span><span class="p">;</span>
<a name="rest_code_1bec4361efde4f8ab909d6e4d5a87895-5"></a>  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
<a name="rest_code_1bec4361efde4f8ab909d6e4d5a87895-6"></a>  <span class="nv">$result</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">;</span>
<a name="rest_code_1bec4361efde4f8ab909d6e4d5a87895-7"></a>  <span class="k">return</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">total</span><span class="p">;</span>
<a name="rest_code_1bec4361efde4f8ab909d6e4d5a87895-8"></a><span class="p">}</span>
</pre>
</div>
<div class="section" id="mas-tutoriales">
<h2>Más tutoriales</h2>
<p>Este tutorial es la continuación de <a class="reference external" href="/blog/creacion-modulo-drupal">Creación de un módulo Drupal</a>, Además, podéis continuar el tutorial en:</p>
<ul class="simple">
<li><a class="reference external" href="/blog/creacion-modulo-drupal-3">Creación de un módulo drupal (III)</a></li>
<li><a class="reference external" href="/blog/creacion-modulo-drupal-4">Creación de un módulo drupal (IV)</a></li>
<li><a class="reference external" href="/blog/drupal-expansors">Drupal: Creando contenido con 'expansors'</a></li>
<li><a class="reference external" href="/blog/critica-drupal">Crítica a Drupal</a></li>
<li><a class="reference external" href="/blog/drupal-tabla-perfecta">Tablas en Drupal: Haciendo la tabla perfecta</a></li>
</ul>
</div>
</div>
          </div>
          <br><div>
            <nav><span class="author">
                <span class="glyphicon glyphicon-user"></span> 
                <span>Publicado:Miguel Ángel García</span>
              </span>
               

              
              <span class="dateline">
                <span class="glyphicon glyphicon-calendar"></span> 
                <time class="published dt-published" datetime="2010-05-11T00:00:00+00:00" title="2010-05-11">2010-05-11</time></span>
               
              <span class="tags">
                <span class="glyphicon glyphicon-tags"></span> 
                <a class="label label-primary p-category" href="/categories/drupal/" rel="tag">drupal</a>
              </span>
                      <ul class="pager">
<li class="previous">
              <a href="/blog/tarta-manzana/" rel="prev" title="Tarta de manzana">
                <span class="glyphicon glyphicon-arrow-left"></span>
                Publicación anterior
              </a>
            </li>
            <li class="next">
              <a href="/blog/creacion-modulo-drupal-3/" rel="next" title="Creación de un módulo Drupal III">
                Siguiente publicación
                <span class="glyphicon glyphicon-arrow-right"></span>
              </a>
            </li>
        </ul>
<div style="margin-left: auto; margin-right: auto;">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-1887364423515042" data-ad-slot="4236077264"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>
            </nav>
</div>
          <section class="comments"><h2>Comentarios</h2>
                            <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="magmax",
            disqus_url="http://magmax.org/blog/creacion-modulo-drupal-2/",
        disqus_title="Creaci\u00f3n de un m\u00f3dulo Drupal II",
        disqus_identifier="cache/posts/creacion-modulo-drupal-2.html",
        disqus_config = function () {
            this.language = "es_ES";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


          </section></article><script>var disqus_shortname="magmax";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
      <aside class="sidebar col-md-3"><div>
<section class="panel panel-default"><div class="panel-body">
    <div id="recentcomments" class="dsq-widget">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:inline-block;width:180px;height:150px" data-ad-client="ca-pub-1887364423515042" data-ad-slot="7479875641"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
</div>
  </div>
</section>
</div>
          <div>
<section class="panel panel-default"><div class="panel-heading">
    <h3 class="panel-title">Last comments</h3>
  </div>
  <div class="panel-body">
    <div id="disqus_last_comments" class="dsq-widget">
      <script type="text/javascript" src="http://magmax.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=0&amp;avatar_size=32&amp;excerpt_length=150">
      </script>
</div>
  </div>
</section>
</div>
          <div>
<section class="panel panel-default"><div class="panel-heading">
    <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="panel-body">
    <ul id="gh_repos" class="list-unstyled">
<li class="loading">Status updating…</li>
    </ul>
</div>
  <div class="panel-footer">
    <a href="https://github.com/magmax">@magmax</a> on GitHub
  </div>
</section>
</div>
      </aside>
</div>

    <footer>
      Contents © 2009-2020 <a href="mailto:">Miguel Ángel García</a> 
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.5/es/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;width:80px;height:15px;vertical-align:middle" src="https://i.creativecommons.org/l/by-nc-sa/2.5/es/80x15.png"></a>; Using <a href="/stories/credits/">a lot of free software</a>
      
    </footer>
</div>
</div>




<a href="http://www.addthis.com/bookmark.php?v=250" id="addthisbox" class="addthis_button" src="http://s7.addthis.com/static/btn/v2/lg-share-en.gif" width="125" height="16" border="0" alt="Share">
<script data-main="/assets/js/main" src="/assets/js/libs/require/require.min.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-9308241-3', 'auto');
  ga('send', 'pageview');

</script></a>
</body>
</html>
