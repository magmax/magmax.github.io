<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Creación de un módulo Drupal II - El blog de MagMax</title><meta name="Description" content="El blog de un Ingeniero Informático: tutoriales, manuales, opiniones, comparativas, ..."><meta property="og:title" content="Creación de un módulo Drupal II" />
<meta property="og:description" content="Tomando como referencia el tutorial Creación de un módulo Drupal, vamos a añadirle la posibilidad de &ldquo;ver&rdquo; los comentarios, marcándolos como leídos." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/creacion-modulo-drupal-2/" /><meta property="og:image" content="https://magmax.org/icons/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2010-05-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-28T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://magmax.org/icons/favicon.png"/>

<meta name="twitter:title" content="Creación de un módulo Drupal II"/>
<meta name="twitter:description" content="Tomando como referencia el tutorial Creación de un módulo Drupal, vamos a añadirle la posibilidad de &ldquo;ver&rdquo; los comentarios, marcándolos como leídos."/>
<meta name="application-name" content="El blog de MagMax">
<meta name="apple-mobile-web-app-title" content="El blog de MagMax"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://magmax.org/blog/creacion-modulo-drupal-2/" /><link rel="prev" href="https://magmax.org/blog/creacion-modulo-drupal-3/" /><link rel="next" href="https://magmax.org/blog/creacion-modulo-drupal/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Creación de un módulo Drupal II",
        "inLanguage": "es",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/magmax.org\/blog\/creacion-modulo-drupal-2\/"
        },"genre": "posts","keywords": "drupal","wordcount":  1497 ,
        "url": "https:\/\/magmax.org\/blog\/creacion-modulo-drupal-2\/","datePublished": "2010-05-11T00:00:00+00:00","dateModified": "2021-01-28T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Miguel Ángel"},"author": {
                "@type": "Person",
                "name": "Miguel Ángel"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="El blog de MagMax"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon.png"
        data-srcset="/icons/favicon.png, /icons/favicon.png 1.5x, /icons/favicon.png 2x"
        data-sizes="auto"
        alt="/icons/favicon.png"
        title="/icons/favicon.png" />MagMax Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> Inicio </a><a class="menu-item" href="/tags"> Tags </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Selecciona el lenguage">Español<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/blog/creacion-modulo-drupal-2/" selected>Español</option></select>
                    </a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="El blog de MagMax"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon.png"
        data-srcset="/icons/favicon.png, /icons/favicon.png 1.5x, /icons/favicon.png 2x"
        data-sizes="auto"
        alt="/icons/favicon.png"
        title="/icons/favicon.png" />MagMax Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="">Inicio</a><a class="menu-item" href="/tags" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Selecciona el lenguage">Español<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/blog/creacion-modulo-drupal-2/" selected>Español</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contenido</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Creación de un módulo Drupal II</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Miguel Ángel</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="11 May 2010">11 May 2010</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1497 palabras&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;8 minutos&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contenido</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#qué-se-explica-aquí">Qué se explica aquí</a></li>
    <li><a href="#notas-previas">Notas previas</a></li>
    <li><a href="#modificando-la-bbdd">Modificando la BBDD</a></li>
    <li><a href="#modificando-los-menús">Modificando los menús</a></li>
    <li><a href="#modificando-funciones">Modificando funciones</a></li>
    <li><a href="#más-tutoriales">Más tutoriales</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Tomando como referencia el tutorial <a href="https://magmax.org/blog/creacion-modulo-drupal/" rel="">Creación de un módulo Drupal</a>, vamos a añadirle la posibilidad de &ldquo;ver&rdquo; los comentarios, marcándolos como leídos.</p>
<figure><img src="/images/drupal.png"
         alt="Drupal"/>
</figure>

<h2 id="qué-se-explica-aquí">Qué se explica aquí</h2>
<p>En esta ocasión veremos cómo:</p>
<ul>
<li>Actualizar la base de datos</li>
<li>Crear enlaces desde una tabla</li>
<li>Crear un formulario de edición para una tabla.</li>
<li>Entraremos un poquito más en profundidad en algunos temas.</li>
</ul>
<h2 id="notas-previas">Notas previas</h2>
<p>En la primera parte del tutorial ya traté de inculcaros que sólo se debe abrir el tag de <code>&lt;?php</code>, y no se debe cerrar con <code>?&gt;</code>. En esta ocasión no seré tan pesado.</p>
<p>El primer tutorial fue algo rápido, ya que era muy largo. En los próximos tutoriales, iré ampliando conceptos para que podáis desarrollar vuestros propios módulos. Prometo que serán más cortos.</p>
<h2 id="modificando-la-bbdd">Modificando la BBDD</h2>
<p>Nuestro primer problema es que la base de datos va a cambiar. Necesitamos una columna nueva para la tabla feedback_messages, llamada &ldquo;read&rdquo;, (de &lsquo;leído&rsquo;). Va a ser un booleano. Como tenemos nuestro plugin en producción, no nos apetece tener que estar desinstalándolo, instalándolo de nuevo, etc, perdiendo todos los comentarios que nos hayan puesto. Otra opción es modificar la base de datos a mano, pero no deja de ser igual de tedioso, y no podemos pedirles a nuestros usuarios que lo hagan así.</p>
<p>Vamos a hacerlo bien, editando <code>feedback.install</code> y añadiendo lo siguiente:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">feedback_update_6100</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="nx">db_add_field</span><span class="p">(</span><span class="nv">$ret</span><span class="p">,</span> <span class="s1">&#39;feedback_messages&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;tiny&#39;</span><span class="p">));</span>
  <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>En la función <code>virtualcoin_schema</code> que creamos en la primera parte, lo que
hicimos fue crear un enorme array de arrays. Realmente se le llama <em>&ldquo;schema&rdquo;</em>,
ya que es el esquema de nuestra base de datos. Podríamos haber usado sentencias
SQL, pero el uso de este esquema nos permite ser independientes de la base de
datos que use el futuro usuario de nuestro módulo.</p>
<p>En este caso, completamos el schema añadiéndole la columna nueva, que, como
veréis, no es booleana como dije. Eso es porque el tipo booleano no existe en
Drupal. Podéis consultar la <a href="https://drupal.org/node/159605" target="_blank" rel="noopener noreffer">lista de tipos drupal</a>.</p>
<p>La función se llama <code>feedback_update_6100</code>, ya que es del módulo
&ldquo;feedback&rdquo;, es un &ldquo;update&rdquo;, para la versión 6 de drupal y es el que debe
ejecutarse en primer lugar, si es que tuviéramos más actualizaciones que
aplicar. No me voy a detener a explicar <a href="https://api.drupal.org/api/function/hook_update_N/6" target="_blank" rel="noopener noreffer">el por qué de los numeritos</a>.</p>
<p>Después es necesario irnos a &ldquo;update.php&rdquo; y seguir las instrucciones. Con eso se nos actualizarán los módulos (en este caso, nuestro módulo) y tendremos la tabla actualizada.</p>
<h2 id="modificando-los-menús">Modificando los menús</h2>
<p>Vamos a modificar el <code>hook_menu</code>.</p>
<p>Como ODIO que me pongan sólo parte de una función, os pego el código entero:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="sd">/**
</span><span class="sd">* Implementation of hook_menu().
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_menu</span> <span class="p">(</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

  <span class="nv">$items</span><span class="p">[</span><span class="s1">&#39;feedback/message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
  <span class="p">(</span>
    <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback&#39;</span><span class="p">),</span>
    <span class="s1">&#39;page callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;feedback_message&#39;</span><span class="p">,</span>
    <span class="s1">&#39;access arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;send message&#39;</span><span class="p">),</span>
    <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
  <span class="p">);</span>
  <span class="nv">$items</span><span class="p">[</span><span class="s1">&#39;feedback/adminmessages/%&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
  <span class="p">(</span>
    <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback Admin&#39;</span><span class="p">),</span>
    <span class="s1">&#39;page callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;feedback_admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;page arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">),</span>
    <span class="s1">&#39;access arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;view messages&#39;</span><span class="p">),</span>
    <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
  <span class="p">);</span>
  <span class="nv">$items</span><span class="p">[</span><span class="s1">&#39;feedback/adminmessages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
  <span class="p">(</span>
    <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback Admin&#39;</span><span class="p">),</span>
    <span class="s1">&#39;page callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;feedback_admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;access arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;view messages&#39;</span><span class="p">),</span>
    <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Hay dos cambios respecto de la original. ¿Los véis? ¿No?</p>
<p>El primero consiste en el nombre del menú. Antes era <code>feedback/adminmessages</code>, y ahora <code>feedback/adminmessages/%</code>. Drupal irá tratando de encajar la ruta que hayan insertado con alguno de los patrones; el porcentaje (%) es como decir: <em>cualquier cosa</em>. En este caso, encajará con cualquier cosa que tenga: <code>feedback/adminmessages/</code> y algo más (ojo, ya que no encaja si no tiene nada más).</p>
<p>El segundo cambio es la opción <code>page arguments</code>. Le asignamos el valor <code>array (2)</code>:. Eso implica tomar la 3ª parte de la ruta y meterla en un vector que se le pasará a nuestra función.</p>
<p>Voy a explicarlo con un ejemplo. El usuario pone la ruta <code>feedback/adminmessages/25</code>. Por lo tanto, si ponemos el valor de <code>page arguments</code> a 0, obtendremos <code>feedback</code>; a 1, <code>adminmessages</code> y a 2, &ldquo;25&rdquo;, que es justo lo que queremos.</p>
<p>¿Qué ocurre si el usuario pone <code>feedback/adminmessages/25/añsldfj</code>? Pues que vuelve a encajar en el patrón dado (a falta de otro mejor), y se trataría exactamente igual que el ejemplo anterior (la parte <em>añsldfj</em> ignorará).</p>
<p>Dejamos también la parte que existía antes, con el fin de poder pintar también algo cuando no se ha seleccionado un mensaje.</p>
<h2 id="modificando-funciones">Modificando funciones</h2>
<p>Bueno, pues ya tenemos modificados los menus, así que vamos a modificar también las funciones.</p>
<p>Comenzamos por la función <code>feedback_admin</code>. En esta función vamos a hacer tres cambios:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_admin</span> <span class="p">(</span> <span class="nv">$messageid</span><span class="o">=</span><span class="k">null</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageid</span> <span class="o">!=</span> <span class="k">null</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">&#39;feedback_messageadmin_form&#39;</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
    <span class="nv">$content</span> <span class="o">.=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$header</span> <span class="o">=</span> <span class="k">array</span>
  <span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;indate&#39;</span><span class="p">,</span> <span class="s1">&#39;sort&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;desc&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Message&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;message&#39;</span><span class="p">),</span>
  <span class="p">);</span>

  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT fm.id, u.name, fm.indate, fm.message FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>

  <span class="nv">$rows</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$row</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;indate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;edit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">),</span> <span class="s2">&#34;feedback/adminmessages/&#34;</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">id</span> <span class="p">);</span>
    <span class="nv">$rows</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">theme_table</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$rows</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>En primer lugar, hemos añadido un parámetro con un valor por defecto.</p>
<p>En segundo lugar, se añade la comprobación para saber si a la función se le
llamó con algún parámetro (en caso contario, habría obtenido el valor por
defecto, que es <code>NULL</code>). Si es así, pintamos un formulario (más adelante).</p>
<p>Y para finalizar, le hemos añadido una nueva fila a cada elemento de la lista,
de manera que se creen enlaces a la dirección <code>feedback/adminmessages/</code> seguida
del id del mensaje a mostrar.</p>
<p><strong>NOTA:</strong> ¿Qué ocurre si un usuario malicioso trata de escribir esta dirección
sin tener permisos? No tenemos que preocuparnos. Recordad que al definir los
menús (apartado anterior) establecimos los permisos.</p>
<p>Claro, la función anterior nos está pidiendo a gritos que implementemos el
formulario que nos falta y que, por ser un formulario, requiere también de un
submit:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_messageadmin_form</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$messageid</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT fm.message, fm.read, fm.indate, u.name FROM {feedback_messages} fm, {users} u WHERE fm.id=%d and u.uid=fm.uid&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>

  <span class="nv">$form</span> <span class="o">=</span> <span class="k">array</span>
    <span class="p">(</span>
      <span class="s1">&#39;feedback&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span>
      <span class="p">(</span>
        <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;fieldset&#39;</span><span class="p">,</span>
        <span class="s1">&#39;#title&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span> <span class="s1">&#39;Feedback from &#39;</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">.</span> <span class="s1">&#39; sended on &#39;</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span> <span class="p">),</span>
        <span class="s1">&#39;messageid&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="s2">&#34;#default_value&#34;</span> <span class="o">=&gt;</span> <span class="nv">$messageid</span> <span class="p">),</span>
        <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s2">&#34;#default_value&#34;</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span> <span class="s2">&#34;#disabled&#34;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span> <span class="p">),</span>
        <span class="s1">&#39;read&#39;</span>  <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;#type&#39;</span><span class="o">=&gt;</span> <span class="s1">&#39;checkbox&#39;</span><span class="p">,</span> <span class="s2">&#34;#title&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;Read&#34;</span><span class="p">,</span><span class="s2">&#34;#default_value&#34;</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span> <span class="p">),</span>
        <span class="s1">&#39;submit&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span>  <span class="s1">&#39;#value&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Submit&#39;</span><span class="p">),</span>  <span class="p">),</span>
      <span class="p">),</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_messageadmin_form_submit</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$messageid</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="s1">&#39;messageid&#39;</span><span class="p">];</span>
  <span class="nv">$read</span>      <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="s1">&#39;read&#39;</span><span class="p">];</span>

  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;UPDATE {feedback_messages} fm set fm.read=%d where fm.id=%d&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$read</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Una explicación breve: Hemos creado un formulario con un campo oculto
(<code>messageid</code>) para albergar el id del mensaje. Además, añadimos el propio
mensaje en un textarea deshabilitado, con el fin de que no se pueda modificar.
Por último, añadimos un checkbox para marcar como leído, que es lo que puede
hacer el administrador. Bueno, claro: y el botón de submit.</p>
<p>En este caso no hemos implementado un hook_validate debido a lo sencillo que era
el formulario (en un formulario con un único checkbox es difícil hacer
marranadas), pero sí hemos implementado el <code>hook_submit</code>, que tan sólo actualiza
el mensaje en cuestión.</p>
<p>Y, para ya dejarlo todo niquelao, vamos a modificar la función que obtenía el
número de mensajes a ver. Antes era tan cutre que mostraba todos los que
tuvieran menos de una semana. Ahora podemos hacer que muestre los que no hemos
marcado como leídos:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">_feedback_count</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT count(id) as total from {feedback_messages} fm where fm.read != 1&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
  <span class="nv">$result</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">;</span>
  <span class="k">return</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">total</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="más-tutoriales">Más tutoriales</h2>
<p>Este tutorial es la continuación de <a href="https://magmax.org/blog/creacion-modulo-drupal/" rel="">Creación de un módulo Drupal</a>, Además, podéis continuar el tutorial en:</p>
<ul>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-3/" rel="">Creación de un módulo drupal (III)</a></li>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-4/" rel="">Creación de un módulo drupal (IV)</a></li>
<li><a href="https://magmax.org/blog/drupal-expansors/" rel="">Drupal: Creando contenido con &lsquo;expansors&rsquo;</a></li>
<li><a href="https://magmax.org/blog/critica-drupal/" rel="">Crítica a Drupal</a></li>
<li><a href="https://magmax.org/blog/drupal-tabla-perfecta/" rel="">Tablas en Drupal: Haciendo la tabla perfecta</a></li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Actualizado el 28 Jan 2021</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Compartir en Twitter" data-sharer="twitter" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/" data-title="Creación de un módulo Drupal II" data-hashtags="drupal"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Facebook" data-sharer="facebook" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/" data-hashtag="drupal"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Linkedin" data-sharer="linkedin" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en WhatsApp" data-sharer="whatsapp" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/" data-title="Creación de un módulo Drupal II" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Tumblr" data-sharer="tumblr" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/" data-title="Creación de un módulo Drupal II" data-tags="drupal"><i class="fab fa-tumblr fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Reddit" data-sharer="reddit" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Instapaper" data-sharer="instapaper" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/" data-title="Creación de un módulo Drupal II" data-description=""><i data-svg-src="/lib/simple-icons/icons/instapaper.min.svg"></i></a><a href="javascript:void(0);" title="Compartir en Digg" data-sharer="digg" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/"><i class="fab fa-digg fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Blogger" data-sharer="blogger" data-url="https://magmax.org/blog/creacion-modulo-drupal-2/" data-title="Creación de un módulo Drupal II" data-description=""><i class="fab fa-blogger fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/drupal/">drupal</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Regresar</a></span>&nbsp;|&nbsp;<span><a href="/">Inicio</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/blog/creacion-modulo-drupal-3/" class="prev" rel="prev" title="Creación de un módulo Drupal III"><i class="fas fa-angle-left fa-fw"></i>Creación de un módulo Drupal III</a>
            <a href="/blog/creacion-modulo-drupal/" class="next" rel="next" title="Creación de un módulo Drupal">Creación de un módulo Drupal<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Provisto por <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.91.2">Hugo</a> | Tema - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Miguel Ángel</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Volver arriba">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="Ver comentarios">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="https://magmax.disqus.com/embed.js" defer></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copiar al portapapeles","maxShownLines":10},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-9308241-3', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-9308241-3" async></script></body>
</html>
