<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Cómo puede cambiar los despliegues Docker | El blog de MagMax</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Docker es una nueva tecnología que puede cambiar el sistema de despliegue para evitar DoS.">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="Cómo puede cambiar los despliegues Docker" />
<meta property="og:description" content="Docker es una nueva tecnología que puede cambiar el sistema de despliegue para evitar DoS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/como-puede-cambiar-los-despliegues-docker/" />
<meta property="article:published_time" content="2015-08-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-08-03T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta itemprop="name" content="Cómo puede cambiar los despliegues Docker">
<meta itemprop="description" content="Docker es una nueva tecnología que puede cambiar el sistema de despliegue para evitar DoS.">
<meta itemprop="datePublished" content="2015-08-03T00:00:00+00:00" />
<meta itemprop="dateModified" content="2015-08-03T00:00:00+00:00" />
<meta itemprop="wordCount" content="1095">



<meta itemprop="keywords" content="docker,deployment," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cómo puede cambiar los despliegues Docker"/>
<meta name="twitter:description" content="Docker es una nueva tecnología que puede cambiar el sistema de despliegue para evitar DoS."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        El blog de MagMax
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Inicio page">
              Inicio
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="../en" title="English page">
              English
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://magmax.org/blog/como-puede-cambiar-los-despliegues-docker/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://magmax.org/blog/como-puede-cambiar-los-despliegues-docker/&amp;text=C%c3%b3mo%20puede%20cambiar%20los%20despliegues%20Docker" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://magmax.org/blog/como-puede-cambiar-los-despliegues-docker/&amp;title=C%c3%b3mo%20puede%20cambiar%20los%20despliegues%20Docker" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Cómo puede cambiar los despliegues Docker</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2015-08-03T00:00:00Z">August 3, 2015</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Llevo ya bastante tiempo pensando cómo desplegar correctamente una aplicación.
La idea es ser capaz de desplegar en un sistema distribuido sin
<abbr title="Denial of Service">DoS</abbr>
.</p>
<p>El principal problema reside en cómo sincronizar todas las máquinas para realizar el cambio en el menor tiempo posible, así como en evitar puntos de fallo y admitir <em>rollback</em>. Casi na.</p>
<p>Sin embargo, <a href="https://www.docker.com/">Docker</a> facilita todo esto. Aquí explico cómo se me ha ocurrido, aunque no es nada que probablemente no se os haya pasado por la cabeza a vosotros también.</p>
<p>Y mis agradecimientos al grupo <a href="https://agile-cr.github.io/">Agile-CR</a>, que me ayudaron a poner en orden alguna de estas ideas.</p>
<!-- raw HTML omitted -->
<figure>
    <img src="/images/containers.jpg"
         alt="Docker es un contenedor"/> 
</figure>

<h2 id="problemas-de-despliegue">Problemas de despliegue</h2>
<p>Existen numerosos problemas durante el despliegue:</p>
<ul>
<li>¿Cómo llevar el software hasta todas las máquinas de un cluster?</li>
<li>¿Cómo configurarlas?</li>
<li>¿Cómo reemplazar la versión antigua en el menor plazo de tiempo posible?</li>
<li>¿Cuándo sincronizar la Base de Datos?</li>
<li>¿Es posible que la aplicación funcione durante un tiempo con una configuración errónea?</li>
</ul>
<p>Por supuesto, estamos hablando de <a href="https://magmax.org/blog/en-busca-de-los-cinco-9s/">sistemas con una alta disponibilidad, cercana
al 99.99%</a>. Esto incluye, principalmente, servicios internos y servicios web.</p>
<p>El esquema, por tanto, tendrá esta pinta:</p>
<div hidden>

@startuml docker-service-view
card "Load Balancer" as lb
package Services {
  card "Service 1" as s1
  card "Service 2" as s2
  card "Service N" as sN
}
card "Database Cluster" as dc

lb --> s1
lb --> s2
lb --> sN
s1 --> dc
s2 --> dc
sN --> dc
@enduml

</div>

<img src="/diagrams/docker-service-view.png"/>

<p>Resulta sencillo ver que:</p>
<ul>
<li>Si desplegamos primero la base de datos, el sistema estará inconsistente hasta que se despliegue el resto.</li>
<li>Si desplegamos primero la configuración, pasará lo mismo.</li>
<li>Si desplegamos primero el software, puede estar mal configurado o no ser acorde con la base de datos.</li>
</ul>
<p>Luego el problema tiene difícil solución.</p>
<p>Herramientas como <a href="https://puppetlabs.com/">Puppet</a>, <a href="https://www.chef.io">Chef</a>, <a href="https://saltstack.com/">Salt</a> o <a href="https://www.ansible.com">Ansible</a> pueden ayudar, pero
también pueden ser foco de problemas, ya que suelen ser declarativas. Además, es
posible que necesitemos realizar operaciones en distintas máquinas, como evitar
que el balanceador de carga sirva la máquina que estamos alterando o lanzar los
cambios de base de datos.</p>
<h3 id="desplegando-la-base-de-datos">Desplegando la base de datos</h3>
<p>Quizá el punto de fallo más crítico es la base de datos. La única manera posible de evitar problemas durante el despliegue es dividir los cambios en dos.</p>
<p>Por una parte, todos los <code>create</code>, <code>add column</code>, <code>insert</code>, etc. Estas operaciones son inócuas y no deberían afectar al despliegue actual, más allá de una pequeña reducción temporal de rendimiento.</p>
<p>Por otra parte, los <code>drop</code>, <code>delete</code>, <code>alter</code>, etc. Que son operaciones que sí pueden tener repercusiones.</p>
<p>Los <code>alter</code> que modifican el nombre de una columna deberían estar prohibidos completamente, ya que se ejecuten donde se ejecuten dejarán el sistema inestable durante un tiempo.</p>
<p>Con estas premisas, es fácil ver que podemos ejecutar el primer grupo <strong>antes</strong> de instalar la nueva versión del software y el segundo grupo <strong>después</strong> de la instalación de éste.</p>
<p>Y con esto, el despliegue de nuestra base de datos es seguro.</p>
<h3 id="desplegando-la-aplicación-y-la-configuración">Desplegando la aplicación y la configuración</h3>
<p>Con la aplicación y la configuración no ocurre lo mismo. No importa qué se despliegue antes, afectará al funcionamiento.</p>
<p>Una opción es <strong>centralizar la configuración</strong>. Básicamente se deja la configuración en una base de datos y se accede a ella directamente o mediante un servicio intermedio (yo recomendaría esto último).</p>
<p>Pero hay cierta configuración que no puede moverse a este nuevo sistema: La configuración para conectarse a él. Sin embargo, ésta es una configuración que no cambiará a menudo y que, probablemente, sea igual en todos los servicios de un mismo tipo.</p>
<h2 id="soluciones-al-despliegue">Soluciones al despliegue</h2>
<h3 id="duplicando-el-sistema">Duplicando el sistema</h3>
<p>Una posible solución es duplicar el sistema. Se duplican las máquinas y se instala la nueva aplicación en las máquinas nuevas. Luego se cambia el <strong>Load balancer</strong> y todo solucionado.</p>
<p>El problema de esta solución es el coste. Si albergamos nuestro propio hardware, necesitamos duplicar el número de máquinas para una acción que se realiza en pocos minutos.</p>
<p>Sin embargo, también tiene ventajas adicionales:</p>
<ul>
<li>El cambio se realiza en todas las máquinas al mismo tiempo.</li>
<li>Se podría probar la nueva versión de la aplicación en distintas máquinas, comprobando que tiene el mismo funcionamiento que la versión anterior (al menos).</li>
<li>Permite <strong>A/B Testing</strong>.</li>
<li>Permite hacer <strong>rollback</strong> de forma sencilla.</li>
</ul>
<h3 id="dockers">Dockers</h3>
<p>Y aquí es cuando viene <a href="https://www.docker.com/">Docker</a> al rescate. Si no sabéis qué es, podéis ver mi
<a href="https://magmax.org/blog/docker/">artículo anterior sobre Docker</a>.</p>
<p><a href="https://www.docker.com/">Docker</a> permite ver la aplicación y su configuración como una caja negra, permitiéndonos desplegar más de un servicio idéntico en la misma máquina.</p>
<p>Por lo tanto, podríamos mantener desplegadas las dos versiones de nuestra aplicación al mismo tiempo, quizá en puertos diferentes, y servir ambas. Durante un despliegue, se mira cuál es la activa y se sustituye la inactiva. A continuación se cambia el <strong>Load Balancer</strong> y todo queda resuelto en milésimas de segundo.</p>
<p><a href="https://www.docker.com/">Docker</a> nos permite, por tanto, duplicar el sistema utilizando el mismo
hardware. La carga adicional será tan pequeña como permita nuestro contenedor de
aplicaciones, si es que estamos usando <a href="https://www.jboss.org/">JBoss</a> o similar. Seguramente sea una
carga en RAM, pero poco en CPU.</p>
<p>De esta forma ahorramos los costes y obtenemos todas las ventajas del sistema duplicado y algunas adicionales:</p>
<ul>
<li><strong>la gestión de todos nuestros servicios se puede realizar de forma homogénea</strong>, es decir, que podemos desplegar cualquier servicio de la misma manera.</li>
<li><strong>Podemos mantener desplegadas varias versiones distintas</strong> para permitirnos hacer <em>rollback</em> o pruebas del conjunto, con un coste de un <strong>Load Balancer</strong>.</li>
<li>Se pueden <strong>guardar las versiones</strong> como un bloque, usando los <strong>Docker Repositories</strong>. Esto también facilitará la forma de hacer llegar las imágenes a las máquinas donde se van a desplegar.</li>
</ul>
<p>Por si esto fuera poco, <a href="https://www.docker.com/">Docker</a> guarda información en los <em>containers</em> sobre
los puertos que expone y los puntos de montaje, lo que puede facilitar la
gestión de alertas (al menos a nievel básico).</p>
<h2 id="docker-vs-puppet-chef-salt-ansible-">Docker vs Puppet, Chef, Salt, Ansible, &hellip;</h2>
<p>Seguramente penséis que <a href="https://www.docker.com/">Docker</a> es mejor que los sistemas típicos de
orquestación, como <a href="https://puppetlabs.com/">Puppet</a>, <a href="https://www.chef.io">Chef</a>, <a href="https://saltstack.com/">Salt</a> o <a href="https://www.ansible.com">Ansible</a>. Sin embargo, son
herramientas diferentes que sirven para objetivos diferentes.</p>
<p>Con este nuevo esquema de despliegues, podría usarse cualquiera de estos
sistemas de orquestación para instalar la nueva aplicación en las máquinas, y
planificar el momento en que se hará el cambio en el <em>load balancer</em>. Así,
Docker y los sistemas de orquestación trabajan juntos.</p>
<p>También son útiles para cambiar la configuración a nivel global o configurar
sistemas de monitorización y alertado.</p>
<p>Como vemos, son herramientas complementarias, no competencia.</p>
<h2 id="conclusión">Conclusión</h2>
<p><a href="https://www.docker.com/">Docker</a> es un nuevo paradigma que ha llegado para quedarse, a pesar de estar
basado en los &ldquo;Linux Containers&rdquo;, una tecnología que un amigo ya usaba allá por
el 2004.</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/docker" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">docker</a>
   </li>
  
   <li class="list">
     <a href="/tags/deployment" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">deployment</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "magmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Relacionado</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/docker/">Docker</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://magmax.org/" >
    &copy;  El blog de MagMax 2021 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
