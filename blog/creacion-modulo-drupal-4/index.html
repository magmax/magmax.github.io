<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Creación de un módulo Drupal IV - El blog de MagMax</title><meta name="Description" content="El blog de un Ingeniero Informático: tutoriales, manuales, opiniones, comparativas, ..."><meta property="og:title" content="Creación de un módulo Drupal IV" />
<meta property="og:description" content="En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura&hellip; cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.
Hoy queremos que nuestros &ldquo;feedbacks&rdquo; se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc.
Me voy a basar en el magnífico tutorial para crear contenido en Drupal." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/creacion-modulo-drupal-4/" />
<meta property="og:image" content="https://magmax.org/icons/favicon.png"/>
<meta property="article:published_time" content="2010-05-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-28T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://magmax.org/icons/favicon.png"/>

<meta name="twitter:title" content="Creación de un módulo Drupal IV"/>
<meta name="twitter:description" content="En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura&hellip; cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.
Hoy queremos que nuestros &ldquo;feedbacks&rdquo; se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc.
Me voy a basar en el magnífico tutorial para crear contenido en Drupal."/>
<meta name="application-name" content="El blog de MagMax">
<meta name="apple-mobile-web-app-title" content="El blog de MagMax"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://magmax.org/blog/creacion-modulo-drupal-4/" /><link rel="prev" href="https://magmax.org/blog/tarta-manzana/" /><link rel="next" href="https://magmax.org/blog/creacion-modulo-drupal-3/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Creación de un módulo Drupal IV",
        "inLanguage": "es",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/magmax.org\/blog\/creacion-modulo-drupal-4\/"
        },"genre": "posts","keywords": "drupal","wordcount":  4507 ,
        "url": "https:\/\/magmax.org\/blog\/creacion-modulo-drupal-4\/","datePublished": "2010-05-11T00:00:00+00:00","dateModified": "2021-01-28T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Miguel Ángel"},"author": {
                "@type": "Person",
                "name": "Miguel Ángel"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="El blog de MagMax"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon.png"
        data-srcset="/icons/favicon.png, /icons/favicon.png 1.5x, /icons/favicon.png 2x"
        data-sizes="auto"
        alt="/icons/favicon.png"
        title="/icons/favicon.png" />MagMax Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> Inicio </a><a class="menu-item" href="/tags"> Tags </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Selecciona el lenguage">Español<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/blog/creacion-modulo-drupal-4/" selected>Español</option></select>
                    </a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="El blog de MagMax"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon.png"
        data-srcset="/icons/favicon.png, /icons/favicon.png 1.5x, /icons/favicon.png 2x"
        data-sizes="auto"
        alt="/icons/favicon.png"
        title="/icons/favicon.png" />MagMax Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="">Inicio</a><a class="menu-item" href="/tags" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Selecciona el lenguage">Español<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/blog/creacion-modulo-drupal-4/" selected>Español</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contenido</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Creación de un módulo Drupal IV</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Miguel Ángel</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="11 May 2010">11 May 2010</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;4507 palabras&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;22 minutos&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contenido</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#versiones">Versiones</a></li>
    <li><a href="#qué-se-explica-aquí">Qué se explica aquí</a></li>
    <li><a href="#qué-es-el-cck">Qué es el CCK</a></li>
    <li><a href="#pasos">Pasos</a></li>
    <li><a href="#hooks-obligatorios">Hooks obligatorios</a>
      <ul>
        <li><a href="#hooks-recomendables">Hooks recomendables</a></li>
      </ul>
    </li>
    <li><a href="#drupal-7">Drupal 7</a></li>
    <li><a href="#más-tutoriales">Más tutoriales</a></li>
    <li><a href="#opinión-personal">Opinión personal</a></li>
    <li><a href="#más-tutoriales-1">Más tutoriales</a></li>
    <li><a href="#código">Código</a>
      <ul>
        <li><a href="#feedbackmodule">feedback.module</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura&hellip; cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.</p>
<p>Hoy queremos que nuestros &ldquo;feedbacks&rdquo; se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc.</p>
<p>Me voy a basar en el <a href="https://drupal.org/node/231019" target="_blank" rel="noopener noreffer">magnífico tutorial para crear contenido en Drupal</a>.</p>
<figure>
    <img src="/images/drupal.png"
         alt="Drupal"/> 
</figure>

<h2 id="versiones">Versiones</h2>
<p>Igual que es posible que este documento se copie, también es posible que yo lo
modifique. Por eso, la última versión del mismo siempre se encontrará en la
<a href="https://magmax.org/blog/creacion-modulo-drupal-4/" rel="">cuarta parte del tutorial de drupal</a>. Un
saludo.</p>
<h2 id="qué-se-explica-aquí">Qué se explica aquí</h2>
<p>Cómo crear un nodo programáticamente. Una vez hayamos terminado, todo lo que hayamos hecho se podría haber hecho con el módulo CCK, pero de lo que se trata es aprender.</p>
<h2 id="qué-es-el-cck">Qué es el CCK</h2>
<p>Fácil: es el <em>Content Construction Kit</em> :-D</p>
<p>Consiste en una herramienta muy potente para la creación de formularios mediante el propio Drupal. De esta manera, sólo tenemos que ir añadiendo una lista de elementos, que posteriormente se renderizarán como un formulario. Gran parte de nuestro módulo &ldquo;feedback&rdquo; se podría haber hecho directamente sobre el CCK, por no decir todo.</p>
<p>¿Por qué no usar el CCK? En nuestro caso, &ldquo;porque estamos aprendiendo&rdquo; es una razón tan válida como cualquier otra. En concreto, para un módulo de las características de &ldquo;feedback&rdquo;, tal vez haya sido una pérdida de tiempo usar un módulo en lugar de el CCK. Sin embargo, un módulo tiene unas características de replicabilidad que el CCK creo que no tiene.</p>
<p>Además, el CCK nos permite crear formularios simples, pero si lo que queremos es poder manipular los datos, entonces necesitaremos crear nuestro propio módulo.</p>
<h2 id="pasos">Pasos</h2>
<p>Vamos a necesitar los siguientes <em>hooks</em>, aunque algunos de ellos ya los hemos implementado:</p>
<ul>
<li><code>hook_node_info</code></li>
<li><code>hook_perm</code></li>
<li><code>hook_access</code></li>
<li><code>hook_form</code></li>
</ul>
<p>También vamos a necesitar algunos de los siguientes <em>hooks</em> opcionales:</p>
<ul>
<li><code>hook_insert</code></li>
<li><code>hook_update</code></li>
<li><code>hook_delete</code></li>
<li><code>hook_validate</code></li>
<li><code>hook_nodeapi</code></li>
<li><code>hook_view</code></li>
<li><code>hook_load</code></li>
</ul>
<h2 id="hooks-obligatorios">Hooks obligatorios</h2>
<p>Nosotros ya tenemos nuestro <code>hook_node_info</code> y nuestro propio <code>hook_perm</code>, así que saltamos directamente a implementar el <code>hook_access</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="sd">/**
</span><span class="sd">* Implements hook_access()
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_access</span> <span class="p">(</span> <span class="nv">$op</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$retval</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span> <span class="nv">$op</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;view&#39;</span><span class="o">:</span>
      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">&#39;view messages&#39;</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">);</span>
    <span class="k">case</span> <span class="s1">&#39;create&#39;</span><span class="o">:</span>
      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">&#39;send message&#39;</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;update&#39;</span><span class="o">:</span>
      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">&#39;admin messages&#39;</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;delete&#39;</span><span class="o">:</span>
      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">&#39;admin messages&#39;</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nv">$retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>La función va a devolver <code>true</code> si queremos que el usuario tenga acceso. Para ello comprobamos si el usuario tiene los roles necesarios como para realizar ciertas acciones. En el caso de &ldquo;update&rdquo; y &ldquo;delete&rdquo; comprobamos también que el usuario sea el propietario del nodo.</p>
<p>Siguiendo con la lista, implementaremos el <code>hook_node_info</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="sd">/**
</span><span class="sd">* Implements hook_node_info()
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_node_info</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;feedback&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback&#39;</span><span class="p">),</span>
      <span class="s1">&#39;module&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;feedback&#39;</span><span class="p">,</span>
      <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;Handle a feedback message&#34;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Ahora vamos a renombrar algunas de nuestras funciones&hellip; En concreto, <code>feedback_message_form</code>, que pasará a ser <code>feedback_form</code>. Es necesario también renombrar las funciones <code>feedback_message_form_validate</code> y <code>feedback_message_form_submit</code> para que todo siga funcionando como hasta ahora. También tendremos que modificar la llamada a <code>feedback_message_form</code> (ojo, que luego seguiremos transformando estas funciones):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_message</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">&#39;feedback_form&#39;</span> <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_form</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_form_validate</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_form_submit</span> <span class="p">(</span> <span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Y&hellip;. ya está. Ya tenemos nuestro elemento integrado con Drupal. Si recargamos la caché (Administration-&gt;Performance), y nos vamos a &ldquo;create content&rdquo;, veremos que tenemos un tipo de contenido llamado &ldquo;feedback&rdquo;.</p>
<p>El caso es que también veremos que no funciona del todo bien :-D</p>
<h3 id="hooks-recomendables">Hooks recomendables</h3>
<p>Antes de nada, os voy a hablar de <code>hook_nodeapi</code>. Hacéos un favor a vosotros mismos: olvidad que alguna vez existió. Las funciones que tienen parámetros que cambian en función de otros parámetros nunca son una buena idea. Además, en Drupal 7 lo han quitado, por lo que su uso está obsoleto. Toda la funcionalidad que podía ofrecer esta función la cumplen el resto de los hooks de la lista: insert, update, delete, validate, view y load. Existe una remota posibilidad de que necesitéis usar <code>hook_nodeapi</code>; pensáoslo bien antes de usarla.</p>
<p>El resto de <code>hooks</code> se ejecutarán automáticamente cuando alguien realice la operación esperada: <code>hook_insert</code> cuando se cree un nuevo elemento, etc.</p>
<p>Realmente lo que vamos a hacer es realizar una serie de transformaciones. Por ejemplo, nuestro antiguo <code>feedback_form_submit</code> se va a transformar en el nuevo y flamante <code>feedback_insert</code>, nuestro propio <code>hook_insert</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_insert</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$userid</span>  <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>

  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;INSERT into {feedback_messages} ( uid, message, indate, usermail ) values ( %d, &#39;%s&#39;, now(), &#39;%s&#39; ) &#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$userid</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$mail</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span> <span class="p">(</span> <span class="s2">&#34;Thank you for your feedback.&#34;</span> <span class="p">)</span> <span class="p">);</span>
    <span class="nx">drupal_goto</span> <span class="p">(</span> <span class="s1">&#39;node&#39;</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;feedback&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">&#34;An error has happened. Your feedback has not been sent.&#34;</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Vamos a estudiarlo un poquito&hellip; Hemos cambiado la cabecera, de manera que ahora
el <em>UID</em>, el mensaje y el e-mail lo sacamos del nodo en lugar de usar variables
globales y formularios. Nosotros tenemos que decidir cómo almacenar la
información que sobrepasa a la información del nodo, por lo que insertamos en
nuestra tabla exactamente la misma información que antes. Es decir: a partir de
<code>$query</code> no hemos cambiado nada.</p>
<p>No ha sido difícil, ¿verdad? Ahora ya podemos insertar nodos que son feeds. Y
podemos probarlo: <code>Create Content-&gt;feedback</code>, escribimos y guardamos.</p>
<p>Se nos ha quedado el submit del formulario. Eso queda un poquito feo, ¿no? Ahora
que tenemos nuestro botón &ldquo;preview&rdquo; y nuestro &ldquo;save&rdquo;, amén de todas las opciones
de publicación, permisos, etc&hellip; Así que vamos a quitarlo. Además hay un
problema: se va a utilizar el mismo formulario para editar y para crear nuevos
elementos. Por esa razón, he decidido sacar una serie de variables que se
establecerán cuando se esté editando el nodo. Además, en modo &ldquo;edición&rdquo; se
mostrará también el check para indicar que ya se ha leído.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_form</span> <span class="p">(</span> <span class="o">&amp;</span><span class="nv">$node</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>

  <span class="nv">$title</span> <span class="o">=</span> <span class="nx">sprintf</span> <span class="p">(</span> <span class="s1">&#39;Feed from %s&#39;</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">name</span> <span class="p">);</span>
  <span class="nv">$mail</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="nv">$read</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
  <span class="nv">$editing</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="nv">$mail</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// estamos editando
</span><span class="c1"></span>    <span class="nv">$editing</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT uid, message, indate, usermail, fm.read FROM {feedback_messages} fm WHERE id=%d&#34;</span><span class="p">;</span>
    <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
    <span class="nv">$storednode</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>

    <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
    <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$form</span> <span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
    <span class="p">(</span>
      <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;fieldset&#39;</span><span class="p">,</span>
      <span class="s1">&#39;#title&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span> <span class="s1">&#39;Feedback&#39;</span> <span class="p">),</span>
      <span class="s1">&#39;mail&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span><span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;textfield&#39;</span><span class="p">,</span> <span class="s2">&#34;#title&#34;</span><span class="o">=&gt;</span><span class="s2">&#34;E-Mail&#34;</span><span class="p">,</span> <span class="s2">&#34;#description&#34;</span><span class="o">=&gt;</span><span class="s2">&#34;If you want any answer, please, tell me your mail. It would not be shown anywhere.&#34;</span><span class="p">,</span> <span class="s2">&#34;#default_value&#34;</span> <span class="o">=&gt;</span> <span class="nv">$mail</span> <span class="p">),</span>
      <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s2">&#34;#description&#34;</span><span class="o">=&gt;</span><span class="s2">&#34;Write here your message&#34;</span><span class="p">,</span> <span class="s1">&#39;#default_value&#39;</span><span class="o">=&gt;</span><span class="nv">$message</span> <span class="p">),</span>
      <span class="s1">&#39;#required&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
    <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$editing</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$form</span> <span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">][</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;checkbox&#39;</span><span class="p">,</span> <span class="s2">&#34;#title&#34;</span><span class="o">=&gt;</span><span class="s2">&#34;The message has been read&#34;</span><span class="p">,</span> <span class="s1">&#39;#default_value&#39;</span><span class="o">=&gt;</span><span class="nv">$read</span> <span class="p">)</span> <span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
    <span class="p">(</span>
      <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span>
      <span class="s1">&#39;#default_value&#39;</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
    <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>¡Eh!, ¡Para!, que aquí al final hay algo extraño&hellip; Sí, lo que hacemos es
preguntarle a Drupal el tipo de nodo que estamos tratando, y comprobar si este
tipo necesita un título. Si es así, pues lo pintamos. Se podría hacer lo mismo
con el <em>body</em>, pero en esta ocasión no lo queremos. El título es interesante
para que después nos aparezca en la lista de contenido y podamos pincharle.</p>
<p>Ahora vamos a realizar las comprobaciones adecuadas, renombrando
<code>feedback_form_validate</code> y haciendo los cambios pertinentes:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_validate</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">];</span>
  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="s1">&#39;mail&#39;</span><span class="p">];</span>
  <span class="nv">$validmail</span> <span class="o">=</span> <span class="nx">preg_match</span> <span class="p">(</span><span class="s2">&#34;/^[^0-9][A-z0-9_]+([.][A-z0-9_]+)*[@][A-z0-9_]+([.][A-z0-9_]+)*[.][A-z]{2,4}$/&#34;</span> <span class="p">,</span> <span class="nv">$mail</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$mail</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;You are not a registered user. Please, insert your e-mail.&#39;</span><span class="p">)</span> <span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nv">$mail</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$validmail</span> <span class="p">)</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;The mail does not like an e-mail address.&#39;</span><span class="p">)</span> <span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Message cannot be empty.&#39;</span><span class="p">));</span>

  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Es una lástima ver lo fácil que habría resultado realizarlo así desde el principio, ¿verdad? ¡¡Pero había que aprender!! Pasito a pasito&hellip;</p>
<p>Ahora vamos a &ldquo;ver&rdquo; los feeds. No sé si habréis notado que cuando pulsáis sobre un feed, no se ve nada. Igual que en el <em>preview</em>. Eso es porque tenemos que implementar el <code>hook_view</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_view</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$teaser</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">,</span> <span class="nv">$page</span> <span class="o">=</span> <span class="k">FALSE</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$messageread</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
  <span class="nv">$messagedata</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="nv">$messagename</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// ya tenemos el mensaje. Puede deberse a que estamos editando.
</span><span class="c1"></span>    <span class="nv">$messageread</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
    <span class="nv">$messagedata</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="nv">$messagename</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">// tenemos que obtener el mensaje
</span><span class="c1"></span>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT fm.uid, message, indate, usermail, u.name, fm.read FROM {feedback_messages} fm, {users} u WHERE id=%d and fm.uid=u.uid&#34;</span><span class="p">;</span>
    <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>

    <span class="nv">$messageread</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
    <span class="nv">$messagedata</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="nv">$messagename</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$read</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageread</span> <span class="p">)</span>
    <span class="nv">$read</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34; and &lt;b&gt;already read&lt;/b&gt;&#34;</span><span class="p">);</span>

  <span class="nv">$content</span>  <span class="o">=</span> <span class="nx">sprintf</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;&lt;blockquote&gt;&lt;i&gt;%s&lt;/i&gt;&lt;/blockquote&gt;&lt;p&gt;Sent by %s&lt;a href=&#34;mailto:%s&#34;&gt;&amp;lt;%s&amp;gt;&lt;/a&gt;%s.&lt;/p&gt;&#39;</span><span class="p">),</span> <span class="nv">$messagedata</span><span class="p">,</span> <span class="nv">$messagename</span><span class="p">,</span> <span class="nv">$messageusermail</span><span class="p">,</span> <span class="nv">$messageusermail</span><span class="p">,</span> <span class="nv">$read</span> <span class="p">);</span>


  <span class="nv">$node</span> <span class="o">=</span> <span class="nx">node_prepare</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$teaser</span> <span class="p">);</span>
  <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;#value&#39;</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span>
    <span class="s1">&#39;#weight&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Ahora vamos con la edición, para que se hagan efectivos los cambios:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_update</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$userid</span>  <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
  <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>

  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;UPDATE {feedback_messages} fm SET message=&#39;%s&#39;, usermail=&#39;%s&#39;, fm.read=%d where id=%d&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$mail</span><span class="p">,</span> <span class="nv">$read</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">&#34;The feedback has been updated.&#34;</span> <span class="p">)</span> <span class="p">);</span>
    <span class="nx">drupal_goto</span> <span class="p">(</span> <span class="s1">&#39;node&#39;</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;feedback&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">&#34;An error has happened. Your feedback has not been sent.&#34;</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Ahora una nota sobre el borrado: Si tratamos de borrar el nodo, veremos que se realiza sin problemas, pero eso no quiere decir que lo estemos haciendo BIEN. Se habrá borrado el nodo, pero no se habrá borrado la información asociada a nuestro feed, dejando basura inaccesible en la base de datos. Por eso implementaremos:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="sd">/**
</span><span class="sd">* Implementation of hook_delete
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_delete</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;DELETE FROM {feedback_messages} where id=%d&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Con esto, queda obsoleto lo que implementamos en la cuarta entrega del curso
para poder eliminar mensajes :-D. Claro, que también hay una serie de enlaces
anticuados que nos están permitiendo crear feeds que no son nodos. Por estas
razones, vamos a eliminar:</p>
<ul>
<li><code>feedback_delete_form_submit</code></li>
<li><code>feedback_delete_form</code></li>
<li><code>feedback_messageadmin_form_submit</code></li>
<li><code>feedback_messageadmin_form_submit</code></li>
<li><code>feedback_messageadmin_form</code></li>
</ul>
<p>Y vamos a cambiar los enlaces en <code>feedback_admin</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">function</span> <span class="nf">feedback_admin</span> <span class="p">(</span> <span class="nv">$messageid</span><span class="o">=</span><span class="k">null</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageid</span> <span class="o">!=</span> <span class="k">null</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">&#39;feedback_messageadmin_form&#39;</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
    <span class="nv">$content</span> <span class="o">.=</span> <span class="s2">&#34;&lt;hr/&gt;&#34;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$header</span> <span class="o">=</span> <span class="k">array</span>
  <span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;indate&#39;</span><span class="p">,</span> <span class="s1">&#39;sort&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;desc&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;mail&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Message&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;message&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Read&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;fm.read&#39;</span><span class="p">),</span>
  <span class="p">);</span>

  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT fm.id, u.uid as uid, u.name, fm.usermail, fm.indate, fm.message, fm.read FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span><span class="p">;</span>
  <span class="nv">$query</span> <span class="o">.=</span> <span class="nx">tablesort_sql</span> <span class="p">(</span> <span class="nv">$header</span> <span class="p">);</span>
  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>

  <span class="nv">$rows</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$row</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;indate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;&lt;a href=&#34;?q=user/&#39;</span><span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">.</span><span class="s1">&#39;&#34;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">.</span> <span class="s1">&#39;&lt;/a&gt;&#39;</span> <span class="o">:</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;mail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;edit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">),</span> <span class="s2">&#34;node/&#34;</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span> <span class="s2">&#34;/edit&#34;</span><span class="p">);</span>
    <span class="nv">$rows</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">theme_table</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$rows</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Y lo más importante: ¡¡Ahora no podemos permitir que se cree un elemento
<em>feedback</em> sin que sea un nodo!! Así que se tercian dos cambios: Cambiar el
enlace del bloque (acordaos de limpiar la caché en Administration-&gt;performance)
y eliminar el acceso del <code>hook_menu</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="sd">/**
</span><span class="sd">* Implementation of hook_block().
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_block</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="nv">$delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$edit</span> <span class="o">=</span> <span class="k">array</span><span class="p">()</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">&#34;list&#34;</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="nv">$blocks</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;info&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback&#39;</span><span class="p">);</span>
      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&#34;info&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;New Feedbacks&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nv">$blocks</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">&#34;view&#34;</span> <span class="p">)</span>
  <span class="p">{</span>
      <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nv">$block</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
      <span class="k">switch</span> <span class="p">(</span> <span class="nv">$delta</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
          <span class="nv">$block</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback&#39;</span><span class="p">);</span>

          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;attributes&#34;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;title&#34;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34;Sends a feedback message&#34;</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34;New Feedback&#34;</span><span class="p">),</span> <span class="s2">&#34;node/add/feedback&#34;</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">&#39;&lt;div class=&#34;link&#34;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">&#34;&lt;/div&gt;&#34;</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
          <span class="nv">$block</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback Messages&#39;</span><span class="p">);</span>

          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;attributes&#34;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;title&#34;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34;Shows feedback messages&#34;</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nv">$title</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34;There are @total new feeds&#34;</span><span class="p">,</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;@total&#39;</span> <span class="o">=&gt;</span> <span class="nx">_feedback_count</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nv">$title</span> <span class="p">,</span> <span class="s2">&#34;feedback/adminmessages&#34;</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">&#39;&lt;div class=&#34;link&#34;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">&#34;&lt;/div&gt;&#34;</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nv">$block</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
      <span class="k">return</span> <span class="nv">$block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd">* Implementation of hook_menu().
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_menu</span> <span class="p">(</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

  <span class="nv">$items</span><span class="p">[</span><span class="s1">&#39;feedback/adminmessages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
  <span class="p">(</span>
    <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Feedback admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;page callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;feedback_admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;access arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;view messages&#39;</span><span class="p">),</span>
    <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="drupal-7">Drupal 7</h2>
<p>Mucho me temo que todo lo que cuento aquí es válido para Drupal 6, pero no para Drupal 7.</p>
<p>Hay tutoriales de cómo pasar de Drupal 6 a Drupal 7, y seguro que todo lo contado en esta parte del tutorial se verá afectado.</p>
<h2 id="más-tutoriales">Más tutoriales</h2>
<p>Tengo en mente hacer un tutorial más y terminar con toda la tanda. Lo que queda por ver es sencillo: aplicar <em>themes</em> y añadir archivos de traducción. Si se os ocurre algo más, ¡¡decidlo ahora!!</p>
<h2 id="opinión-personal">Opinión personal</h2>
<p>En muchos casos puede venir bien crear un módulo para drupal que gestiona nodos. Sin embargo, también es cierto que en este caso a mí, particulamente, me parece un problema. Al ser nodos, se verán afectados por los permisos de nodos, por lo que si en tu site no dejas crear contenido, se acabaron los feeds.</p>
<p>De todas maneras, me parecía interesante contarlo de esta manera, con el fin de que quede como una continuación y se aprenda a crear contenido para Drupal, que no es nada difícil</p>
<h2 id="más-tutoriales-1">Más tutoriales</h2>
<p>Este tutorial es la continuación de una serie de tutoriales relacionados con Drupal. Podéis consultar cualquiera de ellos:</p>
<ul>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal/" rel="">Creación de un módulo drupal (I)</a></li>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-2/" rel="">Creación de un módulo drupal (II)</a></li>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-4/" rel="">Creación de un módulo drupal (III)</a></li>
<li><a href="https://magmax.org/blog/drupal-expansors/" rel="">Drupal: Creando contenido con &lsquo;expansors&rsquo;</a></li>
<li><a href="https://magmax.org/blog/critica-drupal/" rel="">Crítica a Drupal</a></li>
<li><a href="https://magmax.org/blog/drupal-tabla-perfecta/" rel="">Tablas en Drupal: Haciendo la tabla perfecta</a></li>
</ul>
<h2 id="código">Código</h2>
<p>Como en este caso no se ha modificado nada del <code>feedback.install</code>, pongo sólo el módulo principal:</p>
<h3 id="feedbackmodule">feedback.module</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="cm">/*
</span><span class="cm">Copyright 2009-2010 Miguel Ángel García Martínez &lt;miguelangel.garcia@gmail.com&gt;
</span><span class="cm">
</span><span class="cm">  &#39;Feedback&#39; is free software; you can redistribute it and/or modify
</span><span class="cm">it under the terms of the GNU General Public License as published by
</span><span class="cm">the Free Software Foundation; either version 3 of the License, or
</span><span class="cm">(at your option) any later version.
</span><span class="cm">
</span><span class="cm">  &#39;Feedback&#39; is distributed in the hope that it will be useful,
</span><span class="cm">but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><span class="cm">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span><span class="cm">GNU General Public License for more details.
</span><span class="cm">
</span><span class="cm">  You should have received a copy of the GNU General Public License
</span><span class="cm">along with &#39;Feedback&#39; (maybe in file &#34;COPYING&#34;); if not, write to the Free Software
</span><span class="cm">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
</span><span class="cm">*/</span>
<span class="sd">/**
</span><span class="sd">* Implements hook_help().
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_help</span> <span class="p">(</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$arg</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$output</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="c1">// para construir la salida
</span><span class="c1"></span>  <span class="k">switch</span> <span class="p">(</span> <span class="nx">path</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;admin/help#feedback&#39;</span><span class="o">:</span>
      <span class="nv">$output</span> <span class="o">.=</span> <span class="s1">&#39;&lt;p&gt;&#39;</span> <span class="o">.</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Módulo que permite la inserción de mensajes de feedback.&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd">* Implements hook_perm().
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_perm</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;send message&#39;</span><span class="p">,</span> <span class="s1">&#39;view messages&#39;</span><span class="p">,</span> <span class="s1">&#39;admin messages&#39;</span> <span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd">* Implements hook_access()
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_access</span> <span class="p">(</span> <span class="nv">$op</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$retval</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span> <span class="nv">$op</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;view&#39;</span><span class="o">:</span>
      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">&#39;view messages&#39;</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">);</span>
    <span class="k">case</span> <span class="s1">&#39;create&#39;</span><span class="o">:</span>
      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">&#39;send message&#39;</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;update&#39;</span><span class="o">:</span>
      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">&#39;admin messages&#39;</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;delete&#39;</span><span class="o">:</span>
      <span class="nv">$retval</span> <span class="o">=</span> <span class="nx">user_access</span> <span class="p">(</span> <span class="s1">&#39;admin messages&#39;</span><span class="p">,</span> <span class="nv">$account</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nv">$retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd">* Implements hook_node_info()
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_node_info</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;feedback&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback&#39;</span><span class="p">),</span>
      <span class="s1">&#39;module&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;feedback&#39;</span><span class="p">,</span>
      <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;Handle a feedback message&#34;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd">* Implementation of hook_block().
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_block</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="nv">$delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$edit</span> <span class="o">=</span> <span class="k">array</span><span class="p">()</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">&#34;list&#34;</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="nv">$blocks</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;info&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback&#39;</span><span class="p">);</span>
      <span class="nv">$blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&#34;info&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;New Feedbacks&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nv">$blocks</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">$op</span> <span class="o">==</span> <span class="s2">&#34;view&#34;</span> <span class="p">)</span>
  <span class="p">{</span>
      <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nv">$block</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
      <span class="k">switch</span> <span class="p">(</span> <span class="nv">$delta</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
          <span class="nv">$block</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback&#39;</span><span class="p">);</span>

          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;attributes&#34;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;title&#34;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34;Sends a feedback message&#34;</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34;New Feedback&#34;</span><span class="p">),</span> <span class="s2">&#34;node/add/feedback&#34;</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">&#39;&lt;div class=&#34;link&#34;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">&#34;&lt;/div&gt;&#34;</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
          <span class="nv">$block</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Feedback Messages&#39;</span><span class="p">);</span>

          <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">&#34;attributes&#34;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;title&#34;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34;Shows feedback messages&#34;</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nv">$title</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34;There are @total new feeds&#34;</span><span class="p">,</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;@total&#39;</span> <span class="o">=&gt;</span> <span class="nx">_feedback_count</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nv">$link</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nv">$title</span> <span class="p">,</span> <span class="s2">&#34;feedback/adminmessages&#34;</span><span class="p">,</span> <span class="nv">$options</span> <span class="p">);</span>
          <span class="nv">$content</span> <span class="o">.=</span> <span class="s1">&#39;&lt;div class=&#34;link&#34;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$link</span> <span class="o">.</span> <span class="s2">&#34;&lt;/div&gt;&#34;</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nv">$block</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$content</span><span class="p">;</span>
      <span class="k">return</span> <span class="nv">$block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd">* Implementation of hook_menu().
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_menu</span> <span class="p">(</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

  <span class="nv">$items</span><span class="p">[</span><span class="s1">&#39;feedback/adminmessages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
  <span class="p">(</span>
    <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Feedback admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;page callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;feedback_admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;access arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;view messages&#39;</span><span class="p">),</span>
    <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nx">MENU_CALLBACK</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_message</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">&#39;feedback_form&#39;</span> <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_form</span> <span class="p">(</span> <span class="o">&amp;</span><span class="nv">$node</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">global</span> <span class="nv">$user</span><span class="p">;</span>

  <span class="nv">$title</span> <span class="o">=</span> <span class="nx">sprintf</span> <span class="p">(</span> <span class="s1">&#39;Feed from %s&#39;</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">name</span> <span class="p">);</span>
  <span class="nv">$mail</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="nv">$read</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
  <span class="nv">$editing</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="nv">$mail</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// estamos editando
</span><span class="c1"></span>    <span class="nv">$editing</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// estamos previsualizando datos
</span><span class="c1"></span>      <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
      <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
      <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT uid, message, indate, usermail, fm.read FROM {feedback_messages} fm WHERE id=%d&#34;</span><span class="p">;</span>
      <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
      <span class="nv">$storednode</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>

      <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
      <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
      <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$storednode</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nv">$form</span> <span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
    <span class="p">(</span>
      <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;fieldset&#39;</span><span class="p">,</span>
      <span class="s1">&#39;#title&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span> <span class="s1">&#39;Feedback&#39;</span> <span class="p">),</span>
      <span class="s1">&#39;mail&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span><span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;textfield&#39;</span><span class="p">,</span> <span class="s2">&#34;#title&#34;</span><span class="o">=&gt;</span><span class="s2">&#34;E-Mail&#34;</span><span class="p">,</span> <span class="s2">&#34;#description&#34;</span><span class="o">=&gt;</span><span class="s2">&#34;If you want any answer, please, tell me your mail. It would not be shown anywhere.&#34;</span><span class="p">,</span> <span class="s2">&#34;#default_value&#34;</span> <span class="o">=&gt;</span> <span class="nv">$mail</span> <span class="p">),</span>
      <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s2">&#34;#description&#34;</span><span class="o">=&gt;</span><span class="s2">&#34;Write here your message&#34;</span><span class="p">,</span> <span class="s1">&#39;#default_value&#39;</span><span class="o">=&gt;</span><span class="nv">$message</span> <span class="p">),</span>
      <span class="s1">&#39;#required&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
    <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$editing</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$form</span> <span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">][</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;checkbox&#39;</span><span class="p">,</span> <span class="s2">&#34;#title&#34;</span><span class="o">=&gt;</span><span class="s2">&#34;The message has been read&#34;</span><span class="p">,</span> <span class="s1">&#39;#default_value&#39;</span><span class="o">=&gt;</span><span class="nv">$read</span> <span class="p">)</span> <span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span>
    <span class="p">(</span>
      <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span>
      <span class="s1">&#39;#default_value&#39;</span> <span class="o">=&gt;</span> <span class="nv">$title</span><span class="p">,</span>
    <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_insert</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$userid</span>  <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>

  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;INSERT into {feedback_messages} ( id, uid, message, indate, usermail ) values ( %d, %d, &#39;%s&#39;, now(), &#39;%s&#39; ) &#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span><span class="p">,</span> <span class="nv">$userid</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$mail</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span> <span class="p">(</span> <span class="s2">&#34;Thank you for your feedback.&#34;</span> <span class="p">)</span> <span class="p">);</span>
    <span class="nx">drupal_goto</span> <span class="p">(</span> <span class="s1">&#39;node&#39;</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;feedback&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">&#34;An error has happened. Your feedback has not been sent.&#34;</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_update</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$userid</span>  <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">;</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
  <span class="nv">$read</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>

  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;UPDATE {feedback_messages} fm SET message=&#39;%s&#39;, usermail=&#39;%s&#39;, fm.read=%d where id=%d&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$mail</span><span class="p">,</span> <span class="nv">$read</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">db_affected_rows</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">drupal_set_message</span> <span class="p">(</span> <span class="nx">t</span> <span class="p">(</span> <span class="s2">&#34;The feedback has been updated.&#34;</span> <span class="p">)</span> <span class="p">);</span>
    <span class="nx">drupal_goto</span> <span class="p">(</span> <span class="s1">&#39;node&#39;</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;feedback&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span> <span class="s2">&#34;An error has happened. Your feedback has not been sent.&#34;</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**
</span><span class="sd">* Implementation of hook_delete
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">feedback_delete</span> <span class="p">(</span> <span class="nv">$node</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;DELETE FROM {feedback_messages} where id=%d&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_validate</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
  <span class="nv">$mail</span>    <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
  <span class="nv">$validmail</span> <span class="o">=</span> <span class="nx">preg_match</span> <span class="p">(</span><span class="s2">&#34;/^[^0-9][A-z0-9_]+([.][A-z0-9_]+)*[@][A-z0-9_]+([.][A-z0-9_]+)*[.][A-z]{2,4}$/&#34;</span> <span class="p">,</span> <span class="nv">$mail</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$mail</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;You are not a registered user. Please, insert your e-mail.&#39;</span><span class="p">)</span> <span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nv">$mail</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$validmail</span> <span class="p">)</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;The mail does not like an e-mail address.&#39;</span><span class="p">)</span> <span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>
    <span class="nx">form_set_error</span> <span class="p">(</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Message cannot be empty.&#39;</span><span class="p">));</span>

  <span class="k">return</span> <span class="nv">$form</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_view</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$teaser</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">,</span> <span class="nv">$page</span> <span class="o">=</span> <span class="k">FALSE</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$messageread</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
  <span class="nv">$messagedata</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="nv">$messagename</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// ya tenemos el mensaje. Puede deberse a que estamos editando.
</span><span class="c1"></span>    <span class="nv">$messageread</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
    <span class="nv">$messagedata</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="nv">$messagename</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">mail</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">// tenemos que obtener el mensaje
</span><span class="c1"></span>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT fm.uid, message, indate, usermail, u.name, fm.read FROM {feedback_messages} fm, {users} u WHERE id=%d and fm.uid=u.uid&#34;</span><span class="p">;</span>
    <span class="nv">$queryResult</span> <span class="o">=</span> <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span> <span class="p">);</span>
    <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">);</span>

    <span class="nv">$messageread</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
    <span class="nv">$messagedata</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="nv">$messagename</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="nv">$messageusermail</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$read</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageread</span> <span class="p">)</span>
    <span class="nv">$read</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s2">&#34; and &lt;b&gt;already read&lt;/b&gt;&#34;</span><span class="p">);</span>

  <span class="nv">$content</span>  <span class="o">=</span> <span class="nx">sprintf</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;&lt;blockquote&gt;&lt;i&gt;%s&lt;/i&gt;&lt;/blockquote&gt;&lt;p&gt;Sent by %s&lt;a href=&#34;mailto:%s&#34;&gt;&amp;lt;%s&amp;gt;&lt;/a&gt;%s.&lt;/p&gt;&#39;</span><span class="p">),</span> <span class="nv">$messagedata</span><span class="p">,</span> <span class="nv">$messagename</span><span class="p">,</span> <span class="nv">$messageusermail</span><span class="p">,</span> <span class="nv">$messageusermail</span><span class="p">,</span> <span class="nv">$read</span> <span class="p">);</span>


  <span class="nv">$node</span> <span class="o">=</span> <span class="nx">node_prepare</span> <span class="p">(</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$teaser</span> <span class="p">);</span>
  <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">content</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;#value&#39;</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span>
    <span class="s1">&#39;#weight&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">feedback_admin</span> <span class="p">(</span> <span class="nv">$messageid</span><span class="o">=</span><span class="k">null</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nv">$messageid</span> <span class="o">!=</span> <span class="k">null</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">drupal_get_form</span> <span class="p">(</span> <span class="s1">&#39;feedback_messageadmin_form&#39;</span><span class="p">,</span> <span class="nv">$messageid</span> <span class="p">);</span>
    <span class="nv">$content</span> <span class="o">.=</span> <span class="s2">&#34;&lt;hr/&gt;&#34;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$header</span> <span class="o">=</span> <span class="k">array</span>
  <span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;indate&#39;</span><span class="p">,</span> <span class="s1">&#39;sort&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;desc&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;mail&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Message&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;message&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Read&#39;</span><span class="p">),</span> <span class="s1">&#39;field&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;fm.read&#39;</span><span class="p">),</span>
  <span class="p">);</span>

  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT fm.id, u.uid as uid, u.name, fm.usermail, fm.indate, fm.message, fm.read FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span><span class="p">;</span>
  <span class="nv">$query</span> <span class="o">.=</span> <span class="nx">tablesort_sql</span> <span class="p">(</span> <span class="nv">$header</span> <span class="p">);</span>
  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>

  <span class="nv">$rows</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span> <span class="nv">$message</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$row</span> <span class="o">=</span> <span class="k">array</span> <span class="p">();</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;indate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">indate</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;&lt;a href=&#34;?q=user/&#39;</span><span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">uid</span> <span class="o">.</span><span class="s1">&#39;&#34;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">.</span> <span class="s1">&#39;&lt;/a&gt;&#39;</span> <span class="o">:</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;mail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">usermail</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">;</span>
    <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;edit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span> <span class="p">(</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">),</span> <span class="s2">&#34;node/&#34;</span> <span class="o">.</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span> <span class="s2">&#34;/edit&#34;</span><span class="p">);</span>
    <span class="nv">$rows</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$content</span> <span class="o">.=</span> <span class="nx">theme_table</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$rows</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$content</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/** Devuelve el número de feeds creados en la última semana
</span><span class="sd">*/</span>
<span class="k">function</span> <span class="nf">_feedback_count</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&#34;SELECT count(id) as total from {feedback_messages} fm where fm.read != 1 or isnull(fm.read)&#34;</span><span class="p">;</span>
  <span class="nv">$queryResult</span> <span class="o">=</span>  <span class="nx">db_query</span> <span class="p">(</span> <span class="nv">$query</span> <span class="p">);</span>
  <span class="nv">$result</span> <span class="o">=</span> <span class="nx">db_fetch_object</span> <span class="p">(</span> <span class="nv">$queryResult</span> <span class="p">)</span> <span class="p">;</span>

  <span class="k">return</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">total</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Actualizado el 28 Jan 2021</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Compartir en Twitter" data-sharer="twitter" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/" data-title="Creación de un módulo Drupal IV" data-hashtags="drupal"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Facebook" data-sharer="facebook" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/" data-hashtag="drupal"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Linkedin" data-sharer="linkedin" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en WhatsApp" data-sharer="whatsapp" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/" data-title="Creación de un módulo Drupal IV" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Tumblr" data-sharer="tumblr" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/" data-title="Creación de un módulo Drupal IV" data-tags="drupal"><i class="fab fa-tumblr fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Reddit" data-sharer="reddit" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Instapaper" data-sharer="instapaper" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/" data-title="Creación de un módulo Drupal IV" data-description=""><i data-svg-src="/lib/simple-icons/icons/instapaper.min.svg"></i></a><a href="javascript:void(0);" title="Compartir en Digg" data-sharer="digg" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/"><i class="fab fa-digg fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Blogger" data-sharer="blogger" data-url="https://magmax.org/blog/creacion-modulo-drupal-4/" data-title="Creación de un módulo Drupal IV" data-description=""><i class="fab fa-blogger fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/drupal/">drupal</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Regresar</a></span>&nbsp;|&nbsp;<span><a href="/">Inicio</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/blog/tarta-manzana/" class="prev" rel="prev" title="Tarta de manzana"><i class="fas fa-angle-left fa-fw"></i>Tarta de manzana</a>
            <a href="/blog/creacion-modulo-drupal-3/" class="next" rel="next" title="Creación de un módulo Drupal III">Creación de un módulo Drupal III<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Provisto por <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.79.1">Hugo</a> | Tema - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Miguel Ángel</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Volver arriba">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="Ver comentarios">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copiar al portapapeles","maxShownLines":10},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-9308241-3', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-9308241-3" async></script></body>
</html>
