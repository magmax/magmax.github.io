<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Creación de un módulo Drupal II | El blog de MagMax</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Tomando como referencia el tutorial Creación de un módulo Drupal, vamos a añadirle la posibilidad de &ldquo;ver&rdquo; los comentarios, marcándolos como leídos.
  Qué se explica aquí En esta ocasión veremos cómo:
 Actualizar la base de datos Crear enlaces desde una tabla Crear un formulario de edición para una tabla. Entraremos un poquito más en profundidad en algunos temas.  Notas previas En la primera parte del tutorial ya traté de inculcaros que sólo se debe abrir el tag de &lt;?">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="Creación de un módulo Drupal II" />
<meta property="og:description" content="Tomando como referencia el tutorial Creación de un módulo Drupal, vamos a añadirle la posibilidad de &ldquo;ver&rdquo; los comentarios, marcándolos como leídos.
  Qué se explica aquí En esta ocasión veremos cómo:
 Actualizar la base de datos Crear enlaces desde una tabla Crear un formulario de edición para una tabla. Entraremos un poquito más en profundidad en algunos temas.  Notas previas En la primera parte del tutorial ya traté de inculcaros que sólo se debe abrir el tag de &lt;?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/creacion-modulo-drupal-2/" />
<meta property="article:published_time" content="2010-05-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2010-05-11T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta itemprop="name" content="Creación de un módulo Drupal II">
<meta itemprop="description" content="Tomando como referencia el tutorial Creación de un módulo Drupal, vamos a añadirle la posibilidad de &ldquo;ver&rdquo; los comentarios, marcándolos como leídos.
  Qué se explica aquí En esta ocasión veremos cómo:
 Actualizar la base de datos Crear enlaces desde una tabla Crear un formulario de edición para una tabla. Entraremos un poquito más en profundidad en algunos temas.  Notas previas En la primera parte del tutorial ya traté de inculcaros que sólo se debe abrir el tag de &lt;?">
<meta itemprop="datePublished" content="2010-05-11T00:00:00+00:00" />
<meta itemprop="dateModified" content="2010-05-11T00:00:00+00:00" />
<meta itemprop="wordCount" content="1473">



<meta itemprop="keywords" content="drupal," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Creación de un módulo Drupal II"/>
<meta name="twitter:description" content="Tomando como referencia el tutorial Creación de un módulo Drupal, vamos a añadirle la posibilidad de &ldquo;ver&rdquo; los comentarios, marcándolos como leídos.
  Qué se explica aquí En esta ocasión veremos cómo:
 Actualizar la base de datos Crear enlaces desde una tabla Crear un formulario de edición para una tabla. Entraremos un poquito más en profundidad en algunos temas.  Notas previas En la primera parte del tutorial ya traté de inculcaros que sólo se debe abrir el tag de &lt;?"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        El blog de MagMax
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Inicio page">
              Inicio
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="../en" title="English page">
              English
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://magmax.org/blog/creacion-modulo-drupal-2/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://magmax.org/blog/creacion-modulo-drupal-2/&amp;text=Creaci%c3%b3n%20de%20un%20m%c3%b3dulo%20Drupal%20II" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://magmax.org/blog/creacion-modulo-drupal-2/&amp;title=Creaci%c3%b3n%20de%20un%20m%c3%b3dulo%20Drupal%20II" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Creación de un módulo Drupal II</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2010-05-11T00:00:00Z">May 11, 2010</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Tomando como referencia el tutorial <a href="https://magmax.org/blog/creacion-modulo-drupal/">Creación de un módulo Drupal</a>, vamos a añadirle la posibilidad de &ldquo;ver&rdquo; los comentarios, marcándolos como leídos.</p>
<!-- raw HTML omitted -->
<figure>
    <img src="/images/drupal.png"
         alt="Drupal"/> 
</figure>

<h2 id="qué-se-explica-aquí">Qué se explica aquí</h2>
<p>En esta ocasión veremos cómo:</p>
<ul>
<li>Actualizar la base de datos</li>
<li>Crear enlaces desde una tabla</li>
<li>Crear un formulario de edición para una tabla.</li>
<li>Entraremos un poquito más en profundidad en algunos temas.</li>
</ul>
<h2 id="notas-previas">Notas previas</h2>
<p>En la primera parte del tutorial ya traté de inculcaros que sólo se debe abrir el tag de <code>&lt;?php</code>, y no se debe cerrar con <code>?&gt;</code>. En esta ocasión no seré tan pesado.</p>
<p>El primer tutorial fue algo rápido, ya que era muy largo. En los próximos tutoriales, iré ampliando conceptos para que podáis desarrollar vuestros propios módulos. Prometo que serán más cortos.</p>
<h2 id="modificando-la-bbdd">Modificando la BBDD</h2>
<p>Nuestro primer problema es que la base de datos va a cambiar. Necesitamos una columna nueva para la tabla feedback_messages, llamada &ldquo;read&rdquo;, (de &lsquo;leído&rsquo;). Va a ser un booleano. Como tenemos nuestro plugin en producción, no nos apetece tener que estar desinstalándolo, instalándolo de nuevo, etc, perdiendo todos los comentarios que nos hayan puesto. Otra opción es modificar la base de datos a mano, pero no deja de ser igual de tedioso, y no podemos pedirles a nuestros usuarios que lo hagan así.</p>
<p>Vamos a hacerlo bien, editando <code>feedback.install</code> y añadiendo lo siguiente:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_update_6100</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  $ret <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  <span style="color:#a6e22e">db_add_field</span>($ret, <span style="color:#e6db74">&#39;feedback_messages&#39;</span>, <span style="color:#e6db74">&#39;read&#39;</span>, <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;int&#39;</span>, <span style="color:#e6db74">&#39;size&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;tiny&#39;</span>));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  <span style="color:#66d9ef">return</span> $ret;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>}
</code></pre></div><p>En la función <code>virtualcoin_schema</code> que creamos en la primera parte, lo que
hicimos fue crear un enorme array de arrays. Realmente se le llama <em>&ldquo;schema&rdquo;</em>,
ya que es el esquema de nuestra base de datos. Podríamos haber usado sentencias
SQL, pero el uso de este esquema nos permite ser independientes de la base de
datos que use el futuro usuario de nuestro módulo.</p>
<p>En este caso, completamos el schema añadiéndole la columna nueva, que, como
veréis, no es booleana como dije. Eso es porque el tipo booleano no existe en
Drupal. Podéis consultar la <a href="https://drupal.org/node/159605">lista de tipos drupal</a>.</p>
<p>La función se llama <code>feedback_update_6100</code>, ya que es del módulo
&ldquo;feedback&rdquo;, es un &ldquo;update&rdquo;, para la versión 6 de drupal y es el que debe
ejecutarse en primer lugar, si es que tuviéramos más actualizaciones que
aplicar. No me voy a detener a explicar <a href="https://api.drupal.org/api/function/hook_update_N/6">el por qué de los numeritos</a>.</p>
<p>Después es necesario irnos a &ldquo;update.php&rdquo; y seguir las instrucciones. Con eso se nos actualizarán los módulos (en este caso, nuestro módulo) y tendremos la tabla actualizada.</p>
<h2 id="modificando-los-menús">Modificando los menús</h2>
<p>Vamos a modificar el <code>hook_menu</code>.</p>
<p>Como ODIO que me pongan sólo parte de una función, os pego el código entero:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#e6db74">* Implementation of hook_menu().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_menu</span> ( )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  $items <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  $items[<span style="color:#e6db74">&#39;feedback/message&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_message&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;send message&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  $items[<span style="color:#e6db74">&#39;feedback/adminmessages/%&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback Admin&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#e6db74">&#39;page arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#ae81ff">2</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;view messages&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  $items[<span style="color:#e6db74">&#39;feedback/adminmessages&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback Admin&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;view messages&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  <span style="color:#66d9ef">return</span> $items;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>}
</code></pre></div><p>Hay dos cambios respecto de la original. ¿Los véis? ¿No?</p>
<p>El primero consiste en el nombre del menú. Antes era <code>feedback/adminmessages</code>, y ahora <code>feedback/adminmessages/%</code>. Drupal irá tratando de encajar la ruta que hayan insertado con alguno de los patrones; el porcentaje (%) es como decir: <em>cualquier cosa</em>. En este caso, encajará con cualquier cosa que tenga: <code>feedback/adminmessages/</code> y algo más (ojo, ya que no encaja si no tiene nada más).</p>
<p>El segundo cambio es la opción <code>page arguments</code>. Le asignamos el valor <code>array (2)</code>:. Eso implica tomar la 3ª parte de la ruta y meterla en un vector que se le pasará a nuestra función.</p>
<p>Voy a explicarlo con un ejemplo. El usuario pone la ruta <code>feedback/adminmessages/25</code>. Por lo tanto, si ponemos el valor de <code>page arguments</code> a 0, obtendremos <code>feedback</code>; a 1, <code>adminmessages</code> y a 2, &ldquo;25&rdquo;, que es justo lo que queremos.</p>
<p>¿Qué ocurre si el usuario pone <code>feedback/adminmessages/25/añsldfj</code>? Pues que vuelve a encajar en el patrón dado (a falta de otro mejor), y se trataría exactamente igual que el ejemplo anterior (la parte <em>añsldfj</em> ignorará).</p>
<p>Dejamos también la parte que existía antes, con el fin de poder pintar también algo cuando no se ha seleccionado un mensaje.</p>
<h2 id="modificando-funciones">Modificando funciones</h2>
<p>Bueno, pues ya tenemos modificados los menus, así que vamos a modificar también las funciones.</p>
<p>Comenzamos por la función <code>feedback_admin</code>. En esta función vamos a hacer tres cambios:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_admin</span> ( $messageid<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#66d9ef">if</span> ( $messageid <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_messageadmin_form&#39;</span>, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  $header <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Date&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;indate&#39;</span>, <span style="color:#e6db74">&#39;sort&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;desc&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;User&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;name&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;message&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.id, u.name, fm.indate, fm.message FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>  $queryResult <span style="color:#f92672">=</span>  <span style="color:#a6e22e">db_query</span> ( $query );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  $rows <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  <span style="color:#66d9ef">while</span> ( $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult ) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    $row <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    $row[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    $row[<span style="color:#e6db74">&#39;indate&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    $row[<span style="color:#e6db74">&#39;message&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    $row[<span style="color:#e6db74">&#39;edit&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;edit&#39;</span>), <span style="color:#e6db74">&#34;feedback/adminmessages/&#34;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">id</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    $rows[] <span style="color:#f92672">=</span> $row;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">theme_table</span>($header, $rows);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>}
</code></pre></div><p>En primer lugar, hemos añadido un parámetro con un valor por defecto.</p>
<p>En segundo lugar, se añade la comprobación para saber si a la función se le
llamó con algún parámetro (en caso contario, habría obtenido el valor por
defecto, que es <code>NULL</code>). Si es así, pintamos un formulario (más adelante).</p>
<p>Y para finalizar, le hemos añadido una nueva fila a cada elemento de la lista,
de manera que se creen enlaces a la dirección <code>feedback/adminmessages/</code> seguida
del id del mensaje a mostrar.</p>
<p><strong>NOTA:</strong> ¿Qué ocurre si un usuario malicioso trata de escribir esta dirección
sin tener permisos? No tenemos que preocuparnos. Recordad que al definir los
menús (apartado anterior) establecimos los permisos.</p>
<p>Claro, la función anterior nos está pidiendo a gritos que implementemos el
formulario que nos falta y que, por ser un formulario, requiere también de un
submit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_messageadmin_form</span> ( $form, <span style="color:#f92672">&amp;</span>$messageid )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.message, fm.read, fm.indate, u.name FROM {feedback_messages} fm, {users} u WHERE fm.id=%d and u.uid=fm.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  $form <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>      <span style="color:#e6db74">&#39;feedback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>      (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;fieldset&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#e6db74">&#39;#title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#39;Feedback from &#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39; sended on &#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#e6db74">&#39;messageid&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;hidden&#39;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $messageid ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textarea&#39;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>, <span style="color:#e6db74">&#34;#disabled&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        <span style="color:#e6db74">&#39;read&#39;</span>  <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;checkbox&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Read&#34;</span>,<span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        <span style="color:#e6db74">&#39;submit&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;submit&#39;</span>,  <span style="color:#e6db74">&#39;#value&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Submit&#39;</span>),  ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>      ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_messageadmin_form_submit</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  $messageid <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;messageid&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  $read      <span style="color:#f92672">=</span> $form_state[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;read&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UPDATE {feedback_messages} fm set fm.read=%d where fm.id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $read, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>}
</code></pre></div><p>Una explicación breve: Hemos creado un formulario con un campo oculto
(<code>messageid</code>) para albergar el id del mensaje. Además, añadimos el propio
mensaje en un textarea deshabilitado, con el fin de que no se pueda modificar.
Por último, añadimos un checkbox para marcar como leído, que es lo que puede
hacer el administrador. Bueno, claro: y el botón de submit.</p>
<p>En este caso no hemos implementado un hook_validate debido a lo sencillo que era
el formulario (en un formulario con un único checkbox es difícil hacer
marranadas), pero sí hemos implementado el <code>hook_submit</code>, que tan sólo actualiza
el mensaje en cuestión.</p>
<p>Y, para ya dejarlo todo niquelao, vamos a modificar la función que obtenía el
número de mensajes a ver. Antes era tan cutre que mostraba todos los que
tuvieran menos de una semana. Ahora podemos hacer que muestre los que no hemos
marcado como leídos:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_feedback_count</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT count(id) as total from {feedback_messages} fm where fm.read != 1&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>  $result <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult ) ;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>  <span style="color:#66d9ef">return</span> $result<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">total</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>}
</code></pre></div><h2 id="más-tutoriales">Más tutoriales</h2>
<p>Este tutorial es la continuación de <a href="https://magmax.org/blog/creacion-modulo-drupal/">Creación de un módulo Drupal</a>, Además, podéis continuar el tutorial en:</p>
<ul>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-3/">Creación de un módulo drupal (III)</a></li>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-4/">Creación de un módulo drupal (IV)</a></li>
<li><a href="https://magmax.org/blog/drupal-expansors/">Drupal: Creando contenido con &lsquo;expansors&rsquo;</a></li>
<li><a href="https://magmax.org/blog/critica-drupal/">Crítica a Drupal</a></li>
<li><a href="https://magmax.org/blog/drupal-tabla-perfecta/">Tablas en Drupal: Haciendo la tabla perfecta</a></li>
</ul>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/drupal" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">drupal</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "magmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Relacionado</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal/">Creación de un módulo Drupal</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal-3/">Creación de un módulo Drupal III</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal-4/">Creación de un módulo Drupal IV</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/drupal-no-muestra-comentarios/">Drupal no me muestra los comentarios</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/drupal-tabla-perfecta/">Tablas en Drupal: Haciendo una tabla perfecta</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://magmax.org/" >
    &copy;  El blog de MagMax 2021 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
