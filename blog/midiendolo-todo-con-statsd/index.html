<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Midiéndolo todo con StatsD | El blog de MagMax</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Introducción al uso de StatsD">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="Midiéndolo todo con StatsD" />
<meta property="og:description" content="Introducción al uso de StatsD" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/midiendolo-todo-con-statsd/" />
<meta property="article:published_time" content="2015-07-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-07-12T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta itemprop="name" content="Midiéndolo todo con StatsD">
<meta itemprop="description" content="Introducción al uso de StatsD">
<meta itemprop="datePublished" content="2015-07-12T00:00:00+00:00" />
<meta itemprop="dateModified" content="2015-07-12T00:00:00+00:00" />
<meta itemprop="wordCount" content="1666">



<meta itemprop="keywords" content="monitoring," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Midiéndolo todo con StatsD"/>
<meta name="twitter:description" content="Introducción al uso de StatsD"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        El blog de MagMax
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Inicio page">
              Inicio
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="../en" title="English page">
              English
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://magmax.org/blog/midiendolo-todo-con-statsd/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://magmax.org/blog/midiendolo-todo-con-statsd/&amp;text=Midi%c3%a9ndolo%20todo%20con%20StatsD" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://magmax.org/blog/midiendolo-todo-con-statsd/&amp;title=Midi%c3%a9ndolo%20todo%20con%20StatsD" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Midiéndolo todo con StatsD</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2015-07-12T00:00:00Z">July 12, 2015</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Tras el artículo <a href="https://magmax.org/blog/graficas-basadas-en-tiempo-graphite/">Gráficas basadas en tiempo: Graphite</a> era obligatorio escribir
uno sobre <a href="https://github.com/etsy/statsd">StatsD</a>.</p>
<p>En este artículo voy a contar qué es <a href="https://github.com/etsy/statsd">StatsD</a> y cómo usarlo para extraer
estadísticas de uso de nuestro código. Aunque al principio pueda parecer un poco
extraño, os aseguro que es realmente interesante, sobre todo cuando se usa junto
con <a href="https://graphite.wikidot.com/">Graphite</a>.</p>
<!-- raw HTML omitted -->
<figure>
    <img src="/images/stats.png"
         alt="Diferentes tipos de gráficas"/> 
</figure>

<h2 id="qué-es-statsd">¿Qué es StatsD?</h2>
<p>Según la propia página de StatsD:</p>
<blockquote>
<p>StatsD is a front-end proxy for the Graphite/Carbon metrics server, originally written by Etsy&rsquo;s Erik Kastner. It is based on ideas from Flickr and this post by Cal Henderson: Counting and Timing. The server was written in Node, though there have been implementations in other languages since then.</p>
</blockquote>
<p>Pero debo decir que la definición no me gusta. No, porque <a href="https://graphite.wikidot.com/">Graphite</a> es sólo uno de los posibles backends.</p>
<p>En lugar de preguntarnos <em>&quot;¿qué es StatsD?&quot;</em> deberíamos preguntarnos <em>&quot;¿Para qué sirve StatsD?&quot;</em>.</p>
<p>StatsD permite recopilar datos de&hellip; cosas, para su posterior uso. Cosas como número de ejecuciones, veces que se pasa por una función, tiempo que tarda en ejecutarse una acción, etc.</p>
<p>Existen <a href="https://github.com/etsy/statsd/wiki#server-implementations">distintas implementaciones del servidor StatsD</a>, aunque la original es
la escrita en <a href="https://nodejs.org/">NodeJS</a>, que va a ser la que voy a comentar, ya que es la más completa. Hay clientes para cualquier lenguaje, ya que basta enviar una trama sencilla por UDP. Veremos esto más adelante.</p>
<h2 id="instalando-statsd">Instalando StatsD</h2>
<p>Como ya he dicho, usaremos <a href="https://github.com/etsy/statsd">la implementación de Etsy</a>, que es la más famosa, y
que está implementada en <a href="https://nodejs.org/">NodeJS</a>, por lo que lo primero será instalar <a href="https://nodejs.org/">NodeJS</a> si no lo tenemos ya:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>apt-get install nodejs
</code></pre></div><p>A continuación, la instalación estándar nos sugiere clonar el repositorio:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>git clone https://github.com/etsy/statsd.git
</code></pre></div><p>Aunque otro métido alternativo es usar <a href="https://www.npmjs.com/">npm</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>npm install statsd
</code></pre></div><p>El primer metodo nos dejará el código en el directorio <code>statsd</code>, mientras que
el segundo lo hará en <code>node_modules\statsd</code>, pero el resultado será muy
similar. Yo he usado <a href="https://www.npmjs.com/">npm</a> para este artículo.</p>
<p>Lo siguiente es configurarlo. Para ello basta copiar el archivo <code>node_modules/statsd/exampleConfig.js</code> al directorio actual y modificarlo. Veréis que el 99% del archivo es ayuda sobre el propio archivo, y que la configuración se reduce a algo como:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  <span style="color:#a6e22e">graphitePort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2003</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>, <span style="color:#a6e22e">graphiteHost</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;graphite.example.com&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>, <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">8125</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>, <span style="color:#a6e22e">backends</span><span style="color:#f92672">:</span> [ <span style="color:#e6db74">&#34;./backends/graphite&#34;</span> ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>}
</code></pre></div><p>Podéis cambiar <code>graphiteHost</code> por <code>localhost</code>, y si seguísteis el artículo
<a href="https://magmax.org/blog/graficas-basadas-en-tiempo-graphite/">Gráficas basadas en tiempo: Graphite</a> ya estaría todo funcionando con
<a href="https://graphite.wikidot.com/">Graphite</a>. De todas maneras, para comenzar recomiendo cambiar el <strong>backend</strong>
por <code>console</code>, y así no es necesario tener <a href="https://graphite.wikidot.com/">Graphite</a> instalado y podremos ver todos los datos en crudo. Por ello usaremos el archivo de configuración:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  <span style="color:#a6e22e">port</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">8125</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>, <span style="color:#a6e22e">backends</span><span style="color:#f92672">:</span> [ <span style="color:#e6db74">&#34;./backends/console&#34;</span> ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>}
</code></pre></div><h2 id="ejecutando-statsd">Ejecutando StatsD</h2>
<p>Con esta configuración ya podemos ejecutarlo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>node node_modules/statsd/stats.js config.js
</code></pre></div><p>Cada 10 segundos aparecerá un mensaje parecido a éste:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>{ <span style="color:#a6e22e">counters</span><span style="color:#f92672">:</span> { <span style="color:#e6db74">&#39;statsd.bad_lines_seen&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;statsd.packets_received&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  <span style="color:#a6e22e">timers</span><span style="color:#f92672">:</span> {},
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  <span style="color:#a6e22e">gauges</span><span style="color:#f92672">:</span> {},
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  <span style="color:#a6e22e">timer_data</span><span style="color:#f92672">:</span> {},
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  <span style="color:#a6e22e">counter_rates</span><span style="color:#f92672">:</span> { <span style="color:#e6db74">&#39;statsd.bad_lines_seen&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;statsd.packets_received&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>  <span style="color:#a6e22e">sets</span><span style="color:#f92672">:</span> {},
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>  <span style="color:#a6e22e">pctThreshold</span><span style="color:#f92672">:</span> [ <span style="color:#ae81ff">90</span> ] }
</code></pre></div><p>Ahí se indica la información recolectada. Hay algunos puntos curiosos:</p>
<ul>
<li><code>counters</code>: Los contadores recibidos. Por defecto ya tiene 2, relacionados
con el propio <a href="https://github.com/etsy/statsd">StatsD</a>.</li>
<li><code>timers</code>: contadores de tipo tiempo recibidos.</li>
<li><code>gauges</code>: Es un tipo de métrica que mantiene el último valor hasta recibir uno nuevo.</li>
<li><code>timer_data</code>: Información ya tratada de los <code>timers</code>.</li>
<li><code>counter_rates</code>: estadísticas de uso de los contadores.</li>
<li><code>sets</code>: grupos de métricas recibidos.</li>
<li><code>pctThreshold</code>: o &ldquo;percentile threshold&rdquo;, que es el percentil calculado para
tiempos. Es decir: si en un intervalo se reciben 100 mediciones de tiempo, se
cogerá el <a href="https://en.wikipedia.org/wiki/Percentile">percentil 90</a> de éstas, ya que es estadísticamente más representativo.</li>
</ul>
<p>Se puede configurar el tiempo del intervalo, pero por defecto son 10 segundos, y eso está bien para nuestro ejemplo.</p>
<h2 id="cómo-enviar-métricas-a-statsd">Cómo enviar métricas a StatsD</h2>
<p>Bueno, antes deberíamos saber qué tipos de métricas se pueden enviar, aunque ya están mencionadas en el apartado anterior:</p>
<ul>
<li>Contadores, con formato <code>métrica:N|c</code>, siendo <code>N</code> el valor de la métrica.</li>
<li>Tiempos, con formato <code>métrica:N|ms</code>, siendo <code>N</code> el tiempo a registrar.</li>
<li>Gauges, con formato <code>métrica:N|g</code>, siendo <code>N</code> el valor de la métrica. Son valores que se mantienen hasta que llegue el siguiente.</li>
<li>Sets, con formato <code>métrica:N|s</code>, siendo <code>N</code> un número de ocurrencias a registrar.</li>
</ul>
<p>El formato, además, permite indicar la agrupación añadiendo <code>|@0.1</code>, donde <code>0.1</code> indica que el valor sólo se está enviando 1/10 del tiempo.
También se permite el envío de varias métricas en un sólo mensaje, separándolas por <code>\n</code>.</p>
<p>Como ya se dijo antes, basta con enviar estos datos en una trama UDP. Podemos usar <strong>Bash</strong>, por ejemplo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>   echo <span style="color:#e6db74">&#34;this.is.a.counter:1|c&#34;</span> | nc -u -w1 127.0.0.1 <span style="color:#ae81ff">8125</span>
</code></pre></div><p>que provocará un cambio en la salida del servidor, mostrando el mensaje:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>   { <span style="color:#a6e22e">counters</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>      { <span style="color:#e6db74">&#39;statsd.bad_lines_seen&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        <span style="color:#e6db74">&#39;statsd.packets_received&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#e6db74">&#39;this.is.a.counter&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>     <span style="color:#a6e22e">timers</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">glork</span><span style="color:#f92672">:</span> [] },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>     <span style="color:#a6e22e">gauges</span><span style="color:#f92672">:</span> { <span style="color:#e6db74">&#39;statsd.timestamp_lag&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>     <span style="color:#a6e22e">timer_data</span><span style="color:#f92672">:</span> {},
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>     <span style="color:#a6e22e">counter_rates</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>      { <span style="color:#e6db74">&#39;statsd.bad_lines_seen&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#e6db74">&#39;statsd.packets_received&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0.1</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        <span style="color:#e6db74">&#39;this.is.a.counter&#39;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0.1</span> },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>     <span style="color:#a6e22e">sets</span><span style="color:#f92672">:</span> {},
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>     <span style="color:#a6e22e">pctThreshold</span><span style="color:#f92672">:</span> [ <span style="color:#ae81ff">90</span> ] }
</code></pre></div><p>Como vemos, hay una ocurrencia del contador. A los 10 segundos se volverá a mostrar un 0, ya que en ese intervalo no ha habido ocurrencias.</p>
<p>Recomendaría jugar aquí con los distintos tipos de métricas, varias métricas en un mensaje, cambiar la agrupación, etc. Incluso intentarlo desde el lenguaje que vayáis a utilizar después.</p>
<h2 id="para-qué-sive-statsd">¿Para qué sive StatsD?</h2>
<p>Pero nada de todo esto explica para qué podemos utilizar StatsD. Vamos a verlo
con ejemplos. Utilizaré Python, junto con el [ejemplo de cliente Python
proporcionado por Ets]y</p>
<p>Tenemos una función muy costosa, que permite multiplicar dos matrices y queremos registrar cuánto tarda en ejecutarse. Aquí está nuestra función original:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply_matrix</span>(a, acols, b, bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    c <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (acols <span style="color:#f92672">*</span> bcols)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(acols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>            partial <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>            <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>                partial <span style="color:#f92672">+=</span> a[pos(i, k, acols)] <span style="color:#f92672">*</span> b[pos(k, j, bcols)]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>            c[pos(i, j, acols)] <span style="color:#f92672">=</span> partial
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>    <span style="color:#66d9ef">return</span> c
</code></pre></div><p>Dado que el cliente de <a href="https://github.com/etsy/statsd">StatsD</a> no va a cambiar con el tiempo, podemos considerar que todos sus métodos son estáticos y usar una única instancia, ya configurada con el <em>host</em> y <em>port</em> deseados, y guardarlo todo en una variable global (cosa que no debería ser lo habitual, pero en este caso estaría justificado). He marcado las líneas nuevas:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">import</span> time  <span style="color:#75715e"># +</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> python_example <span style="color:#f92672">import</span> StatsdClient  <span style="color:#75715e"># +</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>statsd <span style="color:#f92672">=</span> StatsdClient(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;localhost&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8125</span>)  <span style="color:#75715e"># +</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply_matrix</span>(a, acols, b, bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    start <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()  <span style="color:#75715e"># +</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    c <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (acols <span style="color:#f92672">*</span> bcols)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(acols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            partial <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>                partial <span style="color:#f92672">+=</span> a[pos(i, k, acols)] <span style="color:#f92672">*</span> b[pos(k, j, bcols)]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            c[pos(i, j, acols)] <span style="color:#f92672">=</span> partial
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    elapsed <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start  <span style="color:#75715e"># +</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    statsd<span style="color:#f92672">.</span>timing(<span style="color:#e6db74">&#39;matrix.</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_colsx</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_cols.time&#39;</span> <span style="color:#f92672">%</span> (acols, bcols), elapsed)  <span style="color:#75715e"># +</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#66d9ef">return</span> c
</code></pre></div><p>6 líneas contando <code>include</code> y configuración.</p>
<p>Además, quiero contar cuántas veces se llama a la función por cada tamaño de matrices:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">import</span> time
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> python_example <span style="color:#f92672">import</span> StatsdClient
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>statsd <span style="color:#f92672">=</span> StatsdClient(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;localhost&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8125</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply_matrix</span>(a, acols, b, bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    statsd<span style="color:#f92672">.</span>count(<span style="color:#e6db74">&#39;matrix.</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_colsx</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_cols.count&#39;</span> <span style="color:#f92672">%</span> (acols, bcols), elapsed)  <span style="color:#75715e"># +</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    start <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    c <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (acols <span style="color:#f92672">*</span> bcols)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(acols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            partial <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>            <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(bcols):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>                partial <span style="color:#f92672">+=</span> a[pos(i, k, acols)] <span style="color:#f92672">*</span> b[pos(k, j, bcols)]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            c[pos(i, j, acols)] <span style="color:#f92672">=</span> partial
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    elapsed <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    statsd<span style="color:#f92672">.</span>timing(<span style="color:#e6db74">&#39;matrix.</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_colsx</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_cols.time&#39;</span> <span style="color:#f92672">%</span> (acols, bcols), elapsed)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#66d9ef">return</span> c
</code></pre></div><p>Una línea más.</p>
<h3 id="ventajas">Ventajas</h3>
<p>Pero&hellip; ¿En qué afecta esto al tiempo de ejecución? Bueno, por el principio de Heisenberg, donde el observador siempre altera lo observado, en algo, pero en muy poco, ya que al utilizar el protocolo UDP no hay tiempos de latencia.</p>
<p>UDP tiene un problema: Es posible que la trama se pierda. Así que estas
estadísticas no serán muy exactas, pero pueden darnos una idea muy aproximada de
la evolución del sistema. De todas maneras, si el servidor <a href="https://github.com/etsy/statsd">StatsD</a> está en local, es raro que se pierda una trama.</p>
<p>Si se conectara contra <a href="https://graphite.wikidot.com/">Graphite</a> directamente por TCP entonces sí que habría retrasos: hay que establecer la conexión, enviar la información, esperar <strong>ACK</strong>, etc.</p>
<p>Otra ventaja es que no puede fallar. Si nuestro servidor TCP está caído, debemos tratar la excepción o el programa fallará. Si usamos UDP, perderemos la métrica, pero seguiremos dando servicio.</p>
<p>¿Dónde es especialmente útil?</p>
<ul>
<li>Para tiempos de ejecución de <strong>queries</strong>. En pruebas de estrés podría mostrar la evolución del tiempo de ejecución en función de los datos ya existentes.</li>
<li>Contabilizar <strong>logins en una web</strong> u otras operaciones, así como <em>logins</em> fallidos, permitiendo detectar ataques por fuerza bruta.</li>
<li>Medir <strong>tiempos de respuesta</strong> en una web.</li>
</ul>
<p>En Tuenti nos hicimos un <em>wrapper</em> sobre mercurial, para detectar la evolución
del tiempo necesario para ejecutar cada subcomando, para medir la evolución de
los más lentos. Gracias a esto, <a href="https://corporate.tuenti.com/es/dev/blog/Mercurial-performance-boost">detectamos un problema grave de rendimiento</a> y pudimos medir su evolución.</p>
<h2 id="clusters-de-statsd">Clusters de StatsD</h2>
<p>Todo esto tiene un problema. Si tenemos un balanceador de carga con dos
servidores, cada uno con su servidor StatsD, y queremos medir los tiempos de
request, el último que mande su valor a <a href="https://graphite.wikidot.com/">Graphite</a> es el que quedará. Por eso debemos configurar los servidores StatsD como <strong>Proxies</strong>, indicando la ubicación del resto de servidores StatsD.</p>
<h2 id="conclusión">Conclusión</h2>
<p>Todo se puede medir, y es importante medirlo todo. Desgraciadamente, eso requiere muchos recursos. Pero StatsD es una herramienta muy interesante para medir allá donde no se puede con otras herramientas.</p>
<p>Finalmente os dejo con un vídeo de cómo hacer todo lo que he contado aquí:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/J5CeLI2CiPk" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>También os proporciono otro vídeo de cómo instalar <a href="https://graphite.wikidot.com/">Graphite</a> y <a href="https://github.com/etsy/statsd">Statsd</a> en 3
minutos, mostrando los datos. Es importante tener en cuenta que <a href="https://github.com/etsy/statsd">Statsd</a> dejará las métricas en <code>stats/gauges/</code> en lugar de colgar del árbol principal.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/ADMPs4FzLDQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>Quizá os parezca extraño ver cómo se altera la gráfica en parte del vídeo, pero
es algo normal: Al llegar varias métricas durante el mismo cupo de tiempo, el
último predomina. Para cambiar eso habría que modificar la configuración de
Carbon, como se explicó en el artículo <a href="https://magmax.org/blog/graficas-basadas-en-tiempo-graphite/">Gráficas basadas en tiempo: Graphite</a>.</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/monitoring" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">monitoring</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "magmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Relacionado</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/graficas-basadas-en-tiempo-graphite/">Gráficas basadas en tiempo: Graphite</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/monitorizacion-y-alertado/">Monitorización y alertado</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://magmax.org/" >
    &copy;  El blog de MagMax 2021 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
