<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>compilers on El blog de MagMax</title>
    <link>https://magmax.org/tags/compilers/</link>
    <description>Recent content in compilers on El blog de MagMax</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Sun, 20 May 2012 00:00:00 +0000</lastBuildDate><atom:link href="https://magmax.org/tags/compilers/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>El compilador de Python desde dentro</title>
      <link>https://magmax.org/blog/python-compiler-internals/</link>
      <pubDate>Sun, 20 May 2012 00:00:00 +0000</pubDate>
      
      <guid>https://magmax.org/blog/python-compiler-internals/</guid>
      <description>
        
          &lt;p&gt;Los viernes hay formación en la oficina. El viernes pasado le tocó dar una charla a Goran, y nos estuvo contando cómo funciona PHP por dentro.&lt;/p&gt;
&lt;p&gt;No he podido quitarme la charla de la cabeza en todo el fin de semana, y he investigado cómo funciona Python por dentro. Goran se quejaba de que hay muy poca información sobre PHP, y tampoco hay tanta sobre Python. Pero encontré este artículo, me gustó y he tenido que traducirlo. Lo mejor es que todos los lenguajes que están de moda (PHP, Python, Ruby, Java, &amp;hellip;) se basan en los mismos principios, aunque algunos de ellos tienen mayor acierto que otros, y la implementación, que es completamente diferente.&lt;/p&gt;
&lt;p&gt;El artículo original, &lt;a href=&#34;https://tomlee.co/wp-content/uploads/2008/12/python-language-internals.pdf&#34;&gt;&amp;lsquo;Python Compiler Internals&amp;rsquo;&lt;/a&gt;  lo escribió &lt;a href=&#34;https://tomlee.co&#34;&gt;Thomas Lee&lt;/a&gt;  (&lt;a href=&#34;https://twitter.com/#!/tglee&#34;&gt;@tglee&lt;/a&gt; ) en el 2008, pero es perfectamente válido hoy en día. Me gustó por lo sencillo y por lo acertado del ejemplo.&lt;/p&gt;
&lt;p&gt;Espero que también os guste:&lt;/p&gt;
&lt;!-- raw HTML omitted --&gt;
&lt;figure&gt;
    &lt;img src=&#34;https://magmax.org/images/python.png&#34;
         alt=&#34;Python&#34;/&gt; 
&lt;/figure&gt;

&lt;hr&gt;
&lt;h2 id=&#34;resumen&#34;&gt;Resumen&lt;/h2&gt;
&lt;p&gt;En este artículo se introduce una nueva instrucción del lenguaje para demostrar cómo se puede comenzar a modificar el compilador del lenguaje Python. El lenguaje Python en sí mismo es un lenguaje potente, dinámicamente tipado que corre en gran variedad de sistemas operativos y plataformas. Los entresijos del propio compilador siguen un patrón común en las implementaciones de muchos lenguajes, con fases de análisis léxico, sintáctico y generación de código. Esto hace del código fuente de Python un buen lugar para aprender cómo deberían implementarse los lenguajes en su sentido más general. Tras leer el artículo, se espera que el lector vea que contribuir al núcleo del lenguaje Python no es tan complejo como puede parecer.&lt;/p&gt;
&lt;h2 id=&#34;1-vista-general&#34;&gt;1. Vista general&lt;/h2&gt;
&lt;p&gt;Aquéllos que ven a Python como un lenguaje de &lt;em&gt;scripting&lt;/em&gt; pueden sorprenderse al descubrir que el núcleo del intérprete Python realmente tiene la estructura de un compilador clásico. Cuando se invoca la orden &amp;ldquo;python&amp;rdquo;, el código fuente se escanea buscando &lt;em&gt;tokens&lt;/em&gt;, estos &lt;em&gt;tokens&lt;/em&gt; se procesan en una representación arbórea de la estructura lógica del programa, que finalmente se transforma en &lt;em&gt;bytecode&lt;/em&gt;. Finalmente, este &lt;em&gt;bytecode&lt;/em&gt; se procesa por la máquina virtual.&lt;/p&gt;
&lt;p&gt;Con el fin de demostrar cómo encajan entre sí los distintos componentes del compilador de Python, usaremos como base el código de Python 2.6 caminando hacia la agregación de una nueva estructura del lenguaje: la instrucción &lt;em&gt;&amp;ldquo;unless&amp;rdquo;&lt;/em&gt;, mostrada en el listado siguiente:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; sys
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;2&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;3&lt;/span&gt;passwd &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; sys&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;stdin&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;readline()&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;strip()
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;4&lt;/span&gt;unless passwd &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;tehsecret&amp;#39;&lt;/span&gt;:
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;5&lt;/span&gt;       &lt;span style=&#34;color:#66d9ef&#34;&gt;print&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Password do not match. Exiting!&amp;#39;&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;6&lt;/span&gt;       sys&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;exit(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Todo el código de este artículo se ha escrito y probado con Python 2.6 beta 3, cuyo repositorio Subversion puede encontrarse aquí: &lt;a href=&#34;https://svn.python.org/projects/python/tags/r26b3/&#34;&gt;https://svn.python.org/projects/python/tags/r26b3/&lt;/a&gt; . La única cosa que debería cambiar en la versión 2.6 final son los números de línea referenciados en los listados de fuentes aquí presentes.&lt;/p&gt;
&lt;h2 id=&#34;2-análisis-léxico&#34;&gt;2. Análisis léxico&lt;/h2&gt;
&lt;p&gt;En lugar de tratar de procesar un flujo de texto directamente, a menudo es más sencillo &amp;ndash; y rápido &amp;ndash; desglosar la entrada de texto en una serie de &amp;ldquo;tokens&amp;rdquo;, que deberían incluir palabras reservadas, literales, operadores y/o identificadores. Estos &lt;em&gt;tokens&lt;/em&gt; pueden inspeccionarse por el procesador de forma más eficiente que un flujo de texto plano. El proceso de transformar la entra de texto en &lt;em&gt;tokens&lt;/em&gt; se conoce como &amp;ldquo;análisis léxico&amp;rdquo;, &amp;ldquo;tokenizado&amp;rdquo; (&lt;code&gt;tokenizing&lt;/code&gt;) o, simplemente, &amp;ldquo;escaneo&amp;rdquo; (&lt;code&gt;scanning&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;El punto de entrada del analizador léxico es la función &lt;code&gt;PyTokenizer_Get&lt;/code&gt; en &lt;a href=&#34;https://svn.python.org/projects/python/tags/r26b3/Parser/tokenizer.c&#34;&gt;Parser/tokenizer.c&lt;/a&gt; . Esta función se llama repetidamente desde la función principal de procesado, &lt;code&gt;parsetok&lt;/code&gt; en &lt;a href=&#34;https://svn.python.org/projects/python/tags/r26b3/Parser/parsetok.c&#34;&gt;Parser/parsetok.c&lt;/a&gt; , que a su vez se utiliza por por alguna de las distintas funciones de proceso de más alto nivel.&lt;/p&gt;
&lt;p&gt;Para implementar nuestra instrucción &amp;ldquo;unless&amp;rdquo;, no es necesario realizar nada explícito en el código del &lt;code&gt;tokenizer&lt;/code&gt; &amp;ndash; sólo es necesario modificar la descripción de la gramática, como se verá en la siguiente sección.&lt;/p&gt;
&lt;h2 id=&#34;3-análisis-sintáctico&#34;&gt;3. Análisis sintáctico&lt;/h2&gt;
&lt;p&gt;Para que el compilador obtenga algún significado del programa fuente, el flujo de tokens emitido por el analizador léxico debe estar organizado en algún tipo de estructura. Éste es el trabajo del analizador sintáctico de Python, que toma como entrada un flujo de tokens y &amp;ndash; basado en las reglas declaradas en la gramática de Python &amp;ndash; produce un Árbol Sintáctico Abstracto (AST, &lt;em&gt;&amp;ldquo;Abstract Syntax Tree&amp;rdquo;&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;Python utiliza un generador de análisis sintáctico a medida que genera automáticamente su analizador sintáctico a partir de una descripción gramatical. La salida del análisis sintáctico es el árbol sintáctico, que puede verse como una representación de bajo nivel del programa analizado en la estructura definida por la descripción gramatical.&lt;/p&gt;
&lt;p&gt;En Python 2.5, se añade un paso adicional a la fase de análisis sintáctico: la construcción de un Árbol Sintáctico Abstracto (AST) del árbol analizado. El AST, como el árbol analizado, es una representación en memoria del programa que se está procesando, aunque de una forma de más alto nivel y por tanto más sencilla de manipular.&lt;/p&gt;
&lt;p&gt;Ahora, para añadir nuestra nueva instrucción &lt;code&gt;unless&lt;/code&gt; al lenguaje Python, primero tenemos que modificar el archivo de gramática (&lt;a href=&#34;https://svn.python.org/projects/python/tags/r26b3/Grammar/Grammar&#34;&gt;Grammar/Grammar&lt;/a&gt;)  para describir la sintaxis de esta característica, como en el listado siguiente:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/* Grammar/Grammar:78 */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;2&lt;/span&gt;if_stmt: &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; test &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;:&amp;#39;&lt;/span&gt; suite (&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;elif&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; test &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;:&amp;#39;&lt;/span&gt; suite)&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; [&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; suite]
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;3&lt;/span&gt;while_stmt: &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; test &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;:&amp;#39;&lt;/span&gt; suite [&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; suite]
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;4&lt;/span&gt;unless_stmt: &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;unless&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; test &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;:&amp;#39;&lt;/span&gt; suite
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;5&lt;/span&gt;for_stmt: &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; exprlist &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;in&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; testlist &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;:&amp;#39;&lt;/span&gt; suite [&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt; suite]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Dado que nuesta instrucción &lt;code&gt;unless&lt;/code&gt; es realmente una instrucción &amp;ldquo;if&amp;rdquo; con la lógica invertida, para implementarlo &lt;em&gt;podríamos&lt;/em&gt; utilizar los nodos AST del &amp;ldquo;if&amp;rdquo; y el &amp;ldquo;Not&amp;rdquo; existentes. De hecho, así es como se introdujo la sintaxis el try&amp;hellip;except&amp;hellip;finally en Python 2.5. De todas formas, para los propósitos de este artículo se modificará la estructura AST para poder demostrar cómo generar &lt;em&gt;bytecode&lt;/em&gt; para nuestra nueva construcción. Con tal fin, se modifica &lt;a href=&#34;https://svn.python.org/projects/python/tags/r26b3/Parser/Python.asdl&#34;&gt;Parser/Python.asdl&lt;/a&gt;  &amp;ndash; que contiene la definición del AST &amp;ndash; como en el listado siguiente:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/* Parser/Python.asdl:25 */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;2&lt;/span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; For(expr target, expr iter, stmt&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; body, stmt&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; orelse)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;3&lt;/span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; While(expr test, stmt&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; body, stmt&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; orelse)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;4&lt;/span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; Unless(expr test, stmt&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; body)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;5&lt;/span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; If(expr test, stmt&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; body, stmt&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; orelse)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Finalmente, necesitamos añadir algo de código para manejar la transformación de la gramática al AST en &lt;a href=&#34;https://svn.python.org/projects/python/tags/r26b3/Python/ast.c&#34;&gt;Python/ast.c&lt;/a&gt; . Aquí añadimos &lt;code&gt;ast_for_unless_stmt&lt;/code&gt;, como se muestra a continuación:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 1&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/* Python/ast.c:2805 */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 2&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; stmt_ty
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 3&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ast_for_unless_stmt&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;compiling&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; c, &lt;span style=&#34;color:#66d9ef&#34;&gt;const&lt;/span&gt; node &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;n)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 4&lt;/span&gt;{
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 5&lt;/span&gt;    expr_ty test_expr;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 6&lt;/span&gt;    asdl_seq &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;suite_seq;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 7&lt;/span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;/* unless_stmt: &amp;#39;unless&amp;#39; test &amp;#39;:&amp;#39; suite */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 8&lt;/span&gt;    REQ(n, unless_stmt);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 9&lt;/span&gt;    test_expr &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ast_for_expr(c, CHILD(n, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;));
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;10&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (test_expr &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;11&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;12&lt;/span&gt;    suite_seq &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ast_for_suite(c, CHILD(n, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;));
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;13&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (suite_seq &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;14&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; NULL;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;15&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; Unless(test_expr, suite_seq, LINENO(n), n&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;n_col_offset, c&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;c_arena);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;16&lt;/span&gt;}
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;17&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/* ... &amp;lt;snip&amp;gt; ... */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;18&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/* Python/ast.c:3125 */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;19&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;case&lt;/span&gt; while_stmt:
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;20&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; ast_for_while_stmt(c, ch);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;21&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;case&lt;/span&gt; unless_stmt:
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;22&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; ast_for_unless_stmt(c, ch);
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;El código de transformación del árbol sintáctico al AST sigue un popular patrón Visitor. En la línea 3123, se añade un &lt;em&gt;hook&lt;/em&gt; para llamar al código de transformación apropiado si se encuentra un nodo &lt;code&gt;unless_stmt&lt;/code&gt; en el árbol sintáctico. Una vez dentro de la función de transformación, se construye un nodo Unless analizando recursivamente la condición y el cuerpo.&lt;/p&gt;
&lt;p&gt;Note que puede necesitar regenerar explícitamente algunos ficheros tras realizar estos cambios:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;1&lt;/span&gt;$ rm -f Python/graminit.c &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; make Python/graminit.c
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;2&lt;/span&gt;$ rm -f Python/Python-ast.c &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; make Python/Python-ast.c
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;En este punto, el compilador podrá escanear y analizar nuestra nueva instrucción &amp;ldquo;unless&amp;rdquo;. Lo único que falta es añadir código para generar el &lt;em&gt;bytecode&lt;/em&gt; para nuestro nuevo nodo AST.&lt;/p&gt;
&lt;h2 id=&#34;4-generación-de-código&#34;&gt;4. Generación de código&lt;/h2&gt;
&lt;p&gt;La siguiente fase de compilación &amp;ndash; generación de código &amp;ndash; toma el AST construído en la fase anterior y produce un PyCodeObject como salida. Un PyCodeObject es una unidad independiente de código ejecutable, que contiene toda la información y código para la ejecución independiente por parte del intérprete de &lt;em&gt;bytecode&lt;/em&gt; de Python.&lt;/p&gt;
&lt;p&gt;Antes de ver más código fuente, es importante comprender que el intérprete de &lt;em&gt;bytecode&lt;/em&gt; de Python es una máquina virtual basada en pila. Esto significa que el proceso de ejecutar &lt;em&gt;bytecode&lt;/em&gt; manipula una pila de datos, con instrucciones que añaden, eliminan y operan sobre el par de elementos de la cima de la pila. Con esto en mente, veamos cómo generar &lt;em&gt;bytecode&lt;/em&gt; desde nuestro nuevo nodo AST Unless en el listado siguiente (veremos lo que hace realmente el &lt;em&gt;bytecode&lt;/em&gt; en la sección siguiente):&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-cpp&#34; data-lang=&#34;cpp&#34;&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 1&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/* Python/compile.c:1623 */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 2&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;static&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;int&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 3&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;compiler_unless&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;struct&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;compiler&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;c, stmt_ty s)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 4&lt;/span&gt;{
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 5&lt;/span&gt;    basicblock &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;end;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 6&lt;/span&gt;    basicblock &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;next;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 7&lt;/span&gt;    assert(s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;kind &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; Unless_kind);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 8&lt;/span&gt;    end &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; compiler_new_block(c);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt; 9&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (end &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;10&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;11&lt;/span&gt;    next &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; compiler_new_block(c);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;12&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (next &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; NULL)
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;13&lt;/span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;14&lt;/span&gt;    VISIT(c, expr, s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;v.Unless.test);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;15&lt;/span&gt;    ADDOP_JREL(c, JUMP_IF_TRUE, next);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;16&lt;/span&gt;    ADDOP(c, POP_TOP);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;17&lt;/span&gt;    VISIT_SEQ(c, stmt, s&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;v.Unless.body);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;18&lt;/span&gt;    ADDOP_JREL(c, JUMP_FORWARD, end);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;19&lt;/span&gt;    compiler_use_next_block(c, next);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;20&lt;/span&gt;    ADDOP(c, POP_TOP);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;21&lt;/span&gt;    compiler_use_next_block(c, end);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;22&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;23&lt;/span&gt;}
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;24&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/* ... &amp;lt;snip&amp;gt; ... */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;25&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;/* Python/compile.c:2167 */&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;26&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;case&lt;/span&gt; If_kind:
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;27&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; compiler_if(c, s);
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;28&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;case&lt;/span&gt; Unless_kind:
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;29&lt;/span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; compiler_unless(c, s);
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;En este punto, nuestra implementación de la instrucción &amp;ldquo;Unless&amp;rdquo; está terminada. Recompile Python y pruébelo:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;1&lt;/span&gt;$ ./configure &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; make clean &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; make
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;2&lt;/span&gt;$ ./python &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;lt;&amp;lt;EOF
&lt;/span&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;gt; dv = False
&lt;/span&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;gt; unless v:
&lt;/span&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;5&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;gt;
&lt;/span&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;print &amp;#39;test&amp;#39;
&lt;/span&gt;&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;7&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;gt; EOF&lt;/span&gt;
&lt;span style=&#34;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f&#34;&gt;8&lt;/span&gt;test
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Vea &lt;a href=&#34;https://svn.python.org/projects/python/tags/r26b3/Python/compile.c&#34;&gt;Python/compile.c&lt;/a&gt;  para más detalles sobre el generador de &lt;em&gt;bytecode&lt;/em&gt; de Python.&lt;/p&gt;
&lt;h2 id=&#34;5-ejecución-de-código&#34;&gt;5. Ejecución de código&lt;/h2&gt;
&lt;p&gt;La ejecución del &lt;em&gt;bytecode&lt;/em&gt; de Python se maneja por el intérprete de &lt;em&gt;bytecode&lt;/em&gt;. Como se mencionó en la sección anterior, el intérprete es una máquina virtual basada en pila que ejecuta las instrucciones &lt;em&gt;bytecode&lt;/em&gt; de Python que actúan sobre una única pila de datos. No se requiere realizar ningún cambio adicional al propio intérprete de &lt;em&gt;bytecode&lt;/em&gt; para que nuestra instrucción &amp;ldquo;Unless&amp;rdquo; funcione, pero veamos con más detenimiento cómo interpreta el &lt;em&gt;bytecode&lt;/em&gt; que generamos en la sección anterior.&lt;/p&gt;
&lt;p&gt;Primero se ejecuta la expresión de la condición, y se añade el resultado de la misma a la pila. A continuación, el &lt;em&gt;opcode&lt;/em&gt; &lt;code&gt;JUMP_IF_TRUE&lt;/code&gt; inspeccionará el valor en la cima de la pila y determinará si contiene un valor que representa la verdad.  Si es así, se salta todo el cuerpo y continúa la ejecución a partir del final de la instrucción &amp;ldquo;unless&amp;rdquo;. Si la expresión se evalúa como un valor &lt;em&gt;falso&lt;/em&gt;, el compilador ejecutará el cuerpo de la instrucción &lt;code&gt;unless&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Se aprecia que la primera instrucción a ejecutar en cualquiera de las ramas es desapilar el elemento de encima de la pila de datos (POP_TOP). Es así porque la expresión JUMP_IF_TRUE deja la expresión comprobada en la pila. En nuestro caso ya no se necesita el valor de la expresión de comprobación, por lo que simplemente se descarta con la ejecución de la instrucción POP_TOP.&lt;/p&gt;
&lt;p&gt;Si está interesado en los detalles de lo que hacen los &lt;em&gt;bytecodes&lt;/em&gt; individuales, puede encontrar información sobre todos los &lt;em&gt;bytecodes&lt;/em&gt; en &lt;a href=&#34;https://docs.python.org/lib/bytecodes.html&#34;&gt;https://docs.python.org/lib/bytecodes.html&lt;/a&gt; . También puede ver &lt;code&gt;PyEval_CodeEvalEx&lt;/code&gt; y &lt;code&gt;PyEval_EvalFrame_ex&lt;/code&gt;  en &lt;a href=&#34;https://svn.python.org/projects/python/tags/r26b3/Python/ceval.c&#34;&gt;Python/ceval.c&lt;/a&gt;  si está interesado en investigar con mayor detalle el intérprete de &lt;em&gt;bytecode&lt;/em&gt;.&lt;/p&gt;
&lt;h2 id=&#34;6-conclusión&#34;&gt;6. Conclusión&lt;/h2&gt;
&lt;p&gt;Debería quedar claro que no es necesario ser un científico de la Nasa para contribuir en el núcleo del lenguaje Python. Si le interesan realmente los entresijos del trabajo de un intérprete del mundo real, Python es un buen lugar para comenzar. Si no está seguro de por dónde debe continuar, aquí tiene un par de ideas tanto alcanzables como educativas para el nivel iniciado del &lt;em&gt;hacker&lt;/em&gt; de Python:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Reescriba la instrucción &amp;ldquo;unless&amp;rdquo; usando sólo nodos AST ya existentes.&lt;/li&gt;
&lt;li&gt;Añada un nuevo operador al lenguaje modificando el &lt;code&gt;tokenizer&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Investigue cómo funcionan por dentro las funciones embebidas en el lenguaje.&lt;/li&gt;
&lt;li&gt;Investigue el uso de la tabla de símbolos (symtable).&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Hay mucho que aprender jugando con el código, y aún más realizando contribuciones activas al proyecto mediante el arreglo de errores, contribuyendo a la documentación o respondiendo las preguntas de novatos en la lista de correo de usuarios. Anímese &amp;ndash; y puede que se sorprenda usted mismo.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Artículo original: &lt;a href=&#34;https://tomlee.co/wp-content/uploads/2008/12/python-language-internals.pdf&#34;&gt;Python Compiler Internals&lt;/a&gt;
Autor original: &lt;a href=&#34;https://tomlee.co&#34;&gt;Thomas Lee&lt;/a&gt; / (&lt;a href=&#34;https://twitter.com/#!/tglee&#34;&gt;@tglee&lt;/a&gt; )
Traducción: &lt;a href=&#34;https://magmax.org&#34;&gt;Miguel Ángel García&lt;/a&gt;  (&lt;a href=&#34;https://twitter.com/#!/magmax_en&#34;&gt;@magmax_en&lt;/a&gt; )&lt;/p&gt;

        
      </description>
    </item>
    
  </channel>
</rss>
