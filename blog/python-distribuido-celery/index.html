<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Python distribuido: Celery - El blog de MagMax</title><meta name="Description" content="Python orientado a servicios mediante colas de mensajes, usando Celery"><meta property="og:title" content="Python distribuido: Celery" />
<meta property="og:description" content="Python orientado a servicios mediante colas de mensajes, usando Celery" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/python-distribuido-celery/" />
<meta property="og:image" content="https://magmax.org/icons/favicon.png"/>
<meta property="article:published_time" content="2015-03-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-28T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://magmax.org/icons/favicon.png"/>

<meta name="twitter:title" content="Python distribuido: Celery"/>
<meta name="twitter:description" content="Python orientado a servicios mediante colas de mensajes, usando Celery"/>
<meta name="application-name" content="El blog de MagMax">
<meta name="apple-mobile-web-app-title" content="El blog de MagMax"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://magmax.org/blog/python-distribuido-celery/" /><link rel="prev" href="https://magmax.org/blog/django-lo-hizo-un-mago-plantillas-y-contextos/" /><link rel="next" href="https://magmax.org/blog/como-funciona-internet/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Python distribuido: Celery",
        "inLanguage": "es",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/magmax.org\/blog\/python-distribuido-celery\/"
        },"genre": "posts","keywords": "python, celery","wordcount":  2131 ,
        "url": "https:\/\/magmax.org\/blog\/python-distribuido-celery\/","datePublished": "2015-03-20T00:00:00+00:00","dateModified": "2021-01-28T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Miguel Ángel"},"author": {
                "@type": "Person",
                "name": "Miguel Ángel"
            },"description": "Python orientado a servicios mediante colas de mensajes, usando Celery"
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="El blog de MagMax"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon.png"
        data-srcset="/icons/favicon.png, /icons/favicon.png 1.5x, /icons/favicon.png 2x"
        data-sizes="auto"
        alt="/icons/favicon.png"
        title="/icons/favicon.png" />MagMax Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> Inicio </a><a class="menu-item" href="/tags"> Tags </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Selecciona el lenguage">Español<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/en/blog/python-distribuido-celery/">English</option><option value="/blog/python-distribuido-celery/" selected>Español</option></select>
                    </a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="El blog de MagMax"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/icons/favicon.png"
        data-srcset="/icons/favicon.png, /icons/favicon.png 1.5x, /icons/favicon.png 2x"
        data-sizes="auto"
        alt="/icons/favicon.png"
        title="/icons/favicon.png" />MagMax Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="">Inicio</a><a class="menu-item" href="/tags" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Cambia el tema">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Selecciona el lenguage">Español<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/en/blog/python-distribuido-celery/">English</option><option value="/blog/python-distribuido-celery/" selected>Español</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contenido</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Python distribuido: Celery</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Miguel Ángel</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="20 Mar 2015">20 Mar 2015</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2131 palabras&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;11 minutos&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contenido</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#qué-es-celery">Qué es Celery</a></li>
    <li><a href="#cómo-instalarlo">Cómo instalarlo</a></li>
    <li><a href="#ejemplo">Ejemplo</a>
      <ul>
        <li><a href="#creando-servicios">Creando servicios</a></li>
        <li><a href="#lanzando-servicios">Lanzando servicios</a></li>
        <li><a href="#todo-junto-es-más-fácil">Todo junto es más fácil</a></li>
      </ul>
    </li>
    <li><a href="#herramientas">Herramientas</a>
      <ul>
        <li><a href="#el-beat">El Beat</a></li>
        <li><a href="#warning-pickle">Warning: pickle</a></li>
      </ul>
    </li>
    <li><a href="#entornos-complejos">Entornos complejos</a></li>
    <li><a href="#más-información">Más información</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Ahora están de modas las arquitecturas
<abbr title="Service Oriented Architectures">SOA</abbr>
.
Estas arquitecturas consisten en pequeños servicios muy específicos, de manera que interactúan unos con otros.</p>
<p>En esta ocasión voy a contar cómo utilizar <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> para crear una arquitectura SOA.</p>
<figure>
    <img src="/images/python.png"
         alt="Python"/> 
</figure>

<h2 id="qué-es-celery">Qué es Celery</h2>
<p>No puede decirse que sea un sistema de comunicaciones, ya que el sistema de comunicaciones es <a href="https://www.rabbitmq.com" target="_blank" rel="noopener noreffer">RabbitMQ</a>, <a href="https://redis.io/" target="_blank" rel="noopener noreffer">Redis</a>, etc. Como usa uno de ellos, no puede ser un sistema de colas de mensajes. Tampoco es un protocolo, ya que utiliza <a href="https://www.amqp.org/" target="_blank" rel="noopener noreffer">AMQP</a>. Tampoco es una abstracción sobre éstos, ya que eso es <a href="https://kombu.readthedocs.org/en/latest/" target="_blank" rel="noopener noreffer">Kombu</a>, la librería de comunicaciones que utiliza.</p>
<p><a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> es un conjunto de herramientas que nos permite trabajar fácilmente con múltiples servicios, con algo de azúcar sintáctico. Es una forma de lanzar servicios viéndolos como <strong>tareas</strong>.</p>
<h2 id="cómo-instalarlo">Cómo instalarlo</h2>
<p>Instalarlo es sencillo; con <code>pip</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">pip install celery
</code></pre></td></tr></table>
</div>
</div><p>o con <code>apt</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">apt-get install python-celery
</code></pre></td></tr></table>
</div>
</div><p>El problema es que necesitamos un <strong>Broker</strong>. El <strong>Broker</strong> es el medio utilizado para transportar los mensajes de un servicio a otro. En este caso, necesitamos una cola de mensajes.</p>
<p>Para los ejemplos usaremos dos: <a href="https://www.rabbitmq.com" target="_blank" rel="noopener noreffer">RabbitMQ</a> y <a href="https://redis.io/" target="_blank" rel="noopener noreffer">Redis</a>. La primera es algo&hellip; complicadilla, pero muy visual si ya lo conocéis e instaláis el <a href="https://www.rabbitmq.com/management.html" target="_blank" rel="noopener noreffer">plugin de gestión</a>. La segunda es más sencilla de instalar, pero más difícil de ver las tripas. Para <a href="https://redis.io/" target="_blank" rel="noopener noreffer">Redis</a> necesitaréis también la librería; con <code>pip</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">pip install redis
</code></pre></td></tr></table>
</div>
</div><p>o con <code>apt</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">apt-get install python-redis
</code></pre></td></tr></table>
</div>
</div><h2 id="ejemplo">Ejemplo</h2>
<h3 id="creando-servicios">Creando servicios</h3>
<p>Vamos a comenzar con la creación de un pequeño servicio que multiplica dos números:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery service example: task to multiply two numbers</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span></code></pre></td></tr></table>
</div>
</div>
<p>Como veis, el <em>overhead</em> de añadir <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> es mínimo: importar la librería, crear la conexión (<code>app</code>) y añadir un decorador a nuestro servicio.</p>
<p>Ya es ejecutable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ celery worker --loglevel<span class="o">=</span>info -A tasks

 -------------- celery@nightcrawler v3.1.17 <span class="o">(</span>Cipater<span class="o">)</span>
---- **** -----
--- * ***  * -- Linux-3.16.0-4-amd64-x86_64-with-debian-8.0
-- * - **** ---
- ** ---------- <span class="o">[</span>config<span class="o">]</span>
- ** ---------- .&gt; app:         tasks:0x7f3476eb9b90
- ** ---------- .&gt; transport:   redis://localhost:6379/0
- ** ---------- .&gt; results:     redis://localhost:6379/0
- *** --- * --- .&gt; concurrency: <span class="m">4</span> <span class="o">(</span>prefork<span class="o">)</span>
-- ******* ----
--- ***** ----- <span class="o">[</span>queues<span class="o">]</span>
 -------------- .&gt; celery           <span class="nv">exchange</span><span class="o">=</span>celery<span class="o">(</span>direct<span class="o">)</span> <span class="nv">key</span><span class="o">=</span>celery


<span class="o">[</span>tasks<span class="o">]</span>
  . tasks.multiply

<span class="o">[</span>2015-03-20 21:56:16,526: INFO/MainProcess<span class="o">]</span> Connected to redis://localhost:6379/0
<span class="o">[</span>2015-03-20 21:56:16,541: INFO/MainProcess<span class="o">]</span> mingle: searching <span class="k">for</span> neighbors
<span class="o">[</span>2015-03-20 21:56:17,780: INFO/MainProcess<span class="o">]</span> mingle: all alone
<span class="o">[</span>2015-03-20 21:56:17,791: WARNING/MainProcess<span class="o">]</span> celery@nightcrawler ready.</code></pre></td></tr></table>
</div>
</div>
<p>Aquí hay mucha información:</p>
<ul>
<li>versiones utilizadas.</li>
<li>colas creadas.</li>
<li><em>brokers</em> usados para transporte y para resultados.</li>
<li>Número de <em>workers</em>, es decir, procesos dispuestos a responder una petición de forma concurrente.</li>
</ul>
<p>Y alguna cosa más que podemos ignorar por el momento.</p>
<p>Dejaremos eso ahí corriendo de momento.</p>
<h3 id="lanzando-servicios">Lanzando servicios</h3>
<p>Ése es el <em>subscriptor</em>. Vamos a crear ahora el <em>publicador</em>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery client example: request for two numbers multiplication</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="n">promise</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">send_task</span><span class="p">(</span><span class="s1">&#39;tasks.multiply&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="n">promise</span><span class="o">.</span><span class="n">get</span><span class="p">())</span></code></pre></td></tr></table>
</div>
</div>
<p>Un poco complicado&hellip; Pero vamos a verlo rápidamente:</p>
<ul>
<li>La primera parte es igual que en el primer ejemplo, ya que necesitamos conectarnos al mismo sitio.</li>
<li>La segunda parte ejecuta la tarea por su nombre, pasándole los argumentos. Eso devuelve una <em>promesa</em> (<code>promise</code>). En este punto hemos dejado un mensaje en la cola.</li>
<li>Finalmente, materializamos la <em>promesa</em> mediante <code>promise.get()</code>. En algún momento el servicio habrá leído el mensaje, lo habrá procesado, habrá dejado el resultado en otra cola y, mediante este método, se lee.</li>
</ul>
<p>Así que parece complicado&hellip; pero podría serlo aún más.</p>
<p>De todas maneras, he grabado un vídeo para que veáis cómo se usa todo lo anterior:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/Lf4Q7K6Ab_g" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h3 id="todo-junto-es-más-fácil">Todo junto es más fácil</h3>
<p>Existe la opción de ponerlo todo junto en el mismo archivo, y veréis cómo las cosas resultan aún más sencillas. Esto no siempre es posible y puede tener algún problema (como que cada cambio nos obliga a reiniciar también el servicio), pero es muy didáctico:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery full example: publisher/subscriber to request a multiplication</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">promise</span> <span class="o">=</span> <span class="n">multiply</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">promise</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<p>En este caso invocamos a un método de la tarea directamente, y así obtenemos la tarea.</p>
<p>Ya tenemos una forma muy complicada de multiplicar dos números :D</p>
<h2 id="herramientas">Herramientas</h2>
<p>Como dije, <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> proporciona herramientas y azúcar sintáctico.</p>
<p>Lo primero que vamos a ver son las funciones parciales o <em>partials</em>. Simplemente son funciones con algunos parámetros ya resueltos.</p>
<p>En nuestro caso es fácil crear el <em>partial</em> <code>duplicate</code> forzando el primer parámetro de <code>multiply</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="hl"><span class="lnt">13
</span></span><span class="hl"><span class="lnt">14
</span></span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery full example: multiply two numbers with partials</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="hl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="hl">    <span class="n">duplicate</span> <span class="o">=</span> <span class="n">multiply</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="hl">    <span class="n">promise</span> <span class="o">=</span> <span class="n">duplicate</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class="hl">    <span class="k">print</span><span class="p">(</span><span class="n">promise</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<p>Sí, los parciales se realizan con el método <code>.si</code>, aunque también podemos utilizar <code>.s</code>. La diferencia entre ambas es que la primera es <em>inmutable</em> (por eso la <code>i</code>). Resulta difícil explicar qué es eso sin contar antes otra herramienta de <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a>: las cadenas (<code>Chain</code>).</p>
<p>En <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> se pueden concatenar tareas, de manera que el resultado de una de ellas sea el primer parámetro de la siguiente. ¿Por qué el primero? Pues porque sí. Es una putada, pero es así.</p>
<p>En ocasiones querremos funciones encadenadas tan sólo para que exista un orden, en cuyo caso queremos ignorar el resultado de la función anterior. En estos casos usaremos funciones inmutables, que no usan el parámetro anterior.</p>
<p>Espero que se haya notado que uso &ldquo;funciones&rdquo; o &ldquo;servicios&rdquo; indistintamente.</p>
<p>Pero basta ya de palabrería y concatenemos algo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="hl"><span class="lnt">13
</span></span><span class="hl"><span class="lnt">14
</span></span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="hl"><span class="lnt">17
</span></span><span class="hl"><span class="lnt">18
</span></span><span class="hl"><span class="lnt">19
</span></span><span class="hl"><span class="lnt">20
</span></span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery example: multiply with chains</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="hl"><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">chain</span>
</span><span class="hl">
</span><span class="hl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="hl">    <span class="n">duplicate</span> <span class="o">=</span> <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="hl">
</span><span class="hl">    <span class="n">task</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><span class="hl">    <span class="n">promise</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</span><span class="hl">    <span class="k">print</span><span class="p">(</span><span class="n">promise</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<p>Como dije antes, <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> proporciona azúcar sintáctico, por lo que lo anterior también puede escribirse así:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="hl"><span class="lnt">13
</span></span><span class="hl"><span class="lnt">14
</span></span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="hl"><span class="lnt">17
</span></span><span class="hl"><span class="lnt">18
</span></span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery example: multiply with chains using pipes (syntactic sugar)</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="hl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="hl">    <span class="n">duplicate</span> <span class="o">=</span> <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="hl">
</span><span class="hl">    <span class="n">task</span> <span class="o">=</span> <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="hl">    <span class="n">promise</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</span><span class="hl">    <span class="k">print</span><span class="p">(</span><span class="n">promise</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<p>Y aquí es donde comienza la diversión: hemos creado un <strong>canvas</strong>, es decir, un flujo de tareas. Aunque parezca mentira, si lanzáis distintos <em>workers</em> en distintas máquinas y todos se conectan al mismo <em>broker</em>, cada operación podría ejecutarse en uno diferente.</p>
<p>Pero claro&hellip; ¿para qué tanto <em>canvas</em> si las operaciones son secuenciales? Pues aquí viene la gracia: procesarlas de forma concurrente, los <strong>Grupos</strong> o <code>group</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="hl"><span class="lnt">13
</span></span><span class="hl"><span class="lnt">14
</span></span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="hl"><span class="lnt">17
</span></span><span class="hl"><span class="lnt">18
</span></span><span class="hl"><span class="lnt">19
</span></span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery example: several multiplications with chains and groups (canvas)</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="hl"><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">group</span>
</span><span class="hl">
</span><span class="hl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="hl">    <span class="n">duplicate</span> <span class="o">=</span> <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="hl">
</span><span class="hl">    <span class="n">task</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span>
</span><span class="hl">        <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class="hl">        <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
</span><span class="hl">        <span class="n">multiply</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">duplicate</span><span class="p">,</span>
</span><span class="hl">    <span class="p">)</span>
</span><span class="hl">    <span class="n">promise</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</span><span class="hl">    <span class="k">print</span><span class="p">(</span><span class="n">promise</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<p>Existe aún más azúcar sintáctico, como los <code>chords</code>, <code>maps</code>, <code>starmaps</code> y <code>chunks</code>, pero no los vamos a ver aquí. Este artículo es meramente introductorio. <a href="https://celery.readthedocs.org/en/latest/userguide/canvas.html" target="_blank" rel="noopener noreffer">Podéis leer más información sobre los Canvas</a>.</p>
<h3 id="el-beat">El Beat</h3>
<p>Otro aspecto importante de <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> es el <strong>Beat</strong>. Consiste en un <em>latido</em> o una señal producida cada cierto tiempo. Podemos activarla en el worker mediante la opción <code>--beat</code>. Mientras no metan <a href="https://github.com/celery/celery/issues/1495" target="_blank" rel="noopener noreffer">exclusividad en el Beat</a>, es importante lanzar sólo uno o recibiríamos más de un <em>latido</em>.</p>
<p>Es este <em>beat</em> quien nos permite lanzar tareas periódicas.</p>
<p>Veamos un ejemplo pequeñito: Cada 10 segundos vamos a multiplicar la hora por dos:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery beat example: periodic date operation</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">group</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">add_days</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">CELERYBEAT_SCHEDULE</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;multiply-each-10-seconds&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;tasks.add_days&#39;</span><span class="p">,</span>
            <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>Y aquí os dejo un ejemplo de ejecución:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/qTXJUnV0oHU" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>Nuevamente, no voy a entrar en más detalles aquí; tan sólo pretendo darlo a conocer. Podéis leer más sobre las <a href="https://celery.readthedocs.org/en/latest/userguide/periodic-tasks.html" target="_blank" rel="noopener noreffer">tareas periódicas</a> si os interesa.</p>
<h3 id="warning-pickle">Warning: pickle</h3>
<p>Es posible que veamos un <em>warning</em> del estilo <code>warnings.warn(CDeprecationWarning(W_PICKLE_DEPRECATED))</code>. Esto se debe a que estamos usando el serializador <a href="https://docs.python.org/3.4/library/pickle.html" target="_blank" rel="noopener noreffer">pickle</a>, que está obsoleto. Podéis evitarlo añadiendo la línea siguiente:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="hl"><span class="lnt">23
</span></span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Celery beat example: periodic date operation</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">group</span>

<span class="c1"># RabbitMQ</span>
<span class="c1">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span class="c1"># Redis</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost:6379/0&#39;</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">add_days</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">CELERYBEAT_SCHEDULE</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;multiply-each-10-seconds&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;tasks.add_days&#39;</span><span class="p">,</span>
            <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">)</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="hl">    <span class="n">CELERY_ACCEPT_CONTENT</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">],</span>
</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="entornos-complejos">Entornos complejos</h2>
<p>Evidentemente, todo lo que he contado aquí es lo más básico de <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a>. Hemos utilizado una única cola para nuestras comunicaciones. Dado que <a href="https://www.rabbitmq.com" target="_blank" rel="noopener noreffer">RabbitMQ</a> permite operaciones entre colas, <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> también.</p>
<p>Entre otras cosas, se puede:</p>
<ul>
<li>asignar colas diferentes para diferentes tareas, de manera que no todos los <em>workers</em> atiendan todas las peticiones o que haya un número de <em>workers</em> diferente para cada cola.</li>
<li><em>enrutar</em> mensajes entre colas.</li>
<li>enviar mensajes a todas las colas (<strong>topic</strong>).</li>
<li>&hellip;</li>
</ul>
<p>No me voy a meter aquí en profundidad, pero sí voy a describir cómo funciona la entrega de mensajes. Esta información es necesaria para poder entender los enrutados (obtenido de <a href="https://celery.readthedocs.org/en/latest/userguide/routing.html#exchanges-queues-and-routing-keys" target="_blank" rel="noopener noreffer">Exchanges, queues and routing keys</a>):</p>
<ol>
<li>Se envía un mensaje. Éste se deposita en un <strong>EXCHANGE</strong>. Si no existía, <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> lo crea.</li>
<li>El <strong>EXCHANGE</strong> enruta el mensaje a una o más colas, dependiendo de su configuración. Si las colas no existen, <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> las crea.</li>
<li>El mensaje queda esperando en la cola hasta que un consumidor lo recoge y procesa. En ese momento el mensaje se bloquea para que ningún otro consumidor lo lea.</li>
<li>Tras su procesado, el consumidor envía un <strong>ACK</strong> y el mensaje se borra de la cola.</li>
</ol>
<p>Por defecto, <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a> crea colas con el nombre del <em>exchange</em> y las une (<strong>bind</strong>) en modo directo, es decir, que todo lo que llega al <em>exchange</em> se deja en la cola.</p>
<p>Se puede jugar con los enrutados y crear arquitecturas realmente complejas, de manera que cada mensaje llege a su destino dependiendo de la operación a realizar.</p>
<h2 id="más-información">Más información</h2>
<p>Entre los artículos de nivel básico, me gusta mucho el artículo <a href="https://abhishek-tiwari.com/post/amqp-rabbitmq-and-celery-a-visual-guide-for-dummies" target="_blank" rel="noopener noreffer">AMQP, RabbitMQ and Celery - A Visual Guide For Dummies</a>, ya que lo explica todo con imágenes. No está mal un artículo publicado en Digitalocean, <a href="https://www.digitalocean.com/community/tutorials/how-to-use-celery-with-rabbitmq-to-queue-tasks-on-an-ubuntu-vps" target="_blank" rel="noopener noreffer">How To Use Celery with RabbitMQ to Queue Tasks on an Ubuntu VPS</a> o una presentación de la PyCon 2013, titulada <a href="https://www.imankulov.name/posts/celery-for-internal-api.html" target="_blank" rel="noopener noreffer">Celery for Internal API in SOA infrastructure</a>.</p>
<p><a href="https://www.caktusgroup.com/blog/2014/06/23/scheduling-tasks-celery/" target="_blank" rel="noopener noreffer">Getting Started Scheduling Tasks with Celery</a> es un artículo que cuenta más cómo configurar tareas periódicas de forma dinámica con <a href="https://pypi.python.org/pypi/django-celery" target="_blank" rel="noopener noreffer">DJCelery</a>, bastante interesante aunque no queráis usar <a href="https://www.djangoproject.com/" target="_blank" rel="noopener noreffer">Django</a>.</p>
<p>Para entender mejor lo que ocurre a bajo nivel, recomiendo meterse de lleno en <a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html" target="_blank" rel="noopener noreffer">AMQP 0-9-1 Model Explained</a>, donde se cuenta cómo funciona el protocolo <a href="https://www.amqp.org/" target="_blank" rel="noopener noreffer">AMQP</a>. Muy interesante antes de entrar en enrutados complejos. En este mismo sentido recomiendo <a href="https://rajith.2rlabs.com/2007/10/13/amqp-in-10-mins-part3-flexible-routing-model/" target="_blank" rel="noopener noreffer">AMQP in 10 mins : Part3 – Flexible Routing Model</a>, que es más sencillo y sólo explica los conceptos más básicos.</p>
<p>Si queréis participar en un proyecto que utiliza <a href="https://www.celeryproject.org/" target="_blank" rel="noopener noreffer">Celery</a>, os puedo animar a que me ayudéis con <a href="https://github.com/djcron-project/" target="_blank" rel="noopener noreffer">DJCron</a>, que es un wrapper sobre <a href="https://pypi.python.org/pypi/django-celery" target="_blank" rel="noopener noreffer">DJCelery</a> que permite configurar tareas distribuidas de forma dinámica, añadiendo algunas características extra sobre <a href="https://pypi.python.org/pypi/django-celery" target="_blank" rel="noopener noreffer">DJCelery</a>.</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Actualizado el 28 Jan 2021</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Compartir en Twitter" data-sharer="twitter" data-url="https://magmax.org/blog/python-distribuido-celery/" data-title="Python distribuido: Celery" data-hashtags="python,celery"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Facebook" data-sharer="facebook" data-url="https://magmax.org/blog/python-distribuido-celery/" data-hashtag="python"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Linkedin" data-sharer="linkedin" data-url="https://magmax.org/blog/python-distribuido-celery/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en WhatsApp" data-sharer="whatsapp" data-url="https://magmax.org/blog/python-distribuido-celery/" data-title="Python distribuido: Celery" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Tumblr" data-sharer="tumblr" data-url="https://magmax.org/blog/python-distribuido-celery/" data-title="Python distribuido: Celery" data-caption="Python orientado a servicios mediante colas de mensajes, usando Celery" data-tags="python,celery"><i class="fab fa-tumblr fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Reddit" data-sharer="reddit" data-url="https://magmax.org/blog/python-distribuido-celery/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Instapaper" data-sharer="instapaper" data-url="https://magmax.org/blog/python-distribuido-celery/" data-title="Python distribuido: Celery" data-description="Python orientado a servicios mediante colas de mensajes, usando Celery"><i data-svg-src="/lib/simple-icons/icons/instapaper.min.svg"></i></a><a href="javascript:void(0);" title="Compartir en Digg" data-sharer="digg" data-url="https://magmax.org/blog/python-distribuido-celery/"><i class="fab fa-digg fa-fw"></i></a><a href="javascript:void(0);" title="Compartir en Blogger" data-sharer="blogger" data-url="https://magmax.org/blog/python-distribuido-celery/" data-title="Python distribuido: Celery" data-description="Python orientado a servicios mediante colas de mensajes, usando Celery"><i class="fab fa-blogger fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python/">python</a>,&nbsp;<a href="/tags/celery/">celery</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Regresar</a></span>&nbsp;|&nbsp;<span><a href="/">Inicio</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/blog/django-lo-hizo-un-mago-plantillas-y-contextos/" class="prev" rel="prev" title="Django lo hizo un mago: plantillas y contextos"><i class="fas fa-angle-left fa-fw"></i>Django lo hizo un mago: plantillas y contextos</a>
            <a href="/blog/como-funciona-internet/" class="next" rel="next" title="Cómo funciona Internet">Cómo funciona Internet<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Provisto por <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.79.1">Hugo</a> | Tema - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Miguel Ángel</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Volver arriba">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="Ver comentarios">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copiar al portapapeles","maxShownLines":10},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-9308241-3', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-9308241-3" async></script></body>
</html>
