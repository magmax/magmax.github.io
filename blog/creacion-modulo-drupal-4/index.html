<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Creación de un módulo Drupal IV | El blog de MagMax</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura&hellip; cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.
Hoy queremos que nuestros &ldquo;feedbacks&rdquo; se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc.">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="Creación de un módulo Drupal IV" />
<meta property="og:description" content="En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura&hellip; cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.
Hoy queremos que nuestros &ldquo;feedbacks&rdquo; se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/creacion-modulo-drupal-4/" />
<meta property="article:published_time" content="2010-05-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2010-05-11T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta itemprop="name" content="Creación de un módulo Drupal IV">
<meta itemprop="description" content="En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura&hellip; cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.
Hoy queremos que nuestros &ldquo;feedbacks&rdquo; se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc.">
<meta itemprop="datePublished" content="2010-05-11T00:00:00+00:00" />
<meta itemprop="dateModified" content="2010-05-11T00:00:00+00:00" />
<meta itemprop="wordCount" content="4350">



<meta itemprop="keywords" content="drupal," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Creación de un módulo Drupal IV"/>
<meta name="twitter:description" content="En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura&hellip; cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.
Hoy queremos que nuestros &ldquo;feedbacks&rdquo; se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        El blog de MagMax
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Inicio page">
              Inicio
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="../en" title="English page">
              English
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://magmax.org/blog/creacion-modulo-drupal-4/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://magmax.org/blog/creacion-modulo-drupal-4/&amp;text=Creaci%c3%b3n%20de%20un%20m%c3%b3dulo%20Drupal%20IV" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://magmax.org/blog/creacion-modulo-drupal-4/&amp;title=Creaci%c3%b3n%20de%20un%20m%c3%b3dulo%20Drupal%20IV" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Creación de un módulo Drupal IV</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2010-05-11T00:00:00Z">May 11, 2010</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>En esta ocasión vamos a tirar a la basura la mayor parte del código que ya tenemos. Así es la vida de dura&hellip; cuando estamos aprendiendo, las cosas se hacen de una manera; cuando ya sabemos, las cosas se hacen de otra manera diferente.</p>
<p>Hoy queremos que nuestros &ldquo;feedbacks&rdquo; se adapten a drupal. Hasta ahora parecían formar parte del site, pero realmente sólo tenían el mismo aspecto. Lo que queremos conseguir es que realmente pertenezcan a nuestro drupal: aparecerán en las búsquedas, se administrarán como parte del contenido, etc.</p>
<p>Me voy a basar en el <a href="https://drupal.org/node/231019">magnífico tutorial para crear contenido en Drupal</a>.</p>
<!-- raw HTML omitted -->
<figure>
    <img src="/images/drupal.png"
         alt="Drupal"/> 
</figure>

<h2 id="versiones">Versiones</h2>
<p>Igual que es posible que este documento se copie, también es posible que yo lo
modifique. Por eso, la última versión del mismo siempre se encontrará en la
<a href="https://magmax.org/blog/creacion-modulo-drupal-4/">cuarta parte del tutorial de drupal</a>. Un
saludo.</p>
<h2 id="qué-se-explica-aquí">Qué se explica aquí</h2>
<p>Cómo crear un nodo programáticamente. Una vez hayamos terminado, todo lo que hayamos hecho se podría haber hecho con el módulo CCK, pero de lo que se trata es aprender.</p>
<h2 id="qué-es-el-cck">Qué es el CCK</h2>
<p>Fácil: es el <em>Content Construction Kit</em> :-D</p>
<p>Consiste en una herramienta muy potente para la creación de formularios mediante el propio Drupal. De esta manera, sólo tenemos que ir añadiendo una lista de elementos, que posteriormente se renderizarán como un formulario. Gran parte de nuestro módulo &ldquo;feedback&rdquo; se podría haber hecho directamente sobre el CCK, por no decir todo.</p>
<p>¿Por qué no usar el CCK? En nuestro caso, &ldquo;porque estamos aprendiendo&rdquo; es una razón tan válida como cualquier otra. En concreto, para un módulo de las características de &ldquo;feedback&rdquo;, tal vez haya sido una pérdida de tiempo usar un módulo en lugar de el CCK. Sin embargo, un módulo tiene unas características de replicabilidad que el CCK creo que no tiene.</p>
<p>Además, el CCK nos permite crear formularios simples, pero si lo que queremos es poder manipular los datos, entonces necesitaremos crear nuestro propio módulo.</p>
<h2 id="pasos">Pasos</h2>
<p>Vamos a necesitar los siguientes <em>hooks</em>, aunque algunos de ellos ya los hemos implementado:</p>
<ul>
<li><code>hook_node_info</code></li>
<li><code>hook_perm</code></li>
<li><code>hook_access</code></li>
<li><code>hook_form</code></li>
</ul>
<p>También vamos a necesitar algunos de los siguientes <em>hooks</em> opcionales:</p>
<ul>
<li><code>hook_insert</code></li>
<li><code>hook_update</code></li>
<li><code>hook_delete</code></li>
<li><code>hook_validate</code></li>
<li><code>hook_nodeapi</code></li>
<li><code>hook_view</code></li>
<li><code>hook_load</code></li>
</ul>
<h2 id="hooks-obligatorios">Hooks obligatorios</h2>
<p>Nosotros ya tenemos nuestro <code>hook_node_info</code> y nuestro propio <code>hook_perm</code>, así que saltamos directamente a implementar el <code>hook_access</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#e6db74">* Implements hook_access()
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_access</span> ( $op, $node, $account )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  $retval <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#66d9ef">switch</span> ( $op )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;view&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>      $retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">user_access</span> ( <span style="color:#e6db74">&#39;view messages&#39;</span>, $account );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;create&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>      $retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">user_access</span> ( <span style="color:#e6db74">&#39;send message&#39;</span>, $account );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>      <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;update&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>      $retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">user_access</span> ( <span style="color:#e6db74">&#39;admin messages&#39;</span>, $account ) <span style="color:#f92672">&amp;&amp;</span> ( $account<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>      <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;delete&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>      $retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">user_access</span> ( <span style="color:#e6db74">&#39;admin messages&#39;</span>, $account ) <span style="color:#f92672">&amp;&amp;</span> ( $account<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>      <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>  <span style="color:#66d9ef">return</span> $retval;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>La función va a devolver <code>true</code> si queremos que el usuario tenga acceso. Para ello comprobamos si el usuario tiene los roles necesarios como para realizar ciertas acciones. En el caso de &ldquo;update&rdquo; y &ldquo;delete&rdquo; comprobamos también que el usuario sea el propietario del nodo.</p>
<p>Siguiendo con la lista, implementaremos el <code>hook_node_info</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#e6db74">* Implements hook_node_info()
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_node_info</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">array</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#e6db74">&#39;feedback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>      <span style="color:#e6db74">&#39;name&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>      <span style="color:#e6db74">&#39;module&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>      <span style="color:#e6db74">&#39;description&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Handle a feedback message&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>}
</code></pre></div><p>Ahora vamos a renombrar algunas de nuestras funciones&hellip; En concreto, <code>feedback_message_form</code>, que pasará a ser <code>feedback_form</code>. Es necesario también renombrar las funciones <code>feedback_message_form_validate</code> y <code>feedback_message_form_submit</code> para que todo siga funcionando como hasta ahora. También tendremos que modificar la llamada a <code>feedback_message_form</code> (ojo, que luego seguiremos transformando estas funciones):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_form&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_form</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  [<span style="color:#f92672">...</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_form_validate</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>  [<span style="color:#f92672">...</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_form_submit</span> ( $form, <span style="color:#f92672">&amp;</span>$form_state )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  [<span style="color:#f92672">...</span>]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>}
</code></pre></div><p>Y&hellip;. ya está. Ya tenemos nuestro elemento integrado con Drupal. Si recargamos la caché (Administration-&gt;Performance), y nos vamos a &ldquo;create content&rdquo;, veremos que tenemos un tipo de contenido llamado &ldquo;feedback&rdquo;.</p>
<p>El caso es que también veremos que no funciona del todo bien :-D</p>
<h3 id="hooks-recomendables">Hooks recomendables</h3>
<p>Antes de nada, os voy a hablar de <code>hook_nodeapi</code>. Hacéos un favor a vosotros mismos: olvidad que alguna vez existió. Las funciones que tienen parámetros que cambian en función de otros parámetros nunca son una buena idea. Además, en Drupal 7 lo han quitado, por lo que su uso está obsoleto. Toda la funcionalidad que podía ofrecer esta función la cumplen el resto de los hooks de la lista: insert, update, delete, validate, view y load. Existe una remota posibilidad de que necesitéis usar <code>hook_nodeapi</code>; pensáoslo bien antes de usarla.</p>
<p>El resto de <code>hooks</code> se ejecutarán automáticamente cuando alguien realice la operación esperada: <code>hook_insert</code> cuando se cree un nuevo elemento, etc.</p>
<p>Realmente lo que vamos a hacer es realizar una serie de transformaciones. Por ejemplo, nuestro antiguo <code>feedback_form_submit</code> se va a transformar en el nuevo y flamante <code>feedback_insert</code>, nuestro propio <code>hook_insert</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_insert</span> ( $node )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $userid  <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  $message <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  $mail    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;INSERT into {feedback_messages} ( uid, message, indate, usermail ) values ( %d, &#39;%s&#39;, now(), &#39;%s&#39; ) &#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $userid, $message, $mail );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">db_affected_rows</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#a6e22e">drupal_set_message</span> ( <span style="color:#a6e22e">t</span> ( <span style="color:#e6db74">&#34;Thank you for your feedback.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#a6e22e">drupal_goto</span> ( <span style="color:#e6db74">&#39;node&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;feedback&#39;</span>, <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#34;An error has happened. Your feedback has not been sent.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>}
</code></pre></div><p>Vamos a estudiarlo un poquito&hellip; Hemos cambiado la cabecera, de manera que ahora
el <em>UID</em>, el mensaje y el e-mail lo sacamos del nodo en lugar de usar variables
globales y formularios. Nosotros tenemos que decidir cómo almacenar la
información que sobrepasa a la información del nodo, por lo que insertamos en
nuestra tabla exactamente la misma información que antes. Es decir: a partir de
<code>$query</code> no hemos cambiado nada.</p>
<p>No ha sido difícil, ¿verdad? Ahora ya podemos insertar nodos que son feeds. Y
podemos probarlo: <code>Create Content-&gt;feedback</code>, escribimos y guardamos.</p>
<p>Se nos ha quedado el submit del formulario. Eso queda un poquito feo, ¿no? Ahora
que tenemos nuestro botón &ldquo;preview&rdquo; y nuestro &ldquo;save&rdquo;, amén de todas las opciones
de publicación, permisos, etc&hellip; Así que vamos a quitarlo. Además hay un
problema: se va a utilizar el mismo formulario para editar y para crear nuevos
elementos. Por esa razón, he decidido sacar una serie de variables que se
establecerán cuando se esté editando el nodo. Además, en modo &ldquo;edición&rdquo; se
mostrará también el check para indicar que ya se ha leído.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_form</span> ( <span style="color:#f92672">&amp;</span>$node )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  <span style="color:#66d9ef">global</span> $user;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  $title <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span> ( <span style="color:#e6db74">&#39;Feed from %s&#39;</span>, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  $mail <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  $message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  $read <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  $editing <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#66d9ef">if</span> ( $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    $mail <span style="color:#f92672">=</span> $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  <span style="color:#66d9ef">if</span> ( $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#75715e">// estamos editando
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#75715e"></span>    $editing <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT uid, message, indate, usermail, fm.read FROM {feedback_messages} fm WHERE id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    $storednode <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    $mail    <span style="color:#f92672">=</span> $storednode<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">usermail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    $message <span style="color:#f92672">=</span> $storednode<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    $read    <span style="color:#f92672">=</span> $storednode<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  $form [<span style="color:#e6db74">&#39;feedback&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>      <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;fieldset&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>      <span style="color:#e6db74">&#39;#title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#39;Feedback&#39;</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>      <span style="color:#e6db74">&#39;mail&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> (<span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textfield&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;E-Mail&#34;</span>, <span style="color:#e6db74">&#34;#description&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;If you want any answer, please, tell me your mail. It would not be shown anywhere.&#34;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $mail ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>      <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textarea&#39;</span>, <span style="color:#e6db74">&#34;#description&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;Write here your message&#34;</span>, <span style="color:#e6db74">&#39;#default_value&#39;</span><span style="color:#f92672">=&gt;</span>$message ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>      <span style="color:#e6db74">&#39;#required&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>  <span style="color:#66d9ef">if</span> ( $editing )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>    $form [<span style="color:#e6db74">&#39;feedback&#39;</span>][<span style="color:#e6db74">&#39;read&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;checkbox&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;The message has been read&#34;</span>, <span style="color:#e6db74">&#39;#default_value&#39;</span><span style="color:#f92672">=&gt;</span>$read ) ;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>  $form[<span style="color:#e6db74">&#39;title&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>      <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;hidden&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>      <span style="color:#e6db74">&#39;#default_value&#39;</span> <span style="color:#f92672">=&gt;</span> $title,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>  <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>}
</code></pre></div><p>¡Eh!, ¡Para!, que aquí al final hay algo extraño&hellip; Sí, lo que hacemos es
preguntarle a Drupal el tipo de nodo que estamos tratando, y comprobar si este
tipo necesita un título. Si es así, pues lo pintamos. Se podría hacer lo mismo
con el <em>body</em>, pero en esta ocasión no lo queremos. El título es interesante
para que después nos aparezca en la lista de contenido y podamos pincharle.</p>
<p>Ahora vamos a realizar las comprobaciones adecuadas, renombrando
<code>feedback_form_validate</code> y haciendo los cambios pertinentes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_validate</span> ( $node, <span style="color:#f92672">&amp;</span>$form )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $message <span style="color:#f92672">=</span> $form[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;message&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  $mail    <span style="color:#f92672">=</span> $form[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#e6db74">&#39;mail&#39;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  $validmail <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_match</span> (<span style="color:#e6db74">&#34;/^[^0-9][A-z0-9_]+([.][A-z0-9_]+)*[@][A-z0-9_]+([.][A-z0-9_]+)*[.][A-z]{2,4}$/&#34;</span> , $mail );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  <span style="color:#66d9ef">if</span> ( $mail <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;mail&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;You are not a registered user. Please, insert your e-mail.&#39;</span>) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  <span style="color:#66d9ef">if</span> ( $mail <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> $validmail )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;mail&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;The mail does not like an e-mail address.&#39;</span>) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#66d9ef">if</span> ( $message <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message cannot be empty.&#39;</span>));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>}
</code></pre></div><p>Es una lástima ver lo fácil que habría resultado realizarlo así desde el principio, ¿verdad? ¡¡Pero había que aprender!! Pasito a pasito&hellip;</p>
<p>Ahora vamos a &ldquo;ver&rdquo; los feeds. No sé si habréis notado que cuando pulsáis sobre un feed, no se ve nada. Igual que en el <em>preview</em>. Eso es porque tenemos que implementar el <code>hook_view</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_view</span> ( $node, $teaser <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, $page <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $messageread <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  $messagedata <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  $messagename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  $messageusermail <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  <span style="color:#66d9ef">if</span> ( $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#75715e">// ya tenemos el mensaje. Puede deberse a que estamos editando.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#75715e"></span>    $messageread <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    $messagedata <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    $messagename <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    $messageusermail <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#75715e">// tenemos que obtener el mensaje
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#75715e"></span>    $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.uid, message, indate, usermail, u.name, fm.read FROM {feedback_messages} fm, {users} u WHERE id=%d and fm.uid=u.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    $messageread <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    $messagedata <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    $messagename <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    $messageusermail <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">usermail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>  $read <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>  <span style="color:#66d9ef">if</span> ( $messageread )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    $read <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34; and &lt;b&gt;already read&lt;/b&gt;&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>  $content  <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;&lt;blockquote&gt;&lt;i&gt;%s&lt;/i&gt;&lt;/blockquote&gt;&lt;p&gt;Sent by %s&lt;a href=&#34;mailto:%s&#34;&gt;&amp;lt;%s&amp;gt;&lt;/a&gt;%s.&lt;/p&gt;&#39;</span>), $messagedata, $messagename, $messageusermail, $messageusermail, $read );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>  $node <span style="color:#f92672">=</span> <span style="color:#a6e22e">node_prepare</span> ( $node, $teaser );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">content</span>[<span style="color:#e6db74">&#39;message&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>    <span style="color:#e6db74">&#39;#value&#39;</span> <span style="color:#f92672">=&gt;</span> $content,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>    <span style="color:#e6db74">&#39;#weight&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>  <span style="color:#66d9ef">return</span> $node;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>}
</code></pre></div><p>Ahora vamos con la edición, para que se hagan efectivos los cambios:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_update</span> ( $node )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $userid  <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  $message <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  $mail    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  $read    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UPDATE {feedback_messages} fm SET message=&#39;%s&#39;, usermail=&#39;%s&#39;, fm.read=%d where id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $message, $mail, $read, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">db_affected_rows</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#a6e22e">drupal_set_message</span> ( <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#34;The feedback has been updated.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#a6e22e">drupal_goto</span> ( <span style="color:#e6db74">&#39;node&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>  <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;feedback&#39;</span>, <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#34;An error has happened. Your feedback has not been sent.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>}
</code></pre></div><p>Ahora una nota sobre el borrado: Si tratamos de borrar el nodo, veremos que se realiza sin problemas, pero eso no quiere decir que lo estemos haciendo BIEN. Se habrá borrado el nodo, pero no se habrá borrado la información asociada a nuestro feed, dejando basura inaccesible en la base de datos. Por eso implementaremos:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#e6db74">* Implementation of hook_delete
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_delete</span> ( $node )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DELETE FROM {feedback_messages} where id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>}
</code></pre></div><p>Con esto, queda obsoleto lo que implementamos en la cuarta entrega del curso
para poder eliminar mensajes :-D. Claro, que también hay una serie de enlaces
anticuados que nos están permitiendo crear feeds que no son nodos. Por estas
razones, vamos a eliminar:</p>
<ul>
<li><code>feedback_delete_form_submit</code></li>
<li><code>feedback_delete_form</code></li>
<li><code>feedback_messageadmin_form_submit</code></li>
<li><code>feedback_messageadmin_form_submit</code></li>
<li><code>feedback_messageadmin_form</code></li>
</ul>
<p>Y vamos a cambiar los enlaces en <code>feedback_admin</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_admin</span> ( $messageid<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  <span style="color:#66d9ef">if</span> ( $messageid <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_messageadmin_form&#39;</span>, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#34;&lt;hr/&gt;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>  $header <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Date&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;indate&#39;</span>, <span style="color:#e6db74">&#39;sort&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;desc&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;User&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;name&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;email&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;mail&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;message&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Read&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;fm.read&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.id, u.uid as uid, u.name, fm.usermail, fm.indate, fm.message, fm.read FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>  $query <span style="color:#f92672">.=</span> <span style="color:#a6e22e">tablesort_sql</span> ( $header );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  $queryResult <span style="color:#f92672">=</span>  <span style="color:#a6e22e">db_query</span> ( $query );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>  $rows <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  <span style="color:#66d9ef">while</span> ( $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult ) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    $row <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    $row[<span style="color:#e6db74">&#39;indate&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    $row[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;?q=user/&#39;</span><span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&#34;&gt;&#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&lt;/a&gt;&#39;</span> <span style="color:#f92672">:</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    $row[<span style="color:#e6db74">&#39;mail&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">usermail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>    $row[<span style="color:#e6db74">&#39;message&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    $row[<span style="color:#e6db74">&#39;read&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>    $row[<span style="color:#e6db74">&#39;edit&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;edit&#39;</span>), <span style="color:#e6db74">&#34;node/&#34;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;/edit&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    $rows[] <span style="color:#f92672">=</span> $row;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">theme_table</span>($header, $rows);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>}
</code></pre></div><p>Y lo más importante: ¡¡Ahora no podemos permitir que se cree un elemento
<em>feedback</em> sin que sea un nodo!! Así que se tercian dos cambios: Cambiar el
enlace del bloque (acordaos de limpiar la caché en Administration-&gt;performance)
y eliminar el acceso del <code>hook_menu</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#e6db74">* Implementation of hook_block().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_block</span> ( $op <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;list&#39;</span>, $delta <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, $edit <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  <span style="color:#66d9ef">if</span> ( $op <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;list&#34;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>      $blocks <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>      $blocks[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;info&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>      $blocks[<span style="color:#ae81ff">1</span>][<span style="color:#e6db74">&#34;info&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;New Feedbacks&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>      <span style="color:#66d9ef">return</span> $blocks;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( $op <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;view&#34;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>      $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>      $block <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>      <span style="color:#66d9ef">switch</span> ( $delta )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>      {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>          $block[<span style="color:#e6db74">&#39;subject&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>          $options <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>( <span style="color:#e6db74">&#34;attributes&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;Sends a feedback message&#34;</span>) ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>          $link <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span>( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;New Feedback&#34;</span>), <span style="color:#e6db74">&#34;node/add/feedback&#34;</span>, $options );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>          $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;div class=&#34;link&#34;&gt;&#39;</span> <span style="color:#f92672">.</span> $link <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/div&gt;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>          <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>          $block[<span style="color:#e6db74">&#39;subject&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback Messages&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>          $options <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>( <span style="color:#e6db74">&#34;attributes&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;Shows feedback messages&#34;</span>) ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>          $title <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;There are @total new feeds&#34;</span>, <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;@total&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">_feedback_count</span>() ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>          $link <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span>( $title , <span style="color:#e6db74">&#34;feedback/adminmessages&#34;</span>, $options );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>          $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;div class=&#34;link&#34;&gt;&#39;</span> <span style="color:#f92672">.</span> $link <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/div&gt;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>          <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>      $block[<span style="color:#e6db74">&#39;content&#39;</span>] <span style="color:#f92672">=</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>      <span style="color:#66d9ef">return</span> $block;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span style="color:#e6db74">* Implementation of hook_menu().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_menu</span> ( )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>  $items <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>  $items[<span style="color:#e6db74">&#39;feedback/adminmessages&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Feedback admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;view messages&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>  <span style="color:#66d9ef">return</span> $items;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>}
</code></pre></div><h2 id="drupal-7">Drupal 7</h2>
<p>Mucho me temo que todo lo que cuento aquí es válido para Drupal 6, pero no para Drupal 7.</p>
<p>Hay tutoriales de cómo pasar de Drupal 6 a Drupal 7, y seguro que todo lo contado en esta parte del tutorial se verá afectado.</p>
<h2 id="más-tutoriales">Más tutoriales</h2>
<p>Tengo en mente hacer un tutorial más y terminar con toda la tanda. Lo que queda por ver es sencillo: aplicar <em>themes</em> y añadir archivos de traducción. Si se os ocurre algo más, ¡¡decidlo ahora!!</p>
<h2 id="opinión-personal">Opinión personal</h2>
<p>En muchos casos puede venir bien crear un módulo para drupal que gestiona nodos. Sin embargo, también es cierto que en este caso a mí, particulamente, me parece un problema. Al ser nodos, se verán afectados por los permisos de nodos, por lo que si en tu site no dejas crear contenido, se acabaron los feeds.</p>
<p>De todas maneras, me parecía interesante contarlo de esta manera, con el fin de que quede como una continuación y se aprenda a crear contenido para Drupal, que no es nada difícil</p>
<h2 id="más-tutoriales-1">Más tutoriales</h2>
<p>Este tutorial es la continuación de una serie de tutoriales relacionados con Drupal. Podéis consultar cualquiera de ellos:</p>
<ul>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal/">Creación de un módulo drupal (I)</a></li>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-2/">Creación de un módulo drupal (II)</a></li>
<li><a href="https://magmax.org/blog/creacion-modulo-drupal-4/">Creación de un módulo drupal (III)</a></li>
<li><a href="https://magmax.org/blog/drupal-expansors/">Drupal: Creando contenido con &lsquo;expansors&rsquo;</a></li>
<li><a href="https://magmax.org/blog/critica-drupal/">Crítica a Drupal</a></li>
<li><a href="https://magmax.org/blog/drupal-tabla-perfecta/">Tablas en Drupal: Haciendo la tabla perfecta</a></li>
</ul>
<h2 id="código">Código</h2>
<p>Como en este caso no se ha modificado nada del <code>feedback.install</code>, pongo sólo el módulo principal:</p>
<h3 id="feedbackmodule">feedback.module</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span><span style="color:#75715e">/*
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span><span style="color:#75715e">Copyright 2009-2010 Miguel Ángel García Martínez &lt;miguelangel.garcia@gmail.com&gt;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span><span style="color:#75715e">  &#39;Feedback&#39; is free software; you can redistribute it and/or modify
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span><span style="color:#75715e">it under the terms of the GNU General Public License as published by
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span><span style="color:#75715e">the Free Software Foundation; either version 3 of the License, or
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span><span style="color:#75715e">(at your option) any later version.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span><span style="color:#75715e">  &#39;Feedback&#39; is distributed in the hope that it will be useful,
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span><span style="color:#75715e">but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span><span style="color:#75715e">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span><span style="color:#75715e">GNU General Public License for more details.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span><span style="color:#75715e">  You should have received a copy of the GNU General Public License
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span><span style="color:#75715e">along with &#39;Feedback&#39; (maybe in file &#34;COPYING&#34;); if not, write to the Free Software
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span><span style="color:#75715e">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span><span style="color:#75715e">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span><span style="color:#e6db74">* Implements hook_help().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_help</span> ( $path, $arg )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>  $output<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>; <span style="color:#75715e">// para construir la salida
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">switch</span> ( <span style="color:#a6e22e">path</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;admin/help#feedback&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>      $output <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;p&gt;&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Módulo que permite la inserción de mensajes de feedback.&#39;</span>) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&lt;/p&gt;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span>      <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span>  <span style="color:#66d9ef">return</span> $output;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span><span style="color:#e6db74">* Implements hook_perm().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_perm</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;send message&#39;</span>, <span style="color:#e6db74">&#39;view messages&#39;</span>, <span style="color:#e6db74">&#39;admin messages&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span><span style="color:#e6db74">* Implements hook_access()
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_access</span> ( $op, $node, $account )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span>  $retval <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span>  <span style="color:#66d9ef">switch</span> ( $op )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;view&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span>      $retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">user_access</span> ( <span style="color:#e6db74">&#39;view messages&#39;</span>, $account );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;create&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span>      $retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">user_access</span> ( <span style="color:#e6db74">&#39;send message&#39;</span>, $account );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>      <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;update&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>      $retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">user_access</span> ( <span style="color:#e6db74">&#39;admin messages&#39;</span>, $account ) <span style="color:#f92672">&amp;&amp;</span> ( $account<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>      <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;delete&#39;</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>      $retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">user_access</span> ( <span style="color:#e6db74">&#39;admin messages&#39;</span>, $account ) <span style="color:#f92672">&amp;&amp;</span> ( $account<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span>      <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span>  <span style="color:#66d9ef">return</span> $retval;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span><span style="color:#e6db74">* Implements hook_node_info()
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_node_info</span>() {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">array</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span>    <span style="color:#e6db74">&#39;feedback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span>      <span style="color:#e6db74">&#39;name&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>      <span style="color:#e6db74">&#39;module&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span>      <span style="color:#e6db74">&#39;description&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Handle a feedback message&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>    ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span><span style="color:#e6db74">* Implementation of hook_block().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_block</span> ( $op <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;list&#39;</span>, $delta <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, $edit <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span>  <span style="color:#66d9ef">if</span> ( $op <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;list&#34;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span>      $blocks <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span>      $blocks[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;info&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span>      $blocks[<span style="color:#ae81ff">1</span>][<span style="color:#e6db74">&#34;info&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;New Feedbacks&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>      <span style="color:#66d9ef">return</span> $blocks;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( $op <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;view&#34;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>      $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>      $block <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span>      <span style="color:#66d9ef">switch</span> ( $delta )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span>      {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span>          $block[<span style="color:#e6db74">&#39;subject&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span>          $options <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>( <span style="color:#e6db74">&#34;attributes&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;Sends a feedback message&#34;</span>) ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>          $link <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span>( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;New Feedback&#34;</span>), <span style="color:#e6db74">&#34;node/add/feedback&#34;</span>, $options );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span>          $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;div class=&#34;link&#34;&gt;&#39;</span> <span style="color:#f92672">.</span> $link <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/div&gt;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>          <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>          $block[<span style="color:#e6db74">&#39;subject&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Feedback Messages&#39;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>          $options <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>( <span style="color:#e6db74">&#34;attributes&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;title&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;Shows feedback messages&#34;</span>) ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span>          $title <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34;There are @total new feeds&#34;</span>, <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;@total&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">_feedback_count</span>() ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span>          $link <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span>( $title , <span style="color:#e6db74">&#34;feedback/adminmessages&#34;</span>, $options );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span>          $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;&lt;div class=&#34;link&#34;&gt;&#39;</span> <span style="color:#f92672">.</span> $link <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/div&gt;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span>          <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span>      $block[<span style="color:#e6db74">&#39;content&#39;</span>] <span style="color:#f92672">=</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span>      <span style="color:#66d9ef">return</span> $block;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120</span><span style="color:#e6db74">* Implementation of hook_menu().
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_menu</span> ( )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124</span>  $items <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126</span>  $items[<span style="color:#e6db74">&#39;feedback/adminmessages&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128</span>    <span style="color:#e6db74">&#39;title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;Feedback admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129</span>    <span style="color:#e6db74">&#39;page callback&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;feedback_admin&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130</span>    <span style="color:#e6db74">&#39;access arguments&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;view messages&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131</span>    <span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">MENU_CALLBACK</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134</span>  <span style="color:#66d9ef">return</span> $items;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_message</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_form&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_form</span> ( <span style="color:#f92672">&amp;</span>$node )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148</span>  <span style="color:#66d9ef">global</span> $user;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150</span>  $title <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span> ( <span style="color:#e6db74">&#39;Feed from %s&#39;</span>, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151</span>  $mail <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152</span>  $message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153</span>  $read <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154</span>  $editing <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156</span>  <span style="color:#66d9ef">if</span> ( $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157</span>    $mail <span style="color:#f92672">=</span> $user<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159</span>  <span style="color:#66d9ef">if</span> ( $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161</span>    <span style="color:#75715e">// estamos editando
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162</span><span style="color:#75715e"></span>    $editing <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163</span>    <span style="color:#66d9ef">if</span> ( $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165</span>      <span style="color:#75715e">// estamos previsualizando datos
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166</span><span style="color:#75715e"></span>      $mail    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167</span>      $message <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168</span>      $read    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170</span>    <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172</span>      $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT uid, message, indate, usermail, fm.read FROM {feedback_messages} fm WHERE id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173</span>      $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174</span>      $storednode <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176</span>      $mail    <span style="color:#f92672">=</span> $storednode<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">usermail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177</span>      $message <span style="color:#f92672">=</span> $storednode<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178</span>      $read    <span style="color:#f92672">=</span> $storednode<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182</span>  $form [<span style="color:#e6db74">&#39;feedback&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184</span>      <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;fieldset&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185</span>      <span style="color:#e6db74">&#39;#title&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#39;Feedback&#39;</span> ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186</span>      <span style="color:#e6db74">&#39;mail&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> (<span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textfield&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;E-Mail&#34;</span>, <span style="color:#e6db74">&#34;#description&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;If you want any answer, please, tell me your mail. It would not be shown anywhere.&#34;</span>, <span style="color:#e6db74">&#34;#default_value&#34;</span> <span style="color:#f92672">=&gt;</span> $mail ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187</span>      <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;textarea&#39;</span>, <span style="color:#e6db74">&#34;#description&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;Write here your message&#34;</span>, <span style="color:#e6db74">&#39;#default_value&#39;</span><span style="color:#f92672">=&gt;</span>$message ),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188</span>      <span style="color:#e6db74">&#39;#required&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">TRUE</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191</span>  <span style="color:#66d9ef">if</span> ( $editing )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193</span>    $form [<span style="color:#e6db74">&#39;feedback&#39;</span>][<span style="color:#e6db74">&#39;read&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ( <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;checkbox&#39;</span>, <span style="color:#e6db74">&#34;#title&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;The message has been read&#34;</span>, <span style="color:#e6db74">&#39;#default_value&#39;</span><span style="color:#f92672">=&gt;</span>$read ) ;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196</span>  $form[<span style="color:#e6db74">&#39;title&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197</span>    (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198</span>      <span style="color:#e6db74">&#39;#type&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;hidden&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199</span>      <span style="color:#e6db74">&#39;#default_value&#39;</span> <span style="color:#f92672">=&gt;</span> $title,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200</span>    );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202</span>  <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_insert</span> ( $node )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207</span>  $userid  <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208</span>  $message <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209</span>  $mail    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;INSERT into {feedback_messages} ( id, uid, message, indate, usermail ) values ( %d, %d, &#39;%s&#39;, now(), &#39;%s&#39; ) &#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span>, $userid, $message, $mail );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214</span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">db_affected_rows</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216</span>    <span style="color:#a6e22e">drupal_set_message</span> ( <span style="color:#a6e22e">t</span> ( <span style="color:#e6db74">&#34;Thank you for your feedback.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217</span>    <span style="color:#a6e22e">drupal_goto</span> ( <span style="color:#e6db74">&#39;node&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219</span>  <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;feedback&#39;</span>, <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#34;An error has happened. Your feedback has not been sent.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_update</span> ( $node )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225</span>  $userid  <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226</span>  $message <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227</span>  $mail    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228</span>  $read    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UPDATE {feedback_messages} fm SET message=&#39;%s&#39;, usermail=&#39;%s&#39;, fm.read=%d where id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $message, $mail, $read, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233</span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">db_affected_rows</span>() )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235</span>    <span style="color:#a6e22e">drupal_set_message</span> ( <span style="color:#a6e22e">t</span> ( <span style="color:#e6db74">&#34;The feedback has been updated.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236</span>    <span style="color:#a6e22e">drupal_goto</span> ( <span style="color:#e6db74">&#39;node&#39;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">238</span>  <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">239</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;feedback&#39;</span>, <span style="color:#a6e22e">t</span>( <span style="color:#e6db74">&#34;An error has happened. Your feedback has not been sent.&#34;</span> ) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">240</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">241</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">242</span><span style="color:#e6db74">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">243</span><span style="color:#e6db74">* Implementation of hook_delete
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">244</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">245</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_delete</span> ( $node )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">246</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">247</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DELETE FROM {feedback_messages} where id=%d&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">248</span>  $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">249</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">250</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">251</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_validate</span> ( $node, <span style="color:#f92672">&amp;</span>$form )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">252</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">253</span>  $message <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">254</span>  $mail    <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">255</span>  $validmail <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_match</span> (<span style="color:#e6db74">&#34;/^[^0-9][A-z0-9_]+([.][A-z0-9_]+)*[@][A-z0-9_]+([.][A-z0-9_]+)*[.][A-z]{2,4}$/&#34;</span> , $mail );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">256</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">257</span>  <span style="color:#66d9ef">if</span> ( $mail <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">258</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;mail&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;You are not a registered user. Please, insert your e-mail.&#39;</span>) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">259</span>  <span style="color:#66d9ef">if</span> ( $mail <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span> $validmail )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">260</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;mail&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;The mail does not like an e-mail address.&#39;</span>) );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">261</span>  <span style="color:#66d9ef">if</span> ( $message <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">262</span>    <span style="color:#a6e22e">form_set_error</span> ( <span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message cannot be empty.&#39;</span>));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">263</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">264</span>  <span style="color:#66d9ef">return</span> $form;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">265</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">266</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">267</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_view</span> ( $node, $teaser <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, $page <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">268</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">269</span>  $messageread <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">270</span>  $messagedata <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">271</span>  $messagename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">272</span>  $messageusermail <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">273</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">274</span>  <span style="color:#66d9ef">if</span> ( $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">275</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">276</span>    <span style="color:#75715e">// ya tenemos el mensaje. Puede deberse a que estamos editando.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">277</span><span style="color:#75715e"></span>    $messageread <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">278</span>    $messagedata <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">279</span>    $messagename <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">280</span>    $messageusermail <span style="color:#f92672">=</span> $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">281</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">282</span>  <span style="color:#66d9ef">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">283</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">284</span>    <span style="color:#75715e">// tenemos que obtener el mensaje
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">285</span><span style="color:#75715e"></span>    $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.uid, message, indate, usermail, u.name, fm.read FROM {feedback_messages} fm, {users} u WHERE id=%d and fm.uid=u.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">286</span>    $queryResult <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_query</span> ( $query, $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">nid</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">287</span>    $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">288</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">289</span>    $messageread <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">290</span>    $messagedata <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">291</span>    $messagename <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">292</span>    $messageusermail <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">usermail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">293</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">294</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">295</span>  $read <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">296</span>  <span style="color:#66d9ef">if</span> ( $messageread )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">297</span>    $read <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#34; and &lt;b&gt;already read&lt;/b&gt;&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">298</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">299</span>  $content  <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;&lt;blockquote&gt;&lt;i&gt;%s&lt;/i&gt;&lt;/blockquote&gt;&lt;p&gt;Sent by %s&lt;a href=&#34;mailto:%s&#34;&gt;&amp;lt;%s&amp;gt;&lt;/a&gt;%s.&lt;/p&gt;&#39;</span>), $messagedata, $messagename, $messageusermail, $messageusermail, $read );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">300</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">301</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">302</span>  $node <span style="color:#f92672">=</span> <span style="color:#a6e22e">node_prepare</span> ( $node, $teaser );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">303</span>  $node<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">content</span>[<span style="color:#e6db74">&#39;message&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">304</span>    <span style="color:#e6db74">&#39;#value&#39;</span> <span style="color:#f92672">=&gt;</span> $content,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">305</span>    <span style="color:#e6db74">&#39;#weight&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">306</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">307</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">308</span>  <span style="color:#66d9ef">return</span> $node;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">309</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">310</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">311</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">feedback_admin</span> ( $messageid<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">312</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">313</span>  $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">314</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">315</span>  <span style="color:#66d9ef">if</span> ( $messageid <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">316</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">317</span>    $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">drupal_get_form</span> ( <span style="color:#e6db74">&#39;feedback_messageadmin_form&#39;</span>, $messageid );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">318</span>    $content <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#34;&lt;hr/&gt;&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">319</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">320</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">321</span>  $header <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">322</span>  (
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">323</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Date&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;indate&#39;</span>, <span style="color:#e6db74">&#39;sort&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;desc&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">324</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;User&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;name&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">325</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;email&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;mail&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">326</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Message&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;message&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">327</span>    <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;Read&#39;</span>), <span style="color:#e6db74">&#39;field&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;fm.read&#39;</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">328</span>  );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">329</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">330</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT fm.id, u.uid as uid, u.name, fm.usermail, fm.indate, fm.message, fm.read FROM {feedback_messages} fm, {users} u WHERE fm.uid=u.uid&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">331</span>  $query <span style="color:#f92672">.=</span> <span style="color:#a6e22e">tablesort_sql</span> ( $header );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">332</span>  $queryResult <span style="color:#f92672">=</span>  <span style="color:#a6e22e">db_query</span> ( $query );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">333</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">334</span>  $rows <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">335</span>  <span style="color:#66d9ef">while</span> ( $message <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult ) )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">336</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">337</span>    $row <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span> ();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">338</span>    $row[<span style="color:#e6db74">&#39;indate&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">indate</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">339</span>    $row[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;?q=user/&#39;</span><span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">uid</span> <span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&#34;&gt;&#39;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;&lt;/a&gt;&#39;</span> <span style="color:#f92672">:</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">340</span>    $row[<span style="color:#e6db74">&#39;mail&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">usermail</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">341</span>    $row[<span style="color:#e6db74">&#39;message&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">message</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">342</span>    $row[<span style="color:#e6db74">&#39;read&#39;</span>] <span style="color:#f92672">=</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">read</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">343</span>    $row[<span style="color:#e6db74">&#39;edit&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">l</span> ( <span style="color:#a6e22e">t</span>(<span style="color:#e6db74">&#39;edit&#39;</span>), <span style="color:#e6db74">&#34;node/&#34;</span> <span style="color:#f92672">.</span> $message<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;/edit&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">344</span>    $rows[] <span style="color:#f92672">=</span> $row;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">345</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">346</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">347</span>  $content <span style="color:#f92672">.=</span> <span style="color:#a6e22e">theme_table</span>($header, $rows);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">348</span>  <span style="color:#66d9ef">return</span> $content;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">349</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">350</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">351</span><span style="color:#e6db74">/** Devuelve el número de feeds creados en la última semana
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">352</span><span style="color:#e6db74">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">353</span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_feedback_count</span> ()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">354</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">355</span>  $query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT count(id) as total from {feedback_messages} fm where fm.read != 1 or isnull(fm.read)&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">356</span>  $queryResult <span style="color:#f92672">=</span>  <span style="color:#a6e22e">db_query</span> ( $query );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">357</span>  $result <span style="color:#f92672">=</span> <span style="color:#a6e22e">db_fetch_object</span> ( $queryResult ) ;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">358</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">359</span>  <span style="color:#66d9ef">return</span> $result<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">total</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">360</span>}
</code></pre></div><ul class="pa0">
  
   <li class="list">
     <a href="/tags/drupal" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">drupal</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "magmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Relacionado</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal/">Creación de un módulo Drupal</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal-2/">Creación de un módulo Drupal II</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/creacion-modulo-drupal-3/">Creación de un módulo Drupal III</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/drupal-no-muestra-comentarios/">Drupal no me muestra los comentarios</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/drupal-tabla-perfecta/">Tablas en Drupal: Haciendo una tabla perfecta</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://magmax.org/" >
    &copy;  El blog de MagMax 2021 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
