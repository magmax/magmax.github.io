<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Testing en django: mejoras | El blog de MagMax</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="En este artículo se muestran algunas mejoras sobre el sistema de testing de Django">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="Testing en django: mejoras" />
<meta property="og:description" content="En este artículo se muestran algunas mejoras sobre el sistema de testing de Django" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/testing-en-django-mejoras/" />
<meta property="article:published_time" content="2014-03-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2014-03-24T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta itemprop="name" content="Testing en django: mejoras">
<meta itemprop="description" content="En este artículo se muestran algunas mejoras sobre el sistema de testing de Django">
<meta itemprop="datePublished" content="2014-03-24T00:00:00+00:00" />
<meta itemprop="dateModified" content="2014-03-24T00:00:00+00:00" />
<meta itemprop="wordCount" content="1313">



<meta itemprop="keywords" content="django,python,testing," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Testing en django: mejoras"/>
<meta name="twitter:description" content="En este artículo se muestran algunas mejoras sobre el sistema de testing de Django"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        El blog de MagMax
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Inicio page">
              Inicio
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="../en" title="English page">
              English
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://magmax.org/blog/testing-en-django-mejoras/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://magmax.org/blog/testing-en-django-mejoras/&amp;text=Testing%20en%20django:%20mejoras" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://magmax.org/blog/testing-en-django-mejoras/&amp;title=Testing%20en%20django:%20mejoras" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Testing en django: mejoras</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2014-03-24T00:00:00Z">March 24, 2014</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>A menudo, cuando me pongo a hacer algo en <a href="https://www.djangoproject.com/" title="High-level Python Web framework">Django</a> y escribo mis primeros tests, los noto pesados y desordenados. Me resulta difícil diferenciar entre tests unitarios, de integracción y de aceptación.</p>
<p>De la misma manera, suele ser una aventura añadir <em>coverage</em>, ya que nunca me acuerdo de cómo se hace.</p>
<p>En este artículo describiré cómo hacer ambas cosas.</p>
<!-- raw HTML omitted -->
<figure>
    <img src="/images/python.png"
         alt="python"/> 
</figure>

<h1 id="entorno">Entorno</h1>
<p>Lo primero es crear un entorno con lo que vamos a necesitar. Para ello crearemos un entorno virtual, lo que nos aislará un poco del resto. Para este artículo usaré python 2.7, aunque debería ser perfectamente compatible con python 3.</p>
<p>Creemos el entorno:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$ virtualenv venv
</code></pre></div><p>Ahora comencemos a usarlo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$ . venv/bin/activate
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>$
</code></pre></div><p>Lo primero es instalar todo lo que nos hará falta. Para ello, creamos el archivo <strong>requirements.txt</strong> con el siguiente contenido:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Django==1.6.2
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>coverage==3.7.1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>mock==1.0.1
</code></pre></div><p>Y ahora lo instalamos:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>$ pip install -r requirements.txt
</code></pre></div><p>Así seguro que tendréis las mismas versiones que yo.</p>
<h2 id="proyecto">Proyecto</h2>
<p>Vamos con un proyecto muy sencillo. Será más que eso: será mínimo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>$ django-admin startproject prj
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>$ cd prj
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>prj$ python manage.py startapp app
</code></pre></div><p>De todo esto ya hablé en el artículo <a href="https://magmax.org/2011/08/20/django-sitio-basico.html">Creación de un sitio básico Django</a>, así que por eso voy rápido.</p>
<p>A menudo necesito un par de funciones para transformar <code>datetime</code> en <code>timestamps</code> y viceversa, de manera que mis <em>javascripts</em> puedan comunicarse vía <em>REST</em>, así que éstas van a ser las funciones a probar:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># archivo prj/app/views.py</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">import</span> time
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">millis2datetime</span>(timestamp, dater<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>now):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#66d9ef">if</span> timestamp:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        <span style="color:#66d9ef">return</span> datetime<span style="color:#f92672">.</span>fromtimestamp(timestamp<span style="color:#f92672">/</span><span style="color:#ae81ff">1000.0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#66d9ef">return</span> dater()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">datetime2millis</span>(dtime, timer<span style="color:#f92672">=</span>time<span style="color:#f92672">.</span>time):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#66d9ef">if</span> dtime:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#66d9ef">return</span> time<span style="color:#f92672">.</span>mktime(dtime<span style="color:#f92672">.</span>utctimetuple()) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#66d9ef">return</span> timer() <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>
</code></pre></div><p>Una vez tenemos todo esto&hellip; Comencemos.</p>
<h1 id="un-poquito-de-organización">Un poquito de organización</h1>
<h2 id="división-en-ficheros">División en ficheros</h2>
<p>¿A nadie más que a mí le molesta tener todos los tests en un único archivo <strong>tests.py</strong>?</p>
<p>Pues resulta que <a href="https://www.djangoproject.com/" title="High-level Python Web framework">Django</a> estś buscando todos los archivos que se llamen
<code>test_*</code>, por lo que podemos crear el módulo <strong>&ldquo;tests&rdquo;</strong> (es decir, crear el
directorio <strong>&ldquo;tests&rdquo;</strong> con un archivo vacío <strong>&quot;<strong>init</strong>.py&quot;</strong>)  y se ejecutarán
todos los archivos cuyo nombre comience por <code>test_</code>.</p>
<p>Sin embargo, esto me molesta también, ya que es información redundante. ¿No estamos ya dentro del módulo <strong>tests</strong>?</p>
<p>Dado que Django sólo toma como test cualquier clase que herede de <code>TestCase</code> (ya sea de <code>django.test</code> o de <code>unittest</code>), es estúpido filtrar también por el nombre del archivo.</p>
<p>Por esa razón me gusta utilizar la opción <code>-p&quot;*.py&quot;</code>, de manera que me busque los tests en todos los archivos python, y no tener que preocuparme del nombre:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>$ manage.py test -p<span style="color:#e6db74">&#34;*.py&#34;</span>
</code></pre></div><h2 id="unitintegrationacceptance">unit/integration/acceptance</h2>
<p>Otra cosa que me mosquea es tener que esperar mucho a la ejecución de los tests. Por eso me gusta tener unos tests de ejecución ultra rápida, los unitarios, que no necesitan la base de datos ni acceso a disco. De hecho, quiero <strong>asegurarme</strong> de que éstos no pueden acceder a la base de datos de ninguna manera, con el fin de evitar cualquier despiste.</p>
<p><a href="https://www.djangoproject.com/" title="High-level Python Web framework">Django</a> no soporta nada de esto. De hecho, si alguna <code>TestSuite</code> requiere una <em>fixture</em>, automáticamente generará una BBDD vacía e insertará los datos. No quiero eso.</p>
<p>La solución es implementar mi propio <code>Runner</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># archivo runners/__init__.py</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#f92672">from</span> django.test.runner <span style="color:#f92672">import</span> DiscoverRunner
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">from</span> django.utils <span style="color:#f92672">import</span> unittest
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#f92672">from</span> unittest.suite <span style="color:#f92672">import</span> TestSuite
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomizedRunner</span>(DiscoverRunner):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_suite</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        suite <span style="color:#f92672">=</span> super(CustomizedRunner, self)<span style="color:#f92672">.</span>build_suite(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        filtered <span style="color:#f92672">=</span> TestSuite()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#66d9ef">for</span> test <span style="color:#f92672">in</span> suite:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>package <span style="color:#f92672">in</span> str(test):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>                filtered<span style="color:#f92672">.</span>addTest(test)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#66d9ef">return</span> filtered
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnitRunner</span>(CustomizedRunner):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    package <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.unit.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setup_databases</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        <span style="color:#66d9ef">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">teardown_databases</span>(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        <span style="color:#66d9ef">return</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IntegrationRunner</span>(CustomizedRunner):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    package <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.integration.&#39;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AcceptanceRunner</span>(CustomizedRunner):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    package <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.acceptance.&#39;</span>
</code></pre></div><p>Como podéis ver, me creo el <code>CustomizedRunner</code> que hereda de <code>DiscoverRunner</code>. Así no me tengo que preocupar de reinventar la rueda y <a href="https://www.djangoproject.com/" title="High-level Python Web framework">Django</a> me ofrece todo lo que necesito. Lo único que me falta es un filtro para los tests.</p>
<p>Por eso creo tres <strong>Runners</strong> distintos: <code>UnitRunner</code>, <code>IntegrationRunner</code> y <code>AcceptanceRunner</code>. Éstos, básicamente, filtran los tests que contengan cierta cadena en su nombre de módulo.</p>
<p>La única diferencia la pone el <code>UnitRunner</code>, en el que me aseguro de que la base de datos no se toca. No es extrictamente necesario, pero no está de más.</p>
<p>Ahora puedo crearme la siguiente estructura:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>tests
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>├── __init__.py
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>├── acceptance
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>│   └── __init__.py
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>├── integration
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>│   └── __init__.py
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>└── unit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>    └── __init__.py
</code></pre></div><p>Y podré situar los tests en el lugar adecuado.</p>
<p>Para seleccionar los tests que quiero ejecutar, basta con cambiar el runner:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>(venv)$ manage.py test -p&#34;*.py&#34; --testrunner runners.UnitRunner
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>(venv)$ manage.py test -p&#34;*.py&#34; --testrunner runners.IntegrationRunner
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>(venv)$ manage.py test -p&#34;*.py&#34; --testrunner runners.AcceptanceRunner
</code></pre></div><h1 id="cobertura">Cobertura</h1>
<p>Esta estructura de tests me permite algo más: puedo seleccionar la cobertura en función del tipo de test. Puede parecer una tontería, pero me interesa separar la cobertura de tests unitarios de la de los de integración, y la de aceptación no me interesa en absoluto.</p>
<p>Veamos primero cómo se ejecuta para los tests unitarios:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>$ coverage run --source<span style="color:#f92672">=</span>. --omit<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;manage,**/test*&#34;</span> <span style="color:#ae81ff">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#ae81ff"></span>        manage.py test app/ --testrunner runners.UnitRunner -p<span style="color:#e6db74">&#34;*.py&#34;</span>
</code></pre></div><p>Un poco larga la línea, pero fácil de entender. Tan solo le indico dónde están los fuentes y que no me interesa la cobertura de los archivos de test ni de los propios de <a href="https://www.djangoproject.com/" title="High-level Python Web framework">Django</a>. Ahora muestro el resultado:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#f92672">(</span>venv<span style="color:#f92672">)</span>$ coverage report
</code></pre></div><p>Fácil, ¿eh?</p>
<h2 id="aún-más-fácil">Aún más fácil</h2>
<p>Yo soy muy vago y no voy a acordarme de una línea como ésa. Por eso he decidido meterlo todo en un <strong>Makefile</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Archivo Makefile
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>modules<span style="color:#f92672">=</span>app
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#a6e22e">all</span><span style="color:#f92672">:</span> pep8 flakes test
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#a6e22e">full_test</span><span style="color:#f92672">::</span> run_unit_tests run_integration_tests run_acceptance_tests report
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#a6e22e">test</span><span style="color:#f92672">::</span> run_unit_tests run_integration_tests report
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#a6e22e">unit</span><span style="color:#f92672">::</span> run_unit_tests report
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#a6e22e">run_unit_tests</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>	@echo Running UNIT tests...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>	@coverage run --source<span style="color:#f92672">=</span>. --omit<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;manage.py,**/test*&#34;</span><span style="color:#ae81ff">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#ae81ff"></span>        manage.py test --testrunner runners.UnitRunner
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#a6e22e">run_integration_tests</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>	@echo Running INTEGRATION tests...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>	@coverage run --source<span style="color:#f92672">=</span>. --omit<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;manage.py,**/test*&#34;</span> -a<span style="color:#ae81ff">\
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#ae81ff"></span>        manage.py test --testrunner runners.IntegrationRunner
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#a6e22e">run_acceptance_tests</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>	@echo Running ACCEPTANCE tests...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>	@python manage.py test --testrunner runners.AcceptanceRunner
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span style="color:#a6e22e">report</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>	@coverage report
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#a6e22e">html_report</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>	@coverage html -d coverage
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#a6e22e">pep8</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>	@pep8 --statistics <span style="color:#e6db74">${</span>modules<span style="color:#e6db74">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span style="color:#a6e22e">flakes</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>	@pyflakes <span style="color:#e6db74">${</span>modules<span style="color:#e6db74">}</span>
</code></pre></div><p>Como veréis, he añadido algunos detalles para pasar el <a href="https://legacy.python.org/dev/peps/pep-0008/" title="Style Guide for Python Code">pep8</a> y <a href="https://launchpad.net/pyflakes" title="A simple program which checks Python source files for errors">pyflakes</a>, y algunas etiquetas para saber qué está pasando y generar informes.</p>
<p>Los tests unitarios crearán el archivo de cobertura, los de integración añadirán sus datos y los de aceptación no generarán cobertura en absoluto.</p>
<p>De esta manera puedo ejecutar los tests de unit tantas veces como quiera, que serán muy rápidos.</p>
<h1 id="los-tests">Los tests</h1>
<p>Por si alguien desea probar todo esto con datos reales, aquí están los tests:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">import</span> time
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">millis2datetime</span>(timestamp, dater<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>now):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#66d9ef">if</span> timestamp:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        <span style="color:#66d9ef">return</span> datetime<span style="color:#f92672">.</span>fromtimestamp(timestamp<span style="color:#f92672">/</span><span style="color:#ae81ff">1000.0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#66d9ef">return</span> dater()
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">datetime2millis</span>(dtime, timer<span style="color:#f92672">=</span>time<span style="color:#f92672">.</span>time):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#66d9ef">if</span> dtime:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#66d9ef">return</span> time<span style="color:#f92672">.</span>mktime(dtime<span style="color:#f92672">.</span>utctimetuple()) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#66d9ef">return</span> timer() <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>
</code></pre></div><p>Y aquí tenéis un ejemplo de ejecución:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>(venv)$ make unit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>Running UNIT tests...
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>....
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>----------------------------------------------------------------------
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>Ran 4 tests in 0.002s
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>OK
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>Name           Stmts   Miss  Cover
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>----------------------------------
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>app/__init__       0      0   100%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>app/admin          1      1     0%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>app/models         1      1     0%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>app/views         10      0   100%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>manage             6      0   100%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>prj/__init__       0      0   100%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>prj/settings      17      0   100%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>prj/urls           4      4     0%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>prj/wsgi           4      4     0%
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>----------------------------------
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>TOTAL             43     10    77%
</code></pre></div><p>Se puede afinar aún más, evitando entrar en algunos archivos que no nos interesan ( <strong>wsgi</strong>, <strong>settings</strong>), pero creo que esta parte es bastante sencilla comparada con todo lo anterior XD</p>
<h1 id="más-información">Más información</h1>
<p>En la <a href="https://docs.djangoproject.com/en/dev/">documentación de Django</a> podéis encontrar todo lo necesario.</p>
<p>Por otra parte, hace un tiempo que llevo pensando en hacer unas plantillas para hacer proyectos en <a href="https://www.djangoproject.com/" title="High-level Python Web framework">Django</a> y <a href="https://angularjs.org/">AngularJS</a>, y hace poco que encontré un proyecto. Sin embargo, éste usaba versiones muy antiguas copiadas sobre el propio proyecto. Lo mejoré para que las resolviera como dependencias e hice el <em>pull-request</em>, pero aún no me han hecho ni caso.</p>
<p>Podéis encontrar este proyecto con el nombre de <a href="https://github.com/magmax/angularjs-django-rest-framework-seed">angularjs-django-rest-framework-seed</a>. Ya le he añadido estas mejoras.</p>
<p>El proyecto original parece un poco abandonado :(</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/django" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">django</a>
   </li>
  
   <li class="list">
     <a href="/tags/python" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">python</a>
   </li>
  
   <li class="list">
     <a href="/tags/testing" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">testing</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "magmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Relacionado</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/aprender-es-duro/">Aprender es duro (retrospectiva 2014)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python-tornado-2/">Python Tornado: Web Testing</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/webviews-en-el-escritorio/">WebViews en el escritorio</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/micro-web-framework-en-python/">Micro-framework web en Python</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/webdriver-practico/">Webdriver: crackeando la web de Renfe</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python-avanzado/">Python avanzado</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python-basico/">Python básico</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python-tornado/">Python Tornado</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/selenium-y-qa-automation-2/">Selenium y QA Automation: tests</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/selenium-y-qa-automation/">Selenium y QA Automation</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/functional-programming/">Programación funcional</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python3-slow/">Python 3 es lento (I)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/buildbot/">Integración contínua: BuildBot</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/jenkins/">Integración continua: Jenkins</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/java-unit-test-2/">Unit tests en Java (II)</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://magmax.org/" >
    &copy;  El blog de MagMax 2021 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
