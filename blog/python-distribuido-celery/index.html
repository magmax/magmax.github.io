<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Python distribuido: Celery | El blog de MagMax</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Python orientado a servicios mediante colas de mensajes, usando Celery">
    <meta name="generator" content="Hugo 0.79.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="Python distribuido: Celery" />
<meta property="og:description" content="Python orientado a servicios mediante colas de mensajes, usando Celery" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://magmax.org/blog/python-distribuido-celery/" />
<meta property="article:published_time" content="2015-03-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-03-20T00:00:00+00:00" /><meta property="og:site_name" content="El blog de MagMax" />
<meta itemprop="name" content="Python distribuido: Celery">
<meta itemprop="description" content="Python orientado a servicios mediante colas de mensajes, usando Celery">
<meta itemprop="datePublished" content="2015-03-20T00:00:00+00:00" />
<meta itemprop="dateModified" content="2015-03-20T00:00:00+00:00" />
<meta itemprop="wordCount" content="2019">



<meta itemprop="keywords" content="python,celery," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python distribuido: Celery"/>
<meta name="twitter:description" content="Python orientado a servicios mediante colas de mensajes, usando Celery"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        El blog de MagMax
      
    </a>
    <div class="flex-l items-center">
      
<h4></h4>
<ul class="pl0 mr3">
    
    <li class="list f5 f4-ns fw4 dib pr3">
        <a class="hover-white no-underline white-90" href="/en/blog/python-distribuido-celery/">en</a>
    </li>
    
</ul>


      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Inicio page">
              Inicio
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="../en" title="English page">
              English
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://magmax.org/blog/python-distribuido-celery/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://magmax.org/blog/python-distribuido-celery/&amp;text=Python%20distribuido:%20Celery" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://magmax.org/blog/python-distribuido-celery/&amp;title=Python%20distribuido:%20Celery" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Python distribuido: Celery</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2015-03-20T00:00:00Z">March 20, 2015</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Ahora están de modas las arquitecturas
<abbr title="Service Oriented Architectures">SOA</abbr>
.
Estas arquitecturas consisten en pequeños servicios muy específicos, de manera que interactúan unos con otros.</p>
<p>En esta ocasión voy a contar cómo utilizar <a href="https://www.celeryproject.org/">Celery</a> para crear una arquitectura SOA.</p>
<!-- raw HTML omitted -->
<figure>
    <img src="/images/python.png"
         alt="Python"/> 
</figure>

<h2 id="qué-es-celery">Qué es Celery</h2>
<p>No puede decirse que sea un sistema de comunicaciones, ya que el sistema de comunicaciones es <a href="https://www.rabbitmq.com">RabbitMQ</a>, <a href="https://redis.io/">Redis</a>, etc. Como usa uno de ellos, no puede ser un sistema de colas de mensajes. Tampoco es un protocolo, ya que utiliza <a href="https://www.amqp.org/">AMQP</a>. Tampoco es una abstracción sobre éstos, ya que eso es <a href="https://kombu.readthedocs.org/en/latest/">Kombu</a>, la librería de comunicaciones que utiliza.</p>
<p><a href="https://www.celeryproject.org/">Celery</a> es un conjunto de herramientas que nos permite trabajar fácilmente con múltiples servicios, con algo de azúcar sintáctico. Es una forma de lanzar servicios viéndolos como <strong>tareas</strong>.</p>
<h2 id="cómo-instalarlo">Cómo instalarlo</h2>
<p>Instalarlo es sencillo; con <code>pip</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>pip install celery
</code></pre></div><p>o con <code>apt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>apt-get install python-celery
</code></pre></div><p>El problema es que necesitamos un <strong>Broker</strong>. El <strong>Broker</strong> es el medio utilizado para transportar los mensajes de un servicio a otro. En este caso, necesitamos una cola de mensajes.</p>
<p>Para los ejemplos usaremos dos: <a href="https://www.rabbitmq.com">RabbitMQ</a> y <a href="https://redis.io/">Redis</a>. La primera es algo&hellip; complicadilla, pero muy visual si ya lo conocéis e instaláis el <a href="https://www.rabbitmq.com/management.html">plugin de gestión</a>. La segunda es más sencilla de instalar, pero más difícil de ver las tripas. Para <a href="https://redis.io/">Redis</a> necesitaréis también la librería; con <code>pip</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>pip install redis
</code></pre></div><p>o con <code>apt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>apt-get install python-redis
</code></pre></div><h2 id="ejemplo">Ejemplo</h2>
<h3 id="creando-servicios">Creando servicios</h3>
<p>Vamos a comenzar con la creación de un pequeño servicio que multiplica dos números:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery service example: task to multiply two numbers</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#a6e22e">@app.task</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply</span>(a, b):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">*</span> b</code></pre></div>
<p>Como veis, el <em>overhead</em> de añadir <a href="https://www.celeryproject.org/">Celery</a> es mínimo: importar la librería, crear la conexión (<code>app</code>) y añadir un decorador a nuestro servicio.</p>
<p>Ya es ejecutable:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>$ celery worker --loglevel<span style="color:#f92672">=</span>info -A tasks
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span> -------------- celery@nightcrawler v3.1.17 <span style="color:#f92672">(</span>Cipater<span style="color:#f92672">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>---- **** -----
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>--- * ***  * -- Linux-3.16.0-4-amd64-x86_64-with-debian-8.0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>-- * - **** ---
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>- ** ---------- <span style="color:#f92672">[</span>config<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>- ** ---------- .&gt; app:         tasks:0x7f3476eb9b90
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>- ** ---------- .&gt; transport:   redis://localhost:6379/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>- ** ---------- .&gt; results:     redis://localhost:6379/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>- *** --- * --- .&gt; concurrency: <span style="color:#ae81ff">4</span> <span style="color:#f92672">(</span>prefork<span style="color:#f92672">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>-- ******* ----
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>--- ***** ----- <span style="color:#f92672">[</span>queues<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span> -------------- .&gt; celery           exchange<span style="color:#f92672">=</span>celery<span style="color:#f92672">(</span>direct<span style="color:#f92672">)</span> key<span style="color:#f92672">=</span>celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#f92672">[</span>tasks<span style="color:#f92672">]</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>  . tasks.multiply
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#f92672">[</span>2015-03-20 21:56:16,526: INFO/MainProcess<span style="color:#f92672">]</span> Connected to redis://localhost:6379/0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#f92672">[</span>2015-03-20 21:56:16,541: INFO/MainProcess<span style="color:#f92672">]</span> mingle: searching <span style="color:#66d9ef">for</span> neighbors
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#f92672">[</span>2015-03-20 21:56:17,780: INFO/MainProcess<span style="color:#f92672">]</span> mingle: all alone
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#f92672">[</span>2015-03-20 21:56:17,791: WARNING/MainProcess<span style="color:#f92672">]</span> celery@nightcrawler ready.</code></pre></div>
<p>Aquí hay mucha información:</p>
<ul>
<li>versiones utilizadas.</li>
<li>colas creadas.</li>
<li><em>brokers</em> usados para transporte y para resultados.</li>
<li>Número de <em>workers</em>, es decir, procesos dispuestos a responder una petición de forma concurrente.</li>
</ul>
<p>Y alguna cosa más que podemos ignorar por el momento.</p>
<p>Dejaremos eso ahí corriendo de momento.</p>
<h3 id="lanzando-servicios">Lanzando servicios</h3>
<p>Ése es el <em>subscriptor</em>. Vamos a crear ahora el <em>publicador</em>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery client example: request for two numbers multiplication</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>promise <span style="color:#f92672">=</span> app<span style="color:#f92672">.</span>send_task(<span style="color:#e6db74">&#39;tasks.multiply&#39;</span>, args<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>])
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#66d9ef">print</span>(promise<span style="color:#f92672">.</span>get())</code></pre></div>
<p>Un poco complicado&hellip; Pero vamos a verlo rápidamente:</p>
<ul>
<li>La primera parte es igual que en el primer ejemplo, ya que necesitamos conectarnos al mismo sitio.</li>
<li>La segunda parte ejecuta la tarea por su nombre, pasándole los argumentos. Eso devuelve una <em>promesa</em> (<code>promise</code>). En este punto hemos dejado un mensaje en la cola.</li>
<li>Finalmente, materializamos la <em>promesa</em> mediante <code>promise.get()</code>. En algún momento el servicio habrá leído el mensaje, lo habrá procesado, habrá dejado el resultado en otra cola y, mediante este método, se lee.</li>
</ul>
<p>Así que parece complicado&hellip; pero podría serlo aún más.</p>
<p>De todas maneras, he grabado un vídeo para que veáis cómo se usa todo lo anterior:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/Lf4Q7K6Ab_g" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h3 id="todo-junto-es-más-fácil">Todo junto es más fácil</h3>
<p>Existe la opción de ponerlo todo junto en el mismo archivo, y veréis cómo las cosas resultan aún más sencillas. Esto no siempre es posible y puede tener algún problema (como que cada cambio nos obliga a reiniciar también el servicio), pero es muy didáctico:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery full example: publisher/subscriber to request a multiplication</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#a6e22e">@app.task</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply</span>(a, b):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">*</span> b
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    promise <span style="color:#f92672">=</span> multiply<span style="color:#f92672">.</span>delay(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#66d9ef">print</span>(promise<span style="color:#f92672">.</span>get())
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    main()</code></pre></div>
<p>En este caso invocamos a un método de la tarea directamente, y así obtenemos la tarea.</p>
<p>Ya tenemos una forma muy complicada de multiplicar dos números :D</p>
<h2 id="herramientas">Herramientas</h2>
<p>Como dije, <a href="https://www.celeryproject.org/">Celery</a> proporciona herramientas y azúcar sintáctico.</p>
<p>Lo primero que vamos a ver son las funciones parciales o <em>partials</em>. Simplemente son funciones con algunos parámetros ya resueltos.</p>
<p>En nuestro caso es fácil crear el <em>partial</em> <code>duplicate</code> forzando el primer parámetro de <code>multiply</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery full example: multiply two numbers with partials</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#a6e22e">@app.task</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply</span>(a, b):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">*</span> b
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    duplicate <span style="color:#f92672">=</span> multiply<span style="color:#f92672">.</span>si(<span style="color:#ae81ff">2</span>)
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    promise <span style="color:#f92672">=</span> duplicate<span style="color:#f92672">.</span>delay(<span style="color:#ae81ff">5</span>)
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#66d9ef">print</span>(promise<span style="color:#f92672">.</span>get())
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    main()</code></pre></div>
<p>Sí, los parciales se realizan con el método <code>.si</code>, aunque también podemos utilizar <code>.s</code>. La diferencia entre ambas es que la primera es <em>inmutable</em> (por eso la <code>i</code>). Resulta difícil explicar qué es eso sin contar antes otra herramienta de <a href="https://www.celeryproject.org/">Celery</a>: las cadenas (<code>Chain</code>).</p>
<p>En <a href="https://www.celeryproject.org/">Celery</a> se pueden concatenar tareas, de manera que el resultado de una de ellas sea el primer parámetro de la siguiente. ¿Por qué el primero? Pues porque sí. Es una putada, pero es así.</p>
<p>En ocasiones querremos funciones encadenadas tan sólo para que exista un orden, en cuyo caso queremos ignorar el resultado de la función anterior. En estos casos usaremos funciones inmutables, que no usan el parámetro anterior.</p>
<p>Espero que se haya notado que uso &ldquo;funciones&rdquo; o &ldquo;servicios&rdquo; indistintamente.</p>
<p>Pero basta ya de palabrería y concatenemos algo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery example: multiply with chains</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#a6e22e">@app.task</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply</span>(a, b):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">*</span> b
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> chain
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    duplicate <span style="color:#f92672">=</span> multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">2</span>)
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    task <span style="color:#f92672">=</span> chain(multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>), multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">2</span>))
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    promise <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>delay()
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#66d9ef">print</span>(promise<span style="color:#f92672">.</span>get())
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    main()</code></pre></div>
<p>Como dije antes, <a href="https://www.celeryproject.org/">Celery</a> proporciona azúcar sintáctico, por lo que lo anterior también puede escribirse así:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery example: multiply with chains using pipes (syntactic sugar)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#a6e22e">@app.task</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply</span>(a, b):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">*</span> b
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    duplicate <span style="color:#f92672">=</span> multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">2</span>)
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    task <span style="color:#f92672">=</span> multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>) <span style="color:#f92672">|</span> multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">2</span>)
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    promise <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>delay()
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#66d9ef">print</span>(promise<span style="color:#f92672">.</span>get())
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    main()</code></pre></div>
<p>Y aquí es donde comienza la diversión: hemos creado un <strong>canvas</strong>, es decir, un flujo de tareas. Aunque parezca mentira, si lanzáis distintos <em>workers</em> en distintas máquinas y todos se conectan al mismo <em>broker</em>, cada operación podría ejecutarse en uno diferente.</p>
<p>Pero claro&hellip; ¿para qué tanto <em>canvas</em> si las operaciones son secuenciales? Pues aquí viene la gracia: procesarlas de forma concurrente, los <strong>Grupos</strong> o <code>group</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery example: several multiplications with chains and groups (canvas)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#a6e22e">@app.task</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">multiply</span>(a, b):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">*</span> b
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> group
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    duplicate <span style="color:#f92672">=</span> multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">2</span>)
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    task <span style="color:#f92672">=</span> group(
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>        multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>) <span style="color:#f92672">|</span> multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">2</span>),
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>        multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">2</span>) <span style="color:#f92672">|</span> multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">4</span>),
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        multiply<span style="color:#f92672">.</span>s(<span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">7</span>) <span style="color:#f92672">|</span> duplicate,
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    )
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    promise <span style="color:#f92672">=</span> task<span style="color:#f92672">.</span>delay()
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    <span style="color:#66d9ef">print</span>(promise<span style="color:#f92672">.</span>get())
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    main()</code></pre></div>
<p>Existe aún más azúcar sintáctico, como los <code>chords</code>, <code>maps</code>, <code>starmaps</code> y <code>chunks</code>, pero no los vamos a ver aquí. Este artículo es meramente introductorio. <a href="https://celery.readthedocs.org/en/latest/userguide/canvas.html">Podéis leer más información sobre los Canvas</a>.</p>
<h3 id="el-beat">El Beat</h3>
<p>Otro aspecto importante de <a href="https://www.celeryproject.org/">Celery</a> es el <strong>Beat</strong>. Consiste en un <em>latido</em> o una señal producida cada cierto tiempo. Podemos activarla en el worker mediante la opción <code>--beat</code>. Mientras no metan <a href="https://github.com/celery/celery/issues/1495">exclusividad en el Beat</a>, es importante lanzar sólo uno o recibiríamos más de un <em>latido</em>.</p>
<p>Es este <em>beat</em> quien nos permite lanzar tareas periódicas.</p>
<p>Veamos un ejemplo pequeñito: Cada 10 segundos vamos a multiplicar la hora por dos:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery beat example: periodic date operation</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">import</span> datetime
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#a6e22e">@app.task</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_days</span>(days):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#66d9ef">return</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now() <span style="color:#f92672">+</span> datetime<span style="color:#f92672">.</span>timedelta(days<span style="color:#f92672">=</span>days)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>update(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    CELERYBEAT_SCHEDULE<span style="color:#f92672">=</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        <span style="color:#e6db74">&#39;multiply-each-10-seconds&#39;</span>: {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>            <span style="color:#e6db74">&#39;task&#39;</span>: <span style="color:#e6db74">&#39;tasks.add_days&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            <span style="color:#e6db74">&#39;schedule&#39;</span>: datetime<span style="color:#f92672">.</span>timedelta(seconds<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            <span style="color:#e6db74">&#39;args&#39;</span>: (<span style="color:#ae81ff">2</span>, )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>)</code></pre></div>
<p>Y aquí os dejo un ejemplo de ejecución:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/qTXJUnV0oHU" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>Nuevamente, no voy a entrar en más detalles aquí; tan sólo pretendo darlo a conocer. Podéis leer más sobre las <a href="https://celery.readthedocs.org/en/latest/userguide/periodic-tasks.html">tareas periódicas</a> si os interesa.</p>
<h3 id="warning-pickle">Warning: pickle</h3>
<p>Es posible que veamos un <em>warning</em> del estilo <code>warnings.warn(CDeprecationWarning(W_PICKLE_DEPRECATED))</code>. Esto se debe a que estamos usando el serializador <a href="https://docs.python.org/3.4/library/pickle.html">pickle</a>, que está obsoleto. Podéis evitarlo añadiendo la línea siguiente:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#75715e"># Celery beat example: periodic date operation</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#f92672">import</span> datetime
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> group
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e"># RabbitMQ</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#75715e">#app = Celery(&#39;tasks&#39;, broker=&#39;amqp://guest@localhost//&#39;, backend=&#39;amqp&#39;)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#75715e"># Redis</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;tasks&#39;</span>, broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>, backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://localhost:6379/0&#39;</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#a6e22e">@app.task</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_days</span>(days):
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#66d9ef">return</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now() <span style="color:#f92672">+</span> datetime<span style="color:#f92672">.</span>timedelta(days<span style="color:#f92672">=</span>days)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>update(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    CELERYBEAT_SCHEDULE<span style="color:#f92672">=</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        <span style="color:#e6db74">&#39;multiply-each-10-seconds&#39;</span>: {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>            <span style="color:#e6db74">&#39;task&#39;</span>: <span style="color:#e6db74">&#39;tasks.add_days&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            <span style="color:#e6db74">&#39;schedule&#39;</span>: datetime<span style="color:#f92672">.</span>timedelta(seconds<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            <span style="color:#e6db74">&#39;args&#39;</span>: (<span style="color:#ae81ff">2</span>, )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>        },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    },
<span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    CELERY_ACCEPT_CONTENT <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;json&#39;</span>],
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>)</code></pre></div>
<h2 id="entornos-complejos">Entornos complejos</h2>
<p>Evidentemente, todo lo que he contado aquí es lo más básico de <a href="https://www.celeryproject.org/">Celery</a>. Hemos utilizado una única cola para nuestras comunicaciones. Dado que <a href="https://www.rabbitmq.com">RabbitMQ</a> permite operaciones entre colas, <a href="https://www.celeryproject.org/">Celery</a> también.</p>
<p>Entre otras cosas, se puede:</p>
<ul>
<li>asignar colas diferentes para diferentes tareas, de manera que no todos los <em>workers</em> atiendan todas las peticiones o que haya un número de <em>workers</em> diferente para cada cola.</li>
<li><em>enrutar</em> mensajes entre colas.</li>
<li>enviar mensajes a todas las colas (<strong>topic</strong>).</li>
<li>&hellip;</li>
</ul>
<p>No me voy a meter aquí en profundidad, pero sí voy a describir cómo funciona la entrega de mensajes. Esta información es necesaria para poder entender los enrutados (obtenido de <a href="https://celery.readthedocs.org/en/latest/userguide/routing.html#exchanges-queues-and-routing-keys">Exchanges, queues and routing keys</a>):</p>
<ol>
<li>Se envía un mensaje. Éste se deposita en un <strong>EXCHANGE</strong>. Si no existía, <a href="https://www.celeryproject.org/">Celery</a> lo crea.</li>
<li>El <strong>EXCHANGE</strong> enruta el mensaje a una o más colas, dependiendo de su configuración. Si las colas no existen, <a href="https://www.celeryproject.org/">Celery</a> las crea.</li>
<li>El mensaje queda esperando en la cola hasta que un consumidor lo recoge y procesa. En ese momento el mensaje se bloquea para que ningún otro consumidor lo lea.</li>
<li>Tras su procesado, el consumidor envía un <strong>ACK</strong> y el mensaje se borra de la cola.</li>
</ol>
<p>Por defecto, <a href="https://www.celeryproject.org/">Celery</a> crea colas con el nombre del <em>exchange</em> y las une (<strong>bind</strong>) en modo directo, es decir, que todo lo que llega al <em>exchange</em> se deja en la cola.</p>
<p>Se puede jugar con los enrutados y crear arquitecturas realmente complejas, de manera que cada mensaje llege a su destino dependiendo de la operación a realizar.</p>
<h2 id="más-información">Más información</h2>
<p>Entre los artículos de nivel básico, me gusta mucho el artículo <a href="https://abhishek-tiwari.com/post/amqp-rabbitmq-and-celery-a-visual-guide-for-dummies">AMQP, RabbitMQ and Celery - A Visual Guide For Dummies</a>, ya que lo explica todo con imágenes. No está mal un artículo publicado en Digitalocean, <a href="https://www.digitalocean.com/community/tutorials/how-to-use-celery-with-rabbitmq-to-queue-tasks-on-an-ubuntu-vps">How To Use Celery with RabbitMQ to Queue Tasks on an Ubuntu VPS</a> o una presentación de la PyCon 2013, titulada <a href="https://www.imankulov.name/posts/celery-for-internal-api.html">Celery for Internal API in SOA infrastructure</a>.</p>
<p><a href="https://www.caktusgroup.com/blog/2014/06/23/scheduling-tasks-celery/">Getting Started Scheduling Tasks with Celery</a> es un artículo que cuenta más cómo configurar tareas periódicas de forma dinámica con <a href="https://pypi.python.org/pypi/django-celery">DJCelery</a>, bastante interesante aunque no queráis usar <a href="https://www.djangoproject.com/">Django</a>.</p>
<p>Para entender mejor lo que ocurre a bajo nivel, recomiendo meterse de lleno en <a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html">AMQP 0-9-1 Model Explained</a>, donde se cuenta cómo funciona el protocolo <a href="https://www.amqp.org/">AMQP</a>. Muy interesante antes de entrar en enrutados complejos. En este mismo sentido recomiendo <a href="https://rajith.2rlabs.com/2007/10/13/amqp-in-10-mins-part3-flexible-routing-model/">AMQP in 10 mins : Part3 – Flexible Routing Model</a>, que es más sencillo y sólo explica los conceptos más básicos.</p>
<p>Si queréis participar en un proyecto que utiliza <a href="https://www.celeryproject.org/">Celery</a>, os puedo animar a que me ayudéis con <a href="https://github.com/djcron-project/">DJCron</a>, que es un wrapper sobre <a href="https://pypi.python.org/pypi/django-celery">DJCelery</a> que permite configurar tareas distribuidas de forma dinámica, añadiendo algunas características extra sobre <a href="https://pypi.python.org/pypi/django-celery">DJCelery</a>.</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/python" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">python</a>
   </li>
  
   <li class="list">
     <a href="/tags/celery" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">celery</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "magmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Relacionado</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/django-lo-hizo-un-mago-plantillas-y-contextos/">Django lo hizo un mago: plantillas y contextos</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/django-lo-hizo-un-mago-paginacion-y-detalle/">Django lo hizo un mago: paginación y detalle</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/django-lo-hizo-un-mago/">Django lo hizo un mago</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/pycones-2014-2/">Retrospectiva a la #PyConEs2014 (2)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/pycones-2014/">Retrospectiva a la #PyConEs2014 (1)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/publicando-artefactos-python/">Publicando artefactos Python</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/testing-en-django-mejoras/">Testing en django: mejoras</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/aprender-es-duro/">Aprender es duro (retrospectiva 2014)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/webviews-en-el-escritorio/">WebViews en el escritorio</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/micro-web-framework-en-python/">Micro-framework web en Python</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/webdriver-practico/">Webdriver: crackeando la web de Renfe</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python-avanzado/">Python avanzado</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python-basico/">Python básico</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python-tornado-2/">Python Tornado: Web Testing</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/python-tornado/">Python Tornado</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://magmax.org/" >
    &copy;  El blog de MagMax 2021 
  </a>
    <div>














</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
